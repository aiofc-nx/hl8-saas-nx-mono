<!DOCTYPE html>
<!-- saved from url=(0056)http://zhufengpeixun.com/nestjs/html/14.cms-content.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>珠峰架构师成长计划</title>
    <link rel="stylesheet" type="text/css" href="./14_files/main.css">
    <link rel="stylesheet" href="https://static.zhufengpeixun.com/bootstrapmin_1645176572503.css">
    <style>
        .page-toc > ul .red {
            background: #f3f3f3;
            z-index: 1;
            border-left: 3px solid #009a61;
            -webkit-transition: all .2s ease;
            transition: all .2s ease;
            color: #000
        }
    </style>
</head>
<body>
<div class="nav">
    <div class="logo">
        
                珠峰架构师成长计划
                    
    </div>
    <ul><li><a href="http://zhufengpeixun.com/nestjs/index.html">index</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/1.fe.html">1.fe</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/2.nest.html">2.nest</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/3.decorator.html">3.decorator</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/4.controller.html">4.controller</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/5.ioc.html">5.ioc</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/6.Providers.html">6.Providers</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/7.middleware.html">7.middleware</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/8.Exceptionfilters.html">8.Exceptionfilters</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/9.Pipes.html">9.Pipes</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/10.Guards.html">10.Guards</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/11.Interceptors.html">11.Interceptors</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/12.Upload.html">12.Upload</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/13.cms-rbac.html">13.cms-rbac</a></li><li class="active"><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html">14.cms-content</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/15.cms-front.html">15.cms-front</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/16.cms-refer.html">16.cms-refer</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/mysql2.html">mysql2</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/typeorm.html">typeorm</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/logger.html">logger</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/nestjs-i18n.html">nestjs-i18n</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/Schematic.html">Schematic</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/generator.html">generator</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/htmx.html">htmx</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/websocket.html">websocket</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/etcd.html">etcd</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/gRPC.html">gRPC</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/microservices.html">microservices</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/monorepo.html">monorepo</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/graphql.html">graphql</a></li></ul></div>


  <div class="warpper">
    <span id="toc-toggle" style="position: fixed;left:10px;top:55px;z-index: 1000;color:white;background-color: rgb(32,35,42);">&lt;</span>
    <div class="page-toc">
      <ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t01.%E5%88%86%E7%B1%BB%E5%92%8C%E6%A0%87%E7%AD%BE">1.分类和标签</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11.1.%20contains.ts">1.1. contains.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t21.2.%20mapToIds.ts">1.2. mapToIds.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t31.3.%20index.ts">1.3. index.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t41.4.%20article-detail.hbs">1.4. article-detail.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t51.5.%20article.entity.ts">1.5. article.entity.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t61.6.%20article.dto.ts">1.6. article.dto.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t71.7.%20article.service.ts">1.7. article.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t81.8.%20article.controller.ts">1.8. article.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t91.9.%20article-form.hbs">1.9. article-form.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t101.10.%20article-list.hbs">1.10. article-list.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t112.%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8">2.富文本编辑器</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t122.1.%20main.hbs">2.1. main.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t132.2.%20article.controller.ts">2.2. article.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t142.3.%20article-form.hbs">2.3. article-form.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t153.%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0">3.文件上传</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t163.1.%20global.d.ts">3.1. global.d.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t173.2.%20admin.module.ts">3.2. admin.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t183.3.%20article-detail.hbs">3.3. article-detail.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t193.4.%20upload.controller.ts">3.4. upload.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t203.5.%20app.module.ts">3.5. app.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t213.6.%20article-form.hbs">3.6. article-form.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t224.%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9">4.图片压缩</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t234.1.%20upload.controller.ts">4.1. upload.controller.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t245.%E4%B8%8A%E4%BC%A0%E8%87%B3COS">5.上传至COS</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t255.1.%20cos.service.ts">5.1. cos.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t265.2.%20upload.controller.ts">5.2. upload.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t275.3.%20shared.module.ts">5.3. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t285.4.%20article-form.hbs">5.4. article-form.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t296.%E5%A2%9E%E5%8A%A0%E5%AE%A1%E6%A0%B8%E7%8A%B6%E6%80%81">6.增加审核状态</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t306.1.%20article.enum.ts">6.1. article.enum.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t316.2.%20article.entity.ts">6.2. article.entity.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t326.3.%20article.dto.ts">6.3. article.dto.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t336.4.%20article-detail.hbs">6.4. article-detail.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t346.5.%20article.controller.ts">6.5. article.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t356.6.%20article-list.hbs">6.6. article-list.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t367.%E5%8F%91%E9%80%81%E5%AE%A1%E6%A0%B8%E9%80%9A%E7%9F%A5">7.发送审核通知</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t377.1.%20notification.service.ts">7.1. notification.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t387.2.%20app.module.ts">7.2. app.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t397.3.%20article.entity.ts">7.3. article.entity.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t407.4.%20shared.module.ts">7.4. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t417.5.%20article.controller.ts">7.5. article.controller.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t428.%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6">8.发送邮件</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t438.1.%20mail.service.ts">8.1. mail.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t448.2.%20notification.service.ts">8.2. notification.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t458.3.%20shared.module.ts">8.3. shared.module.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t469.%E5%AF%BC%E5%87%BAWord">9.导出Word</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t479.1.%20word-export.service.ts">9.1. word-export.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t489.2.%20shared.module.ts">9.2. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t499.3.%20article-detail.hbs">9.3. article-detail.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t509.4.%20article.controller.ts">9.4. article.controller.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5110.%E5%AF%BC%E5%87%BAppt">10.导出ppt</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5210.1.%20ppt-export.service.ts">10.1. ppt-export.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5310.2.%20admin-exception-filter.ts">10.2. admin-exception-filter.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5410.3.%20shared.module.ts">10.3. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5510.4.%20article.controller.ts">10.4. article.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5610.5.%20article-list.hbs">10.5. article-list.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5711.%E5%AF%BC%E5%87%BAExcel">11.导出Excel</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5811.1.%20excel-export.service.ts">11.1. excel-export.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5911.2.%20shared.module.ts">11.2. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6011.3.%20article.controller.ts">11.3. article.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6111.4.%20article-list.hbs">11.4. article-list.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6212.%E7%BD%91%E7%AB%99%E8%AE%BE%E7%BD%AE">12.网站设置</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6312.1.%20dashboard.controller.ts">12.1. dashboard.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6412.2.%20setting.dto.ts">12.2. setting.dto.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6512.3.%20setting.schema.ts">12.3. setting.schema.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6612.4.%20setting.service.ts">12.4. setting.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6712.5.%20mongodb-base.service.ts">12.5. mongodb-base.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6812.6.%20admin.module.ts">12.6. admin.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6912.7.%20settings.hbs">12.7. settings.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7012.8.%20setting.controller.ts">12.8. setting.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7112.9.%20configuration.service.ts">12.9. configuration.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7212.10.%20sidebar.hbs">12.10. sidebar.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7312.11.%20shared.module.ts">12.11. shared.module.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7413.%20%E5%BF%AB%E6%8D%B7%E6%93%8D%E4%BD%9C">13. 快捷操作</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7513.1.%20header.hbs">13.1. header.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7613.2.%20main.hbs">13.2. main.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7713.3.%20dashboard.hbs">13.3. dashboard.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7814.%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%A7%88">14.系统概览</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7914.1.%20dashboard.controller.ts">14.1. dashboard.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8014.2.%20mysql-base.service.ts">14.2. mysql-base.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8114.3.%20dashboard.service.ts">14.3. dashboard.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8214.4.%20dashboard.hbs">14.4. dashboard.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8314.5.%20shared.module.ts">14.5. shared.module.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8415.%E6%9C%80%E6%96%B0%E6%95%B0%E6%8D%AE">15.最新数据</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8515.1.%20fromNow.ts">15.1. fromNow.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8615.2.%20index.ts">15.2. index.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8715.3.%20mysql-base.service.ts">15.3. mysql-base.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8815.4.%20dashboard.service.ts">15.4. dashboard.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8915.5.%20dashboard.hbs">15.5. dashboard.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9016.%E5%86%85%E5%AE%B9%E7%BB%9F%E8%AE%A1%E5%9B%BE%E8%A1%A8">16.内容统计图表</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9116.1.%20dashboard.service.ts">16.1. dashboard.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9216.2.%20mysql-base.service.ts">16.2. mysql-base.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9316.3.%20article.service.ts">16.3. article.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9416.4.%20dashboard.hbs">16.4. dashboard.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9517.%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5">17.天气预报</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9617.1.%20dashboard.controller.ts">17.1. dashboard.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9717.2.%20weather.service.ts">17.2. weather.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9817.3.%20shared.module.ts">17.3. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9917.4.%20dashboard.hbs">17.4. dashboard.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10018.%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81">18.服务器状态</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10118.1.%20main.hbs">18.1. main.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10218.2.%20dashboard.controller.ts">18.2. dashboard.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10318.3.%20system.service.ts">18.3. system.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10418.4.%20shared.module.ts">18.4. shared.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10518.5.%20dashboard.hbs">18.5. dashboard.hbs</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10619.%E5%90%8E%E5%8F%B0%E7%99%BB%E5%BD%95%E5%92%8C%E9%80%80%E5%87%BA">19.后台登录和退出</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10719.1.%20utility.service.ts">19.1. utility.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10819.2.%20header.hbs">19.2. header.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10919.3.%20admin.module.ts">19.3. admin.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11019.4.%20login.hbs">19.4. login.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11119.5.%20auth.controller.ts">19.5. auth.controller.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11219.6.%20main.ts">19.6. main.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11320.%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90">20.菜单权限</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11420.1.%20global.d.ts">20.1. global.d.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11520.2.%20header.hbs">20.2. header.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11620.3.%20sidebar.hbs">20.3. sidebar.hbs</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11720.4.%20admin.module.ts">20.4. admin.module.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11820.5.%20auth.middleware.ts">20.5. auth.middleware.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11921.Redis%E4%BC%9A%E8%AF%9D">21.Redis会话</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12021.1.%20redis.service.ts">21.1. redis.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12121.2.%20configuration.service.ts">21.2. configuration.service.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12221.3.%20main.ts">21.3. main.ts</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12321.4.%20shared.module.ts">21.4. shared.module.ts</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t124CKEditor%205">CKEditor 5</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1251.%20%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88">1. 架构概览</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1262.%20%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7">2. 主要特性</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1273.%20%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8">3. 安装与使用</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1284.%20%E7%BC%96%E8%BE%91%E5%99%A8%E6%9E%84%E5%BB%BA">4. 编辑器构建</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1295.%20%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F">5. 插件系统</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1306.%20%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%A9%E5%B1%95">6. 自定义与扩展</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1317.%20%E9%9B%86%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8">7. 集成与使用</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1328.%20%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">8. 高级功能</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1339.%20%E6%80%BB%E7%BB%93">9. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t134Simple%20Upload%20Adapter">Simple Upload Adapter</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1351.%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">1. 工作原理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1362.%20%E9%85%8D%E7%BD%AE%20Simple%20Upload%20Adapter">2. 配置 Simple Upload Adapter</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1373.%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%A4%84%E7%90%86">3. 服务器端处理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1384.%20%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F">4. 返回数据格式</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1395.%20%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">5. 使用场景</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1406.%20%E9%99%90%E5%88%B6%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">6. 限制与注意事项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1417.%20%E6%80%BB%E7%BB%93">7. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t142CKEditor%20%E6%8F%92%E4%BB%B6">CKEditor 插件</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1431.%20%E4%BA%86%E8%A7%A3%20CKEditor%20%E6%8F%92%E4%BB%B6%E6%9E%B6%E6%9E%84">1. 了解 CKEditor 插件架构</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1442.%20%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83">2. 设置开发环境</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1453.%20%E5%88%9B%E5%BB%BA%E6%8F%92%E4%BB%B6%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84">3. 创建插件基础结构</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1464.%20%E5%AE%9E%E7%8E%B0%E6%8F%92%E4%BB%B6%E5%8A%9F%E8%83%BD">4. 实现插件功能</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1474.1.%20%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%91%BD%E4%BB%A4">4.1. 添加自定义命令</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1484.2.%20%E6%B7%BB%E5%8A%A0%E6%8C%89%E9%92%AE%E5%88%B0%E5%B7%A5%E5%85%B7%E6%A0%8F">4.2. 添加按钮到工具栏</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1494.3.%20%E4%BF%AE%E6%94%B9%E7%BC%96%E8%BE%91%E5%99%A8%E5%86%85%E5%AE%B9">4.3. 修改编辑器内容</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1505.%20%E6%89%A9%E5%B1%95%E7%BC%96%E8%BE%91%E5%99%A8%E7%9A%84%20Schema">5. 扩展编辑器的 Schema</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1516.%20%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2">6. 处理数据转换</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1527.%20%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B0%83%E8%AF%95">7. 测试与调试</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1538.%20%E5%8F%91%E5%B8%83%E5%92%8C%E5%88%86%E4%BA%AB%E6%8F%92%E4%BB%B6">8. 发布和分享插件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1549.%20%E6%80%BB%E7%BB%93">9. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t155@nestjs/event-emitter">@nestjs/event-emitter</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1561.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1572.%20%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE">2. 模块配置</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1583.%20%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%8F%91%E5%B8%83%E5%92%8C%E8%AE%A2%E9%98%85">3. 事件的发布和订阅</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1593.1.%20%E5%8F%91%E5%B8%83%E4%BA%8B%E4%BB%B6">3.1. 发布事件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1603.2.%20%E8%AE%A2%E9%98%85%E4%BA%8B%E4%BB%B6">3.2. 订阅事件</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1614.%20%E9%80%9A%E9%85%8D%E7%AC%A6%E4%BA%8B%E4%BB%B6">4. 通配符事件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1625.%20%E5%BC%82%E6%AD%A5%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86">5. 异步事件处理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1636.%20%E4%BA%8B%E4%BB%B6%E4%BC%98%E5%85%88%E7%BA%A7">6. 事件优先级</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1647.%20%E5%85%A8%E5%B1%80%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8">7. 全局事件处理器</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1658.%20%E6%80%BB%E7%BB%93">8. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t166COS%20Node.js%20SDK%20v5">COS Node.js SDK v5</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1671.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1682.%20%E5%88%9D%E5%A7%8B%E5%8C%96%20SDK">2. 初始化 SDK</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1693.%20%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C">3. 常用操作</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1703.1.%20%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E6%A1%B6%EF%BC%88Bucket%EF%BC%89">3.1. 创建存储桶（Bucket）</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1713.2.%20%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6">3.2. 上传文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1723.3.%20%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6">3.3. 下载文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1733.4.%20%E5%88%97%E5%87%BA%E5%AD%98%E5%82%A8%E6%A1%B6%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6">3.4. 列出存储桶中的文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1743.5.%20%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6">3.5. 删除文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1753.6.%20%E5%88%A0%E9%99%A4%E5%AD%98%E5%82%A8%E6%A1%B6">3.6. 删除存储桶</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1764.%20%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">4. 高级功能</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1774.1.%20%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%EF%BC%88%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%EF%BC%89">4.1. 分块上传（大文件上传）</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1784.2.%20%E8%AE%BE%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90">4.2. 设置对象的访问权限</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1794.3.%20%E7%94%9F%E6%88%90%E9%A2%84%E7%AD%BE%E5%90%8D%20URL">4.3. 生成预签名 URL</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1805.%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">5. 错误处理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1816.%20%E6%80%BB%E7%BB%93">6. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t182@nestjs/serve-static">@nestjs/serve-static</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1831.%20%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">1. 主要功能</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1842.%20%E5%AE%89%E8%A3%85%E5%92%8C%E8%AE%BE%E7%BD%AE">2. 安装和设置</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1853.%20%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9">3. 配置选项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1864.%20%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">4. 应用场景</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1875.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">5. 注意事项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1886.%20%E6%80%BB%E7%BB%93">6. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t189Sharp%EF%BC%9A%E9%AB%98%E6%80%A7%E8%83%BD%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E5%BA%93">Sharp：高性能图像处理库</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1901.%20Sharp%20%E7%9A%84%E7%89%B9%E7%82%B9">1. Sharp 的特点</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1912.%20%E5%AE%89%E8%A3%85">2. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1923.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">3. 基本用法</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1933.1.%20%E8%B0%83%E6%95%B4%E5%9B%BE%E5%83%8F%E5%A4%A7%E5%B0%8F">3.1. 调整图像大小</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1943.2.%20%E8%A3%81%E5%89%AA%E5%9B%BE%E5%83%8F">3.2. 裁剪图像</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1953.3.%20%E8%BD%AC%E6%8D%A2%E5%9B%BE%E5%83%8F%E6%A0%BC%E5%BC%8F">3.3. 转换图像格式</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1963.4.%20%E6%97%8B%E8%BD%AC%E5%92%8C%E7%BF%BB%E8%BD%AC%E5%9B%BE%E5%83%8F">3.4. 旋转和翻转图像</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1973.5.%20%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0">3.5. 添加水印</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1983.6.%20%E8%B0%83%E6%95%B4%E5%9B%BE%E5%83%8F%E4%BA%AE%E5%BA%A6%E5%92%8C%E5%AF%B9%E6%AF%94%E5%BA%A6">3.6. 调整图像亮度和对比度</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1994.%20%E5%A4%84%E7%90%86%E6%B5%81%E5%BC%8F%E6%95%B0%E6%8D%AE">4. 处理流式数据</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2005.%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">5. 错误处理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2016.%20%E4%BC%98%E5%8C%96%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86">6. 优化图像处理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2027.%20%E6%80%BB%E7%BB%93">7. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t203Nodemailer">Nodemailer</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2041.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2052.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2063.%20%E9%85%8D%E7%BD%AE%E4%BC%A0%E8%BE%93%E5%99%A8%EF%BC%88Transporter%EF%BC%89">3. 配置传输器（Transporter）</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2073.1.%20SMTP%20%E4%BC%A0%E8%BE%93%E5%99%A8">3.1. SMTP 传输器</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2083.2.%20%E4%BD%BF%E7%94%A8%20OAuth2%20%E8%AE%A4%E8%AF%81">3.2. 使用 OAuth2 认证</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2093.3.%20%E6%9C%AC%E5%9C%B0%E9%82%AE%E4%BB%B6%E4%BC%A0%E8%BE%93%E4%BB%A3%E7%90%86">3.3. 本地邮件传输代理</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2104.%20%E9%82%AE%E4%BB%B6%E9%80%89%E9%A1%B9%EF%BC%88Mail%20Options%EF%BC%89">4. 邮件选项（Mail Options）</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2114.1.%20%E5%8F%91%E9%80%81%E5%B8%A6%E9%99%84%E4%BB%B6%E7%9A%84%E9%82%AE%E4%BB%B6">4.1. 发送带附件的邮件</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2125.%20%E5%A4%84%E7%90%86%E5%8F%91%E9%80%81%E7%BB%93%E6%9E%9C">5. 处理发送结果</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2136.%20%E8%B0%83%E8%AF%95%E4%B8%8E%E6%97%A5%E5%BF%97">6. 调试与日志</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2147.%20%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">7. 常见问题</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2158.%20%E6%80%BB%E7%BB%93">8. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t216html-to-docx">html-to-docx</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2171.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2182.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2193.%20API%20%E8%AF%A6%E8%A7%A3">3. API 详解</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2203.1.%20Options%20%E9%85%8D%E7%BD%AE">3.1. Options 配置</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2214.%20%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95">4. 高级用法</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2224.1.%20%E5%B0%86%E5%A4%8D%E6%9D%82%E7%9A%84%20HTML%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%20.docx">4.1. 将复杂的 HTML 转换为 .docx</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2234.2.%20%E9%80%9A%E8%BF%87%20HTTP%20%E5%93%8D%E5%BA%94%E8%BF%94%E5%9B%9E%20.docx">4.2. 通过 HTTP 响应返回 .docx</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2245.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E5%B1%80%E9%99%90%E6%80%A7">5. 注意事项和局限性</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2256.%20%E6%80%BB%E7%BB%93">6. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t226PptxGenJS">PptxGenJS</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2271.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2282.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2293.%20%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A">3. 详细解释</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2303.1.%20%E5%88%9B%E5%BB%BA%20PPTX%20%E6%96%87%E4%BB%B6">3.1. 创建 PPTX 文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2313.2.%20%E5%B0%86%20HTML%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%20PPTX">3.2. 将 HTML 转换为 PPTX</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2323.3.%20%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6">3.3. 保存文件</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2334.%20%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95">4. 高级用法</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2344.1.%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%B7%E5%BC%8F%E5%92%8C%E5%B8%83%E5%B1%80">4.1. 自定义样式和布局</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2354.2.%20%E5%A4%9A%E5%BC%A0%E5%B9%BB%E7%81%AF%E7%89%87">4.2. 多张幻灯片</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2364.3.%20%E6%8F%92%E5%85%A5%E5%9B%BE%E5%83%8F">4.3. 插入图像</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2375.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E5%B1%80%E9%99%90%E6%80%A7">5. 注意事项和局限性</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2386.%20%E6%80%BB%E7%BB%93">6. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t239ExcelJS">ExcelJS</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2401.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2412.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2423.%20%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%92%8C%E7%94%A8%E6%B3%95">3. 主要功能和用法</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2433.1.%20%E5%B7%A5%E4%BD%9C%E7%B0%BF%E5%92%8C%E5%B7%A5%E4%BD%9C%E8%A1%A8">3.1. 工作簿和工作表</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2443.2.%20%E6%93%8D%E4%BD%9C%E5%88%97%E5%92%8C%E8%A1%8C">3.2. 操作列和行</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2453.3.%20%E5%8D%95%E5%85%83%E6%A0%BC%E6%A0%B7%E5%BC%8F">3.3. 单元格样式</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2463.4.%20%E5%90%88%E5%B9%B6%E5%8D%95%E5%85%83%E6%A0%BC">3.4. 合并单元格</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2473.5.%20%E8%AF%BB%E5%8F%96%E5%92%8C%E4%BF%AE%E6%94%B9%E7%8E%B0%E6%9C%89%E7%9A%84%20Excel%20%E6%96%87%E4%BB%B6">3.5. 读取和修改现有的 Excel 文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2483.6.%20%E5%A4%84%E7%90%86%20CSV%20%E6%96%87%E4%BB%B6">3.6. 处理 CSV 文件</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2494.%20%E5%B8%B8%E8%A7%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">4. 常见应用场景</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2505.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">5. 注意事项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2516.%20%E6%80%BB%E7%BB%93">6. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t252StreamableFile">StreamableFile</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2531.%20%E4%BB%80%E4%B9%88%E6%98%AF%20StreamableFile%EF%BC%9F">1. 什么是 StreamableFile？</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2542.%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">2. 安装与配置</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2553.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">3. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2564.%20%E5%A4%84%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6">4. 处理大文件</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2575.%20%E4%BC%A0%E8%BE%93%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E7%9A%84%E5%86%85%E5%AE%B9">5. 传输动态生成的内容</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2586.%20%E5%93%8D%E5%BA%94%E5%A4%B4%E8%AE%BE%E7%BD%AE">6. 响应头设置</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2597.%20%E4%B8%8E%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%9B%86%E6%88%90">7. 与文件上传集成</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2608.%20%E6%80%BB%E7%BB%93">8. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t261@nestjs/mongoose">@nestjs/mongoose</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2621.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2632.%20%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE">2. 基本配置</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2643.%20%E5%AE%9A%E4%B9%89%20Schema">3. 定义 Schema</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2654.%20%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B">4. 创建模型</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2665.%20%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9E%8B">5. 使用模型</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2676.%20%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD">6. 常用功能</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2687.%20%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95">7. 高级用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2698.%20%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86">8. 事务管理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t270%E6%80%BB%E7%BB%93">总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t271geoip-lite">geoip-lite</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2721.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2732.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2743.%20%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C">3. 输出结果</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2754.%20API%20%E8%AF%A6%E8%A7%A3">4. API 详解</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2764.1.%20lookup(ip)">4.1. lookup(ip)</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2774.2.%20%E6%94%AF%E6%8C%81%20IPv4%20%E5%92%8C%20IPv6">4.2. 支持 IPv4 和 IPv6</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2785.%20%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BA%93">5. 本地数据库</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2796.%20%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93">6. 更新数据库</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2807.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">7. 注意事项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2818.%20%E7%A4%BA%E4%BE%8B%E5%9C%BA%E6%99%AF">8. 示例场景</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2829.%20%E6%80%BB%E7%BB%93">9. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t283ECharts">ECharts</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2841.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2852.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2863.%20%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%92%8C%E7%BB%84%E4%BB%B6">3. 核心概念和组件</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2873.1.%20%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%88option%EF%BC%89">3.1. 配置项（option）</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2883.2.%20%E5%B8%B8%E8%A7%81%E5%9B%BE%E8%A1%A8%E7%B1%BB%E5%9E%8B">3.2. 常见图表类型</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2893.3.%20%E6%95%B0%E6%8D%AE">3.3. 数据</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2904.%20%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">4. 高级功能</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2914.1.%20%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE">4.1. 动态更新数据</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2924.2.%20%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A1">4.2. 响应式设计</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2934.3.%20%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86">4.3. 事件处理</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2945.%20%E9%9B%86%E6%88%90%E4%B8%8E%E6%89%A9%E5%B1%95">5. 集成与扩展</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2956.%20%E6%80%BB%E7%BB%93">6. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t296Handlebars">Handlebars</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2971.%20%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95">1. 基本语法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2982.%20%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5">2. 条件语句</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2993.%20%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5">3. 循环语句</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3004.%20%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E4%B8%8E%E6%B8%B2%E6%9F%93">4. 模板编译与渲染</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3015.%20%E8%87%AA%E5%AE%9A%E4%B9%89%20Helper">5. 自定义 Helper</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3026.%20%E9%83%A8%E5%88%86%E6%A8%A1%E6%9D%BF%EF%BC%88Partials%EF%BC%89">6. 部分模板（Partials）</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3037.%20%E5%AE%89%E5%85%A8%E6%80%A7">7. 安全性</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t304%E6%80%BB%E7%BB%93">总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t305@Sse">@Sse</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3061.%20%E4%BB%80%E4%B9%88%E6%98%AF%20SSE%EF%BC%9F">1. 什么是 SSE？</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3072.%20@Sse%20%E7%9A%84%E4%BD%BF%E7%94%A8">2. @Sse 的使用</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3083.%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">3. 工作原理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3094.%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE">4. 客户端如何接收数据</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3105.%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">5. 错误处理</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t311%E6%80%BB%E7%BB%93">总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t312systeminformation">systeminformation</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3131.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3142.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3153.%20%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E4%B8%8E%E6%96%B9%E6%B3%95">3. 核心功能与方法</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3163.1.%20CPU%20%E4%BF%A1%E6%81%AF">3.1. CPU 信息</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3173.2.%20%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF">3.2. 内存信息</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3183.3.%20%E7%A3%81%E7%9B%98%E4%BF%A1%E6%81%AF">3.3. 磁盘信息</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3193.4.%20%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF">3.4. 网络信息</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3203.5.%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF">3.5. 操作系统信息</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3213.6.%20%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF">3.6. 进程信息</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3224.%20%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7">4. 实时监控</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3235.%20%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8">5. 组合使用</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3246.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">6. 注意事项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3257.%20%E6%80%BB%E7%BB%93">7. 总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t326ioredis">ioredis</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3271.%20%E5%AE%89%E8%A3%85%20ioredis">1. 安装 ioredis</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3282.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3293.%20%E8%BF%9E%E6%8E%A5%20Redis">3. 连接 Redis</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3304.%20%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C">4. 常用操作</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3315.%20%E8%AE%A2%E9%98%85/%E5%8F%91%E5%B8%83%EF%BC%88Pub/Sub%EF%BC%89">5. 订阅/发布（Pub/Sub）</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3326.%20Redis%20%E9%9B%86%E7%BE%A4%E6%94%AF%E6%8C%81">6. Redis 集群支持</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3337.%20%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">7. 高级特性</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3348.%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">8. 性能优化</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t335%E6%80%BB%E7%BB%93">总结</a></li></ul></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t336connect-redis">connect-redis</a><ul><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3371.%20%E5%AE%89%E8%A3%85">1. 安装</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3382.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">2. 基本用法</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3393.%20%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9">3. 配置选项</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3404.%20%E9%9B%86%E7%BE%A4%E6%94%AF%E6%8C%81">4. 集群支持</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3415.%20%E6%8C%81%E4%B9%85%E5%8C%96%E4%BC%9A%E8%AF%9D">5. 持久化会话</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3426.%20%E4%BC%9A%E8%AF%9D%E5%85%B1%E4%BA%AB">6. 会话共享</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3437.%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">7. 性能优化</a></li><li><a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t344%E6%80%BB%E7%BB%93">总结</a></li></ul></li></ul>
    </div>
    <div class="content markdown-body">
      <h2 id="t01.分类和标签">1.分类和标签 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t01.%E5%88%86%E7%B1%BB%E5%92%8C%E6%A0%87%E7%AD%BE"> # </a></h2>
<h3 id="t11.1. contains.ts">1.1. contains.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11.1.%20contains.ts"> # </a></h3>
<p>src/shared/helpers/contains.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">contains</span>(<span class="hljs-params">values, keyword</span>) </span>{
    <span class="hljs-keyword">return</span> values?.includes(keyword);
}
</code></pre>
<h3 id="t21.2. mapToIds.ts">1.2. mapToIds.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t21.2.%20mapToIds.ts"> # </a></h3>
<p>src/shared/helpers/mapToIds.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapToIds</span>(<span class="hljs-params">values</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(values.map(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.id));
}
</code></pre>
<h3 id="t31.3. index.ts">1.3. index.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t31.3.%20index.ts"> # </a></h3>
<p>src/shared/helpers/index.ts</p>
<pre><code class="lang-diff">export * from './eq';
export * from './range';
export * from './inc';
export * from './dec';
export * from './multiply';
export * from './json';
export * from './def';
<span class="hljs-addition">+export * from './mapToIds';</span>
<span class="hljs-addition">+export * from './contains';</span>
</code></pre>
<h3 id="t41.4. article-detail.hbs">1.4. article-detail.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t41.4.%20article-detail.hbs"> # </a></h3>
<p>views/article/article-detail.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
    文章详情
&lt;/h1&gt;
&lt;div class="mb-3"&gt;
<span class="hljs-addition">+   &lt;label class="form-label"&gt;标题:&lt;/label&gt;</span>
<span class="hljs-addition">+   &lt;p class="form-control-plaintext"&gt;{{article.title}}&lt;/p&gt;</span>
&lt;/div&gt;
&lt;div class="mb-3"&gt;
<span class="hljs-addition">+   &lt;label class="form-label"&gt;分类:&lt;/label&gt;</span>
<span class="hljs-addition">+   &lt;p class="form-control-plaintext"&gt;</span>
<span class="hljs-addition">+       {{#each article.categories}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/each}}</span>
<span class="hljs-addition">+   &lt;/p&gt;</span>
&lt;/div&gt;
<span class="hljs-addition">+&lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+   &lt;label class="form-label"&gt;标签:&lt;/label&gt;</span>
<span class="hljs-addition">+   &lt;p class="form-control-plaintext"&gt;</span>
<span class="hljs-addition">+       {{#each article.tags}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/each}}</span>
<span class="hljs-addition">+   &lt;/p&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+&lt;a href="/admin/articles/{{article.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;</span>
&lt;a href="/admin/articles" class="btn btn-secondary btn-sm"&gt;返回列表&lt;/a&gt;
</code></pre>
<h3 id="t51.5. article.entity.ts">1.5. article.entity.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t51.5.%20article.entity.ts"> # </a></h3>
<p>src/shared/entities/article.entity.ts</p>
<pre><code class="lang-diff">import { ApiProperty } from '@nestjs/swagger';
<span class="hljs-addition">+import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, UpdateDateColumn, ManyToMany, JoinTable } from 'typeorm';</span>
<span class="hljs-addition">+import { Category } from './category.entity';</span>
<span class="hljs-addition">+import { Tag } from './tag.entity';</span>

@Entity()
export class Article {
    @PrimaryGeneratedColumn()
    @ApiProperty({ description: 'ID', example: 1 })
    id: number;

<span class="hljs-addition">+   @Column({ length: 50, unique: true })</span>
<span class="hljs-addition">+   @ApiProperty({ description: '标题', example: '文章标题' })</span>
<span class="hljs-addition">+   title: string;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Column('text')</span>
<span class="hljs-addition">+   @ApiProperty({ description: '内容', example: '文章内容' })</span>
<span class="hljs-addition">+   content: string;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ManyToMany(() =&gt; Category)</span>
<span class="hljs-addition">+   @JoinTable()</span>
<span class="hljs-addition">+   categories: Category[];</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ManyToMany(() =&gt; Tag)</span>
<span class="hljs-addition">+   @JoinTable()</span>
<span class="hljs-addition">+   tags: Tag[];</span>

    @Column({ default: 1 })
    @ApiProperty({ description: '生效状态', example: 1 })
    status: number;

    @Column({ default: 100 })
    @ApiProperty({ description: '排序号', example: 100 })
    sort: number;

    @CreateDateColumn()
    @ApiProperty({ description: '创建时间', example: '2024年8月11日16:49:22' })
    createdAt: Date;

    @UpdateDateColumn()
    @ApiProperty({ description: '更新时间', example: '2024年8月11日16:49:22' })
    updatedAt: Date;
}

</code></pre>
<h3 id="t61.6. article.dto.ts">1.6. article.dto.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t61.6.%20article.dto.ts"> # </a></h3>
<p>src/shared/dto/article.dto.ts</p>
<pre><code class="lang-diff">import { ApiProperty, PartialType as PartialTypeFromSwagger } from '@nestjs/swagger';
<span class="hljs-addition">+import { IsString, IsInt, MaxLength } from 'class-validator';</span>
import { PartialType } from '@nestjs/mapped-types';
import { IdValidators, StatusValidators, SortValidators } from '../decorators/dto.decorator';
<span class="hljs-addition">+import { Transform } from 'class-transformer';</span>
export class CreateArticleDto {
<span class="hljs-addition">+   @ApiProperty({ description: '标题', example: '文章标题' })</span>
    @IsString()
<span class="hljs-addition">+   @MaxLength(50, { message: '标题不能超过50个字符' })</span>
<span class="hljs-addition">+   title: string;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ApiProperty({ description: '内容', example: '文章内容' })</span>
<span class="hljs-addition">+   content: string;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ApiProperty({ description: '分类ID数组', example: [1, 2] })</span>
<span class="hljs-addition">+   @Transform(({ value }) =&gt; Array.isArray(value) ? value.map(Number) : [Number(value)])</span>
<span class="hljs-addition">+   @IsInt({ each: true })</span>
<span class="hljs-addition">+   categoryIds: number[];</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ApiProperty({ description: '标签ID数组', example: [1, 2] })</span>
<span class="hljs-addition">+   @Transform(({ value }) =&gt; Array.isArray(value) ? value.map(Number) : [Number(value)])</span>
<span class="hljs-addition">+   @IsInt({ each: true })</span>
<span class="hljs-addition">+   tagIds: number[];</span>

    @StatusValidators()
    @ApiProperty({ description: '状态', example: 1 })
    status: number;

    @SortValidators()
    @ApiProperty({ description: '排序号', example: 100 })
    sort: number;
}

export class UpdateArticleDto extends PartialTypeFromSwagger(PartialType(CreateArticleDto)) {
    @IdValidators()
    id: number;
}

</code></pre>
<h3 id="t71.7. article.service.ts">1.7. article.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t71.7.%20article.service.ts"> # </a></h3>
<p>src/shared/services/article.service.ts</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { Injectable, NotFoundException } from "@nestjs/common";</span>
import { InjectRepository } from "@nestjs/typeorm";
import { Article } from "../entities/article.entity";
<span class="hljs-addition">+import { Repository, Like, In, UpdateResult } from 'typeorm';</span>
import { MySQLBaseService } from "./mysql-base.service";
<span class="hljs-addition">+import { CreateArticleDto, UpdateArticleDto } from "../dto/article.dto";</span>
<span class="hljs-addition">+import { Category } from "../entities/category.entity";</span>
<span class="hljs-addition">+import { Tag } from "../entities/tag.entity";</span>

@Injectable()
export class ArticleService extends MySQLBaseService&lt;Article&gt; {
  constructor(
<span class="hljs-addition">+   @InjectRepository(Article) protected repository: Repository&lt;Article&gt;,</span>
<span class="hljs-addition">+   @InjectRepository(Category) private readonly categoryRepository: Repository&lt;Category&gt;,</span>
<span class="hljs-addition">+   @InjectRepository(Tag) private readonly tagRepository: Repository&lt;Tag&gt;</span>
  ) {
    super(repository);
  }

  async findAll(keyword?: string) {
    const where = keyword ? [
<span class="hljs-addition">+     { title: Like(`%${keyword}%`) }</span>
    ] : {};
<span class="hljs-addition">+   return this.repository.find({ where, relations: ['categories', 'tags'] });</span>
  }

  async findAllWithPagination(page: number, limit: number, keyword?: string) {
    const where = keyword ? [
<span class="hljs-addition">+     { title: Like(`%${keyword}%`) }</span>
    ] : {};
    const [articles, total] = await this.repository.findAndCount({
      where,
<span class="hljs-addition">+     relations: ['categories', 'tags'],</span>
      skip: (page - 1) * limit,
      take: limit
    });
    return { articles, total };
  }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+ async create(createArticleDto: CreateArticleDto) {</span>
<span class="hljs-addition">+   const { categoryIds = [], tagIds = [], ...articleData } = createArticleDto;</span>
<span class="hljs-addition">+   const article = this.repository.create(articleData);</span>
<span class="hljs-addition">+   article.categories = await this.categoryRepository.findBy({ id: In(categoryIds) });</span>
<span class="hljs-addition">+   article.tags = await this.tagRepository.findBy({ id: In(tagIds) });</span>
<span class="hljs-addition">+   return await this.repository.save(article);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+ async update(id: number, updateArticleDto: UpdateArticleDto) {</span>
<span class="hljs-addition">+   const { categoryIds, tagIds, ...articleData } = updateArticleDto;</span>
<span class="hljs-addition">+   const article = await this.repository.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+   if (!article) throw new NotFoundException('Article not found');</span>
<span class="hljs-addition">+   Object.assign(article, articleData);</span>
<span class="hljs-addition">+   if (categoryIds) {</span>
<span class="hljs-addition">+     article.categories = await this.categoryRepository.findBy({ id: In(categoryIds) });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   if (tagIds) {</span>
<span class="hljs-addition">+     article.tags = await this.tagRepository.findBy({ id: In(tagIds) });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   await this.repository.save(article);</span>
<span class="hljs-addition">+   return UpdateResult.from({ raw: [], affected: 1, records: [] });</span>
<span class="hljs-addition">+ }</span>
}

</code></pre>
<h3 id="t81.8. article.controller.ts">1.8. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t81.8.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { Controller, Get, Render, Post, Redirect, Body, UseFilters, HttpException, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException } from '@nestjs/common';</span>
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';
<span class="hljs-addition">+import { CategoryService } from 'src/shared/services/category.service';</span>
<span class="hljs-addition">+import { TagService } from 'src/shared/services/tag.service';</span>

@UseFilters(AdminExceptionFilter)
@Controller('admin/articles')
export class ArticleController {
    constructor(
<span class="hljs-addition">+       private readonly articleService: ArticleService,</span>
<span class="hljs-addition">+       private readonly categoryService: CategoryService,</span>
<span class="hljs-addition">+       private readonly tagService: TagService,</span>
    ) { }

    @Get()
    @Render('article/article-list')
    async findAll(@Query('keyword') keyword: string = '',
        @Query('page', new ParseOptionalIntPipe(1)) page: number,
        @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {
        const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);
        const pageCount = Math.ceil(total / limit);
        return { articles, keyword, page, limit, pageCount };
    }

    @Get('create')
    @Render('article/article-form')
<span class="hljs-addition">+   async createForm() {</span>
<span class="hljs-addition">+       const categoryTree = await this.categoryService.findAll();</span>
<span class="hljs-addition">+       const tags = await this.tagService.findAll();</span>
<span class="hljs-addition">+       return { article: { categories: [], tags: [] }, categoryTree, tags };</span>
    }

    @Post()
    @Redirect('/admin/articles')
    async create(@Body() createArticleDto: CreateArticleDto) {
        await this.articleService.create(createArticleDto);
        return { success: true }
    }

    @Get(':id/edit')
    @Render('article/article-form')
    async editForm(@Param('id', ParseIntPipe) id: number) {
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations:['categories', 'tags']  });</span>
<span class="hljs-addition">+       if (!article) throw new NotFoundException('Article not Found');</span>
<span class="hljs-addition">+       const categoryTree = await this.categoryService.findAll();</span>
<span class="hljs-addition">+       const tags = await this.tagService.findAll();</span>
<span class="hljs-addition">+       return { article, categoryTree, tags };</span>
    }

    @Put(':id')
    async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {
        await this.articleService.update(id, updateArticleDto);
        if (accept <span class="hljs-comment">=== 'application/json') {</span>
            return { success: true };
        } else {
            return res.redirect(`/admin/articles`);
        }
    }

    @Delete(":id")
    async delete(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.delete(id);
        return { success: true }
    }

    @Get(':id')
    @Render('article/article-detail')
    async findOne(@Param('id', ParseIntPipe) id: number) {
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations:['categories', 'tags'] });</span>
<span class="hljs-addition">+       if (!article) throw new NotFoundException('Article not Found');</span>
        return { article };
    }
}
</code></pre>
<h3 id="t91.9. article-form.hbs">1.9. article-form.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t91.9.%20article-form.hbs"> # </a></h3>
<p>views/article/article-form.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;{{#if article.id}}编辑文章{{else}}添加文章{{/if}}&lt;/h1&gt;
<span class="hljs-addition">+&lt;form action="/admin/articles{{#if article.id}}/{{article.id}}{{/if}}" method="POST"&gt;</span>
    {{#if article.id}}&lt;input type="hidden" name="_method" value="PUT"&gt;{{/if}}
<span class="hljs-addition">+   &lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+       &lt;label for="title" class="form-label"&gt;标题&lt;/label&gt;</span>
<span class="hljs-addition">+       &lt;input type="text" class="form-control" id="title" name="title" value="{{article.title}}"&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+       &lt;label for="content" class="form-label"&gt;内容&lt;/label&gt;</span>
<span class="hljs-addition">+       &lt;textarea class="form-control" id="content" name="content" rows="10"&gt;{{article.content}}&lt;/textarea&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+       &lt;label class="form-label"&gt;分类&lt;/label&gt;</span>
<span class="hljs-addition">+       &lt;div id="categoryTree" class="border rounded p-3"&gt;&lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+       &lt;label for="tags" class="form-label"&gt;标签&lt;/label&gt;</span>
<span class="hljs-addition">+       &lt;div class="d-flex flex-wrap"&gt;</span>
<span class="hljs-addition">+           {{#each tags}}</span>
<span class="hljs-addition">+           &lt;div class="form-check me-3 mb-2"&gt;</span>
<span class="hljs-addition">+               &lt;input class="form-check-input" type="checkbox" name="tagIds" value="{{this.id}}" {{#if (contains</span>
<span class="hljs-addition">+                   (mapToIds ../article.tags) this.id )}}checked{{/if}}&gt;</span>
<span class="hljs-addition">+               &lt;label class="form-check-label"&gt;{{this.name}}&lt;/label&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+           {{/each}}</span>
        &lt;/div&gt;
    &lt;/div&gt;
<span class="hljs-addition">+   &lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+       &lt;label for="status" class="form-label"&gt;状态&lt;/label&gt;</span>
<span class="hljs-addition">+       &lt;select class="form-control" id="status" name="status"&gt;</span>
<span class="hljs-addition">+           &lt;option value="1" {{#if article.status}}selected{{/if}}&gt;激活&lt;/option&gt;</span>
<span class="hljs-addition">+           &lt;option value="0" {{#unless article.status}}selected{{/unless}}&gt;未激活&lt;/option&gt;</span>
<span class="hljs-addition">+       &lt;/select&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;button type="submit" class="btn btn-primary"&gt;保存&lt;/button&gt;</span>
<span class="hljs-addition">+&lt;/form&gt;</span>
<span class="hljs-addition">+&lt;script&gt;</span>
<span class="hljs-addition">+   const categoryTree = {{{ json categoryTree }}};</span>
<span class="hljs-addition">+   const selectedCategoryIds = {{{ mapToIds article.categories }}};</span>
<span class="hljs-addition">+   function renderCategoryTree(categoryes) {</span>
<span class="hljs-addition">+       let html = '&lt;ul class="list-unstyled"&gt;';</span>
<span class="hljs-addition">+       categoryes.forEach(function (category) {</span>
<span class="hljs-addition">+           html += `</span>
<span class="hljs-addition">+           &lt;li class="mb-2"&gt;</span>
<span class="hljs-addition">+               &lt;div class="d-flex align-items-center"&gt;</span>
<span class="hljs-addition">+                   ${category.children?.length &gt; 0 ? '&lt;span class="toggle me-2 cursor-pointer"&gt;&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;&lt;/span&gt;' : '&lt;span class="me-4"&gt;&lt;/span&gt;'}</span>
<span class="hljs-addition">+                   &lt;label class="form-check-label"&gt;</span>
<span class="hljs-addition">+                       &lt;input type="checkbox" class="form-check-input" name="categoryIds" value="${category.id}" ${selectedCategoryIds.includes(category.id) ? 'checked' : ''}&gt;</span>
<span class="hljs-addition">+                       ${category.name}</span>
<span class="hljs-addition">+                   &lt;/label&gt;</span>
<span class="hljs-addition">+               &lt;/div&gt;</span>
<span class="hljs-addition">+               ${category.children?.length &gt; 0 ? `&lt;div class="children ms-4" &gt;${renderCategoryTree(category.children)}&lt;/div&gt;` : ''}</span>
<span class="hljs-addition">+           &lt;/li&gt;`;</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+       html += '&lt;/ul&gt;';</span>
<span class="hljs-addition">+       return html;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   $(function () {</span>
<span class="hljs-addition">+       $('#categoryTree').html(renderCategoryTree(categoryTree));</span>
<span class="hljs-addition">+       $('body').on('click', '.toggle', function () {</span>
<span class="hljs-addition">+           const childrenContainer = $(this).parent().siblings('.children');</span>
<span class="hljs-addition">+           if (childrenContainer.is(':visible')) {</span>
<span class="hljs-addition">+               childrenContainer.hide();</span>
<span class="hljs-addition">+               $(this).html('&lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt;');</span>
<span class="hljs-addition">+           } else {</span>
<span class="hljs-addition">+               childrenContainer.show();</span>
<span class="hljs-addition">+               $(this).html('&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;');</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+&lt;/script&gt;</span>
</code></pre>
<h3 id="t101.10. article-list.hbs">1.10. article-list.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t101.10.%20article-list.hbs"> # </a></h3>
<p>views/article/article-list.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
  文章列表
&lt;/h1&gt;
&lt;a href="/admin/articles/create" class="btn btn-success mb-3"&gt;添加文章&lt;/a&gt;
&lt;form method="GET" action="/admin/articles" class="mb-3"&gt;
  &lt;div class="input-group"&gt;
    &lt;input type="text" name="keyword" class="form-control" placeholder="请输入搜索关键字" value="{{keyword}}"&gt;
    &lt;button class="btn btn-outline-secondary"&gt;搜索&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;
&lt;table class="table"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
<span class="hljs-addition">+     &lt;th&gt;标题&lt;/th&gt;</span>
<span class="hljs-addition">+     &lt;th&gt;分类&lt;/th&gt;</span>
<span class="hljs-addition">+     &lt;th&gt;标签&lt;/th&gt;</span>
      &lt;td&gt;状态&lt;/td&gt;
      &lt;td&gt;排序&lt;/td&gt;
      &lt;td&gt;操作&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    {{#each articles}}
<span class="hljs-addition">+   &lt;tr&gt;</span>
<span class="hljs-addition">+     &lt;td&gt;{{this.title}}&lt;/td&gt;</span>
<span class="hljs-addition">+     &lt;td&gt;</span>
<span class="hljs-addition">+       {{#each this.categories}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/each}}</span>
<span class="hljs-addition">+     &lt;/td&gt;</span>
<span class="hljs-addition">+     &lt;td&gt;</span>
<span class="hljs-addition">+       {{#each this.tags}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/each}}</span>
<span class="hljs-addition">+     &lt;/td&gt;</span>
<span class="hljs-addition">+     &lt;td&gt;</span>
<span class="hljs-addition">+       &lt;span class="status-toggle" data-id="{{this.id}}" data-status="{{this.status}}"&gt;</span>
<span class="hljs-addition">+         {{#if this.status}}</span>
<span class="hljs-addition">+         &lt;i class="bi bi-check-circle-fill text-success"&gt;&lt;/i&gt;</span>
<span class="hljs-addition">+         {{else}}</span>
<span class="hljs-addition">+         &lt;i class="bi bi-x-circle-fill text-danger"&gt;&lt;/i&gt;</span>
<span class="hljs-addition">+         {{/if}}</span>
<span class="hljs-addition">+       &lt;/span&gt;</span>
<span class="hljs-addition">+     &lt;/td&gt;</span>
<span class="hljs-addition">+     &lt;td&gt;</span>
<span class="hljs-addition">+       &lt;span class="sort-text" data-id="{{this.id}}"&gt;{{this.sort}}&lt;/span&gt;</span>
<span class="hljs-addition">+       &lt;input type="number" class="form-control sort-input d-none" style="width:50%" data-id="{{this.id}}"</span>
<span class="hljs-addition">+         value="{{this.sort}}"&gt;</span>
<span class="hljs-addition">+     &lt;/td&gt;</span>
<span class="hljs-addition">+     &lt;td&gt;</span>
<span class="hljs-addition">+       &lt;a href="/admin/articles/{{this.id}}" class="btn btn-primary btn-sm"&gt;查看&lt;/a&gt;</span>
<span class="hljs-addition">+       &lt;a href="/admin/articles/{{this.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;</span>
<span class="hljs-addition">+       &lt;a class="btn btn-danger btn-sm" onclick="deleteArticle({{this.id}})"&gt;删除&lt;/a&gt;</span>
<span class="hljs-addition">+     &lt;/td&gt;</span>
<span class="hljs-addition">+   &lt;/tr&gt;</span>
<span class="hljs-addition">+   {{/each}}</span>
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;nav&gt;
  &lt;ul class="pagination"&gt;
    &lt;li class="page-item {{#if (eq page 1)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{dec page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;上一页&lt;/a&gt;
    &lt;/li&gt;
    {{#each (range 1 pageCount)}}
    &lt;li class="page-item {{#if (eq this ../page)}}active{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{this}}&amp;keyword={{../keyword}}&amp;limit={{../limit}}"&gt;{{this}}&lt;/a&gt;
    &lt;/li&gt;
    {{/each}}

    &lt;li class="page-item {{#if (eq page pageCount)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{inc page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;下一页&lt;/a&gt;
    &lt;/li&gt;
    &lt;li class="page-item"&gt;
      &lt;form method="GET" action="/admin/articles" class="d-inline-block ms-3"&gt;
        &lt;input type="hidden" name="keyword" value="{{keyword}}"&gt;
        &lt;input type="hidden" name="page" value="{{page}}"&gt;
        &lt;div class="input-group"&gt;
          &lt;input type="number" name="limit" class="form-control" placeholder="每页条数" value="{{limit}}" min="1"&gt;
          &lt;button class="btn btn-outline-secondary" type="submit"&gt;设置每页的条数&lt;/button&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;script&gt;
<span class="hljs-addition">+ function deleteArticle(id) {</span>
    if (confirm('确定要删除吗?')) {
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'DELETE',
        success: function (data) {
          if (data.success) {
            const params = new URLSearchParams(window.location.search);
            params.delete('page');
            params.append('page', 1)
            const query = params.toString();
            window.location = window.location.pathname + '?' + query;
          }
        }
      })
    }
  }
  $(function () {
    $('.sort-text').on('dblclick', function () {
      const $this = $(this);
      const id = $this.data('id');
      $this.addClass('d-none');
      $(`.sort-input[data-id="${id}"]`).removeClass('d-none').focus();
    });
    $('.sort-input').on('blur', function () {
      const $this = $(this);
      const id = $this.data('id');
      const newSort = $this.val();
      $this.addClass('d-none');
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ sort: newSort }),
        success: function (data) {
          if (data.success) {
            $(`.sort-text[data-id="${id}"]`).removeClass('d-none').text(newSort);
          }
        }
      })
    });
    $('.status-toggle').on('click', function () {
      const $this = $(this);
      const id = $this.data('id');
      const currentStatus = $this.data('status');
      const newStatus = currentStatus == 1 ? 0 : 1;
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function (data) {
          if (data.success) {
            $this.data('status', newStatus);
            $this.html(` &lt;i class="bi ${newStatus ? 'bi-check-circle-fill' : 'bi-x-circle-fill'} ${newStatus ? 'text-success' : 'text-danger'}"&gt;&lt;/i&gt;`);
          }
        }
      })
    });
  });
&lt;/script&gt;
</code></pre>
<h2 id="t112.富文本编辑器">2.富文本编辑器 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t112.%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8"> # </a></h2>
<h3 id="t122.1. main.hbs">2.1. main.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t122.1.%20main.hbs"> # </a></h3>
<p>views/layouts/main.hbs</p>
<pre><code class="lang-diff">&lt;!doctype html&gt;
&lt;html lang="en"&gt;
<span class="hljs-addition">+</span>
<span class="hljs-addition">+&lt;head&gt;</span>
<span class="hljs-addition">+ &lt;meta charset="utf-8"&gt;</span>
<span class="hljs-addition">+ &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</span>
<span class="hljs-addition">+ &lt;title&gt;CMS&lt;/title&gt;</span>
<span class="hljs-addition">+ &lt;link href="/style/bootstrap.min.css" rel="stylesheet"&gt;</span>
<span class="hljs-addition">+ &lt;link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"&gt;</span>
<span class="hljs-addition">+ &lt;link rel="stylesheet" href="/style/ckeditor5.css" /&gt;</span>
<span class="hljs-addition">+ &lt;script src="https://code.jquery.com/jquery-3.7.1.min.js"&gt;&lt;/script&gt;</span>
<span class="hljs-addition">+&lt;/head&gt;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+&lt;body&gt;</span>
<span class="hljs-addition">+ {{&gt; header }}</span>
<span class="hljs-addition">+ &lt;div class="container-fluid"&gt;</span>
<span class="hljs-addition">+   &lt;div class="row"&gt;</span>
<span class="hljs-addition">+     {{&gt; sidebar}}</span>
<span class="hljs-addition">+     &lt;div class="col-md-9 col-lg-10"&gt;</span>
<span class="hljs-addition">+       &lt;div class="container mt-4"&gt;</span>
<span class="hljs-addition">+         {{{body}}}</span>
        &lt;/div&gt;
<span class="hljs-addition">+     &lt;/div&gt;</span>
    &lt;/div&gt;
<span class="hljs-addition">+ &lt;/div&gt;</span>
<span class="hljs-addition">+ &lt;script src="/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;</span>
<span class="hljs-addition">+&lt;/body&gt;</span>
<span class="hljs-addition">+</span>
&lt;/html&gt;
</code></pre>
<h3 id="t132.2. article.controller.ts">2.2. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t132.2.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render, Post, Redirect, Body, UseFilters, HttpException, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException } from '@nestjs/common';
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';
import { CategoryService } from 'src/shared/services/category.service';
import { TagService } from 'src/shared/services/tag.service';

@UseFilters(AdminExceptionFilter)
@Controller('admin/articles')
export class ArticleController {
    constructor(
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService,
    ) { }

    @Get()
    @Render('article/article-list')
    async findAll(@Query('keyword') keyword: string = '',
        @Query('page', new ParseOptionalIntPipe(1)) page: number,
        @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {
        const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);
        const pageCount = Math.ceil(total / limit);
        return { articles, keyword, page, limit, pageCount };
    }

    @Get('create')
    @Render('article/article-form')
    async createForm() {
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article: { categories: [], tags: [] }, categoryTree, tags };
    }

    @Post()
    @Redirect('/admin/articles')
    async create(@Body() createArticleDto: CreateArticleDto) {
        await this.articleService.create(createArticleDto);
        return { success: true }
    }

    @Get(':id/edit')
    @Render('article/article-form')
    async editForm(@Param('id', ParseIntPipe) id: number) {
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
        if (!article) throw new NotFoundException('Article not Found');
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article, categoryTree, tags };
    }

    @Put(':id')
    async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {
        await this.articleService.update(id, updateArticleDto);
        if (accept <span class="hljs-comment">=== 'application/json') {</span>
            return { success: true };
        } else {
            return res.redirect(`/admin/articles`);
        }
    }

    @Delete(":id")
    async delete(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.delete(id);
        return { success: true }
    }

    @Get(':id')
    @Render('article/article-detail')
    async findOne(@Param('id', ParseIntPipe) id: number) {
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
        if (!article) throw new NotFoundException('Article not Found');
        return { article };
    }
}

</code></pre>
<h3 id="t142.3. article-form.hbs">2.3. article-form.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t142.3.%20article-form.hbs"> # </a></h3>
<p>views/article/article-form.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;{{#if article.id}}编辑文章{{else}}添加文章{{/if}}&lt;/h1&gt;
<span class="hljs-addition">+&lt;form action="/admin/articles{{#if article.id}}/{{article.id}}{{/if}}" method="POST" id="articleForm"&gt;</span>
    {{#if article.id}}&lt;input type="hidden" name="_method" value="PUT"&gt;{{/if}}
    &lt;div class="mb-3"&gt;
        &lt;label for="title" class="form-label"&gt;标题&lt;/label&gt;
        &lt;input type="text" class="form-control" id="title" name="title" value="{{article.title}}"&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="content" class="form-label"&gt;内容&lt;/label&gt;
<span class="hljs-addition">+       &lt;div id="editor"&gt;</span>
<span class="hljs-addition">+           {{{article.content}}}</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;input type="hidden" name="content" id="contentInput"&gt;</span>
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label class="form-label"&gt;分类&lt;/label&gt;
        &lt;div id="categoryTree" class="border rounded p-3"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="tags" class="form-label"&gt;标签&lt;/label&gt;
        &lt;div class="d-flex flex-wrap"&gt;
            {{#each tags}}
            &lt;div class="form-check me-3 mb-2"&gt;
                &lt;input class="form-check-input" type="checkbox" name="tagIds" value="{{this.id}}" {{#if (contains
                    (mapToIds ../article.tags) this.id )}}checked{{/if}}&gt;
                &lt;label class="form-check-label"&gt;{{this.name}}&lt;/label&gt;
            &lt;/div&gt;
            {{/each}}
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="status" class="form-label"&gt;状态&lt;/label&gt;
        &lt;select class="form-control" id="status" name="status"&gt;
            &lt;option value="1" {{#if article.status}}selected{{/if}}&gt;激活&lt;/option&gt;
            &lt;option value="0" {{#unless article.status}}selected{{/unless}}&gt;未激活&lt;/option&gt;
        &lt;/select&gt;
    &lt;/div&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;保存&lt;/button&gt;
&lt;/form&gt;
<span class="hljs-addition">+&lt;script type="importmap"&gt;</span>
<span class="hljs-addition">+   {</span>
<span class="hljs-addition">+       "imports": {</span>
<span class="hljs-addition">+           "ckeditor5": "/js/ckeditor5.js"</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+&lt;/script&gt;</span>
<span class="hljs-addition">+&lt;script type="module"&gt;</span>
<span class="hljs-addition">+   import {</span>
<span class="hljs-addition">+       ClassicEditor,</span>
<span class="hljs-addition">+       Essentials,</span>
<span class="hljs-addition">+       Bold,</span>
<span class="hljs-addition">+       Italic,</span>
<span class="hljs-addition">+       Font,</span>
<span class="hljs-addition">+       Paragraph,</span>
<span class="hljs-addition">+       Image,</span>
<span class="hljs-addition">+       ImageToolbar,</span>
<span class="hljs-addition">+       ImageUpload,</span>
<span class="hljs-addition">+       ImageResize,</span>
<span class="hljs-addition">+       ImageStyle,</span>
<span class="hljs-addition">+       Plugin</span>
<span class="hljs-addition">+   } from 'ckeditor5';</span>
<span class="hljs-addition">+   ClassicEditor</span>
<span class="hljs-addition">+       .create(document.querySelector('#editor'), {</span>
<span class="hljs-addition">+           plugins: [</span>
<span class="hljs-addition">+               Essentials,</span>
<span class="hljs-addition">+               Bold,</span>
<span class="hljs-addition">+               Italic,</span>
<span class="hljs-addition">+               Font,</span>
<span class="hljs-addition">+               Paragraph,</span>
<span class="hljs-addition">+               Image,</span>
<span class="hljs-addition">+               ImageToolbar,</span>
<span class="hljs-addition">+               ImageStyle,</span>
<span class="hljs-addition">+               ImageResize,</span>
<span class="hljs-addition">+               ImageUpload</span>
<span class="hljs-addition">+           ],</span>
<span class="hljs-addition">+           image: {</span>
<span class="hljs-addition">+               toolbar: ['imageTextAlternative', 'imageStyle:side', 'resizeImage:50', 'resizeImage:75', 'resizeImage:original']</span>
<span class="hljs-addition">+           },</span>
<span class="hljs-addition">+           toolbar: {</span>
<span class="hljs-addition">+               items: [</span>
<span class="hljs-addition">+                   'undo', 'redo', '|', 'bold', 'italic', '|',</span>
<span class="hljs-addition">+                   'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',</span>
<span class="hljs-addition">+                   'insertImage'</span>
<span class="hljs-addition">+               ]</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       })</span>
<span class="hljs-addition">+       .then(editor =&gt; {</span>
<span class="hljs-addition">+           const form = document.getElementById('articleForm');</span>
<span class="hljs-addition">+           const contentInput = document.getElementById('contentInput');</span>
<span class="hljs-addition">+           form.addEventListener('submit', () =&gt; {</span>
<span class="hljs-addition">+               contentInput.value = editor.getData();</span>
<span class="hljs-addition">+           });</span>
<span class="hljs-addition">+       })</span>
<span class="hljs-addition">+       .catch(error =&gt; {</span>
<span class="hljs-addition">+           console.error(error.stack);</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+&lt;/script&gt;</span>
&lt;script&gt;
    const categoryTree = {{{ json categoryTree }}};
    const selectedCategoryIds = {{{ mapToIds article.categories }}};
    function renderCategoryTree(categoryes) {
        let html = '&lt;ul class="list-unstyled"&gt;';
        categoryes.forEach(function (category) {
            html += `
            &lt;li class="mb-2"&gt;
                &lt;div class="d-flex align-items-center"&gt;
                    ${category.children?.length &gt; 0 ? '&lt;span class="toggle me-2 cursor-pointer"&gt;&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;&lt;/span&gt;' : '&lt;span class="me-4"&gt;&lt;/span&gt;'}
                    &lt;label class="form-check-label"&gt;
                        &lt;input type="checkbox" class="form-check-input" name="categoryIds" value="${category.id}" ${selectedCategoryIds.includes(category.id) ? 'checked' : ''}&gt;
                        ${category.name}
                    &lt;/label&gt;
                &lt;/div&gt;
                ${category.children?.length &gt; 0 ? `&lt;div class="children ms-4" &gt;${renderCategoryTree(category.children)}&lt;/div&gt;` : ''}
            &lt;/li&gt;`;
        });
        html += '&lt;/ul&gt;';
        return html;
    }
    $(function () {
        $('#categoryTree').html(renderCategoryTree(categoryTree));
        $('body').on('click', '.toggle', function () {
            const childrenContainer = $(this).parent().siblings('.children');
            if (childrenContainer.is(':visible')) {
                childrenContainer.hide();
                $(this).html('&lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt;');
            } else {
                childrenContainer.show();
                $(this).html('&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;');
            }
        });
    });
&lt;/script&gt;
</code></pre>
<h2 id="t153.文件上传">3.文件上传 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t153.%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"> # </a></h2>
<pre><code class="lang-js">npm i @nestjs/serve-<span class="hljs-keyword">static</span>
npm i @types/multer --save-dev
<span class="hljs-string">`
</span></code></pre>
<h3 id="t163.1. global.d.ts">3.1. global.d.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t163.1.%20global.d.ts"> # </a></h3>
<p>src/global.d.ts</p>
<pre><code class="lang-js">declare namespace Express {
    interface Multer {
        <span class="hljs-attr">File</span>: Express.Multer.File;
    }
}

</code></pre>
<h3 id="t173.2. admin.module.ts">3.2. admin.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t173.2.%20admin.module.ts"> # </a></h3>
<p>src/admin/admin.module.ts</p>
<pre><code class="lang-diff">import { Module } from '@nestjs/common';
import { DashboardController } from './controllers/dashboard.controller';
import { UserController } from './controllers/user.controller';
import { RoleController } from "./controllers/role.controller";
import { AccessController } from "./controllers/access.controller";
import { TagController } from "./controllers/tag.controller";
import { ArticleController } from "./controllers/article.controller";
import { CategoryController } from "./controllers/category.controller";
<span class="hljs-addition">+import { UploadController } from './controllers/upload.controller';</span>
@Module({
<span class="hljs-addition">+   controllers: [DashboardController, UserController, RoleController, AccessController, TagController, ArticleController, CategoryController, UploadController]</span>
})
export class AdminModule {
}

</code></pre>
<h3 id="t183.3. article-detail.hbs">3.3. article-detail.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t183.3.%20article-detail.hbs"> # </a></h3>
<p>views/article/article-detail.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
    文章详情
&lt;/h1&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;标题:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;{{article.title}}&lt;/p&gt;
&lt;/div&gt;
<span class="hljs-addition">+&lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+   &lt;label class="form-label"&gt;内容:&lt;/label&gt;</span>
<span class="hljs-addition">+   &lt;div class="form-control-plaintext"&gt;</span>
<span class="hljs-addition">+       {{{article.content}}}</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;分类:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#each article.categories}}
        &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
    &lt;/p&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;标签:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#each article.tags}}
        &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
    &lt;/p&gt;
&lt;/div&gt;
&lt;a href="/admin/articles/{{article.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;
&lt;a href="/admin/articles" class="btn btn-secondary btn-sm"&gt;返回列表&lt;/a&gt;
</code></pre>
<h3 id="t193.4. upload.controller.ts">3.4. upload.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t193.4.%20upload.controller.ts"> # </a></h3>
<p>src/admin/controllers/upload.controller.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Controller, Get, Post, Query, UploadedFile, UseInterceptors } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { FileInterceptor } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { diskStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'multer'</span>;
<span class="hljs-keyword">import</span> { v4 <span class="hljs-keyword">as</span> uuidv4 } <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
@Controller(<span class="hljs-string">'admin'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UploadController</span> </span>{
    @Post(<span class="hljs-string">'upload'</span>)
    @UseInterceptors(FileInterceptor(<span class="hljs-string">'upload'</span>, {
        <span class="hljs-attr">storage</span>: diskStorage({
            <span class="hljs-attr">destination</span>: <span class="hljs-string">'./uploads'</span>,
            <span class="hljs-attr">filename</span>: <span class="hljs-function">(<span class="hljs-params">_req, file, callback</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> filename: string = uuidv4() + path.extname(file.originalname);
                callback(<span class="hljs-literal">null</span>, filename);
            }
        }),
        <span class="hljs-attr">fileFilter</span>: <span class="hljs-function">(<span class="hljs-params">req, file, callback</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!file.mimetype.match(<span class="hljs-regexp">/\/(jpg|jpeg|png|gif)$/</span>)) {
                <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Unsupported file type'</span>), <span class="hljs-literal">false</span>);
            }
            callback(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
        }
    }))
    <span class="hljs-keyword">async</span> uploadFile(@UploadedFile() file: Express.Multer.File) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">url</span>: <span class="hljs-string">`/uploads/<span class="hljs-subst">${file.filename}</span>`</span> };
    }
}

</code></pre>
<h3 id="t203.5. app.module.ts">3.5. app.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t203.5.%20app.module.ts"> # </a></h3>
<p>src/app.module.ts</p>
<pre><code class="lang-diff">import { MiddlewareConsumer, Module, NestModule } from '@nestjs/common';
import { AdminModule } from './admin/admin.module';
import { ApiModule } from './api/api.module';
import { SharedModule } from './shared/shared.module';
<span class="hljs-addition">+import { AcceptLanguageResolver, QueryResolver, I18nModule, } from 'nestjs-i18n';</span>
import * as  path from 'path';
import methodOverride from 'src/shared/middlewares/method-override'
<span class="hljs-addition">+import { ServeStaticModule } from '@nestjs/serve-static';</span>
@Module({
  imports: [
<span class="hljs-addition">+   ServeStaticModule.forRoot({</span>
<span class="hljs-addition">+     rootPath: path.join(__dirname, '..', 'uploads'),</span>
<span class="hljs-addition">+     serveRoot: '/uploads',</span>
<span class="hljs-addition">+   }),</span>
    I18nModule.forRoot({
<span class="hljs-addition">+     fallbackLanguage: 'en',</span>
<span class="hljs-addition">+     loaderOptions: {</span>
<span class="hljs-addition">+       path: path.join(__dirname, '/i18n/'),</span>
<span class="hljs-addition">+       watch: true</span>
      },
      resolvers: [
<span class="hljs-addition">+       new QueryResolver(["lang", "l"]),</span>
        AcceptLanguageResolver,
      ]
    }),
    SharedModule,
<span class="hljs-addition">+   AdminModule,</span>
    ApiModule
  ],
  controllers: [],
  providers: [],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(methodOverride).forRoutes('*');
  }
<span class="hljs-addition">+</span>
}

</code></pre>
<h3 id="t213.6. article-form.hbs">3.6. article-form.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t213.6.%20article-form.hbs"> # </a></h3>
<p>views/article/article-form.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;{{#if article.id}}编辑文章{{else}}添加文章{{/if}}&lt;/h1&gt;
&lt;form action="/admin/articles{{#if article.id}}/{{article.id}}{{/if}}" method="POST" id="articleForm"&gt;
    {{#if article.id}}&lt;input type="hidden" name="_method" value="PUT"&gt;{{/if}}
    &lt;div class="mb-3"&gt;
        &lt;label for="title" class="form-label"&gt;标题&lt;/label&gt;
        &lt;input type="text" class="form-control" id="title" name="title" value="{{article.title}}"&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="content" class="form-label"&gt;内容&lt;/label&gt;
        &lt;div id="editor"&gt;
            {{{article.content}}}
        &lt;/div&gt;
        &lt;input type="hidden" name="content" id="contentInput"&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label class="form-label"&gt;分类&lt;/label&gt;
        &lt;div id="categoryTree" class="border rounded p-3"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="tags" class="form-label"&gt;标签&lt;/label&gt;
        &lt;div class="d-flex flex-wrap"&gt;
            {{#each tags}}
            &lt;div class="form-check me-3 mb-2"&gt;
                &lt;input class="form-check-input" type="checkbox" name="tagIds" value="{{this.id}}" {{#if (contains
                    (mapToIds ../article.tags) this.id )}}checked{{/if}}&gt;
                &lt;label class="form-check-label"&gt;{{this.name}}&lt;/label&gt;
            &lt;/div&gt;
            {{/each}}
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="status" class="form-label"&gt;状态&lt;/label&gt;
        &lt;select class="form-control" id="status" name="status"&gt;
            &lt;option value="1" {{#if article.status}}selected{{/if}}&gt;激活&lt;/option&gt;
            &lt;option value="0" {{#unless article.status}}selected{{/unless}}&gt;未激活&lt;/option&gt;
        &lt;/select&gt;
    &lt;/div&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;保存&lt;/button&gt;
&lt;/form&gt;
&lt;script type="importmap"&gt;
    {
        "imports": {
            "ckeditor5": "/js/ckeditor5.js"
        }
    }
&lt;/script&gt;
&lt;script type="module"&gt;
    import {
        ClassicEditor,
        Essentials,
        Bold,
        Italic,
        Font,
        Paragraph,
        Image,
        ImageToolbar,
        ImageUpload,
        ImageResize,
        ImageStyle,
<span class="hljs-addition">+       Plugin,</span>
<span class="hljs-addition">+       SimpleUploadAdapter</span>
    } from 'ckeditor5';
    ClassicEditor
        .create(document.querySelector('#editor'), {
            plugins: [
                Essentials,
                Bold,
                Italic,
                Font,
                Paragraph,
                Image,
                ImageToolbar,
                ImageStyle,
                ImageResize,
<span class="hljs-addition">+               ImageUpload,</span>
<span class="hljs-addition">+               SimpleUploadAdapter</span>
            ],
            image: {
                toolbar: ['imageTextAlternative', 'imageStyle:side', 'resizeImage:50', 'resizeImage:75', 'resizeImage:original']
            },
            toolbar: {
                items: [
                    'undo', 'redo', '|', 'bold', 'italic', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                    'insertImage'
                ]
<span class="hljs-addition">+           },</span>
<span class="hljs-addition">+           simpleUpload: {</span>
<span class="hljs-addition">+               uploadUrl: '/admin/upload',</span>
<span class="hljs-addition">+               withCredentials: true,</span>
<span class="hljs-addition">+               headers: {</span>
<span class="hljs-addition">+                   Authorization: 'Bearer &lt;JSON Web Token&gt;'</span>
<span class="hljs-addition">+               }</span>
            }
        })
        .then(editor =&gt; {
            const form = document.getElementById('articleForm');
            const contentInput = document.getElementById('contentInput');
            form.addEventListener('submit', () =&gt; {
                contentInput.value = editor.getData();
            });
        })
        .catch(error =&gt; {
            console.error(error.stack);
        });
&lt;/script&gt;
&lt;script&gt;
    const categoryTree = {{{ json categoryTree }}};
    const selectedCategoryIds = {{{ mapToIds article.categories }}};
    function renderCategoryTree(categoryes) {
        let html = '&lt;ul class="list-unstyled"&gt;';
        categoryes.forEach(function (category) {
            html += `
            &lt;li class="mb-2"&gt;
                &lt;div class="d-flex align-items-center"&gt;
                    ${category.children?.length &gt; 0 ? '&lt;span class="toggle me-2 cursor-pointer"&gt;&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;&lt;/span&gt;' : '&lt;span class="me-4"&gt;&lt;/span&gt;'}
                    &lt;label class="form-check-label"&gt;
                        &lt;input type="checkbox" class="form-check-input" name="categoryIds" value="${category.id}" ${selectedCategoryIds.includes(category.id) ? 'checked' : ''}&gt;
                        ${category.name}
                    &lt;/label&gt;
                &lt;/div&gt;
                ${category.children?.length &gt; 0 ? `&lt;div class="children ms-4" &gt;${renderCategoryTree(category.children)}&lt;/div&gt;` : ''}
            &lt;/li&gt;`;
        });
        html += '&lt;/ul&gt;';
        return html;
    }
    $(function () {
        $('#categoryTree').html(renderCategoryTree(categoryTree));
        $('body').on('click', '.toggle', function () {
            const childrenContainer = $(this).parent().siblings('.children');
            if (childrenContainer.is(':visible')) {
                childrenContainer.hide();
                $(this).html('&lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt;');
            } else {
                childrenContainer.show();
                $(this).html('&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;');
            }
        });
    });
&lt;/script&gt;
</code></pre>
<h2 id="t224.图片压缩">4.图片压缩 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t224.%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9"> # </a></h2>
<h3 id="t234.1. upload.controller.ts">4.1. upload.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t234.1.%20upload.controller.ts"> # </a></h3>
<p>src/admin/controllers/upload.controller.ts</p>
<pre><code class="lang-diff">// 导入必要的装饰器和模块
import { Controller, Get, Post, Query, UploadedFile, UseInterceptors } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { diskStorage } from 'multer';
import { v4 as uuidv4 } from 'uuid';
import * as path from 'path';
import * as sharp from 'sharp';
import * as fs from 'fs';
// 定义一个控制器，控制器的路径前缀为 'admin'
@Controller('admin')
export class UploadController {
    // 定义一个 POST 路由，路径为 'upload'
    @Post('upload')
    // 使用 FileInterceptor 拦截器来处理文件上传
    @UseInterceptors(FileInterceptor('upload', {
        // 设置文件存储的配置
        storage: diskStorage({
            // 指定上传文件的存储目录为 './uploads'
            destination: './uploads',
            // 自定义文件命名方式，使用 UUID 生成唯一文件名，并保留原始文件扩展名
            filename: (_req, file, callback) =&gt; {
                const filename: string = uuidv4() + path.extname(file.originalname);
                callback(null, filename);
            }
        }),
        // 文件过滤器，限制只接受特定的图片类型（jpg, jpeg, png, gif）
        fileFilter: (req, file, callback) =&gt; {
            if (!file.mimetype.match(/\/(jpg|jpeg|png|gif)$/)) {
                return callback(new Error('Unsupported file type'), false);
            }
            callback(null, true);
        }
    }))
    // 定义上传文件处理逻辑
    async uploadFile(@UploadedFile() file: Express.Multer.File) {
<span class="hljs-addition">+       // 生成压缩后的文件名，扩展名为 .min.jpeg</span>
<span class="hljs-addition">+       const filename = `${path.basename(file.filename, path.extname(file.filename))}.min.jpeg`;</span>
<span class="hljs-addition">+       // 设置压缩后的文件路径</span>
<span class="hljs-addition">+       const outputFilePath = `./uploads/${filename}`;</span>
<span class="hljs-addition">+       // 使用 sharp 库处理图像，进行缩放、转换格式和压缩质量设置</span>
<span class="hljs-addition">+       await sharp(file.path)</span>
<span class="hljs-addition">+           .resize(800, 600, {</span>
<span class="hljs-addition">+               fit: sharp.fit.inside, // 使用 inside 适应方式缩放图像</span>
<span class="hljs-addition">+               withoutEnlargement: true // 防止图像被放大</span>
<span class="hljs-addition">+           })</span>
<span class="hljs-addition">+           .toFormat('jpeg') // 转换图像格式为 jpeg</span>
<span class="hljs-addition">+           .jpeg({ quality: 80 }) // 设置图像压缩质量为 80%</span>
<span class="hljs-addition">+           .toFile(outputFilePath); // 输出处理后的图像到指定路径</span>
<span class="hljs-addition">+       // 删除原始上传的文件</span>
<span class="hljs-addition">+       fs.unlinkSync(file.path);</span>
<span class="hljs-addition">+       // 返回包含压缩后图像的 URL 的对象</span>
<span class="hljs-addition">+       return { url: `/uploads/${filename}` };</span>
    }
}

</code></pre>
<h2 id="t245.上传至COS">5.上传至COS <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t245.%E4%B8%8A%E4%BC%A0%E8%87%B3COS"> # </a></h2>
<ul>
<li><a href="https://console.cloud.tencent.com/cos">COS</a></li>
</ul>
<pre><code class="lang-js">npm install cos-nodejs-sdk-v5
</code></pre>
<h3 id="t255.1. cos.service.ts">5.1. cos.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t255.1.%20cos.service.ts"> # </a></h3>
<p>src/shared/services/cos.service.ts</p>
<pre><code class="lang-js"><span class="hljs-comment">// 导入 Injectable 装饰器，用于标记一个服务类</span>
<span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-comment">// 导入 ConfigService，用于获取配置文件中的配置信息</span>
<span class="hljs-keyword">import</span> { ConfigService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-comment">// 导入 COS SDK</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> COS <span class="hljs-keyword">from</span> <span class="hljs-string">'cos-nodejs-sdk-v5'</span>;
<span class="hljs-comment">// 使用 Injectable 装饰器将 CosService 标记为可注入的服务</span>
@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CosService</span> </span>{
    <span class="hljs-comment">// 定义一个私有变量，用于存储 COS 实例</span>
    private cos: COS;
    <span class="hljs-comment">// 构造函数，注入 ConfigService 以获取配置信息</span>
    <span class="hljs-keyword">constructor</span>(private readonly configService: ConfigService) {
        <span class="hljs-comment">// 初始化 COS 实例，使用配置服务中的 SecretId 和 SecretKey</span>
        <span class="hljs-keyword">this</span>.cos = <span class="hljs-keyword">new</span> COS({
            <span class="hljs-attr">SecretId</span>: <span class="hljs-keyword">this</span>.configService.get(<span class="hljs-string">'COS_SECRET_ID'</span>),
            <span class="hljs-attr">SecretKey</span>: <span class="hljs-keyword">this</span>.configService.get(<span class="hljs-string">'COS_SECRET_KEY'</span>),
        });
    }
    <span class="hljs-comment">// 获取签名认证信息的方法，默认过期时间为 60 秒</span>
    getAuth(key, expirationTime = <span class="hljs-number">60</span>) {
        <span class="hljs-comment">// 从配置服务中获取 COS 存储桶名称和区域</span>
        <span class="hljs-keyword">const</span> bucket = <span class="hljs-keyword">this</span>.configService.get(<span class="hljs-string">'COS_BUCKET'</span>);
        <span class="hljs-keyword">const</span> region = <span class="hljs-keyword">this</span>.configService.get(<span class="hljs-string">'COS_REGION'</span>);
        <span class="hljs-comment">// 获取 COS 签名，用于 PUT 请求</span>
        <span class="hljs-keyword">const</span> sign = <span class="hljs-keyword">this</span>.cos.getAuth({
            <span class="hljs-attr">Method</span>: <span class="hljs-string">'put'</span>, <span class="hljs-comment">// 请求方法为 PUT</span>
            <span class="hljs-attr">Key</span>: key, <span class="hljs-comment">// 文件的对象键（路径）</span>
            <span class="hljs-attr">Expires</span>: expirationTime, <span class="hljs-comment">// 签名的有效期</span>
            <span class="hljs-attr">Bucket</span>: bucket, <span class="hljs-comment">// 存储桶名称</span>
            <span class="hljs-attr">Region</span>: region, <span class="hljs-comment">// 存储桶所在区域</span>
        });
        <span class="hljs-comment">// 返回包含签名、键名、存储桶和区域的信息对象</span>
        <span class="hljs-keyword">return</span> {
            sign,
            <span class="hljs-attr">key</span>: key,
            bucket,
            region,
        };
    }
}

</code></pre>
<h3 id="t265.2. upload.controller.ts">5.2. upload.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t265.2.%20upload.controller.ts"> # </a></h3>
<p>src/admin/controllers/upload.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Post, Query, UploadedFile, UseInterceptors } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { diskStorage } from 'multer';
import { v4 as uuidv4 } from 'uuid';
import * as path from 'path';
import * as sharp from 'sharp';
import * as fs from 'fs';
<span class="hljs-addition">+import { CosService } from 'src/shared/services/cos.service';</span>
@Controller('admin')
export class UploadController {
<span class="hljs-addition">+   constructor(</span>
<span class="hljs-addition">+       private readonly cosService: CosService,</span>
<span class="hljs-addition">+   ) { }</span>
    @Post('upload')
    @UseInterceptors(FileInterceptor('upload', {
        storage: diskStorage({
            destination: './uploads',
            filename: (_req, file, callback) =&gt; {
                const filename: string = uuidv4() + path.extname(file.originalname);
                callback(null, filename);
            }
        }),
        fileFilter: (req, file, callback) =&gt; {
            if (!file.mimetype.match(/\/(jpg|jpeg|png|gif)$/)) {
                return callback(new Error('Unsupported file type'), false);
            }
            callback(null, true);
        }
    }))
    async uploadFile(@UploadedFile() file: Express.Multer.File) {
        const filename = `${path.basename(file.filename, path.extname(file.filename))}.min.jpeg`;
        const outputFilePath = `./uploads/${filename}`;
        await sharp(file.path)
            .resize(800, 600, {
                fit: sharp.fit.inside,
                withoutEnlargement: true
            })
            .toFormat('jpeg')
            .jpeg({ quality: 80 })
            .toFile(outputFilePath);
        fs.unlinkSync(file.path);
        return { url: `/uploads/${filename}` };
    }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Get('cos-signature')</span>
<span class="hljs-addition">+   async getCosSignature(@Query('key') key: string) {</span>
<span class="hljs-addition">+       return this.cosService.getAuth(key, 60);</span>
<span class="hljs-addition">+   }</span>
}

</code></pre>
<h3 id="t275.3. shared.module.ts">5.3. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t275.3.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
<span class="hljs-addition">+import { CosService } from './services/cos.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t285.4. article-form.hbs">5.4. article-form.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t285.4.%20article-form.hbs"> # </a></h3>
<p>views/article/article-form.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;{{#if article.id}}编辑文章{{else}}添加文章{{/if}}&lt;/h1&gt;
&lt;form action="/admin/articles{{#if article.id}}/{{article.id}}{{/if}}" method="POST" id="articleForm"&gt;
    {{#if article.id}}&lt;input type="hidden" name="_method" value="PUT"&gt;{{/if}}
    &lt;div class="mb-3"&gt;
        &lt;label for="title" class="form-label"&gt;标题&lt;/label&gt;
        &lt;input type="text" class="form-control" id="title" name="title" value="{{article.title}}"&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="content" class="form-label"&gt;内容&lt;/label&gt;
        &lt;div id="editor"&gt;
            {{{article.content}}}
        &lt;/div&gt;
        &lt;input type="hidden" name="content" id="contentInput"&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label class="form-label"&gt;分类&lt;/label&gt;
        &lt;div id="categoryTree" class="border rounded p-3"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="tags" class="form-label"&gt;标签&lt;/label&gt;
        &lt;div class="d-flex flex-wrap"&gt;
            {{#each tags}}
            &lt;div class="form-check me-3 mb-2"&gt;
                &lt;input class="form-check-input" type="checkbox" name="tagIds" value="{{this.id}}" {{#if (contains
                    (mapToIds ../article.tags) this.id )}}checked{{/if}}&gt;
                &lt;label class="form-check-label"&gt;{{this.name}}&lt;/label&gt;
            &lt;/div&gt;
            {{/each}}
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="status" class="form-label"&gt;状态&lt;/label&gt;
        &lt;select class="form-control" id="status" name="status"&gt;
            &lt;option value="1" {{#if article.status}}selected{{/if}}&gt;激活&lt;/option&gt;
            &lt;option value="0" {{#unless article.status}}selected{{/unless}}&gt;未激活&lt;/option&gt;
        &lt;/select&gt;
    &lt;/div&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;保存&lt;/button&gt;
&lt;/form&gt;
&lt;script type="importmap"&gt;
    {
        "imports": {
            "ckeditor5": "/js/ckeditor5.js"
        }
    }
&lt;/script&gt;
&lt;script type="module"&gt;
    import {
        ClassicEditor,
        Essentials,
        Bold,
        Italic,
        Font,
        Paragraph,
        Image,
        ImageToolbar,
        ImageUpload,
        ImageResize,
        ImageStyle,
        Plugin,
        SimpleUploadAdapter
    } from 'ckeditor5';
<span class="hljs-addition">+   // 异步函数，用于获取文件上传的签名信息</span>
<span class="hljs-addition">+   async function getSignature(key) {</span>
<span class="hljs-addition">+       // 发送请求到后台接口，获取 COS 上传的签名信息</span>
<span class="hljs-addition">+       const response = await fetch(`/admin/cos-signature?key=${encodeURIComponent(key)}`);</span>
<span class="hljs-addition">+       // 返回签名信息的 JSON 数据</span>
<span class="hljs-addition">+       return response.json();</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   // 自定义的 COS 上传适配器类，用于将文件上传到腾讯云 COS</span>
<span class="hljs-addition">+   class COSUploadAdapter {</span>
<span class="hljs-addition">+       // 构造函数，接收一个文件加载器实例</span>
<span class="hljs-addition">+       constructor(loader) {</span>
<span class="hljs-addition">+           this.loader = loader;</span>
<span class="hljs-addition">+       }</span>

<span class="hljs-addition">+       // 上传方法，负责将文件上传到 COS</span>
<span class="hljs-addition">+       async upload() {</span>
<span class="hljs-addition">+           // 等待加载器获取要上传的文件</span>
<span class="hljs-addition">+           const file = await this.loader.file;</span>
<span class="hljs-addition">+           // 获取文件的上传签名信息</span>
<span class="hljs-addition">+           const signature = await getSignature(file.name);</span>
<span class="hljs-addition">+           // 从签名信息中解构出存储桶、区域、文件键名和签名</span>
<span class="hljs-addition">+           const { bucket, region, key, sign } = signature;</span>
<span class="hljs-addition">+           // 构造文件上传的 URL</span>
<span class="hljs-addition">+           const url = `https://${signature.bucket}.cos.${signature.region}.myqcloud.com/${signature.key}`;</span>
<span class="hljs-addition">+           // 发送 PUT 请求，将文件上传到 COS</span>
<span class="hljs-addition">+           return fetch(url, {</span>
<span class="hljs-addition">+               method: 'PUT', // 使用 PUT 方法上传文件</span>
<span class="hljs-addition">+               headers: { Authorization: sign }, // 设置请求头，包含签名信息</span>
<span class="hljs-addition">+               body: file // 请求体为文件本身</span>
<span class="hljs-addition">+           }).then(response =&gt; {</span>
<span class="hljs-addition">+               // 上传成功后，返回包含文件 URL 的对象</span>
<span class="hljs-addition">+               return { default: url };</span>
<span class="hljs-addition">+           });</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   // 插件类，用于将 COS 上传适配器集成到 CKEditor</span>
<span class="hljs-addition">+   class COSUploadAdapterPlugin extends Plugin {</span>
<span class="hljs-addition">+       // 静态方法，定义插件的依赖关系</span>
<span class="hljs-addition">+       static get requires() {</span>
<span class="hljs-addition">+           return [ImageUpload]; // 依赖 ImageUpload 插件</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       // 插件初始化方法</span>
<span class="hljs-addition">+       init() {</span>
<span class="hljs-addition">+           // 获取文件库插件，并设置创建上传适配器的函数</span>
<span class="hljs-addition">+           this.editor.plugins.get('FileRepository').createUploadAdapter = (loader) =&gt; new COSUploadAdapter(loader);</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
    ClassicEditor
        .create(document.querySelector('#editor'), {
            plugins: [
                Essentials,
                Bold,
                Italic,
                Font,
                Paragraph,
                Image,
                ImageToolbar,
                ImageStyle,
                ImageResize,
                ImageUpload,
<span class="hljs-addition">+               COSUploadAdapterPlugin</span>
            ],
            image: {
                toolbar: ['imageTextAlternative', 'imageStyle:side', 'resizeImage:50', 'resizeImage:75', 'resizeImage:original']
            },
            toolbar: {
                items: [
                    'undo', 'redo', '|', 'bold', 'italic', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                    'insertImage'
                ]
            },
            simpleUpload: {
                uploadUrl: '/admin/upload',
                withCredentials: true,
                headers: {
                    Authorization: 'Bearer &lt;JSON Web Token&gt;'
                }
            }
        })
        .then(editor =&gt; {
            const form = document.getElementById('articleForm');
            const contentInput = document.getElementById('contentInput');
            form.addEventListener('submit', () =&gt; {
                contentInput.value = editor.getData();
            });
        })
        .catch(error =&gt; {
            console.error(error.stack);
        });
&lt;/script&gt;
&lt;script&gt;
    const categoryTree = {{{ json categoryTree }}};
    const selectedCategoryIds = {{{ mapToIds article.categories }}};
    function renderCategoryTree(categoryes) {
        let html = '&lt;ul class="list-unstyled"&gt;';
        categoryes.forEach(function (category) {
            html += `
            &lt;li class="mb-2"&gt;
                &lt;div class="d-flex align-items-center"&gt;
                    ${category.children?.length &gt; 0 ? '&lt;span class="toggle me-2 cursor-pointer"&gt;&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;&lt;/span&gt;' : '&lt;span class="me-4"&gt;&lt;/span&gt;'}
                    &lt;label class="form-check-label"&gt;
                        &lt;input type="checkbox" class="form-check-input" name="categoryIds" value="${category.id}" ${selectedCategoryIds.includes(category.id) ? 'checked' : ''}&gt;
                        ${category.name}
                    &lt;/label&gt;
                &lt;/div&gt;
                ${category.children?.length &gt; 0 ? `&lt;div class="children ms-4" &gt;${renderCategoryTree(category.children)}&lt;/div&gt;` : ''}
            &lt;/li&gt;`;
        });
        html += '&lt;/ul&gt;';
        return html;
    }
    $(function () {
        $('#categoryTree').html(renderCategoryTree(categoryTree));
        $('body').on('click', '.toggle', function () {
            const childrenContainer = $(this).parent().siblings('.children');
            if (childrenContainer.is(':visible')) {
                childrenContainer.hide();
                $(this).html('&lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt;');
            } else {
                childrenContainer.show();
                $(this).html('&lt;i class="bi bi-folder-minus"&gt;&lt;/i&gt;');
            }
        });
    });
&lt;/script&gt;
</code></pre>
<h2 id="t296.增加审核状态">6.增加审核状态 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t296.%E5%A2%9E%E5%8A%A0%E5%AE%A1%E6%A0%B8%E7%8A%B6%E6%80%81"> # </a></h2>
<h3 id="t306.1. article.enum.ts">6.1. article.enum.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t306.1.%20article.enum.ts"> # </a></h3>
<p>src/shared/enums/article.enum.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> enum ArticleStateEnum {
    DRAFT = <span class="hljs-string">'draft'</span>,
    PENDING = <span class="hljs-string">'pending'</span>,
    PUBLISHED = <span class="hljs-string">'published'</span>,
    REJECTED = <span class="hljs-string">'rejected'</span>,
    WITHDRAWN = <span class="hljs-string">'withdrawn'</span>
}
</code></pre>
<h3 id="t316.2. article.entity.ts">6.2. article.entity.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t316.2.%20article.entity.ts"> # </a></h3>
<p>src/shared/entities/article.entity.ts</p>
<pre><code class="lang-diff">import { ApiProperty } from '@nestjs/swagger';
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, UpdateDateColumn, ManyToMany, JoinTable } from 'typeorm';
import { Category } from './category.entity';
import { Tag } from './tag.entity';
import { ArticleStateEnum } from '../enums/article.enum';
<span class="hljs-addition">+@Entity()</span>
<span class="hljs-addition">+export class Article {</span>
<span class="hljs-addition">+   @PrimaryGeneratedColumn()</span>
<span class="hljs-addition">+   @ApiProperty({ description: 'ID', example: 1 })</span>
<span class="hljs-addition">+   id: number;</span>
<span class="hljs-addition">+   @Column({ length: 50, unique: true })</span>
<span class="hljs-addition">+   @ApiProperty({ description: '标题', example: '文章标题' })</span>
<span class="hljs-addition">+   title: string;</span>
<span class="hljs-addition">+   @Column('text')</span>
<span class="hljs-addition">+   @ApiProperty({ description: '内容', example: '文章内容' })</span>
<span class="hljs-addition">+   content: string;</span>
<span class="hljs-addition">+   @ManyToMany(() =&gt; Category)</span>
<span class="hljs-addition">+   @JoinTable()</span>
<span class="hljs-addition">+   categories: Category[];</span>
<span class="hljs-addition">+   @ManyToMany(() =&gt; Tag)</span>
<span class="hljs-addition">+   @JoinTable()</span>
<span class="hljs-addition">+   tags: Tag[];</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Column({ type: 'enum', enum: ArticleStateEnum, default: 'draft' })</span>
<span class="hljs-addition">+   @ApiProperty({ description: '文章状态', example: 'draft' })</span>
<span class="hljs-addition">+   state: ArticleStateEnum;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Column({ type: 'text', nullable: true })</span>
<span class="hljs-addition">+   @ApiProperty({ description: '审核不通过原因', example: '内容不符合要求' })</span>
<span class="hljs-addition">+   rejectionReason: string;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Column({ default: 1 })</span>
<span class="hljs-addition">+   @ApiProperty({ description: '生效状态', example: 1 })</span>
<span class="hljs-addition">+   status: number;</span>
<span class="hljs-addition">+   @Column({ default: 100 })</span>
<span class="hljs-addition">+   @ApiProperty({ description: '排序号', example: 100 })</span>
<span class="hljs-addition">+   sort: number;</span>
<span class="hljs-addition">+   @CreateDateColumn()</span>
<span class="hljs-addition">+   @ApiProperty({ description: '创建时间', example: '2024年8月11日16:49:22' })</span>
<span class="hljs-addition">+   createdAt: Date;</span>
<span class="hljs-addition">+   @UpdateDateColumn()</span>
<span class="hljs-addition">+   @ApiProperty({ description: '更新时间', example: '2024年8月11日16:49:22' })</span>
<span class="hljs-addition">+   updatedAt: Date;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t326.3. article.dto.ts">6.3. article.dto.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t326.3.%20article.dto.ts"> # </a></h3>
<p>src/shared/dto/article.dto.ts</p>
<pre><code class="lang-diff">import { ApiProperty, PartialType as PartialTypeFromSwagger } from '@nestjs/swagger';
import { IsString, IsInt, MaxLength, IsOptional } from 'class-validator';
import { PartialType } from '@nestjs/mapped-types';
import { IdValidators, StatusValidators, SortValidators } from '../decorators/dto.decorator';
import { Transform } from 'class-transformer';
<span class="hljs-addition">+import { ArticleStateEnum } from '../enums/article.enum';</span>
<span class="hljs-addition">+export class CreateArticleDto {</span>
<span class="hljs-addition">+   @ApiProperty({ description: '标题', example: '文章标题' })</span>
<span class="hljs-addition">+   @IsString()</span>
<span class="hljs-addition">+   @MaxLength(50, { message: '标题不能超过50个字符' })</span>
<span class="hljs-addition">+   title: string;</span>
<span class="hljs-addition">+   @ApiProperty({ description: '内容', example: '文章内容' })</span>
<span class="hljs-addition">+   content: string;</span>
<span class="hljs-addition">+   @ApiProperty({ description: '分类ID数组', example: [1, 2] })</span>
<span class="hljs-addition">+   @Transform(({ value }) =&gt; Array.isArray(value) ? value.map(Number) : [Number(value)])</span>
<span class="hljs-addition">+   @IsInt({ each: true })</span>
<span class="hljs-addition">+   categoryIds: number[];</span>
<span class="hljs-addition">+   @ApiProperty({ description: '标签ID数组', example: [1, 2] })</span>
<span class="hljs-addition">+   @Transform(({ value }) =&gt; Array.isArray(value) ? value.map(Number) : [Number(value)])</span>
<span class="hljs-addition">+   @IsInt({ each: true })</span>
<span class="hljs-addition">+   tagIds: number[];</span>
<span class="hljs-addition">+   @StatusValidators()</span>
<span class="hljs-addition">+   @ApiProperty({ description: '状态', example: 1 })</span>
<span class="hljs-addition">+   status: number;</span>
<span class="hljs-addition">+   @SortValidators()</span>
<span class="hljs-addition">+   @ApiProperty({ description: '排序号', example: 100 })</span>
<span class="hljs-addition">+   sort: number;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ApiProperty({ description: '文章状态', example: 'draft' })</span>
<span class="hljs-addition">+   @Transform(({ value }) =&gt; ArticleStateEnum[value])</span>
<span class="hljs-addition">+   state: ArticleStateEnum;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @ApiProperty({ description: '审核不通过原因', required: false, example: '内容不符合要求' })</span>
<span class="hljs-addition">+   @IsString()</span>
<span class="hljs-addition">+   @IsOptional()</span>
<span class="hljs-addition">+   rejectionReason?: string;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+export class UpdateArticleDto extends PartialTypeFromSwagger(PartialType(CreateArticleDto)) {</span>
<span class="hljs-addition">+   @IdValidators()</span>
<span class="hljs-addition">+   id?: number;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t336.4. article-detail.hbs">6.4. article-detail.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t336.4.%20article-detail.hbs"> # </a></h3>
<p>views/article/article-detail.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
    文章详情
&lt;/h1&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;标题:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;{{article.title}}&lt;/p&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;内容:&lt;/label&gt;
    &lt;div class="form-control-plaintext"&gt;
        {{{article.content}}}
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;分类:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#each article.categories}}
        &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
    &lt;/p&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;标签:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#each article.tags}}
        &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
    &lt;/p&gt;
&lt;/div&gt;
<span class="hljs-addition">+&lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+   &lt;label class="form-label"&gt;状态:&lt;/label&gt;</span>
<span class="hljs-addition">+   &lt;p class="form-control-plaintext"&gt;</span>
<span class="hljs-addition">+       {{#if (eq article.state 'draft')}}草稿{{/if}}</span>
<span class="hljs-addition">+       {{#if (eq article.state 'pending')}}待审核{{/if}}</span>
<span class="hljs-addition">+       {{#if (eq article.state 'published')}}已发布{{/if}}</span>
<span class="hljs-addition">+       {{#if (eq article.state 'rejected')}}审核不通过{{/if}}</span>
<span class="hljs-addition">+   &lt;/p&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+{{#if (eq article.state 'rejected')}}</span>
<span class="hljs-addition">+&lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+   &lt;label class="form-label"&gt;不通过原因:&lt;/label&gt;</span>
<span class="hljs-addition">+   &lt;p class="form-control-plaintext"&gt;{{article.rejectionReason}}&lt;/p&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+{{/if}}</span>
<span class="hljs-addition">+{{#if (eq article.state 'pending')}}</span>
<span class="hljs-addition">+&lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+   &lt;button id="approveButton" class="btn btn-success"&gt;审核通过&lt;/button&gt;</span>
<span class="hljs-addition">+   &lt;button id="rejectButton" class="btn btn-danger"&gt;审核不通过&lt;/button&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+{{/if}}</span>
&lt;a href="/admin/articles/{{article.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;
&lt;a href="/admin/articles" class="btn btn-secondary btn-sm"&gt;返回列表&lt;/a&gt;
<span class="hljs-addition">+&lt;div id="rejectionReasonModal" class="modal fade" tabindex="-1"&gt;</span>
<span class="hljs-addition">+   &lt;div class="modal-dialog"&gt;</span>
<span class="hljs-addition">+       &lt;div class="modal-content"&gt;</span>
<span class="hljs-addition">+           &lt;div class="modal-header"&gt;</span>
<span class="hljs-addition">+               &lt;h5 class="modal-title"&gt;填写审核不通过原因&lt;/h5&gt;</span>
<span class="hljs-addition">+               &lt;button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"&gt;&lt;/button&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;div class="modal-body"&gt;</span>
<span class="hljs-addition">+               &lt;textarea id="rejectionReason" class="form-control" rows="3" placeholder="请输入不通过原因"&gt;&lt;/textarea&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;div class="modal-footer"&gt;</span>
<span class="hljs-addition">+               &lt;button type="button" class="btn btn-secondary" data-bs-dismiss="modal"&gt;取消&lt;/button&gt;</span>
<span class="hljs-addition">+               &lt;button id="confirmRejectionButton" type="button" class="btn btn-danger"&gt;确认不通过&lt;/button&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+&lt;script&gt;</span>
<span class="hljs-addition">+   $(function () {</span>
<span class="hljs-addition">+       $('#approveButton').on('click', function () {</span>
<span class="hljs-addition">+           if (confirm('确定要通过审核吗？')) {</span>
<span class="hljs-addition">+               $.ajax({</span>
<span class="hljs-addition">+                   url: `/admin/articles/{{article.id}}/approve`,</span>
<span class="hljs-addition">+                   type: 'PUT',</span>
<span class="hljs-addition">+                   success: function (data) {</span>
<span class="hljs-addition">+                       if (data.success) {</span>
<span class="hljs-addition">+                           alert('审核通过');</span>
<span class="hljs-addition">+                           location.reload();</span>
<span class="hljs-addition">+                       } else {</span>
<span class="hljs-addition">+                           alert('审核通过失败');</span>
<span class="hljs-addition">+                       }</span>
<span class="hljs-addition">+                   },</span>
<span class="hljs-addition">+                   error: function () {</span>
<span class="hljs-addition">+                       alert('审核通过失败');</span>
<span class="hljs-addition">+                   }</span>
<span class="hljs-addition">+               });</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       $('#rejectButton').on('click', function () {</span>
<span class="hljs-addition">+           $('#rejectionReasonModal').modal('show');</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       $('#confirmRejectionButton').on('click', function () {</span>
<span class="hljs-addition">+           const rejectionReason = $('#rejectionReason').val().trim();</span>
<span class="hljs-addition">+           if (rejectionReason === '') {</span>
<span class="hljs-addition">+               alert('请填写审核不通过的原因');</span>
<span class="hljs-addition">+               return;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           $.ajax({</span>
<span class="hljs-addition">+               url: `/admin/articles/{{article.id}}/reject`,</span>
<span class="hljs-addition">+               type: 'PUT',</span>
<span class="hljs-addition">+               contentType: 'application/json',</span>
<span class="hljs-addition">+               data: JSON.stringify({ rejectionReason: rejectionReason }),</span>
<span class="hljs-addition">+               success: function (data) {</span>
<span class="hljs-addition">+                   if (data.success) {</span>
<span class="hljs-addition">+                       alert('审核不通过');</span>
<span class="hljs-addition">+                       location.reload();</span>
<span class="hljs-addition">+                   } else {</span>
<span class="hljs-addition">+                       alert('审核不通过失败');</span>
<span class="hljs-addition">+                   }</span>
<span class="hljs-addition">+               },</span>
<span class="hljs-addition">+               error: function () {</span>
<span class="hljs-addition">+                   alert('审核不通过失败');</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+           });</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+&lt;/script&gt;</span>
</code></pre>
<h3 id="t346.5. article.controller.ts">6.5. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t346.5.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render, Post, Redirect, Body, UseFilters, HttpException, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException } from '@nestjs/common';
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
<span class="hljs-addition">+import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';</span>
<span class="hljs-addition">+import { CategoryService } from 'src/shared/services/category.service';</span>
<span class="hljs-addition">+import { TagService } from 'src/shared/services/tag.service';</span>
<span class="hljs-addition">+import { ArticleStateEnum } from 'src/shared/enums/article.enum';</span>
<span class="hljs-addition">+@UseFilters(AdminExceptionFilter)</span>
<span class="hljs-addition">+@Controller('admin/articles')</span>
<span class="hljs-addition">+export class ArticleController {</span>
<span class="hljs-addition">+   constructor(</span>
<span class="hljs-addition">+       private readonly articleService: ArticleService,</span>
<span class="hljs-addition">+       private readonly categoryService: CategoryService,</span>
<span class="hljs-addition">+       private readonly tagService: TagService,</span>
<span class="hljs-addition">+   ) { }</span>
<span class="hljs-addition">+   @Get()</span>
<span class="hljs-addition">+   @Render('article/article-list')</span>
<span class="hljs-addition">+   async findAll(@Query('keyword') keyword: string = '',</span>
<span class="hljs-addition">+       @Query('page', new ParseOptionalIntPipe(1)) page: number,</span>
<span class="hljs-addition">+       @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {</span>
<span class="hljs-addition">+       const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);</span>
<span class="hljs-addition">+       const pageCount = Math.ceil(total / limit);</span>
<span class="hljs-addition">+       return { articles, keyword, page, limit, pageCount };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   @Get('create')</span>
<span class="hljs-addition">+   @Render('article/article-form')</span>
<span class="hljs-addition">+   async createForm() {</span>
<span class="hljs-addition">+       const categoryTree = await this.categoryService.findAll();</span>
<span class="hljs-addition">+       const tags = await this.tagService.findAll();</span>
<span class="hljs-addition">+       return { article: { categories: [], tags: [] }, categoryTree, tags };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   @Post()</span>
<span class="hljs-addition">+   @Redirect('/admin/articles')</span>
<span class="hljs-addition">+   async create(@Body() createArticleDto: CreateArticleDto) {</span>
<span class="hljs-addition">+       await this.articleService.create(createArticleDto);</span>
<span class="hljs-addition">+       return { success: true }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   @Get(':id/edit')</span>
<span class="hljs-addition">+   @Render('article/article-form')</span>
<span class="hljs-addition">+   async editForm(@Param('id', ParseIntPipe) id: number) {</span>
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+       if (!article) throw new NotFoundException('Article not Found');</span>
<span class="hljs-addition">+       const categoryTree = await this.categoryService.findAll();</span>
<span class="hljs-addition">+       const tags = await this.tagService.findAll();</span>
<span class="hljs-addition">+       return { article, categoryTree, tags };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   @Put(':id')</span>
<span class="hljs-addition">+   async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {</span>
<span class="hljs-addition">+       updateArticleDto.state = ArticleStateEnum.DRAFT;</span>
<span class="hljs-addition">+       await this.articleService.update(id, updateArticleDto);</span>
<span class="hljs-addition">+       if (accept === 'application/json') {</span>
<span class="hljs-addition">+           return { success: true };</span>
<span class="hljs-addition">+       } else {</span>
<span class="hljs-addition">+           return res.redirect(`/admin/articles`);</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   @Delete(":id")</span>
<span class="hljs-addition">+   async delete(@Param('id', ParseIntPipe) id: number) {</span>
<span class="hljs-addition">+       await this.articleService.delete(id);</span>
<span class="hljs-addition">+       return { success: true }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   @Get(':id')</span>
<span class="hljs-addition">+   @Render('article/article-detail')</span>
<span class="hljs-addition">+   async findOne(@Param('id', ParseIntPipe) id: number) {</span>
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+       if (!article) throw new NotFoundException('Article not Found');</span>
<span class="hljs-addition">+       return { article };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Put(':id/submit')</span>
<span class="hljs-addition">+   async submitForReview(@Param('id', ParseIntPipe) id: number) {</span>
<span class="hljs-addition">+       await this.articleService.update(id, { state: ArticleStateEnum.PENDING });</span>
<span class="hljs-addition">+       return { success: true };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Put(':id/approve')</span>
<span class="hljs-addition">+   async approveArticle(@Param('id', ParseIntPipe) id: number) {</span>
<span class="hljs-addition">+       await this.articleService.update(id, { state: ArticleStateEnum.PUBLISHED, rejectionReason: null });</span>
<span class="hljs-addition">+       return { success: true };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Put(':id/reject')</span>
<span class="hljs-addition">+   async rejectArticle(</span>
<span class="hljs-addition">+       @Param('id', ParseIntPipe) id: number,</span>
<span class="hljs-addition">+       @Body('rejectionReason') rejectionReason: string</span>
<span class="hljs-addition">+   ) {</span>
<span class="hljs-addition">+       await this.articleService.update(id, { state: ArticleStateEnum.REJECTED, rejectionReason });</span>
<span class="hljs-addition">+       return { success: true };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Put(':id/withdraw')</span>
<span class="hljs-addition">+   async withdrawArticle(@Param('id', ParseIntPipe) id: number) {</span>
<span class="hljs-addition">+       await this.articleService.update(id, { state: ArticleStateEnum.WITHDRAWN });</span>
<span class="hljs-addition">+       return { success: true };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t356.6. article-list.hbs">6.6. article-list.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t356.6.%20article-list.hbs"> # </a></h3>
<p>views/article/article-list.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
  文章列表
&lt;/h1&gt;
&lt;a href="/admin/articles/create" class="btn btn-success mb-3"&gt;添加文章&lt;/a&gt;
&lt;form method="GET" action="/admin/articles" class="mb-3"&gt;
  &lt;div class="input-group"&gt;
    &lt;input type="text" name="keyword" class="form-control" placeholder="请输入搜索关键字" value="{{keyword}}"&gt;
    &lt;button class="btn btn-outline-secondary"&gt;搜索&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;
&lt;table class="table"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;标题&lt;/th&gt;
      &lt;th&gt;分类&lt;/th&gt;
      &lt;th&gt;标签&lt;/th&gt;
<span class="hljs-addition">+     &lt;th&gt;文章状态&lt;/th&gt;</span>
      &lt;td&gt;状态&lt;/td&gt;
      &lt;td&gt;排序&lt;/td&gt;
      &lt;td&gt;操作&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    {{#each articles}}
    &lt;tr&gt;
      &lt;td&gt;{{this.title}}&lt;/td&gt;
      &lt;td&gt;
        {{#each this.categories}}
        &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
      &lt;/td&gt;
      &lt;td&gt;
        {{#each this.tags}}
        &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
      &lt;/td&gt;
<span class="hljs-addition">+     &lt;td&gt;</span>
<span class="hljs-addition">+       {{#if (eq this.state 'draft')}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-secondary"&gt;草稿&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       {{#if (eq this.state 'pending')}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-warning text-dark"&gt;待审核&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       {{#if (eq this.state 'published')}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-success"&gt;已发布&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       {{#if (eq this.state 'rejected')}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-danger"&gt;审核不通过&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       {{#if (eq this.state 'withdrawn')}}</span>
<span class="hljs-addition">+       &lt;span class="badge bg-dark"&gt;已撤回&lt;/span&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+     &lt;/td&gt;</span>
      &lt;td&gt;
        &lt;span class="status-toggle" data-id="{{this.id}}" data-status="{{this.status}}"&gt;
          {{#if this.status}}
          &lt;i class="bi bi-check-circle-fill text-success"&gt;&lt;/i&gt;
          {{else}}
          &lt;i class="bi bi-x-circle-fill text-danger"&gt;&lt;/i&gt;
          {{/if}}
        &lt;/span&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;span class="sort-text" data-id="{{this.id}}"&gt;{{this.sort}}&lt;/span&gt;
        &lt;input type="number" class="form-control sort-input d-none" style="width:50%" data-id="{{this.id}}"
          value="{{this.sort}}"&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;a href="/admin/articles/{{this.id}}" class="btn btn-primary btn-sm"&gt;查看&lt;/a&gt;
        &lt;a href="/admin/articles/{{this.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;
        &lt;a class="btn btn-danger btn-sm" onclick="deleteArticle({{this.id}})"&gt;删除&lt;/a&gt;
<span class="hljs-addition">+       {{#if (eq this.state 'draft')}}</span>
<span class="hljs-addition">+       &lt;button class="btn btn-warning btn-sm" onclick="submitForReview({{this.id}})"&gt;提交审核&lt;/button&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+       {{#if (eq this.state 'pending')}}</span>
<span class="hljs-addition">+       &lt;button class="btn btn-success btn-sm" onclick="approveArticle({{this.id}})"&gt;审核通过&lt;/button&gt;</span>
<span class="hljs-addition">+       &lt;button class="btn btn-danger btn-sm" data-bs-toggle="modal"</span>
<span class="hljs-addition">+         data-bs-target="#rejectModal-{{this.id}}"&gt;审核不通过&lt;/button&gt;</span>
<span class="hljs-addition">+       &lt;div class="modal fade" id="rejectModal-{{this.id}}" tabindex="-1"&gt;</span>
<span class="hljs-addition">+         &lt;div class="modal-dialog"&gt;</span>
<span class="hljs-addition">+           &lt;div class="modal-content"&gt;</span>
<span class="hljs-addition">+             &lt;div class="modal-header"&gt;</span>
<span class="hljs-addition">+               &lt;h5 class="modal-title"&gt;审核不通过&lt;/h5&gt;</span>
<span class="hljs-addition">+               &lt;button type="button" class="btn-close" data-bs-dismiss="modal"&gt;&lt;/button&gt;</span>
<span class="hljs-addition">+             &lt;/div&gt;</span>
<span class="hljs-addition">+             &lt;div class="modal-body"&gt;</span>
<span class="hljs-addition">+               &lt;div class="mb-3"&gt;</span>
<span class="hljs-addition">+                 &lt;label for="rejectionReason-{{this.id}}" class="form-label"&gt;不通过原因&lt;/label&gt;</span>
<span class="hljs-addition">+                 &lt;textarea class="form-control" id="rejectionReason-{{this.id}}" name="rejectionReason"</span>
<span class="hljs-addition">+                   rows="3"&gt;&lt;/textarea&gt;</span>
<span class="hljs-addition">+               &lt;/div&gt;</span>
<span class="hljs-addition">+             &lt;/div&gt;</span>
<span class="hljs-addition">+             &lt;div class="modal-footer"&gt;</span>
<span class="hljs-addition">+               &lt;button type="button" class="btn btn-secondary" data-bs-dismiss="modal"&gt;取消&lt;/button&gt;</span>
<span class="hljs-addition">+               &lt;button type="button" class="btn btn-danger" onclick="rejectArticle({{this.id}})"&gt;提交&lt;/button&gt;</span>
<span class="hljs-addition">+             &lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+         &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
<span class="hljs-addition">+       {{#if (eq this.state 'published')}}</span>
<span class="hljs-addition">+       &lt;button class="btn btn-secondary btn-sm" onclick="withdrawArticle({{this.id}})"&gt;撤回&lt;/button&gt;</span>
<span class="hljs-addition">+       {{/if}}</span>
      &lt;/td&gt;
    &lt;/tr&gt;
    {{/each}}
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;nav&gt;
  &lt;ul class="pagination"&gt;
    &lt;li class="page-item {{#if (eq page 1)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{dec page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;上一页&lt;/a&gt;
    &lt;/li&gt;
    {{#each (range 1 pageCount)}}
    &lt;li class="page-item {{#if (eq this ../page)}}active{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{this}}&amp;keyword={{../keyword}}&amp;limit={{../limit}}"&gt;{{this}}&lt;/a&gt;
    &lt;/li&gt;
    {{/each}}

    &lt;li class="page-item {{#if (eq page pageCount)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{inc page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;下一页&lt;/a&gt;
    &lt;/li&gt;
    &lt;li class="page-item"&gt;
      &lt;form method="GET" action="/admin/articles" class="d-inline-block ms-3"&gt;
        &lt;input type="hidden" name="keyword" value="{{keyword}}"&gt;
        &lt;input type="hidden" name="page" value="{{page}}"&gt;
        &lt;div class="input-group"&gt;
          &lt;input type="number" name="limit" class="form-control" placeholder="每页条数" value="{{limit}}" min="1"&gt;
          &lt;button class="btn btn-outline-secondary" type="submit"&gt;设置每页的条数&lt;/button&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;script&gt;
<span class="hljs-addition">+ function submitForReview(id) {</span>
<span class="hljs-addition">+   if (confirm('确定要提交审核吗？')) {</span>
<span class="hljs-addition">+     $.ajax({</span>
<span class="hljs-addition">+       url: `/admin/articles/${id}/submit`,</span>
<span class="hljs-addition">+       type: 'PUT',</span>
<span class="hljs-addition">+       success: function (data) {</span>
<span class="hljs-addition">+         if (data.success) {</span>
<span class="hljs-addition">+           alert('提交审核成功');</span>
<span class="hljs-addition">+           location.reload();</span>
<span class="hljs-addition">+         }</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       error: function (error) {</span>
<span class="hljs-addition">+         alert('提交审核失败');</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+     });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+ function approveArticle(id) {</span>
<span class="hljs-addition">+   if (confirm('确定要通过审核吗？')) {</span>
<span class="hljs-addition">+     $.ajax({</span>
<span class="hljs-addition">+       url: `/admin/articles/${id}/approve`,</span>
<span class="hljs-addition">+       type: 'PUT',</span>
<span class="hljs-addition">+       success: function (data) {</span>
<span class="hljs-addition">+         if (data.success) {</span>
<span class="hljs-addition">+           alert('审核通过');</span>
<span class="hljs-addition">+           location.reload();</span>
<span class="hljs-addition">+         }</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       error: function (error) {</span>
<span class="hljs-addition">+         alert('审核通过失败');</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+     });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+ function rejectArticle(id) {</span>
<span class="hljs-addition">+   const rejectionReason = $(`#rejectionReason-${id}`).val();</span>
<span class="hljs-addition">+   if (rejectionReason.trim() === '') {</span>
<span class="hljs-addition">+     alert('请填写审核不通过的原因');</span>
<span class="hljs-addition">+     return;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   $.ajax({</span>
<span class="hljs-addition">+     url: `/admin/articles/${id}/reject`,</span>
<span class="hljs-addition">+     type: 'PUT',</span>
<span class="hljs-addition">+     contentType: 'application/json',</span>
<span class="hljs-addition">+     data: JSON.stringify({ rejectionReason }),</span>
<span class="hljs-addition">+     success: function (data) {</span>
<span class="hljs-addition">+       if (data.success) {</span>
<span class="hljs-addition">+         alert('审核不通过');</span>
<span class="hljs-addition">+         location.reload();</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+     },</span>
<span class="hljs-addition">+     error: function (error) {</span>
<span class="hljs-addition">+       alert('审核不通过失败');</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ function withdrawArticle(id) {</span>
<span class="hljs-addition">+   if (confirm('确定要撤回这篇文章吗？')) {</span>
<span class="hljs-addition">+     $.ajax({</span>
<span class="hljs-addition">+       url: `/admin/articles/${id}/withdraw`,</span>
<span class="hljs-addition">+       type: 'PUT',</span>
<span class="hljs-addition">+       success: function (data) {</span>
<span class="hljs-addition">+         if (data.success) {</span>
<span class="hljs-addition">+           alert('文章已撤回');</span>
<span class="hljs-addition">+           location.reload();</span>
<span class="hljs-addition">+         }</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       error: function (error) {</span>
<span class="hljs-addition">+         alert('撤回文章失败');</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+     });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ }</span>
  function deleteArticle(id) {
    if (confirm('确定要删除吗?')) {
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'DELETE',
        success: function (data) {
          if (data.success) {
            const params = new URLSearchParams(window.location.search);
            params.delete('page');
            params.append('page', 1)
            const query = params.toString();
            window.location = window.location.pathname + '?' + query;
          }
        }
      })
    }
  }
  $(function () {
    $('.sort-text').on('dblclick', function () {
      const $this = $(this);
      const id = $this.data('id');
      $this.addClass('d-none');
      $(`.sort-input[data-id="${id}"]`).removeClass('d-none').focus();
    });
    $('.sort-input').on('blur', function () {
      const $this = $(this);
      const id = $this.data('id');
      const newSort = $this.val();
      $this.addClass('d-none');
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ sort: newSort }),
        success: function (data) {
          if (data.success) {
            $(`.sort-text[data-id="${id}"]`).removeClass('d-none').text(newSort);
          }
        }
      })
    });
    $('.status-toggle').on('click', function () {
      const $this = $(this);
      const id = $this.data('id');
      const currentStatus = $this.data('status');
      const newStatus = currentStatus == 1 ? 0 : 1;
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function (data) {
          if (data.success) {
            $this.data('status', newStatus);
            $this.html(` &lt;i class="bi ${newStatus ? 'bi-check-circle-fill' : 'bi-x-circle-fill'} ${newStatus ? 'text-success' : 'text-danger'}"&gt;&lt;/i&gt;`);
          }
        }
      })
    });
  });
&lt;/script&gt;
</code></pre>
<h2 id="t367.发送审核通知">7.发送审核通知 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t367.%E5%8F%91%E9%80%81%E5%AE%A1%E6%A0%B8%E9%80%9A%E7%9F%A5"> # </a></h2>
<pre><code class="lang-js">npm install @nestjs/event-emitter eventemitter2
</code></pre>
<h3 id="t377.1. notification.service.ts">7.1. notification.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t377.1.%20notification.service.ts"> # </a></h3>
<p>src/shared/services/notification.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { OnEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;
<span class="hljs-keyword">import</span> { ArticleService } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/services/article.service'</span>;
<span class="hljs-keyword">import</span> { UserService } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/services/user.service'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotificationService</span> </span>{
    <span class="hljs-keyword">constructor</span>(
        private readonly articleService: ArticleService,
        private readonly userService: UserService,
    ) { }

    @OnEvent(<span class="hljs-string">'article.submitted'</span>)
    <span class="hljs-keyword">async</span> handleArticleSubmittedEvent(payload: { <span class="hljs-attr">articleId</span>: number }) {
        <span class="hljs-keyword">const</span> article = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.articleService.findOne({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: payload.articleId }, <span class="hljs-attr">relations</span>: [<span class="hljs-string">'categories'</span>, <span class="hljs-string">'tags'</span>] });
        <span class="hljs-keyword">const</span> admin = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.findOne({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">is_super</span>: <span class="hljs-literal">true</span> } });
        <span class="hljs-keyword">if</span> (admin) {
            <span class="hljs-keyword">const</span> subject = <span class="hljs-string">`文章审核请求: <span class="hljs-subst">${article.title}</span>`</span>;
            <span class="hljs-keyword">const</span> body = <span class="hljs-string">`有一篇新的文章需要审核，点击链接查看详情: http://localhost:3000/admin/articles/<span class="hljs-subst">${payload.articleId}</span>`</span>;
            <span class="hljs-built_in">console</span>.log(admin.email, subject, body);
        }
    }
}

</code></pre>
<h3 id="t387.2. app.module.ts">7.2. app.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t387.2.%20app.module.ts"> # </a></h3>
<p>src/app.module.ts</p>
<pre><code class="lang-diff">import { MiddlewareConsumer, Module, NestModule } from '@nestjs/common';
import { AdminModule } from './admin/admin.module';
import { ApiModule } from './api/api.module';
import { SharedModule } from './shared/shared.module';
import { AcceptLanguageResolver, QueryResolver, I18nModule, } from 'nestjs-i18n';
<span class="hljs-addition">+import * as  path from 'path';</span>
<span class="hljs-addition">+import methodOverride from 'src/shared/middlewares/method-override'</span>
<span class="hljs-addition">+import { ServeStaticModule } from '@nestjs/serve-static';</span>
<span class="hljs-addition">+import { EventEmitterModule } from '@nestjs/event-emitter';</span>
<span class="hljs-addition">+@Module({</span>
<span class="hljs-addition">+ imports: [</span>
<span class="hljs-addition">+   // 配置 EventEmitterModule 模块</span>
<span class="hljs-addition">+   EventEmitterModule.forRoot({</span>
<span class="hljs-addition">+     // 启用通配符功能，允许使用通配符来订阅事件</span>
<span class="hljs-addition">+     wildcard: true,</span>
<span class="hljs-addition">+     // 设置事件名的分隔符，这里使用 '.' 作为分隔符</span>
<span class="hljs-addition">+     delimiter: '.',</span>
<span class="hljs-addition">+     // 将事件发射器设置为全局模块，所有模块都可以共享同一个事件发射器实例</span>
<span class="hljs-addition">+     global: true</span>
<span class="hljs-addition">+   }),</span>
<span class="hljs-addition">+   ServeStaticModule.forRoot({</span>
<span class="hljs-addition">+     rootPath: path.join(__dirname, '..', 'uploads'),</span>
<span class="hljs-addition">+     serveRoot: '/uploads',</span>
<span class="hljs-addition">+   }),</span>
<span class="hljs-addition">+   I18nModule.forRoot({</span>
<span class="hljs-addition">+     fallbackLanguage: 'en',</span>
<span class="hljs-addition">+     loaderOptions: {</span>
<span class="hljs-addition">+       path: path.join(__dirname, '/i18n/'),</span>
<span class="hljs-addition">+       watch: true</span>
<span class="hljs-addition">+     },</span>
<span class="hljs-addition">+     resolvers: [</span>
<span class="hljs-addition">+       new QueryResolver(["lang", "l"]),</span>
<span class="hljs-addition">+       AcceptLanguageResolver,</span>
<span class="hljs-addition">+     ]</span>
<span class="hljs-addition">+   }),</span>
<span class="hljs-addition">+   SharedModule,</span>
<span class="hljs-addition">+   AdminModule,</span>
<span class="hljs-addition">+   ApiModule</span>
<span class="hljs-addition">+ ],</span>
<span class="hljs-addition">+ controllers: [],</span>
<span class="hljs-addition">+ providers: [],</span>
<span class="hljs-addition">+})</span>
<span class="hljs-addition">+export class AppModule implements NestModule {</span>
<span class="hljs-addition">+ configure(consumer: MiddlewareConsumer) {</span>
<span class="hljs-addition">+   consumer.apply(methodOverride).forRoutes('*');</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t397.3. article.entity.ts">7.3. article.entity.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t397.3.%20article.entity.ts"> # </a></h3>
<p>src/shared/entities/article.entity.ts</p>
<pre><code class="lang-diff">import { ApiProperty } from '@nestjs/swagger';
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn, UpdateDateColumn, ManyToMany, JoinTable } from 'typeorm';
import { Category } from './category.entity';
import { Tag } from './tag.entity';
import { ArticleStateEnum } from '../enums/article.enum';
@Entity()
export class Article {
    @PrimaryGeneratedColumn()
    @ApiProperty({ description: 'ID', example: 1 })
    id: number;
<span class="hljs-addition">+   @Column({ length: 50 })</span>
    @ApiProperty({ description: '标题', example: '文章标题' })
    title: string;
    @Column('text')
    @ApiProperty({ description: '内容', example: '文章内容' })
    content: string;
    @ManyToMany(() =&gt; Category)
    @JoinTable()
    categories: Category[];
    @ManyToMany(() =&gt; Tag)
    @JoinTable()
    tags: Tag[];

    @Column({ type: 'enum', enum: ArticleStateEnum, default: 'draft' })
    @ApiProperty({ description: '文章状态', example: 'draft' })
    state: ArticleStateEnum;

    @Column({ type: 'text', nullable: true })
    @ApiProperty({ description: '审核不通过原因', example: '内容不符合要求' })
    rejectionReason: string;

    @Column({ default: 1 })
    @ApiProperty({ description: '生效状态', example: 1 })
    status: number;
    @Column({ default: 100 })
    @ApiProperty({ description: '排序号', example: 100 })
    sort: number;
    @CreateDateColumn()
    @ApiProperty({ description: '创建时间', example: '2024年8月11日16:49:22' })
    createdAt: Date;
    @UpdateDateColumn()
    @ApiProperty({ description: '更新时间', example: '2024年8月11日16:49:22' })
    updatedAt: Date;
}

</code></pre>
<h3 id="t407.4. shared.module.ts">7.4. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t407.4.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
<span class="hljs-addition">+import { NotificationService } from './services/notification.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t417.5. article.controller.ts">7.5. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t417.5.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render, Post, Redirect, Body, UseFilters, HttpException, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException } from '@nestjs/common';
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';
import { CategoryService } from 'src/shared/services/category.service';
import { TagService } from 'src/shared/services/tag.service';
import { ArticleStateEnum } from 'src/shared/enums/article.enum';
<span class="hljs-addition">+import { EventEmitter2 } from '@nestjs/event-emitter';</span>
@UseFilters(AdminExceptionFilter)
@Controller('admin/articles')
export class ArticleController {
    constructor(
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService,
<span class="hljs-addition">+       private readonly eventEmitter: EventEmitter2,</span>
    ) { }
    @Get()
    @Render('article/article-list')
    async findAll(@Query('keyword') keyword: string = '',
        @Query('page', new ParseOptionalIntPipe(1)) page: number,
        @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {
        const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);
        const pageCount = Math.ceil(total / limit);
        return { articles, keyword, page, limit, pageCount };
    }
    @Get('create')
    @Render('article/article-form')
    async createForm() {
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article: { categories: [], tags: [] }, categoryTree, tags };
    }
    @Post()
    @Redirect('/admin/articles')
    async create(@Body() createArticleDto: CreateArticleDto) {
        await this.articleService.create(createArticleDto);
        return { success: true }
    }
    @Get(':id/edit')
    @Render('article/article-form')
    async editForm(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article, categoryTree, tags };
    }
    @Put(':id')
    async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {
        updateArticleDto.state = ArticleStateEnum.DRAFT;
        await this.articleService.update(id, updateArticleDto);
        if (accept <span class="hljs-comment">=== 'application/json') {</span>
            return { success: true };
        } else {
            return res.redirect(`/admin/articles`);
        }
    }
    @Delete(":id")
    async delete(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.delete(id);
        return { success: true }
    }
    @Get(':id')
    @Render('article/article-detail')
    async findOne(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        return { article };
    }

    @Put(':id/submit')
    async submitForReview(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PENDING });
<span class="hljs-addition">+       this.eventEmitter.emit('article.submitted', { articleId: id });</span>
        return { success: true };
    }

    @Put(':id/approve')
    async approveArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PUBLISHED, rejectionReason: null });
        return { success: true };
    }

    @Put(':id/reject')
    async rejectArticle(
        @Param('id', ParseIntPipe) id: number,
        @Body('rejectionReason') rejectionReason: string
    ) {
        await this.articleService.update(id, { state: ArticleStateEnum.REJECTED, rejectionReason });
        return { success: true };
    }

    @Put(':id/withdraw')
    async withdrawArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.WITHDRAWN });
        return { success: true };
    }
}
</code></pre>
<h2 id="t428.发送邮件">8.发送邮件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t428.%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6"> # </a></h2>
<pre><code class="lang-js">npm install nodemailer
</code></pre>
<h3 id="t438.1. mail.service.ts">8.1. mail.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t438.1.%20mail.service.ts"> # </a></h3>
<p>src/shared/services/mail.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> nodemailer <span class="hljs-keyword">from</span> <span class="hljs-string">'nodemailer'</span>;
<span class="hljs-keyword">import</span> { ConfigService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MailService</span> </span>{
    private transporter;
    <span class="hljs-keyword">constructor</span>(private readonly configService: ConfigService) {
        <span class="hljs-keyword">this</span>.transporter = nodemailer.createTransport({
            <span class="hljs-attr">host</span>: configService.get(<span class="hljs-string">'SMTP_HOST'</span>),
            <span class="hljs-attr">port</span>: configService.get(<span class="hljs-string">'SMTP_PORT'</span>),
            <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">auth</span>: {
                <span class="hljs-attr">user</span>: configService.get(<span class="hljs-string">'SMTP_USER'</span>),
                <span class="hljs-attr">pass</span>: configService.get(<span class="hljs-string">'SMTP_PASS'</span>),
            },
        });
    }

    <span class="hljs-keyword">async</span> sendEmail(to: string, <span class="hljs-attr">subject</span>: string, <span class="hljs-attr">body</span>: string) {
        <span class="hljs-keyword">const</span> mailOptions = {
            <span class="hljs-attr">from</span>: <span class="hljs-keyword">this</span>.configService.get(<span class="hljs-string">'SMTP_USER'</span>), <span class="hljs-comment">// 发件人</span>
            to, <span class="hljs-comment">// 收件人</span>
            subject, <span class="hljs-comment">// 主题</span>
            <span class="hljs-attr">text</span>: body, <span class="hljs-comment">// 邮件正文</span>
        };
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> info = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.transporter.sendMail(mailOptions);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`邮件已发送: <span class="hljs-subst">${info.messageId}</span>`</span>);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`发送邮件失败: <span class="hljs-subst">${error.message}</span>`</span>);
        }
    }
}

</code></pre>
<h3 id="t448.2. notification.service.ts">8.2. notification.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t448.2.%20notification.service.ts"> # </a></h3>
<p>src/shared/services/notification.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from '@nestjs/common';
import { OnEvent } from '@nestjs/event-emitter';
import { ArticleService } from 'src/shared/services/article.service';
import { UserService } from 'src/shared/services/user.service';
<span class="hljs-addition">+import { MailService } from './mail.service';</span>
@Injectable()
export class NotificationService {
    constructor(
        private readonly articleService: ArticleService,
        private readonly userService: UserService,
<span class="hljs-addition">+       private readonly mailService: MailService,</span>
    ) { }

    @OnEvent('article.submitted')
    async handleArticleSubmittedEvent(payload: { articleId: number }) {
        const article = await this.articleService.findOne({ where: { id: payload.articleId }, relations: ['categories', 'tags'] });
        const admin = await this.userService.findOne({ where: { is_super: true } });
        if (admin) {
            const subject = `文章审核请求: ${article.title}`;
            const body = `有一篇新的文章需要审核，点击链接查看详情: http://localhost:3000/admin/articles/${payload.articleId}`;
            console.log(admin.email, subject, body);
<span class="hljs-addition">+           this.mailService.sendEmail(admin.email, subject, body);</span>
        }
    }
}

</code></pre>
<h3 id="t458.3. shared.module.ts">8.3. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t458.3.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
<span class="hljs-addition">+import { MailService } from './services/mail.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}
</code></pre>
<h2 id="t469.导出Word">9.导出Word <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t469.%E5%AF%BC%E5%87%BAWord"> # </a></h2>
<pre><code class="lang-js">npm install html-to-docx
</code></pre>
<p><code>res.setHeader('Content-Disposition', 'attachment; filename="articles.docx"');</code> 是一个关键的 HTTP 头设置，用于控制文件下载行为。通过它，你可以指定返回给客户端的文件名，并确保文件以附件形式下载。</p>
<h3 id="t479.1. word-export.service.ts">9.1. word-export.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t479.1.%20word-export.service.ts"> # </a></h3>
<p>src/shared/services/word-export.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> htmlToDocx <span class="hljs-keyword">from</span> <span class="hljs-string">'html-to-docx'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WordExportService</span> </span>{
    <span class="hljs-keyword">async</span> exportToWord(htmlContent: string): <span class="hljs-built_in">Promise</span>&lt;Buffer&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> htmlToDocx(htmlContent);
    }
}

</code></pre>
<h3 id="t489.2. shared.module.ts">9.2. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t489.2.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
<span class="hljs-addition">+import { WordExportService } from './services/word-export.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t499.3. article-detail.hbs">9.3. article-detail.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t499.3.%20article-detail.hbs"> # </a></h3>
<p>views/article/article-detail.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
    文章详情
&lt;/h1&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;标题:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;{{article.title}}&lt;/p&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;内容:&lt;/label&gt;
    &lt;div class="form-control-plaintext"&gt;
        {{{article.content}}}
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;分类:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#each article.categories}}
        &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
    &lt;/p&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;标签:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#each article.tags}}
        &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
    &lt;/p&gt;
&lt;/div&gt;
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;状态:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;
        {{#if (eq article.state 'draft')}}草稿{{/if}}
        {{#if (eq article.state 'pending')}}待审核{{/if}}
        {{#if (eq article.state 'published')}}已发布{{/if}}
        {{#if (eq article.state 'rejected')}}审核不通过{{/if}}
    &lt;/p&gt;
&lt;/div&gt;
{{#if (eq article.state 'rejected')}}
&lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;不通过原因:&lt;/label&gt;
    &lt;p class="form-control-plaintext"&gt;{{article.rejectionReason}}&lt;/p&gt;
&lt;/div&gt;
{{/if}}
{{#if (eq article.state 'pending')}}
&lt;div class="mb-3"&gt;
    &lt;button id="approveButton" class="btn btn-success"&gt;审核通过&lt;/button&gt;
    &lt;button id="rejectButton" class="btn btn-danger"&gt;审核不通过&lt;/button&gt;
&lt;/div&gt;
{{/if}}
&lt;a href="/admin/articles/{{article.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;
&lt;a href="/admin/articles" class="btn btn-secondary btn-sm"&gt;返回列表&lt;/a&gt;
<span class="hljs-addition">+&lt;a href="/admin/articles/{{article.id}}/export-word" class="btn btn-primary btn-sm"&gt;导出为 Word&lt;/a&gt;</span>
&lt;div id="rejectionReasonModal" class="modal fade" tabindex="-1"&gt;
    &lt;div class="modal-dialog"&gt;
        &lt;div class="modal-content"&gt;
            &lt;div class="modal-header"&gt;
                &lt;h5 class="modal-title"&gt;填写审核不通过原因&lt;/h5&gt;
                &lt;button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"&gt;&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="modal-body"&gt;
                &lt;textarea id="rejectionReason" class="form-control" rows="3" placeholder="请输入不通过原因"&gt;&lt;/textarea&gt;
            &lt;/div&gt;
            &lt;div class="modal-footer"&gt;
                &lt;button type="button" class="btn btn-secondary" data-bs-dismiss="modal"&gt;取消&lt;/button&gt;
                &lt;button id="confirmRejectionButton" type="button" class="btn btn-danger"&gt;确认不通过&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;script&gt;
    $(function () {
        $('#approveButton').on('click', function () {
            if (confirm('确定要通过审核吗？')) {
                $.ajax({
                    url: `/admin/articles/{{article.id}}/approve`,
                    type: 'PUT',
                    success: function (data) {
                        if (data.success) {
                            alert('审核通过');
                            location.reload();
                        } else {
                            alert('审核通过失败');
                        }
                    },
                    error: function () {
                        alert('审核通过失败');
                    }
                });
            }
        });

        $('#rejectButton').on('click', function () {
            $('#rejectionReasonModal').modal('show');
        });

        $('#confirmRejectionButton').on('click', function () {
            const rejectionReason = $('#rejectionReason').val().trim();
            if (rejectionReason <span class="hljs-comment">=== '') {</span>
                alert('请填写审核不通过的原因');
                return;
            }
            $.ajax({
                url: `/admin/articles/{{article.id}}/reject`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ rejectionReason: rejectionReason }),
                success: function (data) {
                    if (data.success) {
                        alert('审核不通过');
                        location.reload();
                    } else {
                        alert('审核不通过失败');
                    }
                },
                error: function () {
                    alert('审核不通过失败');
                }
            });
        });
    });
&lt;/script&gt;
</code></pre>
<h3 id="t509.4. article.controller.ts">9.4. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t509.4.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { Controller, Get, Render, Post, Redirect, Body, UseFilters, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException, Header, StreamableFile } from '@nestjs/common';</span>
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';
import { CategoryService } from 'src/shared/services/category.service';
import { TagService } from 'src/shared/services/tag.service';
import { ArticleStateEnum } from 'src/shared/enums/article.enum';
import { EventEmitter2 } from '@nestjs/event-emitter';
<span class="hljs-addition">+import { WordExportService } from 'src/shared/services/word-export.service';</span>
@UseFilters(AdminExceptionFilter)
@Controller('admin/articles')
export class ArticleController {
    constructor(
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService,
        private readonly eventEmitter: EventEmitter2,
<span class="hljs-addition">+       private readonly wordExportService: WordExportService,</span>
    ) { }
    @Get()
    @Render('article/article-list')
    async findAll(@Query('keyword') keyword: string = '',
        @Query('page', new ParseOptionalIntPipe(1)) page: number,
        @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {
        const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);
        const pageCount = Math.ceil(total / limit);
        return { articles, keyword, page, limit, pageCount };
    }
    @Get('create')
    @Render('article/article-form')
    async createForm() {
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article: { categories: [], tags: [] }, categoryTree, tags };
    }
    @Post()
    @Redirect('/admin/articles')
    async create(@Body() createArticleDto: CreateArticleDto) {
        await this.articleService.create(createArticleDto);
        return { success: true }
    }
    @Get(':id/edit')
    @Render('article/article-form')
    async editForm(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article, categoryTree, tags };
    }
    @Put(':id')
    async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {
        updateArticleDto.state = ArticleStateEnum.DRAFT;
        await this.articleService.update(id, updateArticleDto);
        if (accept <span class="hljs-comment">=== 'application/json') {</span>
            return { success: true };
        } else {
            return res.redirect(`/admin/articles`);
        }
    }
    @Delete(":id")
    async delete(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.delete(id);
        return { success: true }
    }
    @Get(':id')
    @Render('article/article-detail')
    async findOne(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        return { article };
    }

    @Put(':id/submit')
    async submitForReview(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PENDING });
        this.eventEmitter.emit('article.submitted', { articleId: id });
        return { success: true };
    }

    @Put(':id/approve')
    async approveArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PUBLISHED, rejectionReason: null });
        return { success: true };
    }

    @Put(':id/reject')
    async rejectArticle(
        @Param('id', ParseIntPipe) id: number,
        @Body('rejectionReason') rejectionReason: string
    ) {
        await this.articleService.update(id, { state: ArticleStateEnum.REJECTED, rejectionReason });
        return { success: true };
    }

    @Put(':id/withdraw')
    async withdrawArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.WITHDRAWN });
        return { success: true };
    }
<span class="hljs-addition">+   @Get(':id/export-word')</span>
<span class="hljs-addition">+   @Header('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')</span>
<span class="hljs-addition">+   async exportWord(@Param('id', ParseIntPipe) id: number, @Res({ passthrough: true }) res: Response) {</span>
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+       if (!article) throw new NotFoundException('Article not found');</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       const htmlContent = `</span>
<span class="hljs-addition">+           &lt;h1&gt;${article.title}&lt;/h1&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;&lt;strong&gt;状态:&lt;/strong&gt; ${article.state}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;&lt;strong&gt;分类:&lt;/strong&gt; ${article.categories.map(c =&gt; c.name).join(', ')}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;&lt;strong&gt;标签:&lt;/strong&gt; ${article.tags.map(t =&gt; t.name).join(', ')}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;hr/&gt;</span>
<span class="hljs-addition">+           ${article.content}</span>
<span class="hljs-addition">+       `;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       const buffer = await this.wordExportService.exportToWord(htmlContent);</span>
<span class="hljs-addition">+       res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(article.title)}.docx"`);</span>
<span class="hljs-addition">+       return new StreamableFile(buffer);</span>
<span class="hljs-addition">+   }</span>
}
</code></pre>
<h2 id="t5110.导出ppt">10.导出ppt <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5110.%E5%AF%BC%E5%87%BAppt"> # </a></h2>
<pre><code class="lang-js">npm install html-pptxgenjs pptxgenjs 
</code></pre>
<h3 id="t5210.1. ppt-export.service.ts">10.1. ppt-export.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5210.1.%20ppt-export.service.ts"> # </a></h3>
<p>src/shared/services/ppt-export.service.ts</p>
<pre><code class="lang-js"><span class="hljs-comment">// 导入 Injectable 装饰器，用于标记一个服务类</span>
<span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-comment">// 导入 PptxGenJS 库，用于生成 PPTX 文件</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> PptxGenJS <span class="hljs-keyword">from</span> <span class="hljs-string">'pptxgenjs'</span>;
<span class="hljs-comment">// 导入 html-pptxgenjs 库，用于将 HTML 转换为 PPTX 内容</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> html2ppt <span class="hljs-keyword">from</span> <span class="hljs-string">'html-pptxgenjs'</span>;
<span class="hljs-comment">// 使用 Injectable 装饰器将 PptExportService 标记为可注入的服务</span>
@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PptExportService</span> </span>{
    <span class="hljs-comment">// 异步方法，用于将文章列表导出为 PPTX 文件</span>
    <span class="hljs-keyword">async</span> exportToPpt(articles: any[]) {
        <span class="hljs-comment">// 创建一个新的 PPTX 对象</span>
        <span class="hljs-keyword">const</span> pptx = <span class="hljs-keyword">new</span> (PptxGenJS <span class="hljs-keyword">as</span> any)();
        <span class="hljs-comment">// 遍历每篇文章，将其内容添加到 PPTX 幻灯片中</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> article <span class="hljs-keyword">of</span> articles) {
            <span class="hljs-comment">// 添加一个新的幻灯片到 PPTX</span>
            <span class="hljs-keyword">const</span> slide = pptx.addSlide();
            <span class="hljs-comment">// 构建 HTML 内容，包含文章标题、状态、分类、标签和正文内容</span>
            <span class="hljs-keyword">const</span> htmlContent = <span class="hljs-string">`
                &lt;h1&gt;<span class="hljs-subst">${article.title}</span>&lt;/h1&gt;
                &lt;p&gt;&lt;strong&gt;状态:&lt;/strong&gt; <span class="hljs-subst">${article.state}</span>&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;分类:&lt;/strong&gt; <span class="hljs-subst">${article.categories.map(c =&gt; c.name).join(<span class="hljs-string">', '</span>)}</span>&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;标签:&lt;/strong&gt; <span class="hljs-subst">${article.tags.map(t =&gt; t.name).join(<span class="hljs-string">', '</span>)}</span>&lt;/p&gt;
                &lt;hr/&gt;
                <span class="hljs-subst">${article.content}</span>
            `</span>;
            <span class="hljs-comment">// 使用 html-pptxgenjs 将 HTML 内容转换为 PPTX 可用的文本项</span>
            <span class="hljs-keyword">const</span> items = html2ppt.htmlToPptxText(htmlContent);
            <span class="hljs-comment">// 将生成的文本项添加到幻灯片中，设置其位置和大小</span>
            slide.addText(items, { <span class="hljs-attr">x</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">9.5</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">valign</span>: <span class="hljs-string">'top'</span> });
        }
        <span class="hljs-comment">// 将生成的 PPTX 文件以 nodebuffer 的形式输出</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> pptx.write({ <span class="hljs-attr">outputType</span>: <span class="hljs-string">'nodebuffer'</span> });
    }
}
</code></pre>
<h3 id="t5310.2. admin-exception-filter.ts">10.2. admin-exception-filter.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5310.2.%20admin-exception-filter.ts"> # </a></h3>
<p>src/admin/filters/admin-exception-filter.ts</p>
<pre><code class="lang-diff">import { ArgumentsHost, ExceptionFilter, HttpException, Catch, BadRequestException } from "@nestjs/common";
import { Response } from 'express';
import { I18nService, I18nValidationException } from "nestjs-i18n";
@Catch(HttpException)
export class AdminExceptionFilter implements ExceptionFilter {
    constructor(private readonly i18n: I18nService) { }
    catch(exception: any, host: ArgumentsHost) {
        const ctx = host.switchToHttp();
        const request: any = ctx.getRequest&lt;Request&gt;();
        const response = ctx.getResponse&lt;Response&gt;();
        let status = exception.getStatus();
        let message = exception.message;
        if (exception instanceof BadRequestException) {
            const execptionBody: any = exception.getResponse();
            if (typeof execptionBody <span class="hljs-comment">=== 'object' &amp;&amp; execptionBody.message) {</span>
<span class="hljs-addition">+               message = Array.isArray(execptionBody.message) ? execptionBody.message.join(',') : execptionBody.message;</span>
                status = execptionBody.statusCode;
            }
        } else if (exception instanceof I18nValidationException) {
            const errors = exception.errors;
            message = errors.map(error =&gt; this.formatErrorMessage(error, request.i18nLang)).join(';')
        }
        response.status(status).render('error', {
            message
        });
    }
    formatErrorMessage(error, lang) {
        const { property, value, constraints } = error;
        const constraintValues = Object.values(constraints)
        const formattedMessages = constraintValues.map((constraintValue: any) =&gt; {
            const [key, params] = constraintValue.split('|');
            if (params) {
                const parsedParams = JSON.parse(params);
                return this.i18n.translate(key, {
                    lang,
                    args: parsedParams
                });
            }
        })
        return `${property}:${value} ${formattedMessages.join(',')}`
    }
}

</code></pre>
<h3 id="t5410.3. shared.module.ts">10.3. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5410.3.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
<span class="hljs-addition">+import { PptExportService } from './services/ppt-export.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t5510.4. article.controller.ts">10.4. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5510.4.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render, Post, Redirect, Body, UseFilters, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException, Header, StreamableFile } from '@nestjs/common';
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';
import { CategoryService } from 'src/shared/services/category.service';
import { TagService } from 'src/shared/services/tag.service';
import { ArticleStateEnum } from 'src/shared/enums/article.enum';
import { EventEmitter2 } from '@nestjs/event-emitter';
import { WordExportService } from 'src/shared/services/word-export.service';
<span class="hljs-addition">+import { PptExportService } from 'src/shared/services/ppt-export.service';</span>
@UseFilters(AdminExceptionFilter)
@Controller('admin/articles')
export class ArticleController {
    constructor(
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService,
        private readonly eventEmitter: EventEmitter2,
        private readonly wordExportService: WordExportService,
<span class="hljs-addition">+       private readonly pptExportService: PptExportService</span>
    ) { }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Get(':id/export-word')</span>
<span class="hljs-addition">+   @Header('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')</span>
<span class="hljs-addition">+   async exportWord(@Param('id', ParseIntPipe) id: number, @Res({ passthrough: true }) res: Response) {</span>
<span class="hljs-addition">+       const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+       if (!article) throw new NotFoundException('Article not found');</span>
<span class="hljs-addition">+       const htmlContent = `</span>
<span class="hljs-addition">+           &lt;h1&gt;${article.title}&lt;/h1&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;&lt;strong&gt;状态:&lt;/strong&gt; ${article.state}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;&lt;strong&gt;分类:&lt;/strong&gt; ${article.categories.map(c =&gt; c.name).join(', ')}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;&lt;strong&gt;标签:&lt;/strong&gt; ${article.tags.map(t =&gt; t.name).join(', ')}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;hr/&gt;</span>
<span class="hljs-addition">+           ${article.content}</span>
<span class="hljs-addition">+       `;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+       const buffer = await this.wordExportService.exportToWord(htmlContent);</span>
<span class="hljs-addition">+       res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(article.title)}.docx"`);</span>
<span class="hljs-addition">+       return new StreamableFile(buffer);</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Get('export-ppt')</span>
<span class="hljs-addition">+   @Header('Content-Type', 'application/vnd.openxmlformats-officedocument.presentationml.presentation')</span>
<span class="hljs-addition">+   async exportPpt(@Query('search') search: string = '', @Query('page', new ParseOptionalIntPipe(1)) page: number, @Query('limit', new ParseOptionalIntPipe(10)) limit: number, @Res({ passthrough: true }) res: Response) {</span>
<span class="hljs-addition">+       const { articles } = await this.articleService.findAllWithPagination(page, limit, search);</span>
<span class="hljs-addition">+       const buffer = await this.pptExportService.exportToPpt(articles);</span>
<span class="hljs-addition">+       res.setHeader('Content-Disposition', 'attachment; filename=articles.pptx');</span>
<span class="hljs-addition">+       return new StreamableFile(buffer);</span>
<span class="hljs-addition">+   }</span>
    @Get()
    @Render('article/article-list')
    async findAll(@Query('keyword') keyword: string = '',
        @Query('page', new ParseOptionalIntPipe(1)) page: number,
        @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {
        const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);
        const pageCount = Math.ceil(total / limit);
        return { articles, keyword, page, limit, pageCount };
    }
    @Get('create')
    @Render('article/article-form')
    async createForm() {
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article: { categories: [], tags: [] }, categoryTree, tags };
    }
    @Post()
    @Redirect('/admin/articles')
    async create(@Body() createArticleDto: CreateArticleDto) {
        await this.articleService.create(createArticleDto);
        return { success: true }
    }
    @Get(':id/edit')
    @Render('article/article-form')
    async editForm(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article, categoryTree, tags };
    }
    @Put(':id')
    async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {
        updateArticleDto.state = ArticleStateEnum.DRAFT;
        await this.articleService.update(id, updateArticleDto);
        if (accept <span class="hljs-comment">=== 'application/json') {</span>
            return { success: true };
        } else {
            return res.redirect(`/admin/articles`);
        }
    }
    @Delete(":id")
    async delete(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.delete(id);
        return { success: true }
    }
    @Get(':id')
    @Render('article/article-detail')
    async findOne(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        return { article };
    }

    @Put(':id/submit')
    async submitForReview(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PENDING });
        this.eventEmitter.emit('article.submitted', { articleId: id });
        return { success: true };
    }

    @Put(':id/approve')
    async approveArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PUBLISHED, rejectionReason: null });
        return { success: true };
    }

    @Put(':id/reject')
    async rejectArticle(
        @Param('id', ParseIntPipe) id: number,
        @Body('rejectionReason') rejectionReason: string
    ) {
        await this.articleService.update(id, { state: ArticleStateEnum.REJECTED, rejectionReason });
        return { success: true };
    }

    @Put(':id/withdraw')
    async withdrawArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.WITHDRAWN });
        return { success: true };
    }
}

</code></pre>
<h3 id="t5610.5. article-list.hbs">10.5. article-list.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5610.5.%20article-list.hbs"> # </a></h3>
<p>views/article/article-list.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
  文章列表
&lt;/h1&gt;
<span class="hljs-addition">+&lt;a href="/admin/articles/create" class="btn btn-success btn-sm mb-3"&gt;添加文章&lt;/a&gt;</span>
<span class="hljs-addition">+&lt;button id="exportPptBtn" class="btn btn-warning btn-sm mb-3"&gt;导出PPT&lt;/button&gt;</span>
&lt;form method="GET" action="/admin/articles" class="mb-3"&gt;
  &lt;div class="input-group"&gt;
    &lt;input type="text" name="keyword" class="form-control" placeholder="请输入搜索关键字" value="{{keyword}}"&gt;
    &lt;button class="btn btn-outline-secondary"&gt;搜索&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;
&lt;table class="table"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;标题&lt;/th&gt;
      &lt;th&gt;分类&lt;/th&gt;
      &lt;th&gt;标签&lt;/th&gt;
      &lt;th&gt;文章状态&lt;/th&gt;
      &lt;td&gt;状态&lt;/td&gt;
      &lt;td&gt;排序&lt;/td&gt;
      &lt;td&gt;操作&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    {{#each articles}}
    &lt;tr&gt;
      &lt;td&gt;{{this.title}}&lt;/td&gt;
      &lt;td&gt;
        {{#each this.categories}}
        &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
      &lt;/td&gt;
      &lt;td&gt;
        {{#each this.tags}}
        &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
      &lt;/td&gt;
      &lt;td&gt;
        {{#if (eq this.state 'draft')}}
        &lt;span class="badge bg-secondary"&gt;草稿&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'pending')}}
        &lt;span class="badge bg-warning text-dark"&gt;待审核&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'published')}}
        &lt;span class="badge bg-success"&gt;已发布&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'rejected')}}
        &lt;span class="badge bg-danger"&gt;审核不通过&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'withdrawn')}}
        &lt;span class="badge bg-dark"&gt;已撤回&lt;/span&gt;
        {{/if}}
      &lt;/td&gt;
      &lt;td&gt;
        &lt;span class="status-toggle" data-id="{{this.id}}" data-status="{{this.status}}"&gt;
          {{#if this.status}}
          &lt;i class="bi bi-check-circle-fill text-success"&gt;&lt;/i&gt;
          {{else}}
          &lt;i class="bi bi-x-circle-fill text-danger"&gt;&lt;/i&gt;
          {{/if}}
        &lt;/span&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;span class="sort-text" data-id="{{this.id}}"&gt;{{this.sort}}&lt;/span&gt;
        &lt;input type="number" class="form-control sort-input d-none" style="width:50%" data-id="{{this.id}}"
          value="{{this.sort}}"&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;a href="/admin/articles/{{this.id}}" class="btn btn-primary btn-sm"&gt;查看&lt;/a&gt;
        &lt;a href="/admin/articles/{{this.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;
        &lt;a class="btn btn-danger btn-sm" onclick="deleteArticle({{this.id}})"&gt;删除&lt;/a&gt;
        {{#if (eq this.state 'draft')}}
        &lt;button class="btn btn-warning btn-sm" onclick="submitForReview({{this.id}})"&gt;提交审核&lt;/button&gt;
        {{/if}}
        {{#if (eq this.state 'pending')}}
        &lt;button class="btn btn-success btn-sm" onclick="approveArticle({{this.id}})"&gt;审核通过&lt;/button&gt;
        &lt;button class="btn btn-danger btn-sm" data-bs-toggle="modal"
          data-bs-target="#rejectModal-{{this.id}}"&gt;审核不通过&lt;/button&gt;
        &lt;div class="modal fade" id="rejectModal-{{this.id}}" tabindex="-1"&gt;
          &lt;div class="modal-dialog"&gt;
            &lt;div class="modal-content"&gt;
              &lt;div class="modal-header"&gt;
                &lt;h5 class="modal-title"&gt;审核不通过&lt;/h5&gt;
                &lt;button type="button" class="btn-close" data-bs-dismiss="modal"&gt;&lt;/button&gt;
              &lt;/div&gt;
              &lt;div class="modal-body"&gt;
                &lt;div class="mb-3"&gt;
                  &lt;label for="rejectionReason-{{this.id}}" class="form-label"&gt;不通过原因&lt;/label&gt;
                  &lt;textarea class="form-control" id="rejectionReason-{{this.id}}" name="rejectionReason"
                    rows="3"&gt;&lt;/textarea&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;div class="modal-footer"&gt;
                &lt;button type="button" class="btn btn-secondary" data-bs-dismiss="modal"&gt;取消&lt;/button&gt;
                &lt;button type="button" class="btn btn-danger" onclick="rejectArticle({{this.id}})"&gt;提交&lt;/button&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        {{/if}}
        {{#if (eq this.state 'published')}}
        &lt;button class="btn btn-secondary btn-sm" onclick="withdrawArticle({{this.id}})"&gt;撤回&lt;/button&gt;
        {{/if}}
      &lt;/td&gt;
    &lt;/tr&gt;
    {{/each}}
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;nav&gt;
  &lt;ul class="pagination"&gt;
    &lt;li class="page-item {{#if (eq page 1)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{dec page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;上一页&lt;/a&gt;
    &lt;/li&gt;
    {{#each (range 1 pageCount)}}
    &lt;li class="page-item {{#if (eq this ../page)}}active{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{this}}&amp;keyword={{../keyword}}&amp;limit={{../limit}}"&gt;{{this}}&lt;/a&gt;
    &lt;/li&gt;
    {{/each}}

    &lt;li class="page-item {{#if (eq page pageCount)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{inc page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;下一页&lt;/a&gt;
    &lt;/li&gt;
    &lt;li class="page-item"&gt;
      &lt;form method="GET" action="/admin/articles" class="d-inline-block ms-3"&gt;
        &lt;input type="hidden" name="keyword" value="{{keyword}}"&gt;
        &lt;input type="hidden" name="page" value="{{page}}"&gt;
        &lt;div class="input-group"&gt;
          &lt;input type="number" name="limit" class="form-control" placeholder="每页条数" value="{{limit}}" min="1"&gt;
          &lt;button class="btn btn-outline-secondary" type="submit"&gt;设置每页的条数&lt;/button&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;script&gt;
  function submitForReview(id) {
    if (confirm('确定要提交审核吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/submit`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('提交审核成功');
            location.reload();
          }
        },
        error: function (error) {
          alert('提交审核失败');
        }
      });
    }
  }

  function approveArticle(id) {
    if (confirm('确定要通过审核吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/approve`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('审核通过');
            location.reload();
          }
        },
        error: function (error) {
          alert('审核通过失败');
        }
      });
    }
  }

  function rejectArticle(id) {
    const rejectionReason = $(`#rejectionReason-${id}`).val();
    if (rejectionReason.trim() <span class="hljs-comment">=== '') {</span>
      alert('请填写审核不通过的原因');
      return;
    }
    $.ajax({
      url: `/admin/articles/${id}/reject`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify({ rejectionReason }),
      success: function (data) {
        if (data.success) {
          alert('审核不通过');
          location.reload();
        }
      },
      error: function (error) {
        alert('审核不通过失败');
      }
    });
  }
  function withdrawArticle(id) {
    if (confirm('确定要撤回这篇文章吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/withdraw`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('文章已撤回');
            location.reload();
          }
        },
        error: function (error) {
          alert('撤回文章失败');
        }
      });
    }
  }
  function deleteArticle(id) {
    if (confirm('确定要删除吗?')) {
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'DELETE',
        success: function (data) {
          if (data.success) {
            const params = new URLSearchParams(window.location.search);
            params.delete('page');
            params.append('page', 1)
            const query = params.toString();
            window.location = window.location.pathname + '?' + query;
          }
        }
      })
    }
  }
  $(function () {
<span class="hljs-addition">+   $('#exportPptBtn').click(function () {</span>
<span class="hljs-addition">+     window.location.href = `/admin/articles/export-ppt?page={{page}}&amp;search={{search}}&amp;limit={{limit}}`;</span>
<span class="hljs-addition">+   });</span>
    $('.sort-text').on('dblclick', function () {
      const $this = $(this);
      const id = $this.data('id');
      $this.addClass('d-none');
      $(`.sort-input[data-id="${id}"]`).removeClass('d-none').focus();
    });
    $('.sort-input').on('blur', function () {
      const $this = $(this);
      const id = $this.data('id');
      const newSort = $this.val();
      $this.addClass('d-none');
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ sort: newSort }),
        success: function (data) {
          if (data.success) {
            $(`.sort-text[data-id="${id}"]`).removeClass('d-none').text(newSort);
          }
        }
      })
    });
    $('.status-toggle').on('click', function () {
      const $this = $(this);
      const id = $this.data('id');
      const currentStatus = $this.data('status');
      const newStatus = currentStatus == 1 ? 0 : 1;
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function (data) {
          if (data.success) {
            $this.data('status', newStatus);
            $this.html(` &lt;i class="bi ${newStatus ? 'bi-check-circle-fill' : 'bi-x-circle-fill'} ${newStatus ? 'text-success' : 'text-danger'}"&gt;&lt;/i&gt;`);
          }
        }
      })
    });
  });
&lt;/script&gt;
</code></pre>
<h2 id="t5711.导出Excel">11.导出Excel <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5711.%E5%AF%BC%E5%87%BAExcel"> # </a></h2>
<pre><code class="lang-js">npm i exceljs
</code></pre>
<h3 id="t5811.1. excel-export.service.ts">11.1. excel-export.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5811.1.%20excel-export.service.ts"> # </a></h3>
<p>src/shared/services/excel-export.service.ts</p>
<pre><code class="lang-js"><span class="hljs-comment">// 导入 Injectable 装饰器，用于将服务类标记为可注入的依赖</span>
<span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-comment">// 导入 ExcelJS 库，用于创建和操作 Excel 文件</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> ExcelJS <span class="hljs-keyword">from</span> <span class="hljs-string">'exceljs'</span>;
@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExcelExportService</span> </span>{
    <span class="hljs-comment">// 异步方法，用于将数据导出为 Excel 文件</span>
    <span class="hljs-keyword">async</span> exportAsExcel(data: any[], <span class="hljs-attr">columns</span>: { <span class="hljs-attr">header</span>: string, <span class="hljs-attr">key</span>: string, <span class="hljs-attr">width</span>: number }[]) {
        <span class="hljs-comment">// 创建一个新的 Excel 工作簿</span>
        <span class="hljs-keyword">const</span> workbook = <span class="hljs-keyword">new</span> ExcelJS.Workbook();
        <span class="hljs-comment">// 添加一个新的工作表，并命名为 'Data'</span>
        <span class="hljs-keyword">const</span> worksheet = workbook.addWorksheet(<span class="hljs-string">'Data'</span>);
        <span class="hljs-comment">// 设置工作表的列，根据传入的列定义数组</span>
        worksheet.columns = columns;
        <span class="hljs-comment">// 遍历数据数组，将每一项数据作为一行添加到工作表中</span>
        data.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
            worksheet.addRow(item);
        });
        <span class="hljs-comment">// 将工作簿内容写入缓冲区，并返回该缓冲区（用于进一步处理或保存）</span>
        <span class="hljs-keyword">return</span> workbook.xlsx.writeBuffer();
    }
}
</code></pre>
<h3 id="t5911.2. shared.module.ts">11.2. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t5911.2.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
import { PptExportService } from './services/ppt-export.service';
<span class="hljs-addition">+import { ExcelExportService } from './services/excel-export.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t6011.3. article.controller.ts">11.3. article.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6011.3.%20article.controller.ts"> # </a></h3>
<p>src/admin/controllers/article.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render, Post, Redirect, Body, UseFilters, Param, ParseIntPipe, Put, Delete, Headers, Res, Query, NotFoundException, Header, StreamableFile } from '@nestjs/common';
import { CreateArticleDto, UpdateArticleDto } from 'src/shared/dto/article.dto';
import { ArticleService } from 'src/shared/services/article.service';
import { AdminExceptionFilter } from '../filters/admin-exception-filter';
import { Response } from 'express';
import { ParseOptionalIntPipe } from 'src/shared/pipes/parse-optional-int.pipe';
import { CategoryService } from 'src/shared/services/category.service';
import { TagService } from 'src/shared/services/tag.service';
import { ArticleStateEnum } from 'src/shared/enums/article.enum';
import { EventEmitter2 } from '@nestjs/event-emitter';
import { WordExportService } from 'src/shared/services/word-export.service';
import { PptExportService } from 'src/shared/services/ppt-export.service';
<span class="hljs-addition">+import { ExcelExportService } from 'src/shared/services/excel-export.service';</span>
@UseFilters(AdminExceptionFilter)
@Controller('admin/articles')
export class ArticleController {
    constructor(
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService,
        private readonly eventEmitter: EventEmitter2,
        private readonly wordExportService: WordExportService,
<span class="hljs-addition">+       private readonly pptExportService: PptExportService,</span>
<span class="hljs-addition">+       private readonly excelExportService: ExcelExportService,</span>
    ) { }
<span class="hljs-addition">+   @Get('export-excel')</span>
<span class="hljs-addition">+   @Header('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')</span>
<span class="hljs-addition">+   async exportExcel(@Query('search') search: string = '', @Query('page', new ParseOptionalIntPipe(1)) page: number, @Query('limit', new ParseOptionalIntPipe(10)) limit: number, @Res({ passthrough: true }) res: Response) {</span>
<span class="hljs-addition">+       const { articles } = await this.articleService.findAllWithPagination(page, limit, search);</span>
<span class="hljs-addition">+       const data = articles.map(article =&gt; ({</span>
<span class="hljs-addition">+           title: article.title,</span>
<span class="hljs-addition">+           categories: article.categories.map(c =&gt; c.name).join(', '),</span>
<span class="hljs-addition">+           tags: article.tags.map(t =&gt; t.name).join(', '),</span>
<span class="hljs-addition">+           state: article.state,</span>
<span class="hljs-addition">+           createdAt: article.createdAt,</span>
<span class="hljs-addition">+       }));</span>
<span class="hljs-addition">+       const columns = [</span>
<span class="hljs-addition">+           { header: '标题', key: 'title', width: 30 },</span>
<span class="hljs-addition">+           { header: '分类', key: 'categories', width: 20 },</span>
<span class="hljs-addition">+           { header: '标签', key: 'tags', width: 20 },</span>
<span class="hljs-addition">+           { header: '状态', key: 'state', width: 15 },</span>
<span class="hljs-addition">+           { header: '创建时间', key: 'createdAt', width: 20 },</span>
<span class="hljs-addition">+       ];</span>
<span class="hljs-addition">+       const buffer = await this.excelExportService.exportAsExcel(data, columns);</span>
<span class="hljs-addition">+       res.setHeader('Content-Disposition', `attachment; filename="articles.xlsx"`);</span>
<span class="hljs-addition">+       return new StreamableFile(new Uint8Array(buffer));</span>
<span class="hljs-addition">+   }</span>
    @Get(':id/export-word')
    @Header('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')
    async exportWord(@Param('id', ParseIntPipe) id: number, @Res({ passthrough: true }) res: Response) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not found');
        const htmlContent = `
            &lt;h1&gt;${article.title}&lt;/h1&gt;
            &lt;p&gt;&lt;strong&gt;状态:&lt;/strong&gt; ${article.state}&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;分类:&lt;/strong&gt; ${article.categories.map(c =&gt; c.name).join(', ')}&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;标签:&lt;/strong&gt; ${article.tags.map(t =&gt; t.name).join(', ')}&lt;/p&gt;
            &lt;hr/&gt;
            ${article.content}
        `;

        const buffer = await this.wordExportService.exportToWord(htmlContent);
        res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(article.title)}.docx"`);
        return new StreamableFile(buffer);
    }

    @Get('export-ppt')
    @Header('Content-Type', 'application/vnd.openxmlformats-officedocument.presentationml.presentation')
    async exportPpt(@Query('search') search: string = '', @Query('page', new ParseOptionalIntPipe(1)) page: number, @Query('limit', new ParseOptionalIntPipe(10)) limit: number, @Res({ passthrough: true }) res: Response) {
        const { articles } = await this.articleService.findAllWithPagination(page, limit, search);
        const buffer = await this.pptExportService.exportToPpt(articles);
        res.setHeader('Content-Disposition', 'attachment; filename=articles.pptx');
        return new StreamableFile(buffer);
    }
    @Get()
    @Render('article/article-list')
    async findAll(@Query('keyword') keyword: string = '',
        @Query('page', new ParseOptionalIntPipe(1)) page: number,
        @Query('limit', new ParseOptionalIntPipe(10)) limit: number) {
        const { articles, total } = await this.articleService.findAllWithPagination(page, limit, keyword);
        const pageCount = Math.ceil(total / limit);
        return { articles, keyword, page, limit, pageCount };
    }
    @Get('create')
    @Render('article/article-form')
    async createForm() {
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article: { categories: [], tags: [] }, categoryTree, tags };
    }
    @Post()
    @Redirect('/admin/articles')
    async create(@Body() createArticleDto: CreateArticleDto) {
        await this.articleService.create(createArticleDto);
        return { success: true }
    }
    @Get(':id/edit')
    @Render('article/article-form')
    async editForm(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        const categoryTree = await this.categoryService.findAll();
        const tags = await this.tagService.findAll();
        return { article, categoryTree, tags };
    }
    @Put(':id')
    async update(@Param('id', ParseIntPipe) id: number, @Body() updateArticleDto: UpdateArticleDto, @Res({ passthrough: true }) res: Response, @Headers('accept') accept: string) {
        updateArticleDto.state = ArticleStateEnum.DRAFT;
        await this.articleService.update(id, updateArticleDto);
        if (accept <span class="hljs-comment">=== 'application/json') {</span>
            return { success: true };
        } else {
            return res.redirect(`/admin/articles`);
        }
    }
    @Delete(":id")
    async delete(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.delete(id);
        return { success: true }
    }
    @Get(':id')
    @Render('article/article-detail')
    async findOne(@Param('id', ParseIntPipe) id: number) {
        const article = await this.articleService.findOne({ where: { id }, relations: ['categories', 'tags'] });
        if (!article) throw new NotFoundException('Article not Found');
        return { article };
    }

    @Put(':id/submit')
    async submitForReview(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PENDING });
        this.eventEmitter.emit('article.submitted', { articleId: id });
        return { success: true };
    }

    @Put(':id/approve')
    async approveArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.PUBLISHED, rejectionReason: null });
        return { success: true };
    }

    @Put(':id/reject')
    async rejectArticle(
        @Param('id', ParseIntPipe) id: number,
        @Body('rejectionReason') rejectionReason: string
    ) {
        await this.articleService.update(id, { state: ArticleStateEnum.REJECTED, rejectionReason });
        return { success: true };
    }

    @Put(':id/withdraw')
    async withdrawArticle(@Param('id', ParseIntPipe) id: number) {
        await this.articleService.update(id, { state: ArticleStateEnum.WITHDRAWN });
        return { success: true };
    }
}

</code></pre>
<h3 id="t6111.4. article-list.hbs">11.4. article-list.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6111.4.%20article-list.hbs"> # </a></h3>
<p>views/article/article-list.hbs</p>
<pre><code class="lang-diff">&lt;h1&gt;
  文章列表
&lt;/h1&gt;
&lt;a href="/admin/articles/create" class="btn btn-success btn-sm mb-3"&gt;添加文章&lt;/a&gt;
&lt;button id="exportPptBtn" class="btn btn-warning btn-sm mb-3"&gt;导出PPT&lt;/button&gt;
<span class="hljs-addition">+&lt;button id="frontExportBtn" class="btn btn-info btn-sm mb-3"&gt;前台导出Excel&lt;/button&gt;</span>
<span class="hljs-addition">+&lt;button id="backendExportBtn" class="btn btn-info btn-sm mb-3"&gt;后台导出Excel&lt;/button&gt;</span>
&lt;form method="GET" action="/admin/articles" class="mb-3"&gt;
  &lt;div class="input-group"&gt;
    &lt;input type="text" name="keyword" class="form-control" placeholder="请输入搜索关键字" value="{{keyword}}"&gt;
    &lt;button class="btn btn-outline-secondary"&gt;搜索&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;
<span class="hljs-addition">+&lt;table class="table" id="articleTable"&gt;</span>
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;标题&lt;/th&gt;
      &lt;th&gt;分类&lt;/th&gt;
      &lt;th&gt;标签&lt;/th&gt;
      &lt;th&gt;文章状态&lt;/th&gt;
<span class="hljs-addition">+     &lt;th&gt;状态&lt;/th&gt;</span>
<span class="hljs-addition">+     &lt;th&gt;排序&lt;/th&gt;</span>
<span class="hljs-addition">+     &lt;th&gt;操作&lt;/th&gt;</span>
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    {{#each articles}}
    &lt;tr&gt;
      &lt;td&gt;{{this.title}}&lt;/td&gt;
      &lt;td&gt;
        {{#each this.categories}}
        &lt;span class="badge bg-secondary"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
      &lt;/td&gt;
      &lt;td&gt;
        {{#each this.tags}}
        &lt;span class="badge bg-info text-dark"&gt;{{this.name}}&lt;/span&gt;
        {{/each}}
      &lt;/td&gt;
      &lt;td&gt;
        {{#if (eq this.state 'draft')}}
        &lt;span class="badge bg-secondary"&gt;草稿&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'pending')}}
        &lt;span class="badge bg-warning text-dark"&gt;待审核&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'published')}}
        &lt;span class="badge bg-success"&gt;已发布&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'rejected')}}
        &lt;span class="badge bg-danger"&gt;审核不通过&lt;/span&gt;
        {{/if}}

        {{#if (eq this.state 'withdrawn')}}
        &lt;span class="badge bg-dark"&gt;已撤回&lt;/span&gt;
        {{/if}}
      &lt;/td&gt;
      &lt;td&gt;
        &lt;span class="status-toggle" data-id="{{this.id}}" data-status="{{this.status}}"&gt;
          {{#if this.status}}
          &lt;i class="bi bi-check-circle-fill text-success"&gt;&lt;/i&gt;
          {{else}}
          &lt;i class="bi bi-x-circle-fill text-danger"&gt;&lt;/i&gt;
          {{/if}}
        &lt;/span&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;span class="sort-text" data-id="{{this.id}}"&gt;{{this.sort}}&lt;/span&gt;
        &lt;input type="number" class="form-control sort-input d-none" style="width:50%" data-id="{{this.id}}"
          value="{{this.sort}}"&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;a href="/admin/articles/{{this.id}}" class="btn btn-primary btn-sm"&gt;查看&lt;/a&gt;
        &lt;a href="/admin/articles/{{this.id}}/edit" class="btn btn-warning btn-sm"&gt;修改&lt;/a&gt;
        &lt;a class="btn btn-danger btn-sm" onclick="deleteArticle({{this.id}})"&gt;删除&lt;/a&gt;
        {{#if (eq this.state 'draft')}}
        &lt;button class="btn btn-warning btn-sm" onclick="submitForReview({{this.id}})"&gt;提交审核&lt;/button&gt;
        {{/if}}
        {{#if (eq this.state 'pending')}}
        &lt;button class="btn btn-success btn-sm" onclick="approveArticle({{this.id}})"&gt;审核通过&lt;/button&gt;
        &lt;button class="btn btn-danger btn-sm" data-bs-toggle="modal"
          data-bs-target="#rejectModal-{{this.id}}"&gt;审核不通过&lt;/button&gt;
        &lt;div class="modal fade" id="rejectModal-{{this.id}}" tabindex="-1"&gt;
          &lt;div class="modal-dialog"&gt;
            &lt;div class="modal-content"&gt;
              &lt;div class="modal-header"&gt;
                &lt;h5 class="modal-title"&gt;审核不通过&lt;/h5&gt;
                &lt;button type="button" class="btn-close" data-bs-dismiss="modal"&gt;&lt;/button&gt;
              &lt;/div&gt;
              &lt;div class="modal-body"&gt;
                &lt;div class="mb-3"&gt;
                  &lt;label for="rejectionReason-{{this.id}}" class="form-label"&gt;不通过原因&lt;/label&gt;
                  &lt;textarea class="form-control" id="rejectionReason-{{this.id}}" name="rejectionReason"
                    rows="3"&gt;&lt;/textarea&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;div class="modal-footer"&gt;
                &lt;button type="button" class="btn btn-secondary" data-bs-dismiss="modal"&gt;取消&lt;/button&gt;
                &lt;button type="button" class="btn btn-danger" onclick="rejectArticle({{this.id}})"&gt;提交&lt;/button&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        {{/if}}
        {{#if (eq this.state 'published')}}
        &lt;button class="btn btn-secondary btn-sm" onclick="withdrawArticle({{this.id}})"&gt;撤回&lt;/button&gt;
        {{/if}}
      &lt;/td&gt;
    &lt;/tr&gt;
    {{/each}}
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;nav&gt;
  &lt;ul class="pagination"&gt;
    &lt;li class="page-item {{#if (eq page 1)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{dec page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;上一页&lt;/a&gt;
    &lt;/li&gt;
    {{#each (range 1 pageCount)}}
    &lt;li class="page-item {{#if (eq this ../page)}}active{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{this}}&amp;keyword={{../keyword}}&amp;limit={{../limit}}"&gt;{{this}}&lt;/a&gt;
    &lt;/li&gt;
    {{/each}}

    &lt;li class="page-item {{#if (eq page pageCount)}}disabled{{/if}}"&gt;
      &lt;a class="page-link" href="?page={{inc page}}&amp;keyword={{keyword}}&amp;limit={{limit}}"&gt;下一页&lt;/a&gt;
    &lt;/li&gt;
    &lt;li class="page-item"&gt;
      &lt;form method="GET" action="/admin/articles" class="d-inline-block ms-3"&gt;
        &lt;input type="hidden" name="keyword" value="{{keyword}}"&gt;
        &lt;input type="hidden" name="page" value="{{page}}"&gt;
        &lt;div class="input-group"&gt;
          &lt;input type="number" name="limit" class="form-control" placeholder="每页条数" value="{{limit}}" min="1"&gt;
          &lt;button class="btn btn-outline-secondary" type="submit"&gt;设置每页的条数&lt;/button&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;script&gt;
  function submitForReview(id) {
    if (confirm('确定要提交审核吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/submit`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('提交审核成功');
            location.reload();
          }
        },
        error: function (error) {
          alert('提交审核失败');
        }
      });
    }
  }

  function approveArticle(id) {
    if (confirm('确定要通过审核吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/approve`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('审核通过');
            location.reload();
          }
        },
        error: function (error) {
          alert('审核通过失败');
        }
      });
    }
  }

  function rejectArticle(id) {
    const rejectionReason = $(`#rejectionReason-${id}`).val();
    if (rejectionReason.trim() <span class="hljs-comment">=== '') {</span>
      alert('请填写审核不通过的原因');
      return;
    }
    $.ajax({
      url: `/admin/articles/${id}/reject`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify({ rejectionReason }),
      success: function (data) {
        if (data.success) {
          alert('审核不通过');
          location.reload();
        }
      },
      error: function (error) {
        alert('审核不通过失败');
      }
    });
  }
  function withdrawArticle(id) {
    if (confirm('确定要撤回这篇文章吗？')) {
      $.ajax({
        url: `/admin/articles/${id}/withdraw`,
        type: 'PUT',
        success: function (data) {
          if (data.success) {
            alert('文章已撤回');
            location.reload();
          }
        },
        error: function (error) {
          alert('撤回文章失败');
        }
      });
    }
  }
  function deleteArticle(id) {
    if (confirm('确定要删除吗?')) {
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'DELETE',
        success: function (data) {
          if (data.success) {
            const params = new URLSearchParams(window.location.search);
            params.delete('page');
            params.append('page', 1)
            const query = params.toString();
            window.location = window.location.pathname + '?' + query;
          }
        }
      })
    }
  }
  $(function () {
<span class="hljs-addition">+   // 当用户点击 ID 为 backendExportBtn 的按钮时，触发事件处理函数</span>
<span class="hljs-addition">+   $('#backendExportBtn').click(function () {</span>
<span class="hljs-addition">+     // 将浏览器的窗口位置重定向到指定的导出 Excel 文件的 URL</span>
<span class="hljs-addition">+     // URL 中包含当前页面、搜索条件和限制参数</span>
<span class="hljs-addition">+     window.location.href = `/admin/articles/export-excel?page={{page}}&amp;search={{search}}&amp;limit={{limit}}`;</span>
<span class="hljs-addition">+   });</span>

<span class="hljs-addition">+   // 当用户点击 ID 为 frontExportBtn 的按钮时，触发事件处理函数</span>
<span class="hljs-addition">+   $('#frontExportBtn').click(function () {</span>
<span class="hljs-addition">+     // 初始化一个空的字符串，用于存储 CSV 文件内容</span>
<span class="hljs-addition">+     let csvContent = '';</span>

<span class="hljs-addition">+     // 遍历表格的表头行（thead 中的所有 tr），生成 CSV 文件的表头内容</span>
<span class="hljs-addition">+     $('#articleTable thead tr').each(function () {</span>
<span class="hljs-addition">+       let rowContent = ''; // 初始化空字符串，用于存储当前行的内容</span>
<span class="hljs-addition">+       let cells = $(this).find('th'); // 获取当前行中的所有 th 单元格</span>
<span class="hljs-addition">+       cells.each(function (index) {</span>
<span class="hljs-addition">+         if (index &lt; cells.length - 1) { // 遍历时排除最后一列（假设不需要导出）</span>
<span class="hljs-addition">+           rowContent += $(this).text().trim() + ','; // 将单元格文本内容加入行内容，并用逗号分隔</span>
<span class="hljs-addition">+         }</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+       csvContent += rowContent.slice(0, -1) + '\n'; // 移除最后一个多余的逗号并添加换行符</span>
<span class="hljs-addition">+     });</span>

<span class="hljs-addition">+     // 遍历表格的主体行（tbody 中的所有 tr），生成 CSV 文件的表格内容</span>
<span class="hljs-addition">+     $('#articleTable tbody tr').each(function () {</span>
<span class="hljs-addition">+       let rowContent = ''; // 初始化空字符串，用于存储当前行的内容</span>
<span class="hljs-addition">+       let cells = $(this).find('td'); // 获取当前行中的所有 td 单元格</span>
<span class="hljs-addition">+       cells.each(function (index) {</span>
<span class="hljs-addition">+         if (index &lt; cells.length - 1) { // 遍历时排除最后一列（假设不需要导出）</span>
<span class="hljs-addition">+           rowContent += $(this).text().trim().replace(/,/g, '') + ','; // 将单元格文本内容加入行内容，并用逗号分隔，替换掉内容中的逗号以避免干扰 CSV 格式</span>
<span class="hljs-addition">+         }</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+       csvContent += rowContent.slice(0, -1) + '\n'; // 移除最后一个多余的逗号并添加换行符</span>
<span class="hljs-addition">+     });</span>

<span class="hljs-addition">+     // 创建一个 Blob 对象，包含生成的 CSV 内容，类型为 text/csv，并设置字符编码为 UTF-8</span>
<span class="hljs-addition">+     let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });</span>

<span class="hljs-addition">+     // 创建一个指向 Blob 对象的 URL</span>
<span class="hljs-addition">+     let url = URL.createObjectURL(blob);</span>

<span class="hljs-addition">+     // 创建一个隐藏的 &lt;a&gt; 元素，并设置其 href 属性为 Blob URL，设置下载文件名为 articles.csv</span>
<span class="hljs-addition">+     let link = $('&lt;a&gt;').attr({</span>
<span class="hljs-addition">+       href: url,</span>
<span class="hljs-addition">+       download: 'articles.csv'</span>
<span class="hljs-addition">+     }).appendTo('body'); // 将链接元素临时添加到文档的 body 中</span>

<span class="hljs-addition">+     // 模拟点击 &lt;a&gt; 元素以触发下载</span>
<span class="hljs-addition">+     link[0].click();</span>

<span class="hljs-addition">+     // 移除临时添加的 &lt;a&gt; 元素</span>
<span class="hljs-addition">+     link.remove();</span>
<span class="hljs-addition">+   });</span>
    $('#exportPptBtn').click(function () {
      window.location.href = `/admin/articles/export-ppt?page={{page}}&amp;search={{search}}&amp;limit={{limit}}`;
    });
    $('.sort-text').on('dblclick', function () {
      const $this = $(this);
      const id = $this.data('id');
      $this.addClass('d-none');
      $(`.sort-input[data-id="${id}"]`).removeClass('d-none').focus();
    });
    $('.sort-input').on('blur', function () {
      const $this = $(this);
      const id = $this.data('id');
      const newSort = $this.val();
      $this.addClass('d-none');
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ sort: newSort }),
        success: function (data) {
          if (data.success) {
            $(`.sort-text[data-id="${id}"]`).removeClass('d-none').text(newSort);
          }
        }
      })
    });
    $('.status-toggle').on('click', function () {
      const $this = $(this);
      const id = $this.data('id');
      const currentStatus = $this.data('status');
      const newStatus = currentStatus == 1 ? 0 : 1;
      $.ajax({
        url: `/admin/articles/${id}`,
        type: 'PUT',
        headers: { 'accept': 'application/json' },
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function (data) {
          if (data.success) {
            $this.data('status', newStatus);
            $this.html(` &lt;i class="bi ${newStatus ? 'bi-check-circle-fill' : 'bi-x-circle-fill'} ${newStatus ? 'text-success' : 'text-danger'}"&gt;&lt;/i&gt;`);
          }
        }
      })
    });
  });
&lt;/script&gt;
</code></pre>
<h2 id="t6212.网站设置">12.网站设置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6212.%E7%BD%91%E7%AB%99%E8%AE%BE%E7%BD%AE"> # </a></h2>
<pre><code class="lang-js">npm install mongoose @nestjs/mongoose
</code></pre>
<h3 id="t6312.1. dashboard.controller.ts">12.1. dashboard.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6312.1.%20dashboard.controller.ts"> # </a></h3>
<p>src/admin/controllers/dashboard.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render } from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
<span class="hljs-addition">+@Controller('admin')</span>
@ApiTags('dashboard')
export class DashboardController {
<span class="hljs-addition">+   @Get('dashboard')</span>
    @Render('dashboard')
    dashboard() {
        return { title: 'dashboard' };
    }
}

</code></pre>
<h3 id="t6412.2. setting.dto.ts">12.2. setting.dto.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6412.2.%20setting.dto.ts"> # </a></h3>
<p>src/shared/dto/setting.dto.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { ApiProperty } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;
<span class="hljs-keyword">import</span> { PartialType } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mapped-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateSettingDto</span> </span>{
    @ApiProperty({ <span class="hljs-attr">description</span>: <span class="hljs-string">'网站名称'</span>, <span class="hljs-attr">example</span>: <span class="hljs-string">'我的网站'</span> })
    <span class="hljs-attr">siteName</span>: string;

    @ApiProperty({ <span class="hljs-attr">description</span>: <span class="hljs-string">'网站描述'</span>, <span class="hljs-attr">example</span>: <span class="hljs-string">'这是我的个人网站'</span> })
    <span class="hljs-attr">siteDescription</span>: string;

    @ApiProperty({ <span class="hljs-attr">description</span>: <span class="hljs-string">'联系邮箱'</span>, <span class="hljs-attr">example</span>: <span class="hljs-string">'contact@example.com'</span> })
    <span class="hljs-attr">contactEmail</span>: string;
}

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateSettingDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PartialType</span>(<span class="hljs-title">CreateSettingDto</span>) </span>{
    <span class="hljs-attr">id</span>: string
}

</code></pre>
<h3 id="t6512.3. setting.schema.ts">12.3. setting.schema.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6512.3.%20setting.schema.ts"> # </a></h3>
<p>src/shared/schemas/setting.schema.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Prop, Schema, SchemaFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;
<span class="hljs-keyword">import</span> { HydratedDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;
<span class="hljs-keyword">export</span> type SettingDocument = HydratedDocument&lt;Setting&gt;;
@Schema()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Setting</span> </span>{
    <span class="hljs-attr">id</span>: string;
    @Prop({ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> })
    <span class="hljs-attr">siteName</span>: string;
    @Prop()
    <span class="hljs-attr">siteDescription</span>: string;
    @Prop()
    <span class="hljs-attr">contactEmail</span>: string;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> SettingSchema = SchemaFactory.createForClass(Setting);
SettingSchema.virtual(<span class="hljs-string">'id'</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._id.toHexString();
});
SettingSchema.set(<span class="hljs-string">'toJSON'</span>, { <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> });
SettingSchema.set(<span class="hljs-string">'toObject'</span>, { <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> });

</code></pre>
<h3 id="t6612.4. setting.service.ts">12.4. setting.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6612.4.%20setting.service.ts"> # </a></h3>
<p>src/shared/services/setting.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { InjectModel } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;
<span class="hljs-keyword">import</span> { Model } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;
<span class="hljs-keyword">import</span> { SettingDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">'../schemas/setting.schema'</span>;
<span class="hljs-keyword">import</span> { CreateSettingDto, UpdateSettingDto } <span class="hljs-keyword">from</span> <span class="hljs-string">'../dto/setting.dto'</span>;
<span class="hljs-keyword">import</span> { MongoDBBaseService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./mongodb-base.service'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SettingService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoDBBaseService</span>&lt;<span class="hljs-title">SettingDocument</span>, <span class="hljs-title">CreateSettingDto</span>, <span class="hljs-title">UpdateSettingDto</span>&gt; </span>{
    <span class="hljs-keyword">constructor</span>(@InjectModel('Setting') settingModel: Model&lt;SettingDocument&gt;) {
        <span class="hljs-keyword">super</span>(settingModel);
    }
    <span class="hljs-keyword">async</span> findFirst(): <span class="hljs-built_in">Promise</span>&lt;SettingDocument&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model.findOne().exec();
    }
}

</code></pre>
<h3 id="t6712.5. mongodb-base.service.ts">12.5. mongodb-base.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6712.5.%20mongodb-base.service.ts"> # </a></h3>
<p>src/shared/services/mongodb-base.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Model } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;
<span class="hljs-keyword">export</span> abstract <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoDBBaseService</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">C</span>, <span class="hljs-title">U</span>&gt; </span>{
    <span class="hljs-keyword">constructor</span>(
        protected readonly model: Model&lt;T&gt;,
    ) { }

    <span class="hljs-keyword">async</span> findAll() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.model.find();
    }

    <span class="hljs-keyword">async</span> findOne(id: string) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.model.findById(id);
    }

    <span class="hljs-keyword">async</span> create(createDto: C) {
        <span class="hljs-keyword">const</span> createdEntity = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.model(createDto);
        <span class="hljs-keyword">await</span> createdEntity.save();
        <span class="hljs-keyword">return</span> createdEntity;
    }

    <span class="hljs-keyword">async</span> update(id: string, <span class="hljs-attr">updateDto</span>: U) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.model.findByIdAndUpdate(id, updateDto, { <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span> });
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">delete</span>(id: string) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.model.findByIdAndDelete(id);
    }
}

</code></pre>
<h3 id="t6812.6. admin.module.ts">12.6. admin.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6812.6.%20admin.module.ts"> # </a></h3>
<p>src/admin/admin.module.ts</p>
<pre><code class="lang-diff">import { Module } from '@nestjs/common';
import { DashboardController } from './controllers/dashboard.controller';
import { UserController } from './controllers/user.controller';
import { RoleController } from "./controllers/role.controller";
import { AccessController } from "./controllers/access.controller";
<span class="hljs-addition">+import { TagController } from "./controllers/tag.controller";</span>
<span class="hljs-addition">+import { ArticleController } from "./controllers/article.controller";</span>
<span class="hljs-addition">+import { CategoryController } from "./controllers/category.controller";</span>
<span class="hljs-addition">+import { UploadController } from './controllers/upload.controller';</span>
<span class="hljs-addition">+import { SettingController } from './controllers/setting.controller';</span>
<span class="hljs-addition">+@Module({</span>
<span class="hljs-addition">+   controllers: [DashboardController, UserController, RoleController, AccessController, TagController, ArticleController, CategoryController, UploadController, SettingController]</span>
<span class="hljs-addition">+})</span>
<span class="hljs-addition">+export class AdminModule {</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t6912.7. settings.hbs">12.7. settings.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t6912.7.%20settings.hbs"> # </a></h3>
<p>views/settings.hbs</p>
<pre><code class="lang-js">&lt;form action=<span class="hljs-string">"/admin/settings"</span> method=<span class="hljs-string">"post"</span>&gt;
    &lt;input type="hidden" name="id" value="{{settings.id}}"&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="siteName" class="form-label"&gt;网站名称&lt;/label&gt;
        &lt;input type="text" class="form-control" id="siteName" name="siteName" value="{{settings.siteName}}" required&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="siteDescription" class="form-label"&gt;网站描述&lt;/label&gt;
        &lt;input type="text" class="form-control" id="siteDescription" name="siteDescription"
            value="{{settings.siteDescription}}" required&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="contactEmail" class="form-label"&gt;联系邮箱&lt;/label&gt;
        &lt;input type="email" class="form-control" id="contactEmail" name="contactEmail" value="{{settings.contactEmail}}"
            required&gt;
    &lt;/div&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;保存设置&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<h3 id="t7012.8. setting.controller.ts">12.8. setting.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7012.8.%20setting.controller.ts"> # </a></h3>
<p>src/admin/controllers/setting.controller.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Controller, Get, Post, Body, Render, Redirect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { SettingService } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/services/setting.service'</span>;
<span class="hljs-keyword">import</span> { UpdateSettingDto } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/dto/setting.dto'</span>;

@Controller(<span class="hljs-string">'admin/settings'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SettingController</span> </span>{
    <span class="hljs-keyword">constructor</span>(private readonly settingService: SettingService) { }

    @Get()
    @Render(<span class="hljs-string">'settings'</span>)
    <span class="hljs-keyword">async</span> getSettings() {
        <span class="hljs-keyword">let</span> settings = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.settingService.findFirst();
        <span class="hljs-keyword">if</span> (!settings) {
            settings = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.settingService.create({
                <span class="hljs-attr">siteName</span>: <span class="hljs-string">'默认网站名称'</span>,
                <span class="hljs-attr">siteDescription</span>: <span class="hljs-string">'默认网站描述'</span>,
                <span class="hljs-attr">contactEmail</span>: <span class="hljs-string">'default@example.com'</span>,
            });
        }
        <span class="hljs-keyword">return</span> { settings };
    }

    @Post()
    @Redirect(<span class="hljs-string">'/admin/dashboard'</span>)
    <span class="hljs-keyword">async</span> updateSettings(@Body() updateSettingDto: UpdateSettingDto) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.settingService.update(updateSettingDto.id, updateSettingDto);
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
    }
}

</code></pre>
<h3 id="t7112.9. configuration.service.ts">12.9. configuration.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7112.9.%20configuration.service.ts"> # </a></h3>
<p>src/shared/services/configuration.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from "@nestjs/common";
import { ConfigService } from "@nestjs/config";
@Injectable()
export class ConfigurationService {
    constructor(private configService: ConfigService) { }
    get mysqlHost(): string {
        return this.configService.get&lt;string&gt;('MYSQL_HOST');
    }
    get mysqlPort(): number {
        return this.configService.get&lt;number&gt;('MYSQL_PORT');
    }
    get mysqlDB(): string {
        return this.configService.get&lt;string&gt;('MYSQL_DB');
    }
    get mysqlUser(): string {
        return this.configService.get&lt;string&gt;('MYSQL_USER');
    }
    get mysqlPassword(): string {
        return this.configService.get&lt;string&gt;('MYSQL_PASSWORD');
    }
    get mysqlConfig() {
        return {
            host: this.mysqlHost,
            port: this.mysqlPort,
            database: this.mysqlDB,
            username: this.mysqlUser,
            password: this.mysqlPassword
        }
    }
<span class="hljs-addition">+   get mongodbHost(): string {</span>
<span class="hljs-addition">+       return this.configService.get&lt;string&gt;('MONGO_HOST');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get mongodbPort(): number {</span>
<span class="hljs-addition">+       return this.configService.get&lt;number&gt;('MONGO_PORT');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get mongodbDB(): string {</span>
<span class="hljs-addition">+       return this.configService.get&lt;string&gt;('MONGO_DB');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get mongodbUser(): string {</span>
<span class="hljs-addition">+       return this.configService.get&lt;string&gt;('MONGO_USER');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get mongodbPassword(): string {</span>
<span class="hljs-addition">+       return this.configService.get&lt;string&gt;('MONGO_PASSWORD');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get mongodbConfig() {</span>
<span class="hljs-addition">+       return {</span>
<span class="hljs-addition">+           uri: `mongodb://${this.mongodbHost}:${this.mongodbPort}/${this.mongodbDB}`</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
}
</code></pre>
<h3 id="t7212.10. sidebar.hbs">12.10. sidebar.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7212.10.%20sidebar.hbs"> # </a></h3>
<p>views/partials/sidebar.hbs</p>
<pre><code class="lang-diff">&lt;div class="col-md-3 col-lg-2 p-0"&gt;
<span class="hljs-addition">+   &lt;div class="accordion" id="sidebarMenu"&gt;</span>
        &lt;div class="accordion-item"&gt;
            &lt;h2 class="accordion-header" id="heading"&gt;
<span class="hljs-addition">+               &lt;button class="accordion-button" type="button" data-bs-toggle="collapse"</span>
<span class="hljs-addition">+                   data-bs-target="#collapse1"&gt;权限管理&lt;/button&gt;</span>
            &lt;/h2&gt;
            &lt;div class="accordion-collapse collapse" id="collapse1"&gt;
                &lt;div class="accordion-body"&gt;
                    &lt;ul class="list-group"&gt;
                        &lt;li class="list-group-item"&gt;
                            &lt;a href="/admin/users"&gt;用户管理&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="list-group-item"&gt;
                            &lt;a href="/admin/roles"&gt;角色管理&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="list-group-item"&gt;
                            &lt;a href="/admin/accesses"&gt;资源管理&lt;/a&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
<span class="hljs-addition">+           &lt;h2 class="accordion-header" id="heading"&gt;</span>
<span class="hljs-addition">+               &lt;button class="accordion-button" type="button" data-bs-toggle="collapse"</span>
<span class="hljs-addition">+                   data-bs-target="#collapse1"&gt;内容管理&lt;/button&gt;</span>
            &lt;/h2&gt;
            &lt;div class="accordion-collapse collapse" id="collapse1"&gt;
                &lt;div class="accordion-body"&gt;
                    &lt;ul class="list-group"&gt;
                        &lt;li class="list-group-item"&gt;
                            &lt;a href="/admin/tags"&gt;标签管理&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="list-group-item"&gt;
                            &lt;a href="/admin/categories"&gt;分类管理&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="list-group-item"&gt;
                            &lt;a href="/admin/articles"&gt;文章管理&lt;/a&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
<span class="hljs-addition">+           &lt;h2 class="accordion-header" id="heading"&gt;</span>
<span class="hljs-addition">+               &lt;button class="accordion-button" type="button" data-bs-toggle="collapse"</span>
<span class="hljs-addition">+                   data-bs-target="#collapse1"&gt;设置&lt;/button&gt;</span>
<span class="hljs-addition">+           &lt;/h2&gt;</span>
<span class="hljs-addition">+           &lt;div class="accordion-collapse collapse" id="collapse1"&gt;</span>
<span class="hljs-addition">+               &lt;div class="accordion-body"&gt;</span>
<span class="hljs-addition">+                   &lt;ul class="list-group"&gt;</span>
<span class="hljs-addition">+                       &lt;li class="list-group-item"&gt;</span>
<span class="hljs-addition">+                           &lt;a href="/admin/settings"&gt;网站设置&lt;/a&gt;</span>
<span class="hljs-addition">+                       &lt;/li&gt;</span>
<span class="hljs-addition">+                   &lt;/ul&gt;</span>
<span class="hljs-addition">+               &lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
        &lt;/div&gt;
<span class="hljs-addition">+   &lt;/div&gt;</span>
&lt;/div&gt;
</code></pre>
<h3 id="t7312.11. shared.module.ts">12.11. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7312.11.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
import { PptExportService } from './services/ppt-export.service';
import { ExcelExportService } from './services/excel-export.service';
<span class="hljs-addition">+import { MongooseModule } from '@nestjs/mongoose';</span>
<span class="hljs-addition">+import { Setting, SettingSchema } from './schemas/setting.schema';</span>
<span class="hljs-addition">+import { SettingService } from './services/setting.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
<span class="hljs-addition">+       MongooseModule.forRootAsync({</span>
<span class="hljs-addition">+           inject: [ConfigurationService],</span>
<span class="hljs-addition">+           useFactory: (configurationService: ConfigurationService) =&gt; ({</span>
<span class="hljs-addition">+               uri: configurationService.mongodbConfig.uri</span>
<span class="hljs-addition">+           }),</span>
<span class="hljs-addition">+       }),</span>
<span class="hljs-addition">+       MongooseModule.forFeature([</span>
<span class="hljs-addition">+           { name: Setting.name, schema: SettingSchema },</span>
<span class="hljs-addition">+       ]),</span>
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h2 id="t7413. 快捷操作">13. 快捷操作 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7413.%20%E5%BF%AB%E6%8D%B7%E6%93%8D%E4%BD%9C"> # </a></h2>
<h3 id="t7513.1. header.hbs">13.1. header.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7513.1.%20header.hbs"> # </a></h3>
<p>views/partials/header.hbs</p>
<pre><code class="lang-diff">&lt;nav class="navbar navbar-expand-lg bg-light"&gt;
    &lt;div class="container-fluid"&gt;
<span class="hljs-addition">+       &lt;a class="navbar-brand" href="/admin/dashboard"&gt;CMS&lt;/a&gt;</span>
        &lt;div class="collapse navbar-collapse"&gt;
            &lt;ul class="navbar-nav ms-auto"&gt;
                &lt;li class="nav-item dropdown"&gt;
                    &lt;a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"&gt;欢迎, admin&lt;/a&gt;
                    &lt;ul class="dropdown-menu"&gt;
                        &lt;li&gt;&lt;a class="dropdown-item"&gt;退出登录&lt;/a&gt;&lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/nav&gt;
</code></pre>
<h3 id="t7613.2. main.hbs">13.2. main.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7613.2.%20main.hbs"> # </a></h3>
<p>views/layouts/main.hbs</p>
<pre><code class="lang-diff">&lt;!doctype html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
  &lt;title&gt;CMS&lt;/title&gt;
  &lt;link href="/style/bootstrap.min.css" rel="stylesheet"&gt;
  &lt;link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"&gt;
  &lt;link rel="stylesheet" href="/style/ckeditor5.css" /&gt;
  &lt;script src="https://code.jquery.com/jquery-3.7.1.min.js"&gt;&lt;/script&gt;
<span class="hljs-addition">+ &lt;script src="/js/echarts.min.js"&gt;&lt;/script&gt;</span>
&lt;/head&gt;

&lt;body&gt;
  {{&gt; header }}
  &lt;div class="container-fluid"&gt;
    &lt;div class="row"&gt;
      {{&gt; sidebar}}
      &lt;div class="col-md-9 col-lg-10"&gt;
        &lt;div class="container mt-4"&gt;
          {{{body}}}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;script src="/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h3 id="t7713.3. dashboard.hbs">13.3. dashboard.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7713.3.%20dashboard.hbs"> # </a></h3>
<p>views/dashboard.hbs</p>
<pre><code class="lang-diff">&lt;!-- 快捷操作栏 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between"&gt;
<span class="hljs-addition">+               &lt;span&gt;快捷操作&lt;/span&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-body"&gt;</span>
<span class="hljs-addition">+               &lt;div class="row text-center"&gt;</span>
<span class="hljs-addition">+                   &lt;!-- 快捷操作按钮 --&gt;</span>
<span class="hljs-addition">+                   &lt;div class="col-md-2"&gt;</span>
<span class="hljs-addition">+                       &lt;a href="/admin/articles" class="btn btn-outline-primary btn-block"&gt;</span>
<span class="hljs-addition">+                           &lt;i class="bi bi-file-text"&gt;&lt;/i&gt; 文章管理</span>
<span class="hljs-addition">+                       &lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;/div&gt;</span>
<span class="hljs-addition">+                   &lt;div class="col-md-2"&gt;</span>
<span class="hljs-addition">+                       &lt;a href="/admin/categories/create" class="btn btn-outline-success btn-block"&gt;</span>
<span class="hljs-addition">+                           &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 新增分类</span>
<span class="hljs-addition">+                       &lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;/div&gt;</span>
<span class="hljs-addition">+                   &lt;div class="col-md-2"&gt;</span>
<span class="hljs-addition">+                       &lt;a href="/admin/tags/create" class="btn btn-outline-info btn-block"&gt;</span>
<span class="hljs-addition">+                           &lt;i class="bi bi-tag"&gt;&lt;/i&gt; 新增标签</span>
<span class="hljs-addition">+                       &lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;/div&gt;</span>
<span class="hljs-addition">+                   &lt;div class="col-md-2"&gt;</span>
<span class="hljs-addition">+                       &lt;a href="/admin/users/create" class="btn btn-outline-warning btn-block"&gt;</span>
<span class="hljs-addition">+                           &lt;i class="bi bi-person-plus"&gt;&lt;/i&gt; 添加用户</span>
<span class="hljs-addition">+                       &lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;/div&gt;</span>
<span class="hljs-addition">+                   &lt;div class="col-md-2"&gt;</span>
<span class="hljs-addition">+                       &lt;a href="/admin/accesses/create" class="btn btn-outline-danger btn-block"&gt;</span>
<span class="hljs-addition">+                           &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 添加资源</span>
<span class="hljs-addition">+                       &lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;/div&gt;</span>
<span class="hljs-addition">+                   &lt;div class="col-md-2"&gt;</span>
<span class="hljs-addition">+                       &lt;a href="/admin/settings" class="btn btn-outline-secondary btn-block"&gt;</span>
<span class="hljs-addition">+                           &lt;i class="bi bi-gear"&gt;&lt;/i&gt; 系统设置</span>
<span class="hljs-addition">+                       &lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;/div&gt;</span>
<span class="hljs-addition">+               &lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
</code></pre>
<h2 id="t7814.系统概览">14.系统概览 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7814.%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%A7%88"> # </a></h2>
<h3 id="t7914.1. dashboard.controller.ts">14.1. dashboard.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t7914.1.%20dashboard.controller.ts"> # </a></h3>
<p>src/admin/controllers/dashboard.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render } from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
<span class="hljs-addition">+import { DashboardService } from 'src/shared/services/dashboard.service';</span>
@Controller('admin')
@ApiTags('dashboard')
export class DashboardController {
<span class="hljs-addition">+   constructor(</span>
<span class="hljs-addition">+       private readonly dashboardService: DashboardService</span>
<span class="hljs-addition">+   ) { }</span>
    @Get('dashboard')
    @Render('dashboard')
<span class="hljs-addition">+   async dashboard() {</span>
<span class="hljs-addition">+       return await this.dashboardService.getDashboardData();</span>
    }
}

</code></pre>
<h3 id="t8014.2. mysql-base.service.ts">14.2. mysql-base.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8014.2.%20mysql-base.service.ts"> # </a></h3>
<p>src/shared/services/mysql-base.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from "@nestjs/common";;
import { Repository, FindOneOptions } from 'typeorm';
import { DeepPartial } from 'typeorm/common/DeepPartial'
import { QueryDeepPartialEntity } from 'typeorm/query-builder/QueryPartialEntity';
@Injectable()
<span class="hljs-addition">+export abstract class MySQLBaseService&lt;T&gt; {</span>
<span class="hljs-addition">+ constructor(protected repository: Repository&lt;T&gt;) { }</span>
<span class="hljs-addition">+ async findAll() {</span>
<span class="hljs-addition">+   return this.repository.find();</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async findOne(options: FindOneOptions&lt;T&gt;) {</span>
<span class="hljs-addition">+   return this.repository.findOne(options);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async create(createDto: DeepPartial&lt;T&gt;) {</span>
<span class="hljs-addition">+   const entity = this.repository.create(createDto);</span>
<span class="hljs-addition">+   return await this.repository.save(entity);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async update(id: number, updateDto: QueryDeepPartialEntity&lt;T&gt;) {</span>
<span class="hljs-addition">+   return this.repository.update(id, updateDto);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async delete(id: number) {</span>
<span class="hljs-addition">+   return this.repository.delete(id);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async count(): Promise&lt;number&gt; {</span>
<span class="hljs-addition">+   return this.repository.count();</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t8114.3. dashboard.service.ts">14.3. dashboard.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8114.3.%20dashboard.service.ts"> # </a></h3>
<p>src/shared/services/dashboard.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { UserService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { ArticleService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./article.service'</span>;
<span class="hljs-keyword">import</span> { CategoryService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./category.service'</span>;
<span class="hljs-keyword">import</span> { TagService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./tag.service'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DashboardService</span> </span>{
    <span class="hljs-keyword">constructor</span>(
        private readonly userService: UserService,
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService
    ) { }

    <span class="hljs-keyword">async</span> getDashboardData() {
        <span class="hljs-keyword">const</span> [
            userCount,
            articleCount,
            categoryCount,
            tagCount
        ] = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all([
            <span class="hljs-keyword">this</span>.userService.count(),
            <span class="hljs-keyword">this</span>.articleService.count(),
            <span class="hljs-keyword">this</span>.categoryService.count(),
            <span class="hljs-keyword">this</span>.tagService.count()
        ]);
        <span class="hljs-keyword">return</span> {
            userCount,
            articleCount,
            categoryCount,
            tagCount
        };
    }
}

</code></pre>
<h3 id="t8214.4. dashboard.hbs">14.4. dashboard.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8214.4.%20dashboard.hbs"> # </a></h3>
<p>views/dashboard.hbs</p>
<pre><code class="lang-diff">&lt;!-- 快捷操作栏 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between"&gt;
                &lt;span&gt;快捷操作&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;div class="row text-center"&gt;
                    &lt;!-- 快捷操作按钮 --&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/articles" class="btn btn-outline-primary btn-block"&gt;
                            &lt;i class="bi bi-file-text"&gt;&lt;/i&gt; 文章管理
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/categories/create" class="btn btn-outline-success btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 新增分类
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/tags/create" class="btn btn-outline-info btn-block"&gt;
                            &lt;i class="bi bi-tag"&gt;&lt;/i&gt; 新增标签
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/users/create" class="btn btn-outline-warning btn-block"&gt;
                            &lt;i class="bi bi-person-plus"&gt;&lt;/i&gt; 添加用户
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/accesses/create" class="btn btn-outline-danger btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 添加资源
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/settings" class="btn btn-outline-secondary btn-block"&gt;
                            &lt;i class="bi bi-gear"&gt;&lt;/i&gt; 系统设置
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+&lt;!-- 系统概览 --&gt;</span>
<span class="hljs-addition">+&lt;div class="row mb-4"&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-3"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card text-white bg-primary"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-body"&gt;</span>
<span class="hljs-addition">+               &lt;h5 class="card-title"&gt;用户总数&lt;/h5&gt;</span>
<span class="hljs-addition">+               &lt;p class="card-text"&gt;{{userCount}}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-3"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card text-white bg-success"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-body"&gt;</span>
<span class="hljs-addition">+               &lt;h5 class="card-title"&gt;文章总数&lt;/h5&gt;</span>
<span class="hljs-addition">+               &lt;p class="card-text"&gt;{{articleCount}}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-3"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card text-white bg-info"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-body"&gt;</span>
<span class="hljs-addition">+               &lt;h5 class="card-title"&gt;分类总数&lt;/h5&gt;</span>
<span class="hljs-addition">+               &lt;p class="card-text"&gt;{{categoryCount}}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-3"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card text-white bg-warning"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-body"&gt;</span>
<span class="hljs-addition">+               &lt;h5 class="card-title"&gt;标签总数&lt;/h5&gt;</span>
<span class="hljs-addition">+               &lt;p class="card-text"&gt;{{tagCount}}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
&lt;/div&gt;
</code></pre>
<h3 id="t8314.5. shared.module.ts">14.5. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8314.5.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
import { PptExportService } from './services/ppt-export.service';
import { ExcelExportService } from './services/excel-export.service';
import { MongooseModule } from '@nestjs/mongoose';
import { Setting, SettingSchema } from './schemas/setting.schema';
import { SettingService } from './services/setting.service';
<span class="hljs-addition">+import { DashboardService } from './services/dashboard.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        MongooseModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                uri: configurationService.mongodbConfig.uri
            }),
        }),
        MongooseModule.forFeature([
            { name: Setting.name, schema: SettingSchema },
        ]),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h2 id="t8415.最新数据">15.最新数据 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8415.%E6%9C%80%E6%96%B0%E6%95%B0%E6%8D%AE"> # </a></h2>
<h3 id="t8515.1. fromNow.ts">15.1. fromNow.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8515.1.%20fromNow.ts"> # </a></h3>
<p>src/shared/helpers/fromNow.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dayjs <span class="hljs-keyword">from</span> <span class="hljs-string">'dayjs'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dayjs/locale/zh-cn'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> relativeTime <span class="hljs-keyword">from</span> <span class="hljs-string">'dayjs/plugin/relativeTime'</span>
dayjs.locale(<span class="hljs-string">'zh-cn'</span>)
dayjs.extend(relativeTime);
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromNow</span>(<span class="hljs-params">date: string</span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> dayjs(date).fromNow();
}
</code></pre>
<h3 id="t8615.2. index.ts">15.2. index.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8615.2.%20index.ts"> # </a></h3>
<p>src/shared/helpers/index.ts</p>
<pre><code class="lang-diff">export * from './eq';
export * from './range';
export * from './inc';
export * from './dec';
export * from './multiply';
<span class="hljs-addition">+export * from './json';</span>
<span class="hljs-addition">+export * from './def';</span>
<span class="hljs-addition">+export * from './mapToIds';</span>
<span class="hljs-addition">+export * from './contains';</span>
<span class="hljs-addition">+export * from './fromNow';</span>
</code></pre>
<h3 id="t8715.3. mysql-base.service.ts">15.3. mysql-base.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8715.3.%20mysql-base.service.ts"> # </a></h3>
<p>src/shared/services/mysql-base.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from "@nestjs/common";;
import { Repository, FindOneOptions } from 'typeorm';
import { DeepPartial } from 'typeorm/common/DeepPartial'
import { QueryDeepPartialEntity } from 'typeorm/query-builder/QueryPartialEntity';
@Injectable()
export abstract class MySQLBaseService&lt;T&gt; {
  constructor(protected repository: Repository&lt;T&gt;) { }
  async findAll() {
    return this.repository.find();
  }
  async findOne(options: FindOneOptions&lt;T&gt;) {
    return this.repository.findOne(options);
  }
  async create(createDto: DeepPartial&lt;T&gt;) {
    const entity = this.repository.create(createDto);
    return await this.repository.save(entity);
  }
  async update(id: number, updateDto: QueryDeepPartialEntity&lt;T&gt;) {
    return this.repository.update(id, updateDto);
  }
  async delete(id: number) {
    return this.repository.delete(id);
  }
  async count(): Promise&lt;number&gt; {
    return this.repository.count();
  }
<span class="hljs-addition">+ async findLatest(limit: number) {</span>
<span class="hljs-addition">+   const order: any = {</span>
<span class="hljs-addition">+     id: 'DESC'</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   return this.repository.find({</span>
<span class="hljs-addition">+     order,</span>
<span class="hljs-addition">+     take: limit</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+ }</span>
}

</code></pre>
<h3 id="t8815.4. dashboard.service.ts">15.4. dashboard.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8815.4.%20dashboard.service.ts"> # </a></h3>
<p>src/shared/services/dashboard.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from '@nestjs/common';
import { UserService } from './user.service';
import { ArticleService } from './article.service';
import { CategoryService } from './category.service';
import { TagService } from './tag.service';

@Injectable()
export class DashboardService {
    constructor(
        private readonly userService: UserService,
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService
    ) { }

    async getDashboardData() {
        const [
            userCount,
            articleCount,
            categoryCount,
<span class="hljs-addition">+           tagCount,</span>
<span class="hljs-addition">+           latestArticles,</span>
<span class="hljs-addition">+           latestUsers,</span>
        ] = await Promise.all([
            this.userService.count(),
            this.articleService.count(),
            this.categoryService.count(),
<span class="hljs-addition">+           this.tagService.count(),</span>
<span class="hljs-addition">+           this.articleService.findLatest(5),</span>
<span class="hljs-addition">+           this.userService.findLatest(5),</span>
        ]);
        return {
            userCount,
            articleCount,
            categoryCount,
<span class="hljs-addition">+           tagCount,</span>
<span class="hljs-addition">+           latestArticles,</span>
<span class="hljs-addition">+           latestUsers</span>
        };
    }
}

</code></pre>
<h3 id="t8915.5. dashboard.hbs">15.5. dashboard.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t8915.5.%20dashboard.hbs"> # </a></h3>
<p>views/dashboard.hbs</p>
<pre><code class="lang-diff">&lt;!-- 快捷操作栏 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between"&gt;
                &lt;span&gt;快捷操作&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;div class="row text-center"&gt;
                    &lt;!-- 快捷操作按钮 --&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/articles" class="btn btn-outline-primary btn-block"&gt;
                            &lt;i class="bi bi-file-text"&gt;&lt;/i&gt; 文章管理
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/categories/create" class="btn btn-outline-success btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 新增分类
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/tags/create" class="btn btn-outline-info btn-block"&gt;
                            &lt;i class="bi bi-tag"&gt;&lt;/i&gt; 新增标签
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/users/create" class="btn btn-outline-warning btn-block"&gt;
                            &lt;i class="bi bi-person-plus"&gt;&lt;/i&gt; 添加用户
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/accesses/create" class="btn btn-outline-danger btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 添加资源
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/settings" class="btn btn-outline-secondary btn-block"&gt;
                            &lt;i class="bi bi-gear"&gt;&lt;/i&gt; 系统设置
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 系统概览 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-primary"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;用户总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{userCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-success"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;文章总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{articleCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-info"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;分类总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{categoryCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-warning"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;标签总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{tagCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+&lt;div class="row mb-4"&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-6"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-header"&gt;最新文章&lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;ul class="list-group list-group-flush"&gt;</span>
<span class="hljs-addition">+               {{#each latestArticles}}</span>
<span class="hljs-addition">+               &lt;li class="list-group-item"&gt;</span>
<span class="hljs-addition">+                   &lt;a href="/admin/articles/{{id}}"&gt;{{title}}&lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;</span>
<span class="hljs-addition">+               &lt;/li&gt;</span>
<span class="hljs-addition">+               {{/each}}</span>
<span class="hljs-addition">+           &lt;/ul&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-6"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-header"&gt;最新用户&lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;ul class="list-group list-group-flush"&gt;</span>
<span class="hljs-addition">+               {{#each latestUsers}}</span>
<span class="hljs-addition">+               &lt;li class="list-group-item"&gt;</span>
<span class="hljs-addition">+                   &lt;a href="/admin/users/{{id}}"&gt;{{username}}&lt;/a&gt;</span>
<span class="hljs-addition">+                   &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;</span>
<span class="hljs-addition">+               &lt;/li&gt;</span>
<span class="hljs-addition">+               {{/each}}</span>
<span class="hljs-addition">+           &lt;/ul&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
&lt;/div&gt;
</code></pre>
<h2 id="t9016.内容统计图表">16.内容统计图表 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9016.%E5%86%85%E5%AE%B9%E7%BB%9F%E8%AE%A1%E5%9B%BE%E8%A1%A8"> # </a></h2>
<h3 id="t9116.1. dashboard.service.ts">16.1. dashboard.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9116.1.%20dashboard.service.ts"> # </a></h3>
<p>src/shared/services/dashboard.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from '@nestjs/common';
import { UserService } from './user.service';
import { ArticleService } from './article.service';
import { CategoryService } from './category.service';
import { TagService } from './tag.service';

@Injectable()
export class DashboardService {
    constructor(
        private readonly userService: UserService,
        private readonly articleService: ArticleService,
        private readonly categoryService: CategoryService,
        private readonly tagService: TagService
    ) { }

    async getDashboardData() {
        const [
            userCount,
            articleCount,
            categoryCount,
            tagCount,
            latestArticles,
            latestUsers,
<span class="hljs-addition">+           articleTrend,</span>
<span class="hljs-addition">+           userGrowth,</span>
        ] = await Promise.all([
            this.userService.count(),
            this.articleService.count(),
            this.categoryService.count(),
            this.tagService.count(),
            this.articleService.findLatest(5),
            this.userService.findLatest(5),
<span class="hljs-addition">+           this.articleService.getTrend('article'),</span>
<span class="hljs-addition">+           this.userService.getTrend('user'),</span>
        ]);
        return {
            userCount,
            articleCount,
            categoryCount,
            tagCount,
            latestArticles,
<span class="hljs-addition">+           latestUsers,</span>
<span class="hljs-addition">+           articleTrend,</span>
<span class="hljs-addition">+           userGrowth</span>
        };
    }
}

</code></pre>
<h3 id="t9216.2. mysql-base.service.ts">16.2. mysql-base.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9216.2.%20mysql-base.service.ts"> # </a></h3>
<p>src/shared/services/mysql-base.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from "@nestjs/common";;
import { Repository, FindOneOptions } from 'typeorm';
import { DeepPartial } from 'typeorm/common/DeepPartial'
import { QueryDeepPartialEntity } from 'typeorm/query-builder/QueryPartialEntity';
@Injectable()
export abstract class MySQLBaseService&lt;T&gt; {
  constructor(protected repository: Repository&lt;T&gt;) { }
  async findAll() {
    return this.repository.find();
  }
  async findOne(options: FindOneOptions&lt;T&gt;) {
    return this.repository.findOne(options);
  }
  async create(createDto: DeepPartial&lt;T&gt;) {
    const entity = this.repository.create(createDto);
    return await this.repository.save(entity);
  }
  async update(id: number, updateDto: QueryDeepPartialEntity&lt;T&gt;) {
    return this.repository.update(id, updateDto);
  }
  async delete(id: number) {
    return this.repository.delete(id);
  }
  async count(): Promise&lt;number&gt; {
    return this.repository.count();
  }
  async findLatest(limit: number) {
    const order: any = {
      id: 'DESC'
    }
    return this.repository.find({
      order,
      take: limit
    });
  }
<span class="hljs-addition">+ async getTrend(tableName): Promise&lt;{ dates: string[]; counts: number[] }&gt; {</span>
<span class="hljs-addition">+   const result = await this.repository.query(`</span>
<span class="hljs-addition">+           SELECT DATE_FORMAT(createdAt, '%Y-%m-%d') as date, COUNT(*) as count</span>
<span class="hljs-addition">+           FROM ${tableName}</span>
<span class="hljs-addition">+           GROUP BY date</span>
<span class="hljs-addition">+           ORDER BY date ASC</span>
<span class="hljs-addition">+       `);</span>
<span class="hljs-addition">+   const dates = result.map(row =&gt; row.date);</span>
<span class="hljs-addition">+   const counts = result.map(row =&gt; row.count);</span>
<span class="hljs-addition">+   return { dates, counts };</span>
<span class="hljs-addition">+ }</span>
}

</code></pre>
<h3 id="t9316.3. article.service.ts">16.3. article.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9316.3.%20article.service.ts"> # </a></h3>
<p>src/shared/services/article.service.ts</p>
<pre><code class="lang-diff">import { Injectable, NotFoundException } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { Article } from "../entities/article.entity";
import { Repository, Like, In, UpdateResult } from 'typeorm';
import { MySQLBaseService } from "./mysql-base.service";
<span class="hljs-addition">+import { CreateArticleDto, UpdateArticleDto } from "../dto/article.dto";</span>
<span class="hljs-addition">+import { Category } from "../entities/category.entity";</span>
<span class="hljs-addition">+import { Tag } from "../entities/tag.entity";</span>
<span class="hljs-addition">+@Injectable()</span>
<span class="hljs-addition">+export class ArticleService extends MySQLBaseService&lt;Article&gt; {</span>
<span class="hljs-addition">+ constructor(</span>
<span class="hljs-addition">+   @InjectRepository(Article) protected repository: Repository&lt;Article&gt;,</span>
<span class="hljs-addition">+   @InjectRepository(Category) private readonly categoryRepository: Repository&lt;Category&gt;,</span>
<span class="hljs-addition">+   @InjectRepository(Tag) private readonly tagRepository: Repository&lt;Tag&gt;</span>
<span class="hljs-addition">+ ) {</span>
<span class="hljs-addition">+   super(repository);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async findAll(keyword?: string) {</span>
<span class="hljs-addition">+   const where = keyword ? [</span>
<span class="hljs-addition">+     { title: Like(`%${keyword}%`) }</span>
<span class="hljs-addition">+   ] : {};</span>
<span class="hljs-addition">+   return this.repository.find({ where, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async findAllWithPagination(page: number, limit: number, keyword?: string) {</span>
<span class="hljs-addition">+   const where = keyword ? [</span>
<span class="hljs-addition">+     { title: Like(`%${keyword}%`) }</span>
<span class="hljs-addition">+   ] : {};</span>
<span class="hljs-addition">+   const [articles, total] = await this.repository.findAndCount({</span>
<span class="hljs-addition">+     where,</span>
<span class="hljs-addition">+     relations: ['categories', 'tags'],</span>
<span class="hljs-addition">+     skip: (page - 1) * limit,</span>
<span class="hljs-addition">+     take: limit</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+   return { articles, total };</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async create(createArticleDto: CreateArticleDto) {</span>
<span class="hljs-addition">+   const { categoryIds = [], tagIds = [], ...articleData } = createArticleDto;</span>
<span class="hljs-addition">+   const article = this.repository.create(articleData);</span>
<span class="hljs-addition">+   article.categories = await this.categoryRepository.findBy({ id: In(categoryIds) });</span>
<span class="hljs-addition">+   article.tags = await this.tagRepository.findBy({ id: In(tagIds) });</span>
<span class="hljs-addition">+   return await this.repository.save(article);</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ async update(id: number, updateArticleDto: UpdateArticleDto) {</span>
<span class="hljs-addition">+   const { categoryIds, tagIds, ...articleData } = updateArticleDto;</span>
<span class="hljs-addition">+   const article = await this.repository.findOne({ where: { id }, relations: ['categories', 'tags'] });</span>
<span class="hljs-addition">+   if (!article) throw new NotFoundException('Article not found');</span>
<span class="hljs-addition">+   Object.assign(article, articleData);</span>
<span class="hljs-addition">+   if (categoryIds) {</span>
<span class="hljs-addition">+     article.categories = await this.categoryRepository.findBy({ id: In(categoryIds) });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   if (tagIds) {</span>
<span class="hljs-addition">+     article.tags = await this.tagRepository.findBy({ id: In(tagIds) });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   await this.repository.save(article);</span>
<span class="hljs-addition">+   return UpdateResult.from({ raw: [], affected: 1, records: [] });</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t9416.4. dashboard.hbs">16.4. dashboard.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9416.4.%20dashboard.hbs"> # </a></h3>
<p>views/dashboard.hbs</p>
<pre><code class="lang-diff">&lt;!-- 快捷操作栏 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between"&gt;
                &lt;span&gt;快捷操作&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;div class="row text-center"&gt;
                    &lt;!-- 快捷操作按钮 --&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/articles" class="btn btn-outline-primary btn-block"&gt;
                            &lt;i class="bi bi-file-text"&gt;&lt;/i&gt; 文章管理
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/categories/create" class="btn btn-outline-success btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 新增分类
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/tags/create" class="btn btn-outline-info btn-block"&gt;
                            &lt;i class="bi bi-tag"&gt;&lt;/i&gt; 新增标签
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/users/create" class="btn btn-outline-warning btn-block"&gt;
                            &lt;i class="bi bi-person-plus"&gt;&lt;/i&gt; 添加用户
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/accesses/create" class="btn btn-outline-danger btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 添加资源
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/settings" class="btn btn-outline-secondary btn-block"&gt;
                            &lt;i class="bi bi-gear"&gt;&lt;/i&gt; 系统设置
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 系统概览 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-primary"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;用户总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{userCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-success"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;文章总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{articleCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-info"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;分类总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{categoryCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-warning"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;标签总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{tagCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;最新文章&lt;/div&gt;
            &lt;ul class="list-group list-group-flush"&gt;
                {{#each latestArticles}}
                &lt;li class="list-group-item"&gt;
                    &lt;a href="/admin/articles/{{id}}"&gt;{{title}}&lt;/a&gt;
                    &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;
                &lt;/li&gt;
                {{/each}}
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;最新用户&lt;/div&gt;
            &lt;ul class="list-group list-group-flush"&gt;
                {{#each latestUsers}}
                &lt;li class="list-group-item"&gt;
                    &lt;a href="/admin/users/{{id}}"&gt;{{username}}&lt;/a&gt;
                    &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;
                &lt;/li&gt;
                {{/each}}
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

<span class="hljs-addition">+&lt;!-- 内容统计图表 --&gt;</span>
<span class="hljs-addition">+&lt;div class="row mb-4"&gt;</span>
<span class="hljs-addition">+   &lt;!-- 左侧的图表容器，用于显示文章发布趋势图表 --&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-6"&gt;</span>
<span class="hljs-addition">+       &lt;!-- 文章发布趋势图表的容器，宽度为100%，高度为400像素 --&gt;</span>
<span class="hljs-addition">+       &lt;div id="articleTrendChart" style="width: 100%;height:400px;"&gt;&lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;!-- 右侧的图表容器，用于显示用户增长趋势图表 --&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-6"&gt;</span>
<span class="hljs-addition">+       &lt;!-- 用户增长趋势图表的容器，宽度为100%，高度为400像素 --&gt;</span>
<span class="hljs-addition">+       &lt;div id="userGrowthChart" style="width: 100%;height:400px;"&gt;&lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+&lt;script type="text/javascript"&gt;</span>
<span class="hljs-addition">+   // 初始化文章发布趋势图表</span>
<span class="hljs-addition">+   var articleTrendChart = echarts.init(document.getElementById('articleTrendChart'));</span>
<span class="hljs-addition">+   // 配置文章发布趋势图表的选项</span>
<span class="hljs-addition">+   var articleTrendOption = {</span>
<span class="hljs-addition">+       title: {</span>
<span class="hljs-addition">+           text: '文章发布趋势' // 图表标题</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       tooltip: {}, // 工具提示</span>
<span class="hljs-addition">+       xAxis: {</span>
<span class="hljs-addition">+           type: 'category', // X轴类型为类目型</span>
<span class="hljs-addition">+           data: {{{ json articleTrend.dates }}} // X轴数据，使用模板引擎生成的日期数组</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       yAxis: {</span>
<span class="hljs-addition">+           type: 'value' // Y轴类型为数值型</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       series: [{</span>
<span class="hljs-addition">+           data: {{{ json articleTrend.counts }}}, // 图表数据，使用模板引擎生成的文章发布数量数组</span>
<span class="hljs-addition">+           type: 'line' // 数据系列的图表类型为折线图</span>
<span class="hljs-addition">+       }]</span>
<span class="hljs-addition">+   };</span>
<span class="hljs-addition">+   // 将配置的选项应用到文章发布趋势图表上</span>
<span class="hljs-addition">+   articleTrendChart.setOption(articleTrendOption);</span>
<span class="hljs-addition">+   </span>
<span class="hljs-addition">+   // 初始化用户增长趋势图表</span>
<span class="hljs-addition">+   var userGrowthChart = echarts.init(document.getElementById('userGrowthChart'));</span>
<span class="hljs-addition">+   // 配置用户增长趋势图表的选项</span>
<span class="hljs-addition">+   var userGrowthOption = {</span>
<span class="hljs-addition">+       title: {</span>
<span class="hljs-addition">+           text: '用户增长趋势' // 图表标题</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       tooltip: {}, // 工具提示</span>
<span class="hljs-addition">+       xAxis: {</span>
<span class="hljs-addition">+           type: 'category', // X轴类型为类目型</span>
<span class="hljs-addition">+           data: {{{ json userGrowth.dates }}} // X轴数据，使用模板引擎生成的日期数组</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       yAxis: {</span>
<span class="hljs-addition">+           type: 'value' // Y轴类型为数值型</span>
<span class="hljs-addition">+       },</span>
<span class="hljs-addition">+       series: [{</span>
<span class="hljs-addition">+           data: {{{ json userGrowth.counts }}}, // 图表数据，使用模板引擎生成的用户增长数量数组</span>
<span class="hljs-addition">+           type: 'bar' // 数据系列的图表类型为柱状图</span>
<span class="hljs-addition">+       }]</span>
<span class="hljs-addition">+   };</span>
<span class="hljs-addition">+   // 将配置的选项应用到用户增长趋势图表上</span>
<span class="hljs-addition">+   userGrowthChart.setOption(userGrowthOption);</span>
<span class="hljs-addition">+&lt;/script&gt;</span>

</code></pre>
<h2 id="t9517.天气预报">17.天气预报 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9517.%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5"> # </a></h2>
<pre><code class="lang-js">npm i axios geoip-lite
</code></pre>
<h3 id="t9617.1. dashboard.controller.ts">17.1. dashboard.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9617.1.%20dashboard.controller.ts"> # </a></h3>
<p>src/admin/controllers/dashboard.controller.ts</p>
<pre><code class="lang-diff">import { Controller, Get, Render } from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
import { DashboardService } from 'src/shared/services/dashboard.service';
<span class="hljs-addition">+import { WeatherService } from 'src/shared/services/weather.service';</span>
@Controller('admin')
@ApiTags('dashboard')
export class DashboardController {
    constructor(
<span class="hljs-addition">+       private readonly dashboardService: DashboardService,</span>
<span class="hljs-addition">+       private readonly weatherService: WeatherService,</span>
    ) { }
    @Get('dashboard')
    @Render('dashboard')
    async dashboard() {
        return await this.dashboardService.getDashboardData();
    }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+   @Get('dashboard/weather')</span>
<span class="hljs-addition">+   async getWeather() {</span>
<span class="hljs-addition">+       const weather = await this.weatherService.getWeather();</span>
<span class="hljs-addition">+       return { weather };</span>
<span class="hljs-addition">+   }</span>
}

</code></pre>
<h3 id="t9717.2. weather.service.ts">17.2. weather.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9717.2.%20weather.service.ts"> # </a></h3>
<p>src/shared/services/weather.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { ConfigService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> geoip <span class="hljs-keyword">from</span> <span class="hljs-string">'geoip-lite'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WeatherService</span> </span>{
    <span class="hljs-keyword">constructor</span>(private readonly configService: ConfigService) { }

    <span class="hljs-keyword">async</span> getExternalIP() {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> ipApiUrl = <span class="hljs-keyword">this</span>.configService.get&lt;string&gt;(<span class="hljs-string">'IP_API_URL'</span>);
            <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.get(ipApiUrl);
            <span class="hljs-keyword">return</span> response.data.ip;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error fetching external IP:'</span>, error);
            <span class="hljs-keyword">return</span> <span class="hljs-string">'N/A'</span>;
        }
    }

    <span class="hljs-keyword">async</span> getWeather() {
        <span class="hljs-keyword">const</span> ip = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getExternalIP();
        <span class="hljs-keyword">const</span> geo = geoip.lookup(ip);
        <span class="hljs-keyword">const</span> location = geo ? <span class="hljs-string">`<span class="hljs-subst">${geo.city}</span>, <span class="hljs-subst">${geo.country}</span>`</span> : <span class="hljs-string">'Unknown'</span>;
        <span class="hljs-keyword">let</span> weather = <span class="hljs-string">'无法获取天气信息'</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (geo) {
                <span class="hljs-keyword">const</span> apiKey = <span class="hljs-keyword">this</span>.configService.get&lt;string&gt;(<span class="hljs-string">'WEATHER_API_KEY'</span>);
                <span class="hljs-keyword">const</span> weatherApiUrl = <span class="hljs-keyword">this</span>.configService.get&lt;string&gt;(<span class="hljs-string">'WEATHER_API_URL'</span>);
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.get(<span class="hljs-string">`<span class="hljs-subst">${weatherApiUrl}</span>?lang=zh&amp;key=<span class="hljs-subst">${apiKey}</span>&amp;q=<span class="hljs-subst">${location}</span>`</span>);
                weather = <span class="hljs-string">`<span class="hljs-subst">${response.data.current.temp_c}</span>°C, <span class="hljs-subst">${response.data.current.condition.text}</span>`</span>;
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'获取天气信息失败:'</span>, error.message);
        }
        <span class="hljs-keyword">return</span> weather;
    }
}

</code></pre>
<h3 id="t9817.3. shared.module.ts">17.3. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9817.3.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
import { PptExportService } from './services/ppt-export.service';
import { ExcelExportService } from './services/excel-export.service';
import { MongooseModule } from '@nestjs/mongoose';
import { Setting, SettingSchema } from './schemas/setting.schema';
import { SettingService } from './services/setting.service';
import { DashboardService } from './services/dashboard.service';
<span class="hljs-addition">+import { WeatherService } from "./services/weather.service";</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService, WeatherService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService, WeatherService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        MongooseModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                uri: configurationService.mongodbConfig.uri
            }),
        }),
        MongooseModule.forFeature([
            { name: Setting.name, schema: SettingSchema },
        ]),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t9917.4. dashboard.hbs">17.4. dashboard.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t9917.4.%20dashboard.hbs"> # </a></h3>
<p>views/dashboard.hbs</p>
<pre><code class="lang-diff">&lt;!-- 快捷操作栏 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between"&gt;
                &lt;span&gt;快捷操作&lt;/span&gt;
<span class="hljs-addition">+               &lt;span id="weather-info"&gt;正在获取天气信息...&lt;/span&gt;</span>
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;div class="row text-center"&gt;
                    &lt;!-- 快捷操作按钮 --&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/articles" class="btn btn-outline-primary btn-block"&gt;
                            &lt;i class="bi bi-file-text"&gt;&lt;/i&gt; 文章管理
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/categories/create" class="btn btn-outline-success btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 新增分类
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/tags/create" class="btn btn-outline-info btn-block"&gt;
                            &lt;i class="bi bi-tag"&gt;&lt;/i&gt; 新增标签
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/users/create" class="btn btn-outline-warning btn-block"&gt;
                            &lt;i class="bi bi-person-plus"&gt;&lt;/i&gt; 添加用户
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/accesses/create" class="btn btn-outline-danger btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 添加资源
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/settings" class="btn btn-outline-secondary btn-block"&gt;
                            &lt;i class="bi bi-gear"&gt;&lt;/i&gt; 系统设置
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 系统概览 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-primary"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;用户总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{userCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-success"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;文章总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{articleCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-info"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;分类总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{categoryCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-warning"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;标签总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{tagCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;最新文章&lt;/div&gt;
            &lt;ul class="list-group list-group-flush"&gt;
                {{#each latestArticles}}
                &lt;li class="list-group-item"&gt;
                    &lt;a href="/admin/articles/{{id}}"&gt;{{title}}&lt;/a&gt;
                    &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;
                &lt;/li&gt;
                {{/each}}
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;最新用户&lt;/div&gt;
            &lt;ul class="list-group list-group-flush"&gt;
                {{#each latestUsers}}
                &lt;li class="list-group-item"&gt;
                    &lt;a href="/admin/users/{{id}}"&gt;{{username}}&lt;/a&gt;
                    &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;
                &lt;/li&gt;
                {{/each}}
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 内容统计图表 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div id="articleTrendChart" style="width: 100%;height:400px;"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div id="userGrowthChart" style="width: 100%;height:400px;"&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;script type="text/javascript"&gt;
    var articleTrendChart = echarts.init(document.getElementById('articleTrendChart'));
    var articleTrendOption = {
        title: {
            text: '文章发布趋势'
        },
        tooltip: {},
        xAxis: {
            type: 'category',
            data: {{{ json articleTrend.dates }}}
        },
    yAxis: {
        type: 'value'
    },
    series: [{
        data: {{{ json articleTrend.counts }}},
        type: 'line'
        }]
    };
    articleTrendChart.setOption(articleTrendOption);
    var userGrowthChart = echarts.init(document.getElementById('userGrowthChart'));
    var userGrowthOption = {
        title: {
            text: '用户增长趋势'
        },
        tooltip: {},
        xAxis: {
            type: 'category',
            data: {{{ json userGrowth.dates }}}
        },
    yAxis: {
        type: 'value'
    },
    series: [{
        data: {{{ json userGrowth.counts }}},
        type: 'bar'
        }]
    };
    userGrowthChart.setOption(userGrowthOption);
<span class="hljs-addition">+&lt;/script&gt;</span>
<span class="hljs-addition">+&lt;script type="text/javascript"&gt;</span>
<span class="hljs-addition">+   $(function () {</span>
<span class="hljs-addition">+       $.ajax({</span>
<span class="hljs-addition">+           url: '/admin/dashboard/weather',</span>
<span class="hljs-addition">+           method: 'GET',</span>
<span class="hljs-addition">+           success: function (data) {</span>
<span class="hljs-addition">+               $('#weather-info').text(data.weather);</span>
<span class="hljs-addition">+           },</span>
<span class="hljs-addition">+           error: function () {</span>
<span class="hljs-addition">+               $('#weather-info').text('获取天气信息失败');</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+   });</span>
&lt;/script&gt;
</code></pre>
<h2 id="t10018.服务器状态">18.服务器状态 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10018.%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81"> # </a></h2>
<pre><code class="lang-js">npm install systeminformation
</code></pre>
<h3 id="t10118.1. main.hbs">18.1. main.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10118.1.%20main.hbs"> # </a></h3>
<p>views/layouts/main.hbs</p>
<pre><code class="lang-diff">&lt;!doctype html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
  &lt;title&gt;CMS&lt;/title&gt;
  &lt;link href="/style/bootstrap.min.css" rel="stylesheet"&gt;
  &lt;link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"&gt;
  &lt;link rel="stylesheet" href="/style/ckeditor5.css" /&gt;
  &lt;script src="https://code.jquery.com/jquery-3.7.1.min.js"&gt;&lt;/script&gt;
  &lt;script src="/js/echarts.min.js"&gt;&lt;/script&gt;
<span class="hljs-addition">+ &lt;script src="/js/handlebars.min.js"&gt;&lt;/script&gt;</span>
&lt;/head&gt;

&lt;body&gt;
  {{&gt; header }}
  &lt;div class="container-fluid"&gt;
    &lt;div class="row"&gt;
      {{&gt; sidebar}}
      &lt;div class="col-md-9 col-lg-10"&gt;
        &lt;div class="container mt-4"&gt;
          {{{body}}}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;script src="/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h3 id="t10218.2. dashboard.controller.ts">18.2. dashboard.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10218.2.%20dashboard.controller.ts"> # </a></h3>
<p>src/admin/controllers/dashboard.controller.ts</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { Controller, Get, Render, Sse } from '@nestjs/common';</span>
import { ApiTags } from '@nestjs/swagger';
<span class="hljs-addition">+import { interval, mergeMap, map } from 'rxjs';</span>
import { DashboardService } from 'src/shared/services/dashboard.service';
import { WeatherService } from 'src/shared/services/weather.service';
<span class="hljs-addition">+import { SystemService } from 'src/shared/services/system.service';</span>
@Controller('admin')
@ApiTags('dashboard')
export class DashboardController {
    constructor(
        private readonly dashboardService: DashboardService,
        private readonly weatherService: WeatherService,
<span class="hljs-addition">+       private readonly systemService: SystemService</span>
    ) { }
    @Get('dashboard')
    @Render('dashboard')
    async dashboard() {
        return await this.dashboardService.getDashboardData();
    }

    @Get('dashboard/weather')
    async getWeather() {
        const weather = await this.weatherService.getWeather();
        return { weather };
    }
<span class="hljs-addition">+   @Sse('dashboard/systemInfo')</span>
<span class="hljs-addition">+   systemInfo() {</span>
<span class="hljs-addition">+       return interval(3000).pipe(</span>
<span class="hljs-addition">+           mergeMap(() =&gt; this.systemService.getSystemInfo()),</span>
<span class="hljs-addition">+           map((systemInfo) =&gt; ({ data: systemInfo }))</span>
<span class="hljs-addition">+       );</span>
<span class="hljs-addition">+   }</span>
}

</code></pre>
<h3 id="t10318.3. system.service.ts">18.3. system.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10318.3.%20system.service.ts"> # </a></h3>
<p>src/shared/services/system.service.ts</p>
<pre><code class="lang-js"><span class="hljs-comment">// 导入 Injectable 装饰器，表示该类可以被依赖注入</span>
<span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-comment">// 导入 systeminformation 模块，用于获取系统信息</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> si <span class="hljs-keyword">from</span> <span class="hljs-string">'systeminformation'</span>;

<span class="hljs-comment">// 使用 Injectable 装饰器，将此类标记为可注入服务</span>
@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemService</span> </span>{
    <span class="hljs-comment">// 私有方法，将字节值格式化为GB，保留两位小数</span>
    private formatToGB(value: number) {
        <span class="hljs-keyword">return</span> (value / (<span class="hljs-number">1024</span> ** <span class="hljs-number">3</span>)).toFixed(<span class="hljs-number">2</span>);
    }

    <span class="hljs-comment">// 异步方法，获取系统信息</span>
    <span class="hljs-keyword">async</span> getSystemInfo() {
        <span class="hljs-comment">// 获取当前CPU负载信息</span>
        <span class="hljs-keyword">const</span> cpu = <span class="hljs-keyword">await</span> si.currentLoad();
        <span class="hljs-comment">// 获取内存使用情况</span>
        <span class="hljs-keyword">const</span> memory = <span class="hljs-keyword">await</span> si.mem();
        <span class="hljs-comment">// 获取磁盘使用情况</span>
        <span class="hljs-keyword">const</span> disk = <span class="hljs-keyword">await</span> si.fsSize();
        <span class="hljs-comment">// 获取操作系统信息</span>
        <span class="hljs-keyword">const</span> osInfo = <span class="hljs-keyword">await</span> si.osInfo();
        <span class="hljs-comment">// 获取网络接口信息</span>
        <span class="hljs-keyword">const</span> networkInterfaces = <span class="hljs-keyword">await</span> si.networkInterfaces();

        <span class="hljs-comment">// 返回格式化后的系统信息</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">// CPU信息</span>
            <span class="hljs-attr">cpu</span>: {
                <span class="hljs-comment">// CPU核心数</span>
                <span class="hljs-attr">cores</span>: cpu.cpus.length,
                <span class="hljs-comment">// 用户进程占用的CPU负载百分比</span>
                <span class="hljs-attr">userLoad</span>: cpu.currentLoadUser.toFixed(<span class="hljs-number">2</span>),
                <span class="hljs-comment">// 系统进程占用的CPU负载百分比</span>
                <span class="hljs-attr">systemLoad</span>: cpu.currentLoadSystem.toFixed(<span class="hljs-number">2</span>),
                <span class="hljs-comment">// 空闲的CPU负载百分比</span>
                <span class="hljs-attr">idle</span>: cpu.currentLoadIdle.toFixed(<span class="hljs-number">2</span>),
            },
            <span class="hljs-comment">// 内存信息</span>
            <span class="hljs-attr">memory</span>: {
                <span class="hljs-comment">// 总内存，单位GB</span>
                <span class="hljs-attr">total</span>: <span class="hljs-keyword">this</span>.formatToGB(memory.total),
                <span class="hljs-comment">// 已使用内存，单位GB</span>
                <span class="hljs-attr">used</span>: <span class="hljs-keyword">this</span>.formatToGB(memory.used),
                <span class="hljs-comment">// 空闲内存，单位GB</span>
                <span class="hljs-attr">free</span>: <span class="hljs-keyword">this</span>.formatToGB(memory.free),
                <span class="hljs-comment">// 内存使用率，单位百分比</span>
                <span class="hljs-attr">usage</span>: ((memory.used / memory.total) * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>),
            },
            <span class="hljs-comment">// 磁盘信息</span>
            <span class="hljs-attr">disks</span>: disk.map(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> ({
                <span class="hljs-comment">// 挂载点</span>
                <span class="hljs-attr">mount</span>: d.mount,
                <span class="hljs-comment">// 文件系统类型</span>
                <span class="hljs-attr">filesystem</span>: d.fs,
                <span class="hljs-comment">// 磁盘类型</span>
                <span class="hljs-attr">type</span>: d.type,
                <span class="hljs-comment">// 磁盘总大小，单位GB</span>
                <span class="hljs-attr">size</span>: <span class="hljs-keyword">this</span>.formatToGB(d.size),
                <span class="hljs-comment">// 已使用空间，单位GB</span>
                <span class="hljs-attr">used</span>: <span class="hljs-keyword">this</span>.formatToGB(d.used),
                <span class="hljs-comment">// 可用空间，单位GB</span>
                <span class="hljs-attr">available</span>: <span class="hljs-keyword">this</span>.formatToGB(d.available),
                <span class="hljs-comment">// 磁盘使用率，单位百分比</span>
                <span class="hljs-attr">usage</span>: d.use.toFixed(<span class="hljs-number">2</span>),
            })),
            <span class="hljs-comment">// 服务器信息</span>
            <span class="hljs-attr">server</span>: {
                <span class="hljs-comment">// 主机名</span>
                <span class="hljs-attr">hostname</span>: osInfo.hostname,
                <span class="hljs-comment">// IP地址，若无网络接口则返回 'N/A'</span>
                <span class="hljs-attr">ip</span>: networkInterfaces[<span class="hljs-number">0</span>]?.ip4 || <span class="hljs-string">'N/A'</span>,
                <span class="hljs-comment">// 操作系统发行版</span>
                <span class="hljs-attr">os</span>: osInfo.distro,
                <span class="hljs-comment">// 系统架构类型</span>
                <span class="hljs-attr">arch</span>: osInfo.arch,
            }
        };
    }
}
</code></pre>
<h3 id="t10418.4. shared.module.ts">18.4. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10418.4.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
import { PptExportService } from './services/ppt-export.service';
import { ExcelExportService } from './services/excel-export.service';
import { MongooseModule } from '@nestjs/mongoose';
import { Setting, SettingSchema } from './schemas/setting.schema';
import { SettingService } from './services/setting.service';
import { DashboardService } from './services/dashboard.service';
import { WeatherService } from "./services/weather.service";
<span class="hljs-addition">+import { SystemService } from './services/system.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService, WeatherService, SystemService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService, WeatherService, SystemService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        MongooseModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                uri: configurationService.mongodbConfig.uri
            }),
        }),
        MongooseModule.forFeature([
            { name: Setting.name, schema: SettingSchema },
        ]),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h3 id="t10518.5. dashboard.hbs">18.5. dashboard.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10518.5.%20dashboard.hbs"> # </a></h3>
<p>views/dashboard.hbs</p>
<pre><code class="lang-diff">&lt;!-- 快捷操作栏 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between"&gt;
                &lt;span&gt;快捷操作&lt;/span&gt;
                &lt;span id="weather-info"&gt;正在获取天气信息...&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;div class="row text-center"&gt;
                    &lt;!-- 快捷操作按钮 --&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/articles" class="btn btn-outline-primary btn-block"&gt;
                            &lt;i class="bi bi-file-text"&gt;&lt;/i&gt; 文章管理
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/categories/create" class="btn btn-outline-success btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 新增分类
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/tags/create" class="btn btn-outline-info btn-block"&gt;
                            &lt;i class="bi bi-tag"&gt;&lt;/i&gt; 新增标签
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/users/create" class="btn btn-outline-warning btn-block"&gt;
                            &lt;i class="bi bi-person-plus"&gt;&lt;/i&gt; 添加用户
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/accesses/create" class="btn btn-outline-danger btn-block"&gt;
                            &lt;i class="bi bi-folder-plus"&gt;&lt;/i&gt; 添加资源
                        &lt;/a&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-2"&gt;
                        &lt;a href="/admin/settings" class="btn btn-outline-secondary btn-block"&gt;
                            &lt;i class="bi bi-gear"&gt;&lt;/i&gt; 系统设置
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 系统概览 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-primary"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;用户总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{userCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-success"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;文章总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{articleCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-info"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;分类总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{categoryCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3"&gt;
        &lt;div class="card text-white bg-warning"&gt;
            &lt;div class="card-body"&gt;
                &lt;h5 class="card-title"&gt;标签总数&lt;/h5&gt;
                &lt;p class="card-text"&gt;{{tagCount}}&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;最新文章&lt;/div&gt;
            &lt;ul class="list-group list-group-flush"&gt;
                {{#each latestArticles}}
                &lt;li class="list-group-item"&gt;
                    &lt;a href="/admin/articles/{{id}}"&gt;{{title}}&lt;/a&gt;
                    &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;
                &lt;/li&gt;
                {{/each}}
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;最新用户&lt;/div&gt;
            &lt;ul class="list-group list-group-flush"&gt;
                {{#each latestUsers}}
                &lt;li class="list-group-item"&gt;
                    &lt;a href="/admin/users/{{id}}"&gt;{{username}}&lt;/a&gt;
                    &lt;span class="float-right"&gt;{{fromNow createdAt}}&lt;/span&gt;
                &lt;/li&gt;
                {{/each}}
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 内容统计图表 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div id="articleTrendChart" style="width: 100%;height:400px;"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div id="userGrowthChart" style="width: 100%;height:400px;"&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;script type="text/javascript"&gt;
    var articleTrendChart = echarts.init(document.getElementById('articleTrendChart'));
    var articleTrendOption = {
        title: {
            text: '文章发布趋势'
        },
        tooltip: {},
        xAxis: {
            type: 'category',
            data: {{{ json articleTrend.dates }}}
        },
    yAxis: {
        type: 'value'
    },
    series: [{
        data: {{{ json articleTrend.counts }}},
        type: 'line'
        }]
    };
    articleTrendChart.setOption(articleTrendOption);
    var userGrowthChart = echarts.init(document.getElementById('userGrowthChart'));
    var userGrowthOption = {
        title: {
            text: '用户增长趋势'
        },
        tooltip: {},
        xAxis: {
            type: 'category',
            data: {{{ json userGrowth.dates }}}
        },
    yAxis: {
        type: 'value'
    },
    series: [{
        data: {{{ json userGrowth.counts }}},
        type: 'bar'
        }]
    };
    userGrowthChart.setOption(userGrowthOption);
&lt;/script&gt;
&lt;script type="text/javascript"&gt;
    $(function () {
        $.ajax({
            url: '/admin/dashboard/weather',
            method: 'GET',
            success: function (data) {
                $('#weather-info').text(data.weather);
            },
            error: function () {
                $('#weather-info').text('获取天气信息失败');
            }
        });
    });
<span class="hljs-addition">+&lt;/script&gt;</span>
<span class="hljs-addition">+&lt;!-- 系统状态整体展示 --&gt;</span>
<span class="hljs-addition">+&lt;div class="row mb-4"&gt;</span>
<span class="hljs-addition">+   &lt;div class="col-md-12"&gt;</span>
<span class="hljs-addition">+       &lt;div class="card"&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-header"&gt;系统状态&lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;div class="card-body" id="system-status"&gt;</span>
<span class="hljs-addition">+               &lt;div&gt;正在获取系统状态数据...&lt;/div&gt;</span>
<span class="hljs-addition">+           &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+&lt;/div&gt;</span>
<span class="hljs-addition">+&lt;script id="system-status-template" type="text/x-handlebars-template"&gt;</span>
<span class="hljs-addition">+   &lt;div class="row"&gt;</span>
<span class="hljs-addition">+       &lt;div class="col-md-4"&gt;</span>
<span class="hljs-addition">+           &lt;h5&gt;服务器信息&lt;/h5&gt;</span>
<span class="hljs-addition">+           &lt;table class="table table-striped"&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;主机名&lt;/th&gt;&lt;td&gt;\{{server.hostname}}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;IP 地址&lt;/th&gt;&lt;td&gt;\{{server.ip}}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;操作系统&lt;/th&gt;&lt;td&gt;\{{server.os}}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;架构&lt;/th&gt;&lt;td&gt;\{{server.arch}}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+           &lt;/table&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;div class="col-md-4"&gt;</span>
<span class="hljs-addition">+           &lt;h5&gt;CPU 状态&lt;/h5&gt;</span>
<span class="hljs-addition">+           &lt;table class="table table-striped"&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;核心数&lt;/th&gt;&lt;td&gt;\{{cpu.cores}}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;用户占用率&lt;/th&gt;&lt;td&gt;\{{cpu.userLoad}}%&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;系统占用率&lt;/th&gt;&lt;td&gt;\{{cpu.systemLoad}}%&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;空闲率&lt;/th&gt;&lt;td&gt;\{{cpu.idle}}%&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+           &lt;/table&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+       &lt;div class="col-md-4"&gt;</span>
<span class="hljs-addition">+           &lt;h5&gt;内存状态&lt;/h5&gt;</span>
<span class="hljs-addition">+           &lt;table class="table table-striped"&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;总内存&lt;/th&gt;&lt;td&gt;\{{memory.total}} GB&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;已用内存&lt;/th&gt;&lt;td&gt;\{{memory.used}} GB&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;剩余内存&lt;/th&gt;&lt;td&gt;\{{memory.free}} GB&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+               &lt;tr&gt;&lt;th&gt;使用率&lt;/th&gt;&lt;td&gt;\{{memory.usage}}%&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hljs-addition">+           &lt;/table&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;div class="row"&gt;</span>
<span class="hljs-addition">+       &lt;div class="col-md-12"&gt;</span>
<span class="hljs-addition">+           &lt;h5&gt;磁盘状态&lt;/h5&gt;</span>
<span class="hljs-addition">+           &lt;table class="table table-striped"&gt;</span>
<span class="hljs-addition">+               &lt;thead&gt;&lt;tr&gt;&lt;th&gt;挂载点&lt;/th&gt;&lt;th&gt;总空间&lt;/th&gt;&lt;th&gt;已用&lt;/th&gt;&lt;th&gt;使用率&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;</span>
<span class="hljs-addition">+               &lt;tbody&gt;</span>
<span class="hljs-addition">+                   \{{#each disks}}</span>
<span class="hljs-addition">+                   &lt;tr&gt;</span>
<span class="hljs-addition">+                       &lt;td&gt;\{{this.mount}}&lt;/td&gt;</span>
<span class="hljs-addition">+                       &lt;td&gt;\{{this.size}} GB&lt;/td&gt;</span>
<span class="hljs-addition">+                       &lt;td&gt;\{{this.used}} GB&lt;/td&gt;</span>
<span class="hljs-addition">+                       &lt;td&gt;\{{this.usage}}%&lt;/td&gt;</span>
<span class="hljs-addition">+                   &lt;/tr&gt;</span>
<span class="hljs-addition">+                   \{{/each}}</span>
<span class="hljs-addition">+               &lt;/tbody&gt;</span>
<span class="hljs-addition">+           &lt;/table&gt;</span>
<span class="hljs-addition">+       &lt;/div&gt;</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+&lt;/script&gt;</span>
<span class="hljs-addition">+&lt;script type="text/javascript"&gt;</span>
<span class="hljs-addition">+   $(function () {</span>
<span class="hljs-addition">+        // 创建一个新的 EventSource 实例，用于从 '/admin/dashboard/systemInfo' 端点接收服务器发送的事件</span>
<span class="hljs-addition">+       const eventSource = new EventSource('/admin/dashboard/systemInfo');</span>
<span class="hljs-addition">+       // 获取存储在 HTML 中的 Handlebars 模板内容</span>
<span class="hljs-addition">+       const source = $('#system-status-template').html();</span>
<span class="hljs-addition">+       // 使用 Handlebars 编译模板，将其转换为一个可以渲染数据的函数</span>
<span class="hljs-addition">+       const template = Handlebars.compile(source);</span>
<span class="hljs-addition">+       // 当接收到服务器发送的消息时触发该函数</span>
<span class="hljs-addition">+       eventSource.onmessage = function (event) {</span>
<span class="hljs-addition">+           // 将接收到的 JSON 数据字符串解析为 JavaScript 对象</span>
<span class="hljs-addition">+           const systemInfo = JSON.parse(event.data);</span>
<span class="hljs-addition">+           // 使用 Handlebars 模板将系统信息渲染为 HTML</span>
<span class="hljs-addition">+           const html = template(systemInfo);</span>
<span class="hljs-addition">+           // 将生成的 HTML 内容插入到页面中 ID 为 'system-status' 的元素中</span>
<span class="hljs-addition">+           $('#system-status').html(html);</span>
<span class="hljs-addition">+       };</span>
<span class="hljs-addition">+       // 当发生错误时触发该函数</span>
<span class="hljs-addition">+       eventSource.onerror = function () {</span>
<span class="hljs-addition">+           // 显示错误信息，表示无法获取系统状态数据</span>
<span class="hljs-addition">+           $('#system-status').html('&lt;div&gt;获取系统状态数据失败&lt;/div&gt;');</span>
<span class="hljs-addition">+       };</span>
<span class="hljs-addition">+   });</span>
&lt;/script&gt;
</code></pre>
<h2 id="t10619.后台登录和退出">19.后台登录和退出 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10619.%E5%90%8E%E5%8F%B0%E7%99%BB%E5%BD%95%E5%92%8C%E9%80%80%E5%87%BA"> # </a></h2>
<pre><code class="lang-js">npm install svg-captcha
</code></pre>
<h3 id="t10719.1. utility.service.ts">19.1. utility.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10719.1.%20utility.service.ts"> # </a></h3>
<p>src/shared/services/utility.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from "@nestjs/common";
import * as bcrypt from 'bcrypt'
<span class="hljs-addition">+import * as svgCaptcha from 'svg-captcha';</span>
@Injectable()
export class UtilityService {
    async hashPassword(password: string): Promise&lt;string&gt; {
        const salt = await bcrypt.genSalt();
        return bcrypt.hash(password, salt);
    }
    async comparePassword(password: string, hash: string): Promise&lt;boolean&gt; {
        return bcrypt.compare(password, hash)
    }
<span class="hljs-addition">+   generateCaptcha(options) {</span>
<span class="hljs-addition">+       return svgCaptcha.create(options);</span>
<span class="hljs-addition">+   }</span>
}
</code></pre>
<h3 id="t10819.2. header.hbs">19.2. header.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10819.2.%20header.hbs"> # </a></h3>
<p>views/partials/header.hbs</p>
<pre><code class="lang-diff">&lt;nav class="navbar navbar-expand-lg bg-light"&gt;
    &lt;div class="container-fluid"&gt;
        &lt;a class="navbar-brand" href="/admin/dashboard"&gt;CMS&lt;/a&gt;
        &lt;div class="collapse navbar-collapse"&gt;
            &lt;ul class="navbar-nav ms-auto"&gt;
                &lt;li class="nav-item dropdown"&gt;
                    &lt;a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"&gt;欢迎, admin&lt;/a&gt;
                    &lt;ul class="dropdown-menu"&gt;
<span class="hljs-addition">+                       &lt;li&gt;&lt;a class="dropdown-item" href="/admin/logout"&gt;退出登录&lt;/a&gt;&lt;/li&gt;</span>
                    &lt;/ul&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/nav&gt;
</code></pre>
<h3 id="t10919.3. admin.module.ts">19.3. admin.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t10919.3.%20admin.module.ts"> # </a></h3>
<p>src/admin/admin.module.ts</p>
<pre><code class="lang-diff">import { Module } from '@nestjs/common';
import { DashboardController } from './controllers/dashboard.controller';
import { UserController } from './controllers/user.controller';
import { RoleController } from "./controllers/role.controller";
import { AccessController } from "./controllers/access.controller";
import { TagController } from "./controllers/tag.controller";
import { ArticleController } from "./controllers/article.controller";
import { CategoryController } from "./controllers/category.controller";
import { UploadController } from './controllers/upload.controller';
import { SettingController } from './controllers/setting.controller';
<span class="hljs-addition">+import { AuthController } from './controllers/auth.controller';</span>
@Module({
<span class="hljs-addition">+   controllers: [DashboardController, UserController, RoleController, AccessController, TagController, ArticleController, CategoryController, UploadController, SettingController, AuthController]</span>
})
export class AdminModule {
}

</code></pre>
<h3 id="t11019.4. login.hbs">19.4. login.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11019.4.%20login.hbs"> # </a></h3>
<p>views/auth/login.hbs</p>
<pre><code class="lang-js">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;管理员登录&lt;/title&gt;
    &lt;link href="/style/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;script src="/js/jquery.min.js"&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;h1 class="text-center"&gt;管理员登录&lt;/h1&gt;
        {{#if message}}
        &lt;div class="alert alert-danger"&gt;{{message}}&lt;/div&gt;
        {{/if}}
        &lt;form action="/admin/login" method="POST" class="mt-4"&gt;
            &lt;div class="mb-3"&gt;
                &lt;label for="username" class="form-label"&gt;用户名&lt;/label&gt;
                &lt;input type="text" class="form-control" id="username" name="username" required&gt;
            &lt;/div&gt;
            &lt;div class="mb-3"&gt;
                &lt;label for="password" class="form-label"&gt;密码&lt;/label&gt;
                &lt;input type="password" class="form-control" id="password" name="password" required&gt;
            &lt;/div&gt;
            &lt;div class="mb-3"&gt;
                &lt;label for="captcha" class="form-label"&gt;验证码&lt;/label&gt;
                &lt;div class="d-flex"&gt;
                    &lt;input type="text" class="form-control me-2" id="captcha" name="captcha" required&gt;
                    &lt;img id="captcha-img" src="/admin/captcha" alt="captcha" onclick="reloadCaptcha()"
                        style="cursor:pointer;"&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;button type="submit" class="btn btn-primary"&gt;登录&lt;/button&gt;
        &lt;/form&gt;
    &lt;/div&gt;

    &lt;script&gt;
        function reloadCaptcha() {
            $('#captcha-img').attr('src', '/admin/captcha?' + Date.now());
        }
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h3 id="t11119.5. auth.controller.ts">19.5. auth.controller.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11119.5.%20auth.controller.ts"> # </a></h3>
<p>src/admin/controllers/auth.controller.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Controller, Get, Post, Body, Res, Session, Redirect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { Response } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { UserService } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/services/user.service'</span>;
<span class="hljs-keyword">import</span> { UtilityService } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/services/utility.service'</span>;
@Controller(<span class="hljs-string">'admin'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthController</span> </span>{
    <span class="hljs-keyword">constructor</span>(
        private readonly userService: UserService,
        private readonly utilityService: UtilityService,
    ) { }

    @Get(<span class="hljs-string">'login'</span>)
    showLogin(@Res() res: Response) {
        res.render(<span class="hljs-string">'auth/login'</span>, { <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> });
    }

    @Post(<span class="hljs-string">'login'</span>)
    <span class="hljs-keyword">async</span> login(@Body() body, @Res() res: Response, @Session() session) {
        <span class="hljs-keyword">const</span> { username, password, captcha } = body;
        <span class="hljs-keyword">if</span> (captcha?.toLowerCase() !== session.captcha?.toLowerCase()) {
            <span class="hljs-keyword">return</span> res.render(<span class="hljs-string">'auth/login'</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'验证码错误'</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> });
        }
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.findOne({ <span class="hljs-attr">where</span>: { username }, <span class="hljs-attr">relations</span>: [<span class="hljs-string">'roles'</span>, <span class="hljs-string">'roles.accesses'</span>] });
        <span class="hljs-keyword">if</span> (user &amp;&amp; <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.utilityService.comparePassword(password, user.password)) {
            session.user = user;
            <span class="hljs-keyword">return</span> res.redirect(<span class="hljs-string">'/admin/dashboard'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> res.render(<span class="hljs-string">'auth/login'</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名或密码错误'</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> });
        }
    }

    @Get(<span class="hljs-string">'captcha'</span>)
    getCaptcha(@Res() res: Response, @Session() session) {
        <span class="hljs-keyword">const</span> captcha = <span class="hljs-keyword">this</span>.utilityService.generateCaptcha({ <span class="hljs-attr">size</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">ignoreChars</span>: <span class="hljs-string">'0o1il'</span> });
        session.captcha = captcha.text;
        res.type(<span class="hljs-string">'svg'</span>);
        res.send(captcha.data);
    }

    @Get(<span class="hljs-string">'logout'</span>)
    @Redirect(<span class="hljs-string">'login'</span>)
    logout(@Session() session) {
        session.user = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">url</span>: <span class="hljs-string">'login'</span> };
    }
}

</code></pre>
<h3 id="t11219.6. main.ts">19.6. main.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11219.6.%20main.ts"> # </a></h3>
<p>src/main.ts</p>
<pre><code class="lang-diff">import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import * as cookieParser from 'cookie-parser';
import * as session from 'express-session';
import { NestExpressApplication } from '@nestjs/platform-express';
import { join } from 'path';
import { engine } from 'express-handlebars';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { I18nValidationPipe, I18nValidationExceptionFilter } from 'nestjs-i18n';
import { useContainer } from 'class-validator';
import * as helpers from 'src/shared/helpers'
async function bootstrap() {
  const app = await NestFactory.create&lt;NestExpressApplication&gt;(AppModule, {
  });
  useContainer(app.select(AppModule), { fallbackOnErrors: true });
  app.useStaticAssets(join(__dirname, '..', 'public'));
  app.setBaseViewsDir(join(__dirname, '..', 'views'));
  app.engine('hbs', engine({
    extname: '.hbs',
    helpers,
    runtimeOptions: {
      allowProtoMethodsByDefault: true,
      allowProtoPropertiesByDefault: true
    }
  }));
  app.set('view engine', 'hbs');
  app.use(cookieParser());
  app.use(session({
    secret: 'secret-key',
    resave: true,
    saveUninitialized: true,
    cookie: {
      maxAge: 1000 * 60 * 60 * 24 * 7
    }
  }));
  app.useGlobalPipes(new I18nValidationPipe({ transform: true }));
  app.useGlobalFilters(new I18nValidationExceptionFilter({ detailedErrors: true }));
  const config = new DocumentBuilder()
    .setTitle('CMS API')
    .setDescription('CMS API 描述')
    .setVersion("1.0")
    .addTag('CMS')
    .addCookieAuth('connect.sid')
    .addBearerAuth({
      type: 'http',
      scheme: 'bearer'
    })
    .build();
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api-doc', app, document);
  await app.listen(3000);
}
bootstrap();
</code></pre>
<h2 id="t11320.菜单权限">20.菜单权限 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11320.%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90"> # </a></h2>
<h3 id="t11420.1. global.d.ts">20.1. global.d.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11420.1.%20global.d.ts"> # </a></h3>
<p>src/global.d.ts</p>
<pre><code class="lang-diff">declare namespace Express {
    interface Multer {
        File: Express.Multer.File;
    }
    interface Request {
<span class="hljs-addition">+       session: {</span>
<span class="hljs-addition">+           user: any;</span>
<span class="hljs-addition">+       };</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
</code></pre>
<h3 id="t11520.2. header.hbs">20.2. header.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11520.2.%20header.hbs"> # </a></h3>
<p>views/partials/header.hbs</p>
<pre><code class="lang-diff">&lt;nav class="navbar navbar-expand-lg bg-light"&gt;
    &lt;div class="container-fluid"&gt;
        &lt;a class="navbar-brand" href="/admin/dashboard"&gt;CMS&lt;/a&gt;
        &lt;div class="collapse navbar-collapse"&gt;
            &lt;ul class="navbar-nav ms-auto"&gt;
                &lt;li class="nav-item dropdown"&gt;
<span class="hljs-addition">+                   &lt;a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"&gt;欢迎, {{user.username}}&lt;/a&gt;</span>
                    &lt;ul class="dropdown-menu"&gt;
                        &lt;li&gt;&lt;a class="dropdown-item" href="/admin/logout"&gt;退出登录&lt;/a&gt;&lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/nav&gt;
</code></pre>
<h3 id="t11620.3. sidebar.hbs">20.3. sidebar.hbs <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11620.3.%20sidebar.hbs"> # </a></h3>
<p>views/partials/sidebar.hbs</p>
<pre><code class="lang-diff">&lt;div class="col-md-3 col-lg-2 p-0"&gt;
    &lt;div class="accordion" id="sidebarMenu"&gt;
<span class="hljs-addition">+       {{#each menuTree}}</span>
        &lt;div class="accordion-item"&gt;
<span class="hljs-addition">+           &lt;h2 class="accordion-header" id="heading{{id}}"&gt;</span>
                &lt;button class="accordion-button" type="button" data-bs-toggle="collapse"
<span class="hljs-addition">+                   data-bs-target="#collapse{{id}}"&gt;</span>
<span class="hljs-addition">+                   {{name}}</span>
<span class="hljs-addition">+               &lt;/button&gt;</span>
            &lt;/h2&gt;
<span class="hljs-addition">+           &lt;div id="collapse{{id}}" class="accordion-collapse collapse"&gt;</span>
                &lt;div class="accordion-body"&gt;
                    &lt;ul class="list-group"&gt;
<span class="hljs-addition">+                       {{#each children}}</span>
                        &lt;li class="list-group-item"&gt;
<span class="hljs-addition">+                           &lt;a href="{{url}}"&gt;{{name}}&lt;/a&gt;</span>
                        &lt;/li&gt;
<span class="hljs-addition">+                       {{/each}}</span>
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
<span class="hljs-addition">+       {{/each}}</span>
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="t11720.4. admin.module.ts">20.4. admin.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11720.4.%20admin.module.ts"> # </a></h3>
<p>src/admin/admin.module.ts</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { MiddlewareConsumer, Module, NestModule } from '@nestjs/common';</span>
import { DashboardController } from './controllers/dashboard.controller';
import { UserController } from './controllers/user.controller';
import { RoleController } from "./controllers/role.controller";
import { AccessController } from "./controllers/access.controller";
import { TagController } from "./controllers/tag.controller";
import { ArticleController } from "./controllers/article.controller";
import { CategoryController } from "./controllers/category.controller";
import { UploadController } from './controllers/upload.controller';
import { SettingController } from './controllers/setting.controller';
import { AuthController } from './controllers/auth.controller';
<span class="hljs-addition">+import { AuthMiddleware } from './middlewares/auth.middleware';</span>
@Module({
    controllers: [DashboardController, UserController, RoleController, AccessController, TagController, ArticleController, CategoryController, UploadController, SettingController, AuthController]
})
<span class="hljs-addition">+export class AdminModule implements NestModule {</span>
<span class="hljs-addition">+   configure(consumer: MiddlewareConsumer) {</span>
<span class="hljs-addition">+       consumer</span>
<span class="hljs-addition">+           .apply(AuthMiddleware).exclude('/admin/login', '/admin/captcha', '/admin/logout').forRoutes('/admin/*');</span>
<span class="hljs-addition">+   }</span>
}

</code></pre>
<h3 id="t11820.5. auth.middleware.ts">20.5. auth.middleware.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11820.5.%20auth.middleware.ts"> # </a></h3>
<p>src/admin/middlewares/auth.middleware.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable, NestMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { Request, Response, NextFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { match } <span class="hljs-keyword">from</span> <span class="hljs-string">'path-to-regexp'</span>;
<span class="hljs-keyword">import</span> { AccessService } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/services/access.service'</span>;
<span class="hljs-keyword">import</span> { Access } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/entities/access.entity'</span>;
<span class="hljs-keyword">import</span> { AccessType } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/shared/dto/access.dto'</span>;

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthMiddleware</span> <span class="hljs-title">implements</span> <span class="hljs-title">NestMiddleware</span> </span>{
    <span class="hljs-keyword">constructor</span>(private readonly accessService: AccessService) { }
    <span class="hljs-keyword">async</span> use(req: Request, <span class="hljs-attr">res</span>: Response, <span class="hljs-attr">next</span>: NextFunction) {
        <span class="hljs-keyword">const</span> user = req.session.user;
        <span class="hljs-comment">//const user = { is_super: true, roles: [] }</span>
        <span class="hljs-keyword">if</span> (!user) {
            <span class="hljs-keyword">return</span> res.redirect(<span class="hljs-string">'/admin/login'</span>);
        }

        res.locals.user = user;

        <span class="hljs-keyword">const</span> accessTree = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.accessService.findAll();
        <span class="hljs-keyword">const</span> userAccessIds = <span class="hljs-keyword">this</span>.getUserAccessIds(user);
        res.locals.menuTree = user.is_super ? accessTree : <span class="hljs-keyword">this</span>.getMenuTree(accessTree, userAccessIds);
        <span class="hljs-keyword">if</span> (user.is_super || req.originalUrl === <span class="hljs-string">'/admin/dashboard'</span>) {
            <span class="hljs-keyword">return</span> next();
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasPermission(user, req.originalUrl)) {
            <span class="hljs-keyword">return</span> next();
        } <span class="hljs-keyword">else</span> {
            res.status(<span class="hljs-number">403</span>).render(<span class="hljs-string">'error'</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'无权限访问此页面'</span>, <span class="hljs-attr">layout</span>: <span class="hljs-literal">false</span> });
        }
    }

    private getUserAccessIds(user): number[] {
        <span class="hljs-keyword">return</span> user.roles.flatMap(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role.accesses.map(<span class="hljs-function"><span class="hljs-params">access</span> =&gt;</span> access.id));
    }

    private getMenuTree(accessTree: Access[], <span class="hljs-attr">userAccessIds</span>: number[]): Access[] {
        <span class="hljs-keyword">return</span> accessTree.filter(<span class="hljs-function"><span class="hljs-params">access</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (access.type === AccessType.FEATURE || !userAccessIds.includes(access.id)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">if</span> (access.children) {
                access.children = <span class="hljs-keyword">this</span>.getMenuTree(access.children, userAccessIds);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        });
    }

    private hasPermission(user, <span class="hljs-attr">url</span>: string): boolean {
        <span class="hljs-keyword">const</span> userAccessUrls = user.roles.flatMap(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> role.accesses.map(<span class="hljs-function"><span class="hljs-params">access</span> =&gt;</span> access.url));
        <span class="hljs-keyword">return</span> userAccessUrls.some(<span class="hljs-function"><span class="hljs-params">urlPattern</span> =&gt;</span> match(urlPattern)(url));
    }
}

</code></pre>
<h2 id="t11921.Redis会话">21.Redis会话 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t11921.Redis%E4%BC%9A%E8%AF%9D"> # </a></h2>
<pre><code class="lang-js">npm i ioredis connect-redis 
</code></pre>
<h3 id="t12021.1. redis.service.ts">21.1. redis.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12021.1.%20redis.service.ts"> # </a></h3>
<p>src/shared/services/redis.service.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Injectable, OnModuleDestroy } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> Redis <span class="hljs-keyword">from</span> <span class="hljs-string">'ioredis'</span>;
<span class="hljs-keyword">import</span> { ConfigurationService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./configuration.service'</span>;
@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisService</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnModuleDestroy</span> </span>{
    private redisClient: Redis;
    <span class="hljs-keyword">constructor</span>(
        private configurationService: ConfigurationService
    ) {
        <span class="hljs-keyword">this</span>.redisClient = <span class="hljs-keyword">new</span> Redis({
            <span class="hljs-attr">host</span>: <span class="hljs-keyword">this</span>.configurationService.redisHost,
            <span class="hljs-attr">port</span>: <span class="hljs-keyword">this</span>.configurationService.redisPort,
            <span class="hljs-attr">password</span>: <span class="hljs-keyword">this</span>.configurationService.redisPassword
        });
    }

    onModuleDestroy() {
        <span class="hljs-keyword">this</span>.redisClient.quit();
    }

    getClient(): Redis {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisClient;
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">set</span>(key: string, value: string, ttl?: number): Promise&lt;void&gt; {
        <span class="hljs-keyword">if</span> (ttl) {
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisClient.set(key, value, <span class="hljs-string">'EX'</span>, ttl);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisClient.set(key, value);
        }
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">get</span>(key: string): Promise&lt;string | null&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisClient.get(key);
    }

    <span class="hljs-keyword">async</span> del(key: string): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisClient.del(key);
    }
}

</code></pre>
<h3 id="t12121.2. configuration.service.ts">21.2. configuration.service.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12121.2.%20configuration.service.ts"> # </a></h3>
<p>src/shared/services/configuration.service.ts</p>
<pre><code class="lang-diff">import { Injectable } from "@nestjs/common";
import { ConfigService } from "@nestjs/config";
@Injectable()
export class ConfigurationService {
    constructor(private configService: ConfigService) { }
    get mysqlHost(): string {
        return this.configService.get&lt;string&gt;('MYSQL_HOST');
    }
    get mysqlPort(): number {
        return this.configService.get&lt;number&gt;('MYSQL_PORT');
    }
    get mysqlDB(): string {
        return this.configService.get&lt;string&gt;('MYSQL_DB');
    }
    get mysqlUser(): string {
        return this.configService.get&lt;string&gt;('MYSQL_USER');
    }
    get mysqlPassword(): string {
        return this.configService.get&lt;string&gt;('MYSQL_PASSWORD');
    }
    get mysqlConfig() {
        return {
            host: this.mysqlHost,
            port: this.mysqlPort,
            database: this.mysqlDB,
            username: this.mysqlUser,
            password: this.mysqlPassword
        }
    }
    get mongodbHost(): string {
        return this.configService.get&lt;string&gt;('MONGO_HOST');
    }
    get mongodbPort(): number {
        return this.configService.get&lt;number&gt;('MONGO_PORT');
    }
    get mongodbDB(): string {
        return this.configService.get&lt;string&gt;('MONGO_DB');
    }
    get mongodbUser(): string {
        return this.configService.get&lt;string&gt;('MONGO_USER');
    }
    get mongodbPassword(): string {
        return this.configService.get&lt;string&gt;('MONGO_PASSWORD');
    }
    get mongodbConfig() {
        return {
            uri: `mongodb://${this.mongodbHost}:${this.mongodbPort}/${this.mongodbDB}`
        }
    }
<span class="hljs-addition">+   get redisHost(): string {</span>
<span class="hljs-addition">+       return this.configService.get&lt;string&gt;('REDIS_HOST');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get redisPort(): number {</span>
<span class="hljs-addition">+       return this.configService.get&lt;number&gt;('REDIS_PORT');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get redisPassword(): string {</span>
<span class="hljs-addition">+       return this.configService.get&lt;string&gt;('REDIS_PASSWORD');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   get redisConfig() {</span>
<span class="hljs-addition">+       return {</span>
<span class="hljs-addition">+           host: this.redisHost,</span>
<span class="hljs-addition">+           port: this.redisPort,</span>
<span class="hljs-addition">+           password: this.redisPassword</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
}
</code></pre>
<h3 id="t12221.3. main.ts">21.3. main.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12221.3.%20main.ts"> # </a></h3>
<p>src/main.ts</p>
<pre><code class="lang-diff">import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import * as cookieParser from 'cookie-parser';
import * as session from 'express-session';
import { NestExpressApplication } from '@nestjs/platform-express';
import { join } from 'path';
import { engine } from 'express-handlebars';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { I18nValidationPipe, I18nValidationExceptionFilter } from 'nestjs-i18n';
import { useContainer } from 'class-validator';
<span class="hljs-addition">+import * as helpers from 'src/shared/helpers';</span>
<span class="hljs-addition">+import RedisStore from 'connect-redis';</span>
<span class="hljs-addition">+import { RedisService } from 'src/shared/services/redis.service';</span>
async function bootstrap() {
  const app = await NestFactory.create&lt;NestExpressApplication&gt;(AppModule, {
  });
  useContainer(app.select(AppModule), { fallbackOnErrors: true });
  app.useStaticAssets(join(__dirname, '..', 'public'));
  app.setBaseViewsDir(join(__dirname, '..', 'views'));
  app.engine('hbs', engine({
    extname: '.hbs',
    helpers,
    runtimeOptions: {
      allowProtoMethodsByDefault: true,
      allowProtoPropertiesByDefault: true
    }
  }));
  app.set('view engine', 'hbs');
  app.use(cookieParser());
<span class="hljs-addition">+ const redisService = app.get(RedisService);</span>
<span class="hljs-addition">+ const redisClient = redisService.getClient();</span>
  app.use(session({
<span class="hljs-addition">+   store: new RedisStore({ client: redisClient }),</span>
    secret: 'secret-key',
    resave: true,
    saveUninitialized: true,
    cookie: {
      maxAge: 1000 * 60 * 60 * 24 * 7
    }
  }));
  app.useGlobalPipes(new I18nValidationPipe({ transform: true }));
  app.useGlobalFilters(new I18nValidationExceptionFilter({ detailedErrors: true }));
  const config = new DocumentBuilder()
    .setTitle('CMS API')
    .setDescription('CMS API 描述')
    .setVersion("1.0")
    .addTag('CMS')
    .addCookieAuth('connect.sid')
    .addBearerAuth({
      type: 'http',
      scheme: 'bearer'
    })
    .build();
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api-doc', app, document);
  await app.listen(3000);
}
bootstrap();

</code></pre>
<h3 id="t12321.4. shared.module.ts">21.4. shared.module.ts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t12321.4.%20shared.module.ts"> # </a></h3>
<p>src/shared/shared.module.ts</p>
<pre><code class="lang-diff">import { Module, Global } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigurationService } from './services/configuration.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';
import { UserService } from './services/user.service';
import { IsUsernameUniqueConstraint } from './validators/user-validator';
import { UtilityService } from './services/utility.service';
import { Role } from "./entities/role.entity";
import { RoleService } from "./services/role.service";
import { Access } from "./entities/access.entity";
import { AccessService } from "./services/access.service";
import { Tag } from "./entities/tag.entity";
import { TagService } from "./services/tag.service";
import { Article } from "./entities/article.entity";
import { ArticleService } from "./services/article.service";
import { Category } from "./entities/category.entity";
import { CategoryService } from "./services/category.service";
import { CosService } from './services/cos.service';
import { NotificationService } from './services/notification.service';
import { MailService } from './services/mail.service';
import { WordExportService } from './services/word-export.service';
import { PptExportService } from './services/ppt-export.service';
import { ExcelExportService } from './services/excel-export.service';
import { MongooseModule } from '@nestjs/mongoose';
import { Setting, SettingSchema } from './schemas/setting.schema';
import { SettingService } from './services/setting.service';
import { DashboardService } from './services/dashboard.service';
import { WeatherService } from "./services/weather.service";
import { SystemService } from './services/system.service';
<span class="hljs-addition">+import { RedisService } from './services/redis.service';</span>
@Global()
@Module({
<span class="hljs-addition">+   providers: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService, WeatherService, SystemService, RedisService],</span>
<span class="hljs-addition">+   exports: [IsUsernameUniqueConstraint, ConfigurationService, UtilityService, UserService, RoleService, AccessService, TagService, ArticleService, CategoryService, CosService, NotificationService, MailService, WordExportService, PptExportService, ExcelExportService, SettingService, DashboardService, WeatherService, SystemService, RedisService],</span>
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        MongooseModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                uri: configurationService.mongodbConfig.uri
            }),
        }),
        MongooseModule.forFeature([
            { name: Setting.name, schema: SettingSchema },
        ]),
        TypeOrmModule.forRootAsync({
            inject: [ConfigurationService],
            useFactory: (configurationService: ConfigurationService) =&gt; ({
                type: 'mysql',
                ...configurationService.mysqlConfig,
                autoLoadEntities: true,
                synchronize: true,
                logging: false,
            })
        }),
        TypeOrmModule.forFeature([User, Role, Access, Tag, Article, Category])
    ],
})
export class SharedModule {
}

</code></pre>
<h2 id="t124CKEditor 5">CKEditor 5 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t124CKEditor%205"> # </a></h2>
<p><a href="https://ckeditor.com/docs/ckeditor5/latest/getting-started/installation/quick-start.html">ckeditor5</a>是一个现代的开源富文本编辑器，提供了高度灵活和可扩展的框架，适用于各种 Web 应用。与前几代的 CKEditor 相比，CKEditor 5 是一次彻底的重构，采用了现代的 JavaScript 技术和架构，具有模块化、可扩展、易用和性能优异等特点。</p>
<h3 id="t1251. 架构概览">1. 架构概览 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1251.%20%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"> # </a></h3>
<p>CKEditor 5 的架构围绕模块化和插件化设计，核心部分仅包含基本的编辑器框架，而具体的功能如格式化文本、插入图片、创建表格等都是通过插件来实现的。CKEditor 5 的核心特点包括：</p>
<ul>
<li><strong>模块化设计</strong>: 通过插件扩展功能，开发者可以自由组合功能，创建定制的编辑器。</li>
<li><strong>MVC 架构</strong>: CKEditor 5 采用了基于 MVC（Model-View-Controller）的架构，使得数据和界面的分离更加清晰。</li>
<li><strong>实时协作</strong>: 支持多人同时编辑文档，并能实时看到其他人的编辑操作。</li>
<li><strong>高度可配置性</strong>: 允许开发者通过配置项和 API 深度定制编辑器的行为和外观。</li>
<li><strong>可扩展性</strong>: 通过编写自定义插件或扩展现有插件，开发者可以进一步增强编辑器的功能。</li>
</ul>
<h3 id="t1262. 主要特性">2. 主要特性 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1262.%20%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7"> # </a></h3>
<ul>
<li><strong>现代化的用户界面</strong>: CKEditor 5 的 UI 基于用户体验的最佳实践，采用了响应式设计，适用于桌面和移动设备。</li>
<li><strong>实时协作</strong>: CKEditor 5 内置了实时协作功能，允许多个用户同时编辑同一文档，类似于 Google Docs。</li>
<li><strong>文档编辑模式</strong>: CKEditor 5 提供了文档模式和内联模式两种编辑模式。文档模式模拟了传统的文档编辑器（如 Word）的界面，而内联模式则允许在网页中的任何地方直接编辑内容。</li>
<li><strong>数据模型</strong>: CKEditor 5 具有先进的数据模型，确保编辑内容的一致性和完整性，尤其是在复杂的文档结构中。</li>
<li><strong>插件和生态系统</strong>: CKEditor 5 提供了丰富的插件生态系统，涵盖了从基础的文本格式化到高级的表格、图像处理、媒体嵌入等多种功能。</li>
<li><strong>内置 Markdown 支持</strong>: CKEditor 5 支持将内容导出为 Markdown 格式，非常适合需要纯文本输出的场景。</li>
<li><strong>易于集成</strong>: CKEditor 5 提供了多种集成方式，支持与现代前端框架（如 React、Angular、Vue.js）以及传统的后端技术（如 Django、Laravel）无缝结合。</li>
</ul>
<h3 id="t1273. 安装与使用">3. 安装与使用 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1273.%20%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"> # </a></h3>
<p>CKEditor 5 可以通过多种方式安装和使用：</p>
<ul>
<li><p><strong>直接引用 CDN</strong>:
如果你只是需要一个简单的编辑器，可以直接从 CDN 引用 CKEditor 5 的构建版本。</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.ckeditor.com/ckeditor5/39.0.0/classic/ckeditor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    ClassicEditor
        .create(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#editor'</span>))
        .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
            <span class="hljs-built_in">console</span>.error(error);
        });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
</li>
<li><p><strong>通过 npm 安装</strong>:
对于更复杂的应用，可以使用 npm 安装 CKEditor 5，并将其集成到你的项目中。</p>
<pre><code class="lang-bash">npm install --save @ckeditor/ckeditor5-build-classic
</code></pre>
<p>安装后，你可以在你的 JavaScript 代码中导入并初始化 CKEditor 5：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> ClassicEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-build-classic/src/ckeditor'</span>;

ClassicEditor
    .create(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#editor'</span>))
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(error);
    });
</code></pre>
</li>
</ul>
<h3 id="t1284. 编辑器构建">4. 编辑器构建 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1284.%20%E7%BC%96%E8%BE%91%E5%99%A8%E6%9E%84%E5%BB%BA"> # </a></h3>
<p>CKEditor 5 提供了多种编辑器构建版本，每个版本包含了不同的默认插件组合，以满足不同的需求：</p>
<ul>
<li><strong>Classic Editor</strong>: 传统的富文本编辑器界面，适用于大多数使用场景。</li>
<li><strong>Inline Editor</strong>: 允许直接在网页中的元素上进行编辑，不显示工具栏。</li>
<li><strong>Balloon Editor</strong>: 工具栏以气泡的形式显示在编辑内容的上方。</li>
<li><strong>Balloon Block Editor</strong>: 类似于 Balloon Editor，但更适合块级内容的编辑。</li>
<li><strong>Decoupled Editor</strong>: 工具栏和编辑区域分离的版本，允许将工具栏放置在页面的不同位置。</li>
</ul>
<p>开发者可以根据需求选择合适的编辑器构建，或者自己通过自定义插件组合构建一个完全定制的 CKEditor 5。</p>
<h3 id="t1295. 插件系统">5. 插件系统 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1295.%20%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F"> # </a></h3>
<p>CKEditor 5 的插件系统是其灵活性的核心。每个插件都是一个独立的模块，可以根据需要启用或禁用。插件可以实现各种功能，例如文本格式化、图像处理、表格、媒体嵌入、代码块等。</p>
<ul>
<li><p><strong>插件安装</strong>: 可以通过 npm 安装官方插件或第三方插件。</p>
<pre><code class="lang-bash">npm install --save @ckeditor/ckeditor5-basic-styles @ckeditor/ckeditor5-image
</code></pre>
</li>
<li><p><strong>启用插件</strong>: 在编辑器配置中启用插件。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> ClassicEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-build-classic/src/ckeditor'</span>;
<span class="hljs-keyword">import</span> Bold <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-basic-styles/src/bold'</span>;
<span class="hljs-keyword">import</span> Italic <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-basic-styles/src/italic'</span>;

ClassicEditor
    .create(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#editor'</span>), {
        <span class="hljs-attr">plugins</span>: [Bold, Italic],
        <span class="hljs-attr">toolbar</span>: [<span class="hljs-string">'bold'</span>, <span class="hljs-string">'italic'</span>]
    })
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(error);
    });
</code></pre>
</li>
</ul>
<h3 id="t1306. 自定义与扩展">6. 自定义与扩展 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1306.%20%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%A9%E5%B1%95"> # </a></h3>
<p>CKEditor 5 允许开发者创建自定义插件或扩展现有插件，以满足特定需求。开发者可以使用 JavaScript 创建插件，定义其行为和界面，并将其集成到编辑器中。</p>
<ul>
<li><p><strong>创建自定义插件</strong>: 自定义插件可以实现特定的功能，例如一个新的按钮或工具。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> Plugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/plugin'</span>;
<span class="hljs-keyword">import</span> ButtonView <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-ui/src/button/buttonview'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">this</span>.editor;

        editor.ui.componentFactory.add(<span class="hljs-string">'myButton'</span>, locale =&gt; {
            <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> ButtonView(locale);

            view.set({
                <span class="hljs-attr">label</span>: <span class="hljs-string">'My Button'</span>,
                <span class="hljs-attr">withText</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">tooltip</span>: <span class="hljs-literal">true</span>
            });

            view.on(<span class="hljs-string">'execute'</span>, () =&gt; {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'My Button was clicked!'</span>);
            });

            <span class="hljs-keyword">return</span> view;
        });
    }
}

ClassicEditor
    .create(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#editor'</span>), {
        <span class="hljs-attr">plugins</span>: [MyPlugin],
        <span class="hljs-attr">toolbar</span>: [<span class="hljs-string">'myButton'</span>]
    })
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(error);
    });
</code></pre>
</li>
</ul>
<h3 id="t1317. 集成与使用">7. 集成与使用 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1317.%20%E9%9B%86%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8"> # </a></h3>
<p>CKEditor 5 具有广泛的集成功能，可以与各种前端框架（如 React、Angular、Vue.js）以及后端框架（如 Django、Laravel）无缝集成。</p>
<ul>
<li><p><strong>React 集成</strong>: 通过 CKEditor 5 的官方 React 组件，可以轻松地将 CKEditor 5 集成到 React 应用中。</p>
<pre><code class="lang-bash">npm install --save @ckeditor/ckeditor5-react @ckeditor/ckeditor5-build-classic
</code></pre>
<p>在 React 中使用：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { CKEditor } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-react'</span>;
<span class="hljs-keyword">import</span> ClassicEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-build-classic'</span>;

<span class="hljs-keyword">const</span> MyComponent = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CKEditor</span>
        <span class="hljs-attr">editor</span>=<span class="hljs-string">{</span> <span class="hljs-attr">ClassicEditor</span> }
        <span class="hljs-attr">data</span>=<span class="hljs-string">"&lt;p&gt;Hello from CKEditor 5!&lt;/p&gt;"</span>
        <span class="hljs-attr">onReady</span>=<span class="hljs-string">{</span> <span class="hljs-attr">editor</span> =&gt;</span> {
            console.log('Editor is ready to use!', editor);
        } }
        onChange={ (event, editor) =&gt; {
            const data = editor.getData();
            console.log({ event, editor, data });
        } }
        onBlur={ (event, editor) =&gt; {
            console.log('Blur.', editor);
        } }
        onFocus={ (event, editor) =&gt; {
            console.log('Focus.', editor);
        } }
    /&gt;</span>
);
</code></pre>
</li>
<li><p><strong>Angular 集成</strong>: 通过 CKEditor 5 的官方 Angular 组件，可以将 CKEditor 5 集成到 Angular 项目中。</p>
<pre><code class="lang-bash">npm install --save @ckeditor/ckeditor5-angular @ckeditor/ckeditor5-build-classic
</code></pre>
<p>在 Angular 中使用：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Component } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> ClassicEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-build-classic'</span>;

<span class="hljs-meta">@Component</span>({
    selector: <span class="hljs-string">'app-root'</span>,
    template: <span class="hljs-string">`&lt;ckeditor [editor]="Editor" data="&lt;p&gt;Hello from CKEditor 5!&lt;/p&gt;"&gt;&lt;/ckeditor&gt;`</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppComponent {
    <span class="hljs-keyword">public</span> Editor = ClassicEditor;
}
</code></pre>
</li>
<li><p><strong>Vue.js 集成</strong>: Vue.js 的 CKEditor 5 集成也是通过官方组件来实现的。</p>
</li>
</ul>
<pre><code class="lang-bash">  npm install --save @ckeditor/ckeditor5-vue @ckeditor/ckeditor5-build-classic
</code></pre>
<p>  在 Vue.js 中使用：</p>
<pre><code class="lang-javascript">  <span class="hljs-keyword">import</span> Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
  <span class="hljs-keyword">import</span> CKEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-vue'</span>;
  <span class="hljs-keyword">import</span> ClassicEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-build-classic'</span>;

  Vue.use(CKEditor);

  <span class="hljs-keyword">new</span> Vue({
      <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
      <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">editor</span>: ClassicEditor,
          <span class="hljs-attr">editorData</span>: <span class="hljs-string">'&lt;p&gt;Hello from CKEditor 5!&lt;/p&gt;'</span>,
      }
  });
</code></pre>
<h3 id="t1328. 高级功能">8. 高级功能 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1328.%20%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"> # </a></h3>
<ul>
<li><strong>实时协作</strong>: CKEditor 5 内置了实时协作功能，支持多个用户同时编辑同一文档。需要使用 CKEditor 提供的付费服务来启用此功能。</li>
<li><strong>多语言支持</strong>: CKEditor 5 提供了多语言支持，可以根据用户的语言设置自动切换编辑器的语言。</li>
<li><strong>自定义数据处理</strong>: 通过自定义数据处理，你可以控制编辑器如何处理输入和输出数据，包括格式、标签过滤等。</li>
<li><strong>安全性</strong>: CKEditor 5 在处理 HTML 内容时非常注重安全性，默认会对潜在的 XSS 攻击进行过滤。</li>
</ul>
<h3 id="t1339. 总结">9. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1339.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p>CKEditor 5 是一个强大且灵活的富文本编辑器，它不仅适用于简单的文本编辑任务，还可以处理复杂的文档编辑需求。通过其模块化设计和插件系统，CKEditor 5 可以轻松地集成到各种 Web 应用中，同时还提供了丰富的 API 供开发者进行深度定制。无论是构建一个简单的博客平台，还是开发一个复杂的内容管理系统，CKEditor 5 都能为你提供可靠的解决方案。</p>
<h2 id="t134Simple Upload Adapter">Simple Upload Adapter <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t134Simple%20Upload%20Adapter"> # </a></h2>
<p><a href="https://ckeditor.com/docs/ckeditor5/latest/features/images/image-upload/simple-upload-adapter.html">Simple Upload Adapter</a></p>
<p><strong>Simple Upload Adapter</strong> 是 CKEditor 5 中用于实现文件上传的一个插件。它提供了一种简单的方式，将文件（通常是图片）从编辑器直接上传到服务器。Simple Upload Adapter 是一个入门级的上传解决方案，适用于不需要复杂上传逻辑的场景。</p>
<h3 id="t1351. 工作原理">1. 工作原理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1351.%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"> # </a></h3>
<p>Simple Upload Adapter 的工作原理非常简单：当用户在编辑器中插入文件（例如通过拖放或选择文件）时，适配器会捕获该文件，并将其上传到服务器。一旦上传成功，服务器会返回文件的 URL，适配器将该 URL 插入到编辑器中，使文件显示在文档中。</p>
<h3 id="t1362. 配置 Simple Upload Adapter">2. 配置 Simple Upload Adapter <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1362.%20%E9%85%8D%E7%BD%AE%20Simple%20Upload%20Adapter"> # </a></h3>
<p>要使用 Simple Upload Adapter，需要在初始化 CKEditor 5 时进行相应的配置。你需要指定一个上传的 URL，文件会被上传到这个 URL，并且服务器返回的响应中需要包含上传文件的 URL。</p>
<p>以下是配置 Simple Upload Adapter 的步骤：</p>
<ol>
<li><p><strong>安装 CKEditor 5 并加载插件</strong></p>
<p>通常，CKEditor 5 的一些构建版本（如 ClassicEditor）已经包含了 Simple Upload Adapter 插件。如果你自己构建 CKEditor 5，请确保包含 <code>SimpleUploadAdapter</code> 插件。</p>
<p>示例代码（假设已经安装了 CKEditor 5）：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> ClassicEditor <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-build-classic'</span>;
</code></pre>
</li>
<li><p><strong>配置上传适配器</strong></p>
<p>在初始化编辑器时，配置 <code>simpleUpload</code> 插件，指定 <code>uploadUrl</code> 作为上传的目标 URL：</p>
<pre><code class="lang-javascript">ClassicEditor
    .create(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#editor'</span>), {
        <span class="hljs-attr">simpleUpload</span>: {
            <span class="hljs-comment">// The URL that the images are uploaded to.</span>
            <span class="hljs-attr">uploadUrl</span>: <span class="hljs-string">'https://your-server.com/upload'</span>,

            <span class="hljs-comment">// Enable the XMLHttpRequest.withCredentials property.</span>
            <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>,

            <span class="hljs-comment">// Headers sent along with the XMLHttpRequest to the upload server.</span>
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-string">'X-CSRF-TOKEN'</span>: <span class="hljs-string">'CSRF-Token'</span>,
                <span class="hljs-attr">Authorization</span>: <span class="hljs-string">'Bearer &lt;JSON Web Token&gt;'</span>
            }
        }
    })
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(error);
    });
</code></pre>
<ul>
<li><strong>uploadUrl</strong>: 必须配置，它是文件上传的服务器端处理地址。用户在编辑器中插入文件时，文件会被上传到这个 URL。</li>
<li><strong>withCredentials</strong>: 如果需要跨域请求并发送凭据（如 cookies），可以设置为 <code>true</code>。</li>
<li><strong>headers</strong>: 可以配置额外的 HTTP 请求头，比如身份验证的 token 或 CSRF 保护。</li>
</ul>
</li>
</ol>
<h3 id="t1373. 服务器端处理">3. 服务器端处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1373.%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%A4%84%E7%90%86"> # </a></h3>
<p>服务器端需要处理上传请求并返回一个包含文件 URL 的 JSON 响应。上传的文件通常以 <code>FormData</code> 的形式发送到服务器，服务器需要将文件存储在适当的位置，并将文件的可访问 URL 返回给客户端。</p>
<p>示例（Node.js Express 服务器）：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// 设置 multer 存储</span>
<span class="hljs-keyword">const</span> storage = multer.diskStorage({
    <span class="hljs-attr">destination</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
        cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'uploads/'</span>);
    },
    <span class="hljs-attr">filename</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
        cb(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Date</span>.now() + path.extname(file.originalname)); <span class="hljs-comment">// 保存文件时，使用时间戳命名</span>
    }
});
<span class="hljs-keyword">const</span> upload = multer({ <span class="hljs-attr">storage</span>: storage });

<span class="hljs-comment">// 处理文件上传请求</span>
app.post(<span class="hljs-string">'/upload'</span>, upload.single(<span class="hljs-string">'upload'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-comment">// 返回文件的 URL</span>
    res.json({
        <span class="hljs-attr">url</span>: <span class="hljs-string">`/uploads/<span class="hljs-subst">${req.file.filename}</span>`</span>
    });
});

app.listen(<span class="hljs-number">3000</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Server started on port 3000'</span>));
</code></pre>
<p>这个服务器代码处理文件上传并将文件保存在 <code>uploads/</code> 目录中，然后返回文件的 URL 供 CKEditor 5 使用。</p>
<h3 id="t1384. 返回数据格式">4. 返回数据格式 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1384.%20%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"> # </a></h3>
<p>服务器端应该返回以下格式的 JSON 响应：</p>
<pre><code class="lang-json">{
    <span class="hljs-attr">"url"</span>: <span class="hljs-string">"https://your-server.com/uploads/filename.jpg"</span>
}
</code></pre>
<ul>
<li><strong>url</strong>: 这是文件的公开访问路径。CKEditor 5 将使用此 URL 在编辑器中显示上传的文件。</li>
</ul>
<h3 id="t1395. 使用场景">5. 使用场景 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1395.%20%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"> # </a></h3>
<p>Simple Upload Adapter 适合以下场景：</p>
<ul>
<li><strong>轻量级文件上传</strong>: 需要实现简单的文件上传功能，不需要复杂的文件处理逻辑。</li>
<li><strong>快速集成</strong>: 需要快速将文件上传功能集成到现有的 CKEditor 5 实例中。</li>
<li><strong>静态资源服务器</strong>: 文件上传到服务器后即可通过 URL 访问，无需进一步的处理。</li>
</ul>
<h3 id="t1406. 限制与注意事项">6. 限制与注意事项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1406.%20%E9%99%90%E5%88%B6%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"> # </a></h3>
<ul>
<li><strong>仅适用于简单场景</strong>: Simple Upload Adapter 适用于简单的文件上传场景，如果需要更复杂的功能（如多文件上传、进度显示、错误处理、文件压缩等），需要自定义适配器或使用其他高级上传插件。</li>
<li><strong>服务器端安全性</strong>: 服务器端应确保上传过程的安全性，防止不安全文件或恶意代码上传到服务器。可以使用文件类型验证、大小限制等措施来增强安全性。</li>
</ul>
<h3 id="t1417. 总结">7. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1417.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p>Simple Upload Adapter 是 CKEditor 5 提供的一个非常简单且易于配置的文件上传适配器。它适合那些不需要复杂上传逻辑的应用场景，但对于更复杂的需求，可能需要选择更高级的上传解决方案或自定义适配器。通过了解并使用 Simple Upload Adapter，你可以轻松地在 Web 应用中实现基础的文件上传功能。</p>
<h2 id="t142CKEditor 插件">CKEditor 插件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t142CKEditor%20%E6%8F%92%E4%BB%B6"> # </a></h2>
<p>编写 CKEditor 插件可以让你扩展编辑器的功能，增加自定义的行为或界面元素。以下是编写 CKEditor 5 插件的基本步骤和核心概念。</p>
<h3 id="t1431. 了解 CKEditor 插件架构">1. 了解 CKEditor 插件架构 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1431.%20%E4%BA%86%E8%A7%A3%20CKEditor%20%E6%8F%92%E4%BB%B6%E6%9E%B6%E6%9E%84"> # </a></h3>
<p>CKEditor 5 是基于模块化和插件化的架构构建的。每个功能几乎都是通过插件实现的。插件可以控制编辑器的行为、添加新的命令、修改 UI 元素，甚至改变编辑器的数据处理方式。</p>
<h3 id="t1442. 设置开发环境">2. 设置开发环境 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1442.%20%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"> # </a></h3>
<p>首先，需要确保你有一个基本的 CKEditor 5 环境，可以通过 npm 或 yarn 来安装 CKEditor 5 的源代码。</p>
<pre><code class="lang-bash">npm install --save @ckeditor/ckeditor5-core @ckeditor/ckeditor5-basic-styles
</code></pre>
<p>你可以使用 webpack 或其他打包工具来构建你的 CKEditor 5 项目。</p>
<h3 id="t1453. 创建插件基础结构">3. 创建插件基础结构 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1453.%20%E5%88%9B%E5%BB%BA%E6%8F%92%E4%BB%B6%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84"> # </a></h3>
<p>插件通常是一个继承自 <code>Plugin</code> 基类的类。以下是一个简单的插件框架：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> Plugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/plugin'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCustomPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'MyCustomPlugin is initialized.'</span>);
    }
}
</code></pre>
<h3 id="t1464. 实现插件功能">4. 实现插件功能 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1464.%20%E5%AE%9E%E7%8E%B0%E6%8F%92%E4%BB%B6%E5%8A%9F%E8%83%BD"> # </a></h3>
<p>插件的核心功能在 <code>init()</code> 方法中实现。你可以在这里注册命令、修改编辑器的行为，或者添加新的 UI 组件。</p>
<h4 id="t1474.1. 添加自定义命令">4.1. 添加自定义命令 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1474.1.%20%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%91%BD%E4%BB%A4"> # </a></h4>
<p>命令是 CKEditor 5 中的一个核心概念。命令通常表示一个可以由用户触发的操作，比如加粗文本、插入图像等。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> Plugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/plugin'</span>;
<span class="hljs-keyword">import</span> Command <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/command'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCustomCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span> </span>{
    execute() {
        <span class="hljs-comment">// 在这里执行命令的逻辑</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'MyCustomCommand is executed.'</span>);
    }

    refresh() {
        <span class="hljs-comment">// 在这里更新命令的状态（例如启用/禁用）</span>
        <span class="hljs-keyword">this</span>.isEnabled = <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCustomPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-comment">// 注册自定义命令</span>
        <span class="hljs-keyword">this</span>.editor.commands.add(<span class="hljs-string">'myCustomCommand'</span>, <span class="hljs-keyword">new</span> MyCustomCommand(<span class="hljs-keyword">this</span>.editor));
    }
}
</code></pre>
<p>你可以通过调用 <code>editor.execute('myCustomCommand')</code> 来触发这个命令。</p>
<h4 id="t1484.2. 添加按钮到工具栏">4.2. 添加按钮到工具栏 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1484.2.%20%E6%B7%BB%E5%8A%A0%E6%8C%89%E9%92%AE%E5%88%B0%E5%B7%A5%E5%85%B7%E6%A0%8F"> # </a></h4>
<p>如果你希望用户可以通过工具栏按钮来触发你的命令，你需要添加一个按钮：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> Plugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/plugin'</span>;
<span class="hljs-keyword">import</span> ButtonView <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-ui/src/button/buttonview'</span>;
<span class="hljs-keyword">import</span> icon <span class="hljs-keyword">from</span> <span class="hljs-string">'./path-to-icon.svg'</span>; <span class="hljs-comment">// 导入图标</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCustomPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">this</span>.editor;
        <span class="hljs-comment">// 注册按钮并将其与命令关联</span>
        editor.ui.componentFactory.add(<span class="hljs-string">'myCustomButton'</span>, locale =&gt; {
            <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> ButtonView(locale);
            view.set({
                <span class="hljs-attr">label</span>: <span class="hljs-string">'My Custom Button'</span>,
                <span class="hljs-attr">icon</span>: icon, <span class="hljs-comment">// 设置按钮的图标</span>
                <span class="hljs-attr">tooltip</span>: <span class="hljs-literal">true</span>
            });
            <span class="hljs-comment">// 绑定按钮的执行行为</span>
            view.on(<span class="hljs-string">'execute'</span>, () =&gt; {
                editor.execute(<span class="hljs-string">'myCustomCommand'</span>);
            });

            <span class="hljs-keyword">return</span> view;
        });
    }
}
</code></pre>
<p>然后，你需要在配置编辑器时，将你的按钮添加到工具栏中：</p>
<pre><code class="lang-javascript">ClassicEditor
    .create(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#editor'</span>), {
        <span class="hljs-attr">plugins</span>: [ MyCustomPlugin ],
        <span class="hljs-attr">toolbar</span>: [ <span class="hljs-string">'myCustomButton'</span> ]
    })
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(error);
    });
</code></pre>
<h4 id="t1494.3. 修改编辑器内容">4.3. 修改编辑器内容 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1494.3.%20%E4%BF%AE%E6%94%B9%E7%BC%96%E8%BE%91%E5%99%A8%E5%86%85%E5%AE%B9"> # </a></h4>
<p>你可以通过修改编辑器模型来改变内容。例如，添加一个自定义的文本格式化命令：</p>
<pre><code class="lang-javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InsertTextCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span> </span>{
    execute() {
        <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">this</span>.editor.model;
        model.change(<span class="hljs-function"><span class="hljs-params">writer</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> textNode = writer.createText(<span class="hljs-string">'Hello, world!'</span>);
            model.insertContent(textNode, model.document.selection);
        });
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InsertTextPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-keyword">this</span>.editor.commands.add(<span class="hljs-string">'insertText'</span>, <span class="hljs-keyword">new</span> InsertTextCommand(<span class="hljs-keyword">this</span>.editor));
    }
}
</code></pre>
<h3 id="t1505. 扩展编辑器的 Schema">5. 扩展编辑器的 Schema <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1505.%20%E6%89%A9%E5%B1%95%E7%BC%96%E8%BE%91%E5%99%A8%E7%9A%84%20Schema"> # </a></h3>
<p>CKEditor 5 有一个强大的 schema（模式）系统，用于定义编辑器中允许的内容结构。如果你希望引入新的内容类型，比如自定义的 HTML 标签或属性，你需要扩展编辑器的 schema。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> Plugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/plugin'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySchemaPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">this</span>.editor.model.schema;
        <span class="hljs-comment">// 注册自定义元素</span>
        schema.register(<span class="hljs-string">'customElement'</span>, {
            <span class="hljs-attr">isObject</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">allowWhere</span>: <span class="hljs-string">'$block'</span>,
            <span class="hljs-attr">allowAttributes</span>: [<span class="hljs-string">'name'</span>]
        });
    }
}
</code></pre>
<h3 id="t1516. 处理数据转换">6. 处理数据转换 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1516.%20%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2"> # </a></h3>
<p>CKEditor 5 有自己的数据模型，为了正确处理自定义元素或内容，你可能需要编写自定义的转换器来处理从模型到视图、视图到模型的转换。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> Plugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-core/src/plugin'</span>;
<span class="hljs-keyword">import</span> { toWidget, toWidgetEditable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ckeditor/ckeditor5-widget/src/utils'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySchemaPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Plugin</span> </span>{
    init() {
        <span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">this</span>.editor;
        <span class="hljs-keyword">const</span> conversion = editor.conversion;

        <span class="hljs-comment">// 视图 -&gt; 模型</span>
        conversion.for(<span class="hljs-string">'upcast'</span>).elementToElement({
            <span class="hljs-attr">model</span>: <span class="hljs-string">'customElement'</span>,
            <span class="hljs-attr">view</span>: {
                <span class="hljs-attr">name</span>: <span class="hljs-string">'div'</span>,
                <span class="hljs-attr">classes</span>: <span class="hljs-string">'custom-element'</span>
            }
        });

        <span class="hljs-comment">// 模型 -&gt; 视图</span>
        conversion.for(<span class="hljs-string">'dataDowncast'</span>).elementToElement({
            <span class="hljs-attr">model</span>: <span class="hljs-string">'customElement'</span>,
            <span class="hljs-attr">view</span>: <span class="hljs-function">(<span class="hljs-params">modelElement, viewWriter</span>) =&gt;</span> {
                <span class="hljs-keyword">return</span> viewWriter.createContainerElement(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'custom-element'</span> });
            }
        });

        conversion.for(<span class="hljs-string">'editingDowncast'</span>).elementToElement({
            <span class="hljs-attr">model</span>: <span class="hljs-string">'customElement'</span>,
            <span class="hljs-attr">view</span>: <span class="hljs-function">(<span class="hljs-params">modelElement, viewWriter</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> widget = viewWriter.createContainerElement(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'custom-element'</span> });
                <span class="hljs-keyword">return</span> toWidget(widget, viewWriter);
            }
        });
    }
}
</code></pre>
<h3 id="t1527. 测试与调试">7. 测试与调试 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1527.%20%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B0%83%E8%AF%95"> # </a></h3>
<p>在完成插件的开发后，确保通过各种场景对插件进行测试。使用 CKEditor 5 的内置调试工具或浏览器的开发者工具来监控插件的行为和性能。</p>
<h3 id="t1538. 发布和分享插件">8. 发布和分享插件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1538.%20%E5%8F%91%E5%B8%83%E5%92%8C%E5%88%86%E4%BA%AB%E6%8F%92%E4%BB%B6"> # </a></h3>
<p>当你的插件开发完成并经过测试后，可以将其发布到 npm 或 GitHub，以便其他开发者可以使用和贡献。如果你计划长期维护该插件，建议编写详细的文档。</p>
<h3 id="t1549. 总结">9. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1549.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p>编写 CKEditor 5 插件是一项有趣且强大的任务，允许你根据需求自定义编辑器的行为。CKEditor 5 的模块化设计使得插件开发变得相对简单，通过遵循上述步骤，你可以创建功能强大且易于集成的插件。通过深入理解 CKEditor 5 的架构和功能，你可以实现从简单的按钮命令到复杂的内容处理等多种扩展。</p>
<h2 id="t155@nestjs/event-emitter">@nestjs/event-emitter <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t155@nestjs/event-emitter"> # </a></h2>
<p><code>@nestjs/event-emitter</code> 是一个 NestJS 模块，提供了事件驱动的编程模型，使得在应用中发布和订阅事件变得更加简单和高效。这个模块基于 <code>eventemitter2</code>，允许你在 NestJS 应用中使用事件发布-订阅（Pub-Sub）模式，这对于解耦组件、处理异步任务和实现跨模块通信非常有用。</p>
<h3 id="t1561. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1561.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>首先，你需要在 NestJS 项目中安装 <code>@nestjs/event-emitter</code> 包：</p>
<pre><code class="lang-bash">npm install @nestjs/event-emitter eventemitter2
</code></pre>
<h3 id="t1572. 模块配置">2. 模块配置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1572.%20%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"> # </a></h3>
<p>在使用 <code>EventEmitterModule</code> 之前，需要将其导入到应用的模块中。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Module } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { EventEmitterModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;
<span class="hljs-keyword">import</span> { AppService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;

<span class="hljs-meta">@Module</span>({
  imports: [
    EventEmitterModule.forRoot({
      wildcard: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 支持通配符事件</span>
    }),
  ],
  providers: [AppService],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule {}
</code></pre>
<h3 id="t1583. 事件的发布和订阅">3. 事件的发布和订阅 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1583.%20%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%8F%91%E5%B8%83%E5%92%8C%E8%AE%A2%E9%98%85"> # </a></h3>
<h4 id="t1593.1. 发布事件">3.1. 发布事件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1593.1.%20%E5%8F%91%E5%B8%83%E4%BA%8B%E4%BB%B6"> # </a></h4>
<p>你可以通过 <code>EventEmitter2</code> 的实例来发布事件。在 NestJS 中，可以通过依赖注入的方式来获取 <code>EventEmitter2</code> 实例。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { EventEmitter2 } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppService {
  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> eventEmitter: EventEmitter2</span>) {}

  someMethod() {
    <span class="hljs-comment">// 发布事件</span>
    <span class="hljs-keyword">this</span>.eventEmitter.emit(<span class="hljs-string">'user.created'</span>, { name: <span class="hljs-string">'John Doe'</span> });
  }
}
</code></pre>
<p>在上面的例子中，我们发布了一个 <code>user.created</code> 事件，携带了一个包含用户信息的对象作为事件数据。</p>
<h4 id="t1603.2. 订阅事件">3.2. 订阅事件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1603.2.%20%E8%AE%A2%E9%98%85%E4%BA%8B%E4%BB%B6"> # </a></h4>
<p>你可以通过装饰器 <code>@OnEvent</code> 来订阅事件，并定义事件发生时的处理逻辑。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { OnEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> UserListener {
  <span class="hljs-meta">@OnEvent</span>(<span class="hljs-string">'user.created'</span>)
  handleUserCreatedEvent(payload: <span class="hljs-built_in">any</span>) {
    <span class="hljs-comment">// 处理事件</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'用户创建事件已接收，数据:'</span>, payload);
  }
}
</code></pre>
<p>当 <code>user.created</code> 事件被发布时，<code>handleUserCreatedEvent</code> 方法会被调用，并接收发布时传递的事件数据。</p>
<h3 id="t1614. 通配符事件">4. 通配符事件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1614.%20%E9%80%9A%E9%85%8D%E7%AC%A6%E4%BA%8B%E4%BB%B6"> # </a></h3>
<p><code>@nestjs/event-emitter</code> 支持使用通配符来订阅一类事件。例如，如果你想订阅所有 <code>user</code> 相关的事件，可以使用通配符：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { OnEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> UserListener {
  <span class="hljs-meta">@OnEvent</span>(<span class="hljs-string">'user.*'</span>)
  handleUserEvents(event: <span class="hljs-built_in">string</span>, payload: <span class="hljs-built_in">any</span>) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`接收到事件 <span class="hljs-subst">${event}</span>，数据:`</span>, payload);
  }
}
</code></pre>
<p>上面的代码将会监听所有以 <code>user.</code> 开头的事件，例如 <code>user.created</code>、<code>user.updated</code> 等。</p>
<h3 id="t1625. 异步事件处理">5. 异步事件处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1625.%20%E5%BC%82%E6%AD%A5%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"> # </a></h3>
<p>事件处理函数可以是异步的，这在需要进行异步操作时非常有用。你可以简单地将事件处理函数声明为 <code>async</code>：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { OnEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> UserListener {
  <span class="hljs-meta">@OnEvent</span>(<span class="hljs-string">'user.created'</span>)
  <span class="hljs-keyword">async</span> handleUserCreatedEvent(payload: <span class="hljs-built_in">any</span>) {
    <span class="hljs-comment">// 执行异步操作</span>
    <span class="hljs-keyword">await</span> someAsyncOperation(payload);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'用户创建事件已异步处理'</span>);
  }
}
</code></pre>
<h3 id="t1636. 事件优先级">6. 事件优先级 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1636.%20%E4%BA%8B%E4%BB%B6%E4%BC%98%E5%85%88%E7%BA%A7"> # </a></h3>
<p><code>@nestjs/event-emitter</code> 允许你为事件处理器设置优先级，优先级高的处理器会先执行。你可以在 <code>@OnEvent</code> 装饰器中设置 <code>priority</code> 选项：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { OnEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> UserListener {
  <span class="hljs-meta">@OnEvent</span>(<span class="hljs-string">'user.created'</span>, { priority: <span class="hljs-number">1</span> }) <span class="hljs-comment">// 优先级为1，较高</span>
  handleUserCreatedEventHighPriority(payload: <span class="hljs-built_in">any</span>) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'高优先级处理器已执行'</span>);
  }

  <span class="hljs-meta">@OnEvent</span>(<span class="hljs-string">'user.created'</span>, { priority: <span class="hljs-number">10</span> }) <span class="hljs-comment">// 优先级为10，较低</span>
  handleUserCreatedEventLowPriority(payload: <span class="hljs-built_in">any</span>) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'低优先级处理器已执行'</span>);
  }
}
</code></pre>
<p>在上面的例子中，当 <code>user.created</code> 事件被发布时，<code>handleUserCreatedEventHighPriority</code> 会在 <code>handleUserCreatedEventLowPriority</code> 之前执行。</p>
<h3 id="t1647. 全局事件处理器">7. 全局事件处理器 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1647.%20%E5%85%A8%E5%B1%80%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8"> # </a></h3>
<p>如果你需要在整个应用中对某个事件进行监听，可以使用全局事件处理器。全局事件处理器可以通过在模块中全局注册来实现：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Module } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { EventEmitterModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;
<span class="hljs-keyword">import</span> { UserListener } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.listener'</span>;

<span class="hljs-meta">@Module</span>({
  imports: [EventEmitterModule.forRoot()],
  providers: [
    {
      provide: <span class="hljs-string">'GLOBAL_EVENT_LISTENER'</span>,
      useClass: UserListener, <span class="hljs-comment">// 将监听器作为全局监听器注册</span>
    },
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule {}
</code></pre>
<h3 id="t1658. 总结">8. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1658.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>@nestjs/event-emitter</code> 模块为 NestJS 提供了一个强大且灵活的事件驱动模型，使得应用程序的组件之间可以通过事件进行松耦合的通信。它支持同步和异步事件处理，允许使用通配符订阅事件，并可以为事件处理器设置优先级。这些功能使得 <code>@nestjs/event-emitter</code> 成为处理复杂应用场景的理想选择，特别是在处理跨模块通信和异步任务时。</p>
<h2 id="t166COS Node.js SDK v5">COS Node.js SDK v5 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t166COS%20Node.js%20SDK%20v5"> # </a></h2>
<p><code>cos-nodejs-sdk-v5</code> 是腾讯云对象存储（COS）服务的官方 Node.js SDK。它提供了方便的 API，使开发者可以轻松地在 Node.js 应用中集成和操作 COS 服务，如上传文件、下载文件、管理存储桶（Bucket）等。</p>
<h3 id="t1671. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1671.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>要使用 <code>cos-nodejs-sdk-v5</code>，首先需要在 Node.js 项目中安装它：</p>
<pre><code class="lang-bash">npm install cos-nodejs-sdk-v5 --save
</code></pre>
<h3 id="t1682. 初始化 SDK">2. 初始化 SDK <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1682.%20%E5%88%9D%E5%A7%8B%E5%8C%96%20SDK"> # </a></h3>
<p>在使用 SDK 前，需要初始化一个 COS 实例。初始化时需要提供腾讯云的 <code>SecretId</code> 和 <code>SecretKey</code>，这些凭证可以在 <a href="https://console.cloud.tencent.com/cam/capi">腾讯云控制台</a> 获取。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> COS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cos-nodejs-sdk-v5'</span>);

<span class="hljs-comment">// 初始化 COS 实例</span>
<span class="hljs-keyword">const</span> cos = <span class="hljs-keyword">new</span> COS({
    <span class="hljs-attr">SecretId</span>: <span class="hljs-string">'your-secret-id'</span>,
    <span class="hljs-attr">SecretKey</span>: <span class="hljs-string">'your-secret-key'</span>,
});
</code></pre>
<h3 id="t1693. 常用操作">3. 常用操作 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1693.%20%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"> # </a></h3>
<p><code>cos-nodejs-sdk-v5</code> 提供了一系列 API 用于操作 COS 服务。以下是一些常用的操作示例：</p>
<h4 id="t1703.1. 创建存储桶（Bucket）">3.1. 创建存储桶（Bucket） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1703.1.%20%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E6%A1%B6%EF%BC%88Bucket%EF%BC%89"> # </a></h4>
<p>创建一个存储桶，用于存储文件。存储桶名称需要在同一区域内全局唯一。</p>
<pre><code class="lang-javascript">cos.putBucket({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>,  <span class="hljs-comment">// 存储桶名称，必须以 "-APPID" 结尾</span>
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,              <span class="hljs-comment">// 存储桶所在区域</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Bucket Created:'</span>, data);
    }
});
</code></pre>
<h4 id="t1713.2. 上传文件">3.2. 上传文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1713.2.%20%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"> # </a></h4>
<p>将本地文件上传到 COS 存储桶中。</p>
<pre><code class="lang-javascript">cos.putObject({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>, <span class="hljs-comment">// 存储桶名称</span>
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,             <span class="hljs-comment">// 存储桶所在区域</span>
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'exampleobject.jpg'</span>,           <span class="hljs-comment">// 存储在存储桶中的文件名</span>
    <span class="hljs-attr">Body</span>: fs.createReadStream(<span class="hljs-string">'localfile.jpg'</span>), <span class="hljs-comment">// 本地文件路径</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'File Uploaded:'</span>, data);
    }
});
</code></pre>
<h4 id="t1723.3. 下载文件">3.3. 下载文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1723.3.%20%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"> # </a></h4>
<p>从 COS 存储桶中下载文件到本地。</p>
<pre><code class="lang-javascript">cos.getObject({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>, <span class="hljs-comment">// 存储桶名称</span>
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,             <span class="hljs-comment">// 存储桶所在区域</span>
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'exampleobject.jpg'</span>,           <span class="hljs-comment">// 存储桶中的文件名</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        fs.writeFileSync(<span class="hljs-string">'downloadedfile.jpg'</span>, data.Body); <span class="hljs-comment">// 将文件保存到本地</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'File Downloaded'</span>);
    }
});
</code></pre>
<h4 id="t1733.4. 列出存储桶中的文件">3.4. 列出存储桶中的文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1733.4.%20%E5%88%97%E5%87%BA%E5%AD%98%E5%82%A8%E6%A1%B6%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6"> # </a></h4>
<p>列出指定存储桶中的所有对象（文件）。</p>
<pre><code class="lang-javascript">cos.getBucket({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>, <span class="hljs-comment">// 存储桶名称</span>
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,             <span class="hljs-comment">// 存储桶所在区域</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Bucket Contents:'</span>, data.Contents);
    }
});
</code></pre>
<h4 id="t1743.5. 删除文件">3.5. 删除文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1743.5.%20%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"> # </a></h4>
<p>删除存储桶中的指定文件。</p>
<pre><code class="lang-javascript">cos.deleteObject({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>, <span class="hljs-comment">// 存储桶名称</span>
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,             <span class="hljs-comment">// 存储桶所在区域</span>
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'exampleobject.jpg'</span>,           <span class="hljs-comment">// 要删除的文件名</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'File Deleted:'</span>, data);
    }
});
</code></pre>
<h4 id="t1753.6. 删除存储桶">3.6. 删除存储桶 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1753.6.%20%E5%88%A0%E9%99%A4%E5%AD%98%E5%82%A8%E6%A1%B6"> # </a></h4>
<p>删除指定的存储桶。注意，删除存储桶之前，必须确保存储桶为空（无任何文件或目录）。</p>
<pre><code class="lang-javascript">cos.deleteBucket({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>, <span class="hljs-comment">// 存储桶名称</span>
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,             <span class="hljs-comment">// 存储桶所在区域</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Bucket Deleted:'</span>, data);
    }
});
</code></pre>
<h3 id="t1764. 高级功能">4. 高级功能 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1764.%20%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"> # </a></h3>
<h4 id="t1774.1. 分块上传（大文件上传）">4.1. 分块上传（大文件上传） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1774.1.%20%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%EF%BC%88%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%EF%BC%89"> # </a></h4>
<p>对于大文件上传，COS SDK 提供了分块上传的功能，可以将文件分割成多个小块并行上传，提高上传效率，并且在传输过程中如果出现问题，可以只重新上传出错的部分。</p>
<pre><code class="lang-javascript">cos.sliceUploadFile({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>,
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'largefile.zip'</span>,
    <span class="hljs-attr">FilePath</span>: <span class="hljs-string">'path/to/local/largefile.zip'</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Large File Uploaded:'</span>, data);
    }
});
</code></pre>
<h4 id="t1784.2. 设置对象的访问权限">4.2. 设置对象的访问权限 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1784.2.%20%E8%AE%BE%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"> # </a></h4>
<p>你可以为上传的对象设置访问权限，例如公开读、私有等。</p>
<pre><code class="lang-javascript">cos.putObjectAcl({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>,
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'exampleobject.jpg'</span>,
    <span class="hljs-attr">ACL</span>: <span class="hljs-string">'public-read'</span>, <span class="hljs-comment">// 设置文件为公开可读</span>
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ACL Set:'</span>, data);
    }
});
</code></pre>
<h4 id="t1794.3. 生成预签名 URL">4.3. 生成预签名 URL <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1794.3.%20%E7%94%9F%E6%88%90%E9%A2%84%E7%AD%BE%E5%90%8D%20URL"> # </a></h4>
<p>有时你需要为私有对象生成一个预签名 URL，允许用户在指定时间内访问该对象。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> url = cos.getObjectUrl({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>,
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'exampleobject.jpg'</span>,
    <span class="hljs-attr">Expires</span>: <span class="hljs-number">60</span>, <span class="hljs-comment">// URL 的有效时间为 60 秒</span>
});

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Pre-Signed URL:'</span>, url);
</code></pre>
<h3 id="t1805. 错误处理">5. 错误处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1805.%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"> # </a></h3>
<p>在使用 <code>cos-nodejs-sdk-v5</code> 时，需要对可能的错误进行处理。通常情况下，错误会通过回调函数的第一个参数传递。你可以通过查看错误对象中的 <code>code</code> 和 <code>message</code> 来了解错误的具体情况。</p>
<pre><code class="lang-javascript">cos.putObject({
    <span class="hljs-attr">Bucket</span>: <span class="hljs-string">'examplebucket-1250000000'</span>,
    <span class="hljs-attr">Region</span>: <span class="hljs-string">'ap-guangzhou'</span>,
    <span class="hljs-attr">Key</span>: <span class="hljs-string">'exampleobject.jpg'</span>,
    <span class="hljs-attr">Body</span>: fs.createReadStream(<span class="hljs-string">'localfile.jpg'</span>),
}, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error Code:'</span>, err.code);
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error Message:'</span>, err.message);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'File Uploaded:'</span>, data);
    }
});
</code></pre>
<h3 id="t1816. 总结">6. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1816.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>cos-nodejs-sdk-v5</code> 是一个功能强大且易于使用的工具，使开发者能够在 Node.js 应用中轻松集成腾讯云对象存储（COS）服务。它支持从基础的文件上传和下载，到高级的分块上传、访问控制和预签名 URL 生成等功能，几乎覆盖了所有与对象存储相关的需求。通过合理使用 SDK，开发者可以构建高效、可扩展的文件管理系统，并利用腾讯云的存储优势为应用提供可靠的数据存储解决方案。</p>
<h2 id="t182@nestjs/serve-static">@nestjs/serve-static <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t182@nestjs/serve-static"> # </a></h2>
<p><code>@nestjs/serve-static</code> 是 NestJS 提供的一个官方模块，用于在 NestJS 应用中服务静态文件。它基于 Express 或 Fastify 的静态文件中间件，通过简单的配置，使得在 NestJS 应用中服务静态资源变得非常便捷。</p>
<h3 id="t1831. 主要功能">1. 主要功能 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1831.%20%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"> # </a></h3>
<p><code>@nestjs/serve-static</code> 模块主要用于以下场景：</p>
<ul>
<li><strong>提供静态文件</strong>: 如 HTML 文件、CSS、JavaScript、图片、字体等，可以直接通过 HTTP 请求进行访问。</li>
<li><strong>支持多路径配置</strong>: 可以为不同的静态文件目录配置不同的路径和路由前缀。</li>
<li><strong>与前端框架集成</strong>: 常用于将前端构建后的静态文件（如 Angular、React、Vue 的打包输出）与 NestJS 后端应用集成在一起，形成一个统一的服务。</li>
</ul>
<h3 id="t1842. 安装和设置">2. 安装和设置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1842.%20%E5%AE%89%E8%A3%85%E5%92%8C%E8%AE%BE%E7%BD%AE"> # </a></h3>
<p>要使用 <code>@nestjs/serve-static</code> 模块，需要先进行安装：</p>
<pre><code class="lang-bash">npm install @nestjs/serve-static
</code></pre>
<p>安装后，在你的模块中进行配置，通常是在根模块（如 <code>AppModule</code>）中配置：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Module } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { ServeStaticModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/serve-static'</span>;
<span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-meta">@Module</span>({
  imports: [
    ServeStaticModule.forRoot({
      rootPath: join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'public'</span>), <span class="hljs-comment">// 指定静态文件目录</span>
    }),
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule {}
</code></pre>
<h3 id="t1853. 配置选项">3. 配置选项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1853.%20%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"> # </a></h3>
<p><code>ServeStaticModule.forRoot()</code> 方法接受一个配置对象，可以配置多个属性：</p>
<ul>
<li><p><strong><code>rootPath</code></strong>: （必填）静态文件的根目录路径。所有文件将从这个目录中提供服务。通常使用 <code>path.join()</code> 来构建路径。</p>
<pre><code class="lang-typescript">rootPath: join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'public'</span>),
</code></pre>
</li>
<li><p><strong><code>serveRoot</code></strong>: （可选）指定一个路由前缀，只有在访问 URL 以这个前缀开头时，静态文件才会被提供。如果不指定，默认情况下文件会从根路径提供。</p>
<pre><code class="lang-typescript">serveRoot: <span class="hljs-string">'/static'</span>,
</code></pre>
<p>例如，如果 <code>serveRoot</code> 设置为 <code>/static</code>，并且你请求 <code>/static/image.png</code>，它将从 <code>rootPath</code> 指定的目录中查找 <code>image.png</code>。</p>
</li>
<li><p><strong><code>exclude</code></strong>: （可选）一个字符串或字符串数组，用于排除某些路径，使其不会被静态文件中间件处理。适用于需要保护某些路由或路径不被作为静态文件服务的情况。</p>
<pre><code class="lang-typescript">exclude: [<span class="hljs-string">'/api*'</span>, <span class="hljs-string">'/auth*'</span>],
</code></pre>
</li>
<li><p><strong><code>serveStaticOptions</code></strong>: （可选）这是一个传递给底层静态文件中间件的选项对象。根据你使用的是 Express 还是 Fastify，可以配置特定的选项。例如，设置缓存控制头或指定最大缓存时间。</p>
<pre><code class="lang-typescript">serveStaticOptions: {
  cacheControl: <span class="hljs-literal">true</span>,
  maxAge: <span class="hljs-number">3600</span>, <span class="hljs-comment">// 1 hour</span>
},
</code></pre>
</li>
<li><p><strong>多路径支持</strong>: 你可以为不同的目录配置多个 <code>rootPath</code> 和 <code>serveRoot</code>。例如，分别为公共资源和上传文件设置不同的路径：</p>
<pre><code class="lang-typescript">ServeStaticModule.forRoot([
  {
    rootPath: join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'public'</span>),
    serveRoot: <span class="hljs-string">'/public'</span>,
  },
  {
    rootPath: join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'uploads'</span>),
    serveRoot: <span class="hljs-string">'/uploads'</span>,
  },
]),
</code></pre>
</li>
</ul>
<h3 id="t1864. 应用场景">4. 应用场景 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1864.%20%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"> # </a></h3>
<ul>
<li><p><strong>静态网站托管</strong>: 如果你有一个前端应用（如 Angular、React、Vue），可以将构建后的静态文件托管在 NestJS 应用中。</p>
<pre><code class="lang-typescript">ServeStaticModule.forRoot({
  rootPath: join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'client'</span>),
}),
</code></pre>
<p>然后在前端项目中构建产物（如 <code>dist</code> 目录）放入 <code>client</code> 文件夹中，NestJS 会将这些文件通过 HTTP 提供服务。</p>
</li>
<li><p><strong>混合应用</strong>: 当你希望同时提供 API 和前端页面服务时，可以使用 <code>@nestjs/serve-static</code>。例如，你可以在 <code>/api</code> 路径下提供 REST API 服务，在 <code>/</code> 路径下提供前端页面服务。</p>
</li>
<li><p><strong>文件上传与访问</strong>: 你可以将用户上传的文件保存到特定目录，并通过配置 <code>ServeStaticModule</code> 来提供这些文件的访问路径。</p>
</li>
</ul>
<h3 id="t1875. 注意事项">5. 注意事项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1875.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"> # </a></h3>
<ul>
<li><strong>优先级问题</strong>: <code>ServeStaticModule</code> 中定义的路径优先级较高，确保不要让它覆盖了你应用中其他的 API 路由。可以通过 <code>exclude</code> 选项排除不应被处理的路径。</li>
<li><strong>性能优化</strong>: 对于高流量的生产环境，建议启用缓存和压缩，并配置合适的缓存控制策略，以减少静态文件的传输次数。</li>
</ul>
<h3 id="t1886. 总结">6. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1886.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>@nestjs/serve-static</code> 模块提供了一种简单而强大的方式，将静态文件与 NestJS 应用集成在一起。它适合处理从单页面应用到复杂的多页面网站的各种场景。通过简单的配置，你可以灵活地定义静态资源的提供路径，并确保这些资源能够高效地服务于用户。</p>
<h2 id="t189Sharp：高性能图像处理库">Sharp：高性能图像处理库 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t189Sharp%EF%BC%9A%E9%AB%98%E6%80%A7%E8%83%BD%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E5%BA%93"> # </a></h2>
<p><code>Sharp</code> 是一个流行的高性能图像处理库，用于 Node.js 环境中。它支持对各种格式的图像进行快速的转换、调整、裁剪、旋转、合并等操作，且占用的内存和 CPU 资源较少，处理速度非常快。</p>
<h3 id="t1901. Sharp 的特点">1. Sharp 的特点 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1901.%20Sharp%20%E7%9A%84%E7%89%B9%E7%82%B9"> # </a></h3>
<ul>
<li><strong>高性能</strong>: <code>Sharp</code> 使用了由 libvips 提供支持的底层 C++ 库，与其他基于纯 JavaScript 的图像处理库相比，具有显著的性能优势。</li>
<li><strong>多格式支持</strong>: 支持多种图像格式，包括 JPEG、PNG、WebP、TIFF、GIF（静态）、SVG、以及支持的 AVIF 格式。</li>
<li><strong>内存优化</strong>: <code>Sharp</code> 通过流式处理和内存优化，可以处理大型图像文件而不会占用大量内存。</li>
<li><strong>功能丰富</strong>: 提供了多种图像处理功能，包括调整大小、裁剪、旋转、翻转、添加水印、调整亮度和对比度等。</li>
<li><strong>流支持</strong>: 可以将图像处理与 Node.js 流结合，支持管道操作，方便处理大文件。</li>
</ul>
<h3 id="t1912. 安装">2. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1912.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>在 Node.js 项目中使用 <code>Sharp</code>，首先需要安装它：</p>
<pre><code class="lang-bash">npm install sharp
</code></pre>
<p><code>Sharp</code> 需要编译，所以安装过程可能稍微耗时。在一些环境下（如 Windows），可能需要一些额外的构建工具来支持编译过程。</p>
<h3 id="t1923. 基本用法">3. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1923.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p><code>Sharp</code> 的使用非常直观，通常通过链式调用来执行图像处理操作。以下是一些常见的用法示例：</p>
<h4 id="t1933.1. 调整图像大小">3.1. 调整图像大小 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1933.1.%20%E8%B0%83%E6%95%B4%E5%9B%BE%E5%83%8F%E5%A4%A7%E5%B0%8F"> # </a></h4>
<p>调整图像大小是 <code>Sharp</code> 最常用的功能之一。例如，将一个图像的宽度调整为 200 像素，高度自动调整以保持比例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> sharp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sharp'</span>);

sharp(<span class="hljs-string">'input.jpg'</span>)
  .resize(<span class="hljs-number">200</span>)
  .toFile(<span class="hljs-string">'output.jpg'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<p>你还可以指定宽度和高度，如果不保持比例，图像会被拉伸或压缩：</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .resize(<span class="hljs-number">200</span>, <span class="hljs-number">300</span>)
  .toFile(<span class="hljs-string">'output.jpg'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<h4 id="t1943.2. 裁剪图像">3.2. 裁剪图像 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1943.2.%20%E8%A3%81%E5%89%AA%E5%9B%BE%E5%83%8F"> # </a></h4>
<p>裁剪图像也是常见需求，可以使用 <code>resize</code> 方法结合 <code>crop</code> 参数来完成裁剪操作：</p>
<p>在使用 <code>Sharp</code> 进行图像大小调整时，<code>fit</code> 选项决定了图像如何适应给定的宽度和高度。它主要有以下几种模式：</p>
<ul>
<li><strong><code>cover</code></strong>: 默认值，裁剪图像以填充给定的尺寸，可能会裁掉一部分图像内容。</li>
<li><strong><code>contain</code></strong>: 将图像缩放以适应给定的尺寸，但保持整个图像在范围内，可能会出现空白区域。</li>
<li><strong><code>fill</code></strong>: 拉伸图像以完全填充给定的尺寸，可能会改变图像的宽高比例。</li>
<li><strong><code>inside</code></strong>: 将图像缩放以适应给定的尺寸，同时确保整个图像都在范围内，保持宽高比例，并且不裁剪图像。</li>
<li><strong><code>outside</code></strong>: 将图像缩放以覆盖给定的尺寸，保持宽高比例，可能会超出范围，但不会裁剪图像。</li>
</ul>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .resize(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>, {
    <span class="hljs-attr">fit</span>: sharp.fit.cover, <span class="hljs-comment">// 裁剪以适应尺寸</span>
    <span class="hljs-attr">position</span>: sharp.strategy.entropy <span class="hljs-comment">// 根据图像内容裁剪</span>
  })
  .toFile(<span class="hljs-string">'output.jpg'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<h4 id="t1953.3. 转换图像格式">3.3. 转换图像格式 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1953.3.%20%E8%BD%AC%E6%8D%A2%E5%9B%BE%E5%83%8F%E6%A0%BC%E5%BC%8F"> # </a></h4>
<p>将图像从一种格式转换为另一种格式非常简单。例如，将一个 JPEG 图像转换为 PNG：</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .png()
  .toFile(<span class="hljs-string">'output.png'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<h4 id="t1963.4. 旋转和翻转图像">3.4. 旋转和翻转图像 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1963.4.%20%E6%97%8B%E8%BD%AC%E5%92%8C%E7%BF%BB%E8%BD%AC%E5%9B%BE%E5%83%8F"> # </a></h4>
<p>可以轻松地对图像进行旋转和翻转：</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .rotate(<span class="hljs-number">90</span>) <span class="hljs-comment">// 顺时针旋转 90 度</span>
  .flip() <span class="hljs-comment">// 上下翻转</span>
  .toFile(<span class="hljs-string">'output.jpg'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<h4 id="t1973.5. 添加水印">3.5. 添加水印 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1973.5.%20%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0"> # </a></h4>
<p><code>Sharp</code> 允许通过组合多个图像来添加水印。例如，在一个图像上添加一个透明的水印：</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .composite([{ <span class="hljs-attr">input</span>: <span class="hljs-string">'watermark.png'</span>, <span class="hljs-attr">gravity</span>: <span class="hljs-string">'southeast'</span> }])
  .toFile(<span class="hljs-string">'output.jpg'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<h4 id="t1983.6. 调整图像亮度和对比度">3.6. 调整图像亮度和对比度 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1983.6.%20%E8%B0%83%E6%95%B4%E5%9B%BE%E5%83%8F%E4%BA%AE%E5%BA%A6%E5%92%8C%E5%AF%B9%E6%AF%94%E5%BA%A6"> # </a></h4>
<p><code>Sharp</code> 还可以调整图像的亮度、对比度、饱和度等参数：</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .modulate({
    <span class="hljs-attr">brightness</span>: <span class="hljs-number">1.2</span>, <span class="hljs-comment">// 亮度增加 20%</span>
    <span class="hljs-attr">contrast</span>: <span class="hljs-number">1.5</span> <span class="hljs-comment">// 对比度增加 50%</span>
  })
  .toFile(<span class="hljs-string">'output.jpg'</span>, (err, info) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-built_in">console</span>.log(info);
  });
</code></pre>
<h3 id="t1994. 处理流式数据">4. 处理流式数据 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t1994.%20%E5%A4%84%E7%90%86%E6%B5%81%E5%BC%8F%E6%95%B0%E6%8D%AE"> # </a></h3>
<p><code>Sharp</code> 可以与 Node.js 的流结合，特别适合处理大文件或实时图像处理。以下是一个简单示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> sharp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sharp'</span>);

<span class="hljs-keyword">const</span> readStream = fs.createReadStream(<span class="hljs-string">'input.jpg'</span>);
<span class="hljs-keyword">const</span> writeStream = fs.createWriteStream(<span class="hljs-string">'output.jpg'</span>);

readStream
  .pipe(sharp().resize(<span class="hljs-number">200</span>))
  .pipe(writeStream);
</code></pre>
<p>在这个例子中，<code>input.jpg</code> 被读取，调整大小后直接写入 <code>output.jpg</code>，而无需在内存中加载整个图像。</p>
<h3 id="t2005. 错误处理">5. 错误处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2005.%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"> # </a></h3>
<p>在使用 <code>Sharp</code> 时，可能会遇到一些常见的错误，如文件不存在、文件格式不支持等。你可以通过回调函数或 Promise 处理这些错误：</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .resize(<span class="hljs-number">200</span>)
  .toFile(<span class="hljs-string">'output.jpg'</span>)
  .then(<span class="hljs-function"><span class="hljs-params">info</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(info);
  })
  .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'发生错误:'</span>, err);
  });
</code></pre>
<h3 id="t2016. 优化图像处理">6. 优化图像处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2016.%20%E4%BC%98%E5%8C%96%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86"> # </a></h3>
<p><code>Sharp</code> 可以通过以下方式进一步优化图像处理：</p>
<ul>
<li><p><strong>控制输出质量</strong>: 对于 JPEG 和 WebP 格式，可以指定输出质量（1-100）来优化文件大小。</p>
<pre><code class="lang-javascript">sharp(<span class="hljs-string">'input.jpg'</span>)
  .jpeg({ <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span> })
  .toFile(<span class="hljs-string">'output.jpg'</span>);
</code></pre>
</li>
<li><p><strong>流式处理</strong>: 对于大文件，使用流式处理可以避免高内存占用，并提高处理效率。</p>
</li>
<li><p><strong>缓存</strong>: <code>Sharp</code> 通过 libvips 内部的缓存机制优化了性能，确保在处理大量图像时的速度和效率。</p>
</li>
</ul>
<h3 id="t2027. 总结">7. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2027.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>Sharp</code> 是一个功能强大且高效的图像处理库，适用于各种图像处理需求。无论是简单的图像格式转换、调整大小，还是复杂的图像合成、实时处理，<code>Sharp</code> 都能胜任。此外，它的高性能和内存优化使得它在处理大批量或高分辨率图像时表现尤为出色。如果你正在开发需要处理图像的 Node.js 应用，<code>Sharp</code> 是一个非常值得推荐的库。</p>
<h2 id="t203Nodemailer">Nodemailer <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t203Nodemailer"> # </a></h2>
<p><code>Nodemailer</code> 是一个用于 Node.js 应用中发送电子邮件的模块。它支持多种邮件传输方式，包括通过 SMTP 发送邮件、使用本地发送邮件的服务、甚至集成第三方邮件服务（如 Gmail、Outlook、SendGrid 等）。Nodemailer 是 Node.js 中最流行的邮件发送库，简单易用，功能强大。</p>
<h3 id="t2041. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2041.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>首先，在你的 Node.js 项目中安装 <code>Nodemailer</code>：</p>
<pre><code class="lang-bash">npm install nodemailer
</code></pre>
<h3 id="t2052. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2052.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p>发送邮件的基本步骤包括创建传输器（Transporter）、设置邮件选项，并调用发送方法。以下是一个简单的示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> nodemailer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nodemailer'</span>);

<span class="hljs-comment">// 创建一个传输器对象，用于发送邮件</span>
<span class="hljs-keyword">let</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">service</span>: <span class="hljs-string">'gmail'</span>, <span class="hljs-comment">// 使用 Gmail 作为邮件服务</span>
    <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">user</span>: <span class="hljs-string">'your-email@gmail.com'</span>, <span class="hljs-comment">// 你的邮箱地址</span>
        <span class="hljs-attr">pass</span>: <span class="hljs-string">'your-email-password'</span>   <span class="hljs-comment">// 你的邮箱密码或应用专用密码</span>
    }
});

<span class="hljs-comment">// 设置邮件选项</span>
<span class="hljs-keyword">let</span> mailOptions = {
    <span class="hljs-attr">from</span>: <span class="hljs-string">'your-email@gmail.com'</span>, <span class="hljs-comment">// 发件人地址</span>
    <span class="hljs-attr">to</span>: <span class="hljs-string">'recipient@example.com'</span>,  <span class="hljs-comment">// 收件人地址</span>
    <span class="hljs-attr">subject</span>: <span class="hljs-string">'Hello ✔'</span>,           <span class="hljs-comment">// 邮件主题</span>
    <span class="hljs-attr">text</span>: <span class="hljs-string">'Hello world?'</span>,          <span class="hljs-comment">// 纯文本内容</span>
    <span class="hljs-attr">html</span>: <span class="hljs-string">'&lt;b&gt;Hello world?&lt;/b&gt;'</span>    <span class="hljs-comment">// HTML 内容</span>
};

<span class="hljs-comment">// 发送邮件</span>
transporter.sendMail(mailOptions, (error, info) =&gt; {
    <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.log(error);
    }
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Message sent: %s'</span>, info.messageId);
});
</code></pre>
<h3 id="t2063. 配置传输器（Transporter）">3. 配置传输器（Transporter） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2063.%20%E9%85%8D%E7%BD%AE%E4%BC%A0%E8%BE%93%E5%99%A8%EF%BC%88Transporter%EF%BC%89"> # </a></h3>
<p>传输器（Transporter）是 <code>Nodemailer</code> 中用于定义邮件传输方式的对象。你可以使用不同的传输协议来发送邮件，如 SMTP、本地邮件传输代理等。</p>
<h4 id="t2073.1. SMTP 传输器">3.1. SMTP 传输器 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2073.1.%20SMTP%20%E4%BC%A0%E8%BE%93%E5%99%A8"> # </a></h4>
<p>SMTP 是最常用的邮件传输协议，<code>Nodemailer</code> 支持直接使用 SMTP 服务器发送邮件。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">let</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">host</span>: <span class="hljs-string">'smtp.example.com'</span>,  <span class="hljs-comment">// SMTP 服务器地址</span>
    <span class="hljs-attr">port</span>: <span class="hljs-number">587</span>,                 <span class="hljs-comment">// SMTP 端口</span>
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,             <span class="hljs-comment">// 是否使用 TLS，false 表示不使用，通常端口 587 使用明文传输</span>
    <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">user</span>: <span class="hljs-string">'your-email@example.com'</span>, <span class="hljs-comment">// SMTP 登录用户名</span>
        <span class="hljs-attr">pass</span>: <span class="hljs-string">'your-email-password'</span>     <span class="hljs-comment">// SMTP 登录密码</span>
    }
});
</code></pre>
<h4 id="t2083.2. 使用 OAuth2 认证">3.2. 使用 OAuth2 认证 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2083.2.%20%E4%BD%BF%E7%94%A8%20OAuth2%20%E8%AE%A4%E8%AF%81"> # </a></h4>
<p>对于某些服务（如 Gmail），你可能需要使用 OAuth2 进行认证。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">let</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">service</span>: <span class="hljs-string">'gmail'</span>,
    <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'OAuth2'</span>,
        <span class="hljs-attr">user</span>: <span class="hljs-string">'your-email@gmail.com'</span>,
        <span class="hljs-attr">clientId</span>: <span class="hljs-string">'your-client-id'</span>,
        <span class="hljs-attr">clientSecret</span>: <span class="hljs-string">'your-client-secret'</span>,
        <span class="hljs-attr">refreshToken</span>: <span class="hljs-string">'your-refresh-token'</span>,
        <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'your-access-token'</span>
    }
});
</code></pre>
<h4 id="t2093.3. 本地邮件传输代理">3.3. 本地邮件传输代理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2093.3.%20%E6%9C%AC%E5%9C%B0%E9%82%AE%E4%BB%B6%E4%BC%A0%E8%BE%93%E4%BB%A3%E7%90%86"> # </a></h4>
<p>在某些情况下，你可能希望使用本地的邮件传输代理（如 <code>sendmail</code> 或 <code>postfix</code>）来发送邮件。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">let</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">sendmail</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">newline</span>: <span class="hljs-string">'unix'</span>,
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/usr/sbin/sendmail'</span>
});
</code></pre>
<h3 id="t2104. 邮件选项（Mail Options）">4. 邮件选项（Mail Options） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2104.%20%E9%82%AE%E4%BB%B6%E9%80%89%E9%A1%B9%EF%BC%88Mail%20Options%EF%BC%89"> # </a></h3>
<p>邮件选项是用于定义邮件内容和收件人等信息的对象。</p>
<ul>
<li><strong>from</strong>: 发件人地址</li>
<li><strong>to</strong>: 收件人地址，可以是多个地址，用逗号分隔</li>
<li><strong>subject</strong>: 邮件主题</li>
<li><strong>text</strong>: 纯文本内容</li>
<li><strong>html</strong>: HTML 内容</li>
<li><strong>cc</strong>: 抄送地址</li>
<li><strong>bcc</strong>: 密送地址</li>
<li><strong>attachments</strong>: 附件列表，支持文件路径、内容、URL 等形式</li>
</ul>
<h4 id="t2114.1. 发送带附件的邮件">4.1. 发送带附件的邮件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2114.1.%20%E5%8F%91%E9%80%81%E5%B8%A6%E9%99%84%E4%BB%B6%E7%9A%84%E9%82%AE%E4%BB%B6"> # </a></h4>
<p>你可以通过 <code>attachments</code> 属性发送带有附件的邮件：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">let</span> mailOptions = {
    <span class="hljs-attr">from</span>: <span class="hljs-string">'your-email@gmail.com'</span>,
    <span class="hljs-attr">to</span>: <span class="hljs-string">'recipient@example.com'</span>,
    <span class="hljs-attr">subject</span>: <span class="hljs-string">'Here is your attachment'</span>,
    <span class="hljs-attr">text</span>: <span class="hljs-string">'Please see the attached file.'</span>,
    <span class="hljs-attr">attachments</span>: [
        {
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'text1.txt'</span>, <span class="hljs-comment">// 文件名</span>
            <span class="hljs-attr">path</span>: <span class="hljs-string">'./files/text1.txt'</span> <span class="hljs-comment">// 文件路径</span>
        },
        {
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'text2.txt'</span>,
            <span class="hljs-attr">content</span>: <span class="hljs-string">'Hello, World!'</span> <span class="hljs-comment">// 文件内容</span>
        }
    ]
};
</code></pre>
<h3 id="t2125. 处理发送结果">5. 处理发送结果 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2125.%20%E5%A4%84%E7%90%86%E5%8F%91%E9%80%81%E7%BB%93%E6%9E%9C"> # </a></h3>
<p><code>sendMail</code> 方法是异步的，通常会通过回调函数或 <code>Promise</code> 处理发送结果。你可以在回调中处理发送成功或失败的逻辑。</p>
<pre><code class="lang-javascript">transporter.sendMail(mailOptions)
    .then(<span class="hljs-function"><span class="hljs-params">info</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Message sent: %s'</span>, info.messageId);
    })
    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error sending email: '</span>, error);
    });
</code></pre>
<h3 id="t2136. 调试与日志">6. 调试与日志 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2136.%20%E8%B0%83%E8%AF%95%E4%B8%8E%E6%97%A5%E5%BF%97"> # </a></h3>
<p>在开发过程中，你可能需要查看详细的日志以调试邮件发送问题。你可以通过在创建传输器时启用 <code>debug</code> 选项来查看调试信息。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">let</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">host</span>: <span class="hljs-string">'smtp.example.com'</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">587</span>,
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">user</span>: <span class="hljs-string">'your-email@example.com'</span>,
        <span class="hljs-attr">pass</span>: <span class="hljs-string">'your-email-password'</span>
    },
    <span class="hljs-attr">logger</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用日志记录</span>
    <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用调试模式，输出详细的发送过程</span>
});
</code></pre>
<h3 id="t2147. 常见问题">7. 常见问题 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2147.%20%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"> # </a></h3>
<ul>
<li><strong>Gmail 安全性设置</strong>: 如果你使用 Gmail 发送邮件，你可能需要为你的账户启用“低安全性应用的访问”或使用 OAuth2。</li>
<li><strong>SMTP 端口选择</strong>: 如果你使用的是 587 端口，通常是明文传输并支持 STARTTLS。如果你使用的是 465 端口，通常需要启用 <code>secure: true</code> 以使用 SSL/TLS 进行加密。</li>
</ul>
<h3 id="t2158. 总结">8. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2158.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>Nodemailer</code> 是一个强大且灵活的邮件发送工具，它适用于各种场景，从简单的单次邮件发送到复杂的邮件自动化任务。通过合理配置 SMTP、邮件选项和处理发送结果，你可以构建一个稳定、高效的邮件发送系统。无论是个人项目还是企业应用，<code>Nodemailer</code> 都是 Node.js 环境下的首选邮件解决方案。</p>
<h2 id="t216html-to-docx">html-to-docx <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t216html-to-docx"> # </a></h2>
<p><code>html-to-docx</code> 是一个用于将 HTML 内容转换为 Microsoft Word 文档（.docx 格式）的 Node.js 库。这个工具特别适合在 Web 应用中生成 Word 文档，比如在线生成合同、报告、简历等。它的主要功能是将结构化的 HTML 转换为可编辑的 Word 文档，同时保留 HTML 内容的样式和结构。</p>
<h3 id="t2171. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2171.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>要在 Node.js 项目中使用 <code>html-to-docx</code>，首先需要安装它：</p>
<pre><code class="lang-bash">npm install html-to-docx
</code></pre>
<h3 id="t2182. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2182.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p><code>html-to-docx</code> 提供了一个简单的 API，用于将 HTML 字符串转换为 Word 文档的二进制数据，然后你可以将其保存为文件或通过 HTTP 响应返回给客户端。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> htmlToDocx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-to-docx'</span>);

<span class="hljs-comment">// 定义要转换的 HTML 内容</span>
<span class="hljs-keyword">const</span> html = <span class="hljs-string">`
    &lt;h1&gt;Hello, World!&lt;/h1&gt;
    &lt;p&gt;This is a test document generated from HTML.&lt;/p&gt;
`</span>;

<span class="hljs-comment">// 将 HTML 转换为 .docx 二进制数据</span>
htmlToDocx(html)
    .then(<span class="hljs-function">(<span class="hljs-params">docxBuffer</span>) =&gt;</span> {
        <span class="hljs-comment">// 将生成的 .docx 数据保存到文件</span>
        fs.writeFileSync(<span class="hljs-string">'output.docx'</span>, docxBuffer);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Word document generated successfully!'</span>);
    })
    .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error generating Word document:'</span>, error);
    });
</code></pre>
<h3 id="t2193. API 详解">3. API 详解 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2193.%20API%20%E8%AF%A6%E8%A7%A3"> # </a></h3>
<p><code>html-to-docx</code> 提供的主要方法是 <code>htmlToDocx(html, options)</code>，其中：</p>
<ul>
<li><strong>html</strong>: 需要转换的 HTML 字符串。</li>
<li><strong>options</strong>: 一个可选的配置对象，用于自定义生成的 .docx 文件。下面将介绍一些常用的选项。</li>
</ul>
<h4 id="t2203.1. Options 配置">3.1. Options 配置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2203.1.%20Options%20%E9%85%8D%E7%BD%AE"> # </a></h4>
<p><code>html-to-docx</code> 支持一些配置选项，可以用来控制生成的 Word 文档的外观和行为。</p>
<ul>
<li><p><strong>orientation</strong>: 控制文档的页面方向，可以设置为 <code>'portrait'</code> 或 <code>'landscape'</code>。默认值是 <code>'portrait'</code>。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">orientation</span>: <span class="hljs-string">'landscape'</span>,
};
</code></pre>
</li>
<li><p><strong>margins</strong>: 控制页面的边距，单位为英寸。可以设置 <code>top</code>、<code>right</code>、<code>bottom</code> 和 <code>left</code> 四个方向的边距。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">margins</span>: { <span class="hljs-attr">top</span>: <span class="hljs-number">1.0</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">1.0</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">1.0</span>, <span class="hljs-attr">left</span>: <span class="hljs-number">1.0</span> },
};
</code></pre>
</li>
<li><p><strong>title</strong>: 设置生成文档的标题，会显示在 Word 文档的属性中。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Generated Document'</span>,
};
</code></pre>
</li>
<li><p><strong>author</strong>: 设置生成文档的作者信息。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">author</span>: <span class="hljs-string">'John Doe'</span>,
};
</code></pre>
</li>
<li><p><strong>table</strong>: 用于配置表格的样式和行为，包括 <code>rowHeight</code>、<code>cellMargin</code> 等。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">table</span>: {
        <span class="hljs-attr">rowHeight</span>: <span class="hljs-number">0.5</span>,
        <span class="hljs-attr">cellMargin</span>: <span class="hljs-number">0.1</span>,
    },
};
</code></pre>
</li>
<li><p><strong>footer</strong>: 添加页脚，可以是简单的文本或复杂的 HTML 结构。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">footer</span>: <span class="hljs-string">'&lt;p&gt;Page &lt;span class="page-number"&gt;&lt;/span&gt; of &lt;span class="total-pages"&gt;&lt;/span&gt;&lt;/p&gt;'</span>,
};
</code></pre>
</li>
</ul>
<h3 id="t2214. 高级用法">4. 高级用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2214.%20%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"> # </a></h3>
<h4 id="t2224.1. 将复杂的 HTML 转换为 .docx">4.1. 将复杂的 HTML 转换为 .docx <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2224.1.%20%E5%B0%86%E5%A4%8D%E6%9D%82%E7%9A%84%20HTML%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%20.docx"> # </a></h4>
<p>你可以将带有样式、表格、图像等复杂结构的 HTML 转换为 Word 文档。<code>html-to-docx</code> 会保留大部分 HTML 的结构和样式。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> complexHtml = <span class="hljs-string">`
    &lt;h1&gt;Complex Document&lt;/h1&gt;
    &lt;p&gt;This document contains a table and an image.&lt;/p&gt;
    &lt;table border="1"&gt;
        &lt;tr&gt;&lt;th&gt;Header 1&lt;/th&gt;&lt;th&gt;Header 2&lt;/th&gt;&lt;/tr&gt;
        &lt;tr&gt;&lt;td&gt;Cell 1&lt;/td&gt;&lt;td&gt;Cell 2&lt;/td&gt;&lt;/tr&gt;
    &lt;/table&gt;
    &lt;img src="data:image/png;base64,iVBORw0..." alt="Sample Image" /&gt;
`</span>;

htmlToDocx(complexHtml)
    .then(<span class="hljs-function">(<span class="hljs-params">docxBuffer</span>) =&gt;</span> {
        fs.writeFileSync(<span class="hljs-string">'complex-output.docx'</span>, docxBuffer);
    })
    .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error generating complex Word document:'</span>, error);
    });
</code></pre>
<h4 id="t2234.2. 通过 HTTP 响应返回 .docx">4.2. 通过 HTTP 响应返回 .docx <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2234.2.%20%E9%80%9A%E8%BF%87%20HTTP%20%E5%93%8D%E5%BA%94%E8%BF%94%E5%9B%9E%20.docx"> # </a></h4>
<p>在 Web 应用中，你可以通过 HTTP 响应将生成的 .docx 文件返回给客户端，以便用户下载。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> htmlToDocx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-to-docx'</span>);

app.post(<span class="hljs-string">'/generate-docx'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> html = req.body.html; <span class="hljs-comment">// 假设 HTML 内容通过 POST 请求发送</span>

    htmlToDocx(html)
        .then(<span class="hljs-function">(<span class="hljs-params">docxBuffer</span>) =&gt;</span> {
            res.setHeader(<span class="hljs-string">'Content-Disposition'</span>, <span class="hljs-string">'attachment; filename=output.docx'</span>);
            res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/vnd.openxmlformats-officedocument.wordprocessingml.document'</span>);
            res.send(docxBuffer);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
            res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">'Error generating document'</span>);
        });
});

app.listen(<span class="hljs-number">3000</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Server is running on port 3000'</span>));
</code></pre>
<h3 id="t2245. 注意事项和局限性">5. 注意事项和局限性 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2245.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E5%B1%80%E9%99%90%E6%80%A7"> # </a></h3>
<ul>
<li><strong>CSS 支持有限</strong>: <code>html-to-docx</code> 支持的 CSS 样式有限，主要是基础的排版和格式样式。复杂的 CSS 可能无法正确应用。</li>
<li><strong>图像处理</strong>: 图像需要是可访问的 URL 或 base64 编码的数据 URI。如果图像路径不正确，可能无法正确显示。</li>
<li><strong>复杂布局</strong>: 虽然 <code>html-to-docx</code> 能够处理大部分 HTML 内容，但对于非常复杂的布局（如浮动、绝对定位等），可能无法完全正确转换。</li>
</ul>
<h3 id="t2256. 总结">6. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2256.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>html-to-docx</code> 是一个强大的工具，适合将 HTML 内容转换为 Word 文档的场景。它易于使用，支持基本的 HTML 和样式，同时也提供了一些定制选项，使你可以控制生成文档的外观和行为。通过合理使用这个工具，你可以在 Web 应用中轻松生成符合需求的 Word 文档，并通过 HTTP 响应直接提供给用户下载。</p>
<h2 id="t226PptxGenJS">PptxGenJS <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t226PptxGenJS"> # </a></h2>
<p><code>html-pptxgenjs</code> 是一个结合了 <code>PptxGenJS</code> 和 HTML 的库，用于将 HTML 内容转换为 Microsoft PowerPoint 演示文稿（PPTX 格式）。<code>PptxGenJS</code> 是一个用于生成 PowerPoint 文件的 JavaScript 库，而 <code>html-pptxgenjs</code> 则是它的一个扩展，允许你将 HTML 内容直接转换为 PPTX 文件的幻灯片内容。这对于将网页内容或动态生成的 HTML 转换为演示文稿特别有用。</p>
<h3 id="t2271. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2271.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>首先，你需要在项目中安装 <code>html-pptxgenjs</code> 和 <code>PptxGenJS</code> 依赖包：</p>
<pre><code class="lang-bash">npm install html-pptxgenjs pptxgenjs
</code></pre>
<h3 id="t2282. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2282.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p>使用 <code>html-pptxgenjs</code> 将 HTML 转换为 PPTX 文件非常简单。以下是一个基本的用法示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> PptxGenJS = <span class="hljs-built_in">require</span>(<span class="hljs-string">"pptxgenjs"</span>);
<span class="hljs-keyword">const</span> { htmlToPptx } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"html-pptxgenjs"</span>);

<span class="hljs-keyword">const</span> htmlContent = <span class="hljs-string">`
  &lt;h1&gt;Welcome to My Presentation&lt;/h1&gt;
  &lt;p&gt;This slide was generated from HTML content.&lt;/p&gt;
  &lt;ul&gt;
    &lt;li&gt;Introduction&lt;/li&gt;
    &lt;li&gt;Main Content&lt;/li&gt;
    &lt;li&gt;Conclusion&lt;/li&gt;
  &lt;/ul&gt;
`</span>;

<span class="hljs-comment">// 创建一个新的演示文稿对象</span>
<span class="hljs-keyword">let</span> pptx = <span class="hljs-keyword">new</span> PptxGenJS();

<span class="hljs-comment">// 将 HTML 内容转换为 PPTX 幻灯片</span>
htmlToPptx({
  pptx,                 <span class="hljs-comment">// 传入 PptxGenJS 的演示文稿对象</span>
  <span class="hljs-attr">html</span>: htmlContent,    <span class="hljs-comment">// 传入要转换的 HTML 内容</span>
  <span class="hljs-attr">slideNumber</span>: <span class="hljs-number">1</span>,       <span class="hljs-comment">// 指定幻灯片的序号</span>
});

<span class="hljs-comment">// 保存 PPTX 文件</span>
pptx.writeFile(<span class="hljs-string">"presentation.pptx"</span>).then(<span class="hljs-function"><span class="hljs-params">fileName</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`PPTX file created: <span class="hljs-subst">${fileName}</span>`</span>);
});
</code></pre>
<h3 id="t2293. 详细解释">3. 详细解释 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2293.%20%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A"> # </a></h3>
<h4 id="t2303.1. 创建 PPTX 文件">3.1. 创建 PPTX 文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2303.1.%20%E5%88%9B%E5%BB%BA%20PPTX%20%E6%96%87%E4%BB%B6"> # </a></h4>
<p><code>PptxGenJS</code> 是创建和操作 PowerPoint 演示文稿的核心库。通过它可以创建新的幻灯片、添加文本、图像、形状等。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">let</span> pptx = <span class="hljs-keyword">new</span> PptxGenJS(); <span class="hljs-comment">// 创建一个新的演示文稿对象</span>
</code></pre>
<h4 id="t2313.2. 将 HTML 转换为 PPTX">3.2. 将 HTML 转换为 PPTX <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2313.2.%20%E5%B0%86%20HTML%20%E8%BD%AC%E6%8D%A2%E4%B8%BA%20PPTX"> # </a></h4>
<p><code>htmlToPptx</code> 是 <code>html-pptxgenjs</code> 提供的函数，用于将 HTML 内容转换为 PPTX 文件的幻灯片。</p>
<pre><code class="lang-javascript">htmlToPptx({
  pptx,                 <span class="hljs-comment">// PptxGenJS 对象</span>
  <span class="hljs-attr">html</span>: htmlContent,    <span class="hljs-comment">// 要转换的 HTML 字符串</span>
  <span class="hljs-attr">slideNumber</span>: <span class="hljs-number">1</span>,       <span class="hljs-comment">// 插入 HTML 内容的幻灯片编号</span>
});
</code></pre>
<p><code>htmlToPptx</code> 函数会将 HTML 内容转换为与 PowerPoint 幻灯片相匹配的格式。支持的 HTML 元素包括标题、段落、列表、表格、图像等。</p>
<h4 id="t2323.3. 保存文件">3.3. 保存文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2323.3.%20%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6"> # </a></h4>
<p><code>pptx.writeFile</code> 是 PptxGenJS 提供的方法，用于将生成的 PowerPoint 演示文稿保存为文件。</p>
<pre><code class="lang-javascript">pptx.writeFile(<span class="hljs-string">"presentation.pptx"</span>).then(<span class="hljs-function"><span class="hljs-params">fileName</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`PPTX file created: <span class="hljs-subst">${fileName}</span>`</span>);
});
</code></pre>
<h3 id="t2334. 高级用法">4. 高级用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2334.%20%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"> # </a></h3>
<h4 id="t2344.1. 自定义样式和布局">4.1. 自定义样式和布局 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2344.1.%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%B7%E5%BC%8F%E5%92%8C%E5%B8%83%E5%B1%80"> # </a></h4>
<p>你可以在 HTML 中使用内联样式或 CSS 类来自定义文本、图片、表格等元素的外观。这些样式会被尽可能地转换到 PPTX 文件中。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> htmlContent = <span class="hljs-string">`
  &lt;h1 style="color: blue;"&gt;Welcome to My Presentation&lt;/h1&gt;
  &lt;p style="font-size: 18px;"&gt;This slide was generated from HTML content.&lt;/p&gt;
  &lt;ul style="list-style-type: square;"&gt;
    &lt;li&gt;Introduction&lt;/li&gt;
    &lt;li&gt;Main Content&lt;/li&gt;
    &lt;li&gt;Conclusion&lt;/li&gt;
  &lt;/ul&gt;
`</span>;
</code></pre>
<h4 id="t2354.2. 多张幻灯片">4.2. 多张幻灯片 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2354.2.%20%E5%A4%9A%E5%BC%A0%E5%B9%BB%E7%81%AF%E7%89%87"> # </a></h4>
<p>你可以根据需要创建多张幻灯片，并在不同的幻灯片中插入不同的 HTML 内容。</p>
<pre><code class="lang-javascript">htmlToPptx({ pptx, <span class="hljs-attr">html</span>: htmlContent1, <span class="hljs-attr">slideNumber</span>: <span class="hljs-number">1</span> });
htmlToPptx({ pptx, <span class="hljs-attr">html</span>: htmlContent2, <span class="hljs-attr">slideNumber</span>: <span class="hljs-number">2</span> });
</code></pre>
<h4 id="t2364.3. 插入图像">4.3. 插入图像 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2364.3.%20%E6%8F%92%E5%85%A5%E5%9B%BE%E5%83%8F"> # </a></h4>
<p><code>html-pptxgenjs</code> 也支持在 HTML 中插入图像，这些图像将被转换为 PPTX 文件中的图像元素。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> htmlContent = <span class="hljs-string">`
  &lt;h1&gt;Presentation with Images&lt;/h1&gt;
  &lt;img src="https://example.com/image.png" alt="Sample Image" style="width: 300px; height: 200px;" /&gt;
`</span>;
</code></pre>
<h3 id="t2375. 注意事项和局限性">5. 注意事项和局限性 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2375.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E5%B1%80%E9%99%90%E6%80%A7"> # </a></h3>
<ul>
<li><strong>HTML 支持的范围</strong>: <code>html-pptxgenjs</code> 支持的 HTML 标签和样式有限，复杂的布局或高级的 CSS 特性可能不会完全正确地转换为 PPTX。</li>
<li><strong>图片处理</strong>: 插入的图像需要是在线的 URL 或 Base64 编码的字符串。如果图片路径错误或无法访问，图片可能无法正确显示。</li>
<li><strong>字体支持</strong>: 在 PowerPoint 中使用的字体需要在打开 PPTX 文件的系统上可用，否则可能会出现字体替换的问题。</li>
</ul>
<h3 id="t2386. 总结">6. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2386.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>html-pptxgenjs</code> 是一个强大且实用的工具，适用于将现有的 HTML 内容快速转换为 PowerPoint 演示文稿。通过结合 <code>PptxGenJS</code> 的功能，它允许开发者在 Node.js 应用中轻松生成 PPTX 文件，并将其用于报告、演示或其他业务需求。尽管在处理复杂布局和样式时存在一些局限性，但对于大多数简单到中等复杂的文档生成任务，这个工具是一个很好的选择。</p>
<h2 id="t239ExcelJS">ExcelJS <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t239ExcelJS"> # </a></h2>
<p><code>ExcelJS</code> 是一个强大的 Node.js 库，用于创建、读取和操作 Excel 文件（.xlsx 和 .csv 格式）。它可以生成复杂的电子表格、编辑现有文件、处理数据，并支持多种格式和样式，是构建与 Excel 相关功能的绝佳工具。</p>
<h3 id="t2401. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2401.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>首先，在你的 Node.js 项目中安装 <code>ExcelJS</code>：</p>
<pre><code class="lang-bash">npm install exceljs
</code></pre>
<h3 id="t2412. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2412.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p><code>ExcelJS</code> 提供了非常简单的 API 来创建和处理 Excel 工作簿和工作表。以下是创建和保存一个基本 Excel 文件的示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> ExcelJS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'exceljs'</span>);

<span class="hljs-comment">// 创建一个新的工作簿</span>
<span class="hljs-keyword">const</span> workbook = <span class="hljs-keyword">new</span> ExcelJS.Workbook();

<span class="hljs-comment">// 添加一个新的工作表</span>
<span class="hljs-keyword">const</span> worksheet = workbook.addWorksheet(<span class="hljs-string">'My Sheet'</span>);

<span class="hljs-comment">// 添加列</span>
worksheet.columns = [
  { <span class="hljs-attr">header</span>: <span class="hljs-string">'ID'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'id'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">10</span> },
  { <span class="hljs-attr">header</span>: <span class="hljs-string">'Name'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">header</span>: <span class="hljs-string">'DOB'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'dob'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">15</span> },
];

<span class="hljs-comment">// 添加行</span>
worksheet.addRow({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'John Doe'</span>, <span class="hljs-attr">dob</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1990</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) });
worksheet.addRow({ <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Jane Doe'</span>, <span class="hljs-attr">dob</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1995</span>, <span class="hljs-number">5</span>, <span class="hljs-number">15</span>) });

<span class="hljs-comment">// 保存 Excel 文件</span>
workbook.xlsx.writeFile(<span class="hljs-string">'example.xlsx'</span>)
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Excel file saved!'</span>);
  });
</code></pre>
<h3 id="t2423. 主要功能和用法">3. 主要功能和用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2423.%20%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%92%8C%E7%94%A8%E6%B3%95"> # </a></h3>
<h4 id="t2433.1. 工作簿和工作表">3.1. 工作簿和工作表 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2433.1.%20%E5%B7%A5%E4%BD%9C%E7%B0%BF%E5%92%8C%E5%B7%A5%E4%BD%9C%E8%A1%A8"> # </a></h4>
<ul>
<li><p><strong>工作簿（Workbook）</strong>: Excel 文件由多个工作簿组成。一个工作簿可以包含多个工作表。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> workbook = <span class="hljs-keyword">new</span> ExcelJS.Workbook();
</code></pre>
</li>
<li><p><strong>工作表（Worksheet）</strong>: 每个工作簿可以包含一个或多个工作表，工作表用于存储表格数据。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> worksheet = workbook.addWorksheet(<span class="hljs-string">'My Sheet'</span>);
</code></pre>
</li>
</ul>
<h4 id="t2443.2. 操作列和行">3.2. 操作列和行 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2443.2.%20%E6%93%8D%E4%BD%9C%E5%88%97%E5%92%8C%E8%A1%8C"> # </a></h4>
<ul>
<li><p><strong>添加列</strong>: 使用 <code>columns</code> 属性定义工作表的列，可以设置列的标题、键值和宽度。</p>
<pre><code class="lang-javascript">worksheet.columns = [
  { <span class="hljs-attr">header</span>: <span class="hljs-string">'ID'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'id'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">10</span> },
  { <span class="hljs-attr">header</span>: <span class="hljs-string">'Name'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">header</span>: <span class="hljs-string">'DOB'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'dob'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">15</span> },
];
</code></pre>
</li>
<li><p><strong>添加行</strong>: 使用 <code>addRow</code> 方法添加行数据，行数据可以是数组或对象。</p>
<pre><code class="lang-javascript">worksheet.addRow({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'John Doe'</span>, <span class="hljs-attr">dob</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1990</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) });
</code></pre>
</li>
<li><p><strong>多行添加</strong>: 可以通过 <code>addRows</code> 方法一次性添加多行。</p>
<pre><code class="lang-javascript">worksheet.addRows([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Jane Doe'</span>, <span class="hljs-attr">dob</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1995</span>, <span class="hljs-number">5</span>, <span class="hljs-number">15</span>) },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Chris Smith'</span>, <span class="hljs-attr">dob</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1988</span>, <span class="hljs-number">7</span>, <span class="hljs-number">24</span>) },
]);
</code></pre>
</li>
</ul>
<h4 id="t2453.3. 单元格样式">3.3. 单元格样式 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2453.3.%20%E5%8D%95%E5%85%83%E6%A0%BC%E6%A0%B7%E5%BC%8F"> # </a></h4>
<ul>
<li><p><strong>设置字体</strong>: 可以为单元格设置字体样式，包括字体名称、大小、粗体、斜体等。</p>
<pre><code class="lang-javascript">worksheet.getCell(<span class="hljs-string">'A1'</span>).font = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Arial'</span>,
  <span class="hljs-attr">family</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">size</span>: <span class="hljs-number">14</span>,
  <span class="hljs-attr">bold</span>: <span class="hljs-literal">true</span>,
};
</code></pre>
</li>
<li><p><strong>设置边框</strong>: 可以为单元格设置边框样式。</p>
<pre><code class="lang-javascript">worksheet.getCell(<span class="hljs-string">'A1'</span>).border = {
  <span class="hljs-attr">top</span>: { <span class="hljs-attr">style</span>: <span class="hljs-string">'thin'</span> },
  <span class="hljs-attr">left</span>: { <span class="hljs-attr">style</span>: <span class="hljs-string">'thin'</span> },
  <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">style</span>: <span class="hljs-string">'thin'</span> },
  <span class="hljs-attr">right</span>: { <span class="hljs-attr">style</span>: <span class="hljs-string">'thin'</span> },
};
</code></pre>
</li>
<li><p><strong>设置对齐方式</strong>: 可以为单元格设置对齐方式。</p>
<pre><code class="lang-javascript">worksheet.getCell(<span class="hljs-string">'A1'</span>).alignment = { <span class="hljs-attr">vertical</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">horizontal</span>: <span class="hljs-string">'center'</span> };
</code></pre>
</li>
<li><p><strong>设置背景颜色</strong>: 可以为单元格设置填充颜色。</p>
<pre><code class="lang-javascript">worksheet.getCell(<span class="hljs-string">'A1'</span>).fill = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'pattern'</span>,
  <span class="hljs-attr">pattern</span>: <span class="hljs-string">'solid'</span>,
  <span class="hljs-attr">fgColor</span>: { <span class="hljs-attr">argb</span>: <span class="hljs-string">'FFFF0000'</span> },
};
</code></pre>
</li>
</ul>
<h4 id="t2463.4. 合并单元格">3.4. 合并单元格 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2463.4.%20%E5%90%88%E5%B9%B6%E5%8D%95%E5%85%83%E6%A0%BC"> # </a></h4>
<p>你可以合并工作表中的单元格，创建一个跨越多个列或行的单元格区域。</p>
<pre><code class="lang-javascript">worksheet.mergeCells(<span class="hljs-string">'A1:C1'</span>);
worksheet.getCell(<span class="hljs-string">'A1'</span>).value = <span class="hljs-string">'Merged Cells'</span>;
</code></pre>
<h4 id="t2473.5. 读取和修改现有的 Excel 文件">3.5. 读取和修改现有的 Excel 文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2473.5.%20%E8%AF%BB%E5%8F%96%E5%92%8C%E4%BF%AE%E6%94%B9%E7%8E%B0%E6%9C%89%E7%9A%84%20Excel%20%E6%96%87%E4%BB%B6"> # </a></h4>
<p>你可以使用 <code>ExcelJS</code> 读取现有的 Excel 文件，并对其内容进行修改。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> workbook = <span class="hljs-keyword">new</span> ExcelJS.Workbook();
workbook.xlsx.readFile(<span class="hljs-string">'example.xlsx'</span>)
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> worksheet = workbook.getWorksheet(<span class="hljs-string">'My Sheet'</span>);
    worksheet.getCell(<span class="hljs-string">'A1'</span>).value = <span class="hljs-string">'New Value'</span>;
    <span class="hljs-keyword">return</span> workbook.xlsx.writeFile(<span class="hljs-string">'example-modified.xlsx'</span>);
  })
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Excel file modified and saved!'</span>);
  });
</code></pre>
<h4 id="t2483.6. 处理 CSV 文件">3.6. 处理 CSV 文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2483.6.%20%E5%A4%84%E7%90%86%20CSV%20%E6%96%87%E4%BB%B6"> # </a></h4>
<p><code>ExcelJS</code> 也支持创建和读取 CSV 文件。</p>
<ul>
<li><p><strong>生成 CSV 文件</strong>:</p>
<pre><code class="lang-javascript">workbook.csv.writeFile(<span class="hljs-string">'example.csv'</span>)
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'CSV file saved!'</span>);
  });
</code></pre>
</li>
<li><p><strong>读取 CSV 文件</strong>:</p>
<pre><code class="lang-javascript">workbook.csv.readFile(<span class="hljs-string">'example.csv'</span>)
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'CSV file read successfully!'</span>);
  });
</code></pre>
</li>
</ul>
<h3 id="t2494. 常见应用场景">4. 常见应用场景 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2494.%20%E5%B8%B8%E8%A7%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"> # </a></h3>
<ul>
<li><strong>生成报表</strong>: 使用 <code>ExcelJS</code> 动态生成各种报表，如财务报告、统计数据报告等，并可以直接保存为 Excel 文件供用户下载。</li>
<li><strong>数据导出</strong>: 从数据库或 API 获取数据并导出为 Excel 文件，便于用户分析和查看。</li>
<li><strong>批量数据处理</strong>: 使用 <code>ExcelJS</code> 处理和分析大批量的 Excel 数据，适合在自动化任务或后台处理程序中使用。</li>
</ul>
<h3 id="t2505. 注意事项">5. 注意事项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2505.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"> # </a></h3>
<ul>
<li><strong>性能考虑</strong>: 对于非常大的 Excel 文件，操作时可能会消耗较多内存和 CPU 资源。可以考虑分批处理数据或优化代码逻辑以提高性能。</li>
<li><strong>Excel 版本兼容性</strong>: <code>ExcelJS</code> 生成的文件是基于开放的 <code>.xlsx</code> 标准格式的，通常可以在现代版本的 Microsoft Excel 以及其他支持 <code>.xlsx</code> 的软件中正常打开。</li>
</ul>
<h3 id="t2516. 总结">6. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2516.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>ExcelJS</code> 是一个功能强大且灵活的工具，适用于各种 Excel 相关的应用场景，从简单的数据导出到复杂的报表生成和数据分析。通过合理使用 <code>ExcelJS</code> 的 API，你可以轻松地在 Node.js 应用中创建、编辑和处理 Excel 文件。</p>
<h2 id="t252StreamableFile">StreamableFile <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t252StreamableFile"> # </a></h2>
<p><code>StreamableFile</code> 是 NestJS 中一个用于流式传输文件的工具类，特别适合处理需要直接向客户端传输文件内容的场景。它可以帮助你轻松地处理大文件或任何需要按块发送的数据流，以提高传输效率和节省内存。</p>
<h3 id="t2531. 什么是 StreamableFile？">1. 什么是 StreamableFile？ <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2531.%20%E4%BB%80%E4%B9%88%E6%98%AF%20StreamableFile%EF%BC%9F"> # </a></h3>
<p><code>StreamableFile</code> 是 NestJS 提供的一个实用工具，用于将文件内容以流的形式传输给客户端。与一次性将文件内容加载到内存中并发送给客户端不同，<code>StreamableFile</code> 允许你逐块发送文件数据，这对于大文件或实时生成的内容尤其有用。</p>
<h3 id="t2542. 安装与配置">2. 安装与配置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2542.%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"> # </a></h3>
<p><code>StreamableFile</code> 是 NestJS 标准库的一部分，因此无需额外安装，直接引入并使用即可。</p>
<h3 id="t2553. 基本用法">3. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2553.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p>以下是如何在 NestJS 控制器中使用 <code>StreamableFile</code> 的一个基本示例：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Controller, Get, Res, StreamableFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { createReadStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;
<span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> { Response } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'files'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> FilesController {
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'download'</span>)
  downloadFile(<span class="hljs-meta">@Res</span>() res: Response): StreamableFile {
    <span class="hljs-comment">// 创建一个可读流，指向要下载的文件</span>
    <span class="hljs-keyword">const</span> file = createReadStream(join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'files'</span>, <span class="hljs-string">'example.txt'</span>));

    <span class="hljs-comment">// 设置响应头，用于指示下载文件的名称</span>
    res.set({
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span>,
      <span class="hljs-string">'Content-Disposition'</span>: <span class="hljs-string">'attachment; filename="example.txt"'</span>,
    });

    <span class="hljs-comment">// 返回一个 StreamableFile 实例，用于流式传输文件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StreamableFile(file);
  }
}
</code></pre>
<p>在这个示例中：</p>
<ul>
<li><strong><code>createReadStream</code></strong>: 使用 Node.js 内置的 <code>fs</code> 模块的 <code>createReadStream</code> 方法创建一个文件的可读流。</li>
<li><strong><code>res.set()</code></strong>: 设置 HTTP 响应头，比如 <code>Content-Type</code>（文件类型）和 <code>Content-Disposition</code>（文件下载时的名称）。</li>
<li><strong><code>StreamableFile</code></strong>: 将可读流传递给 <code>StreamableFile</code>，并返回给客户端。</li>
</ul>
<p>当客户端发起请求时，文件内容将以流的形式发送给客户端，客户端可以开始下载文件，而不需要等待服务器加载整个文件。</p>
<h3 id="t2564. 处理大文件">4. 处理大文件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2564.%20%E5%A4%84%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6"> # </a></h3>
<p><code>StreamableFile</code> 特别适合处理大文件，因为它不会将整个文件加载到内存中，而是逐块读取文件并发送到客户端。这种方法节省了服务器内存，并提高了大文件传输的效率。</p>
<h3 id="t2575. 传输动态生成的内容">5. 传输动态生成的内容 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2575.%20%E4%BC%A0%E8%BE%93%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E7%9A%84%E5%86%85%E5%AE%B9"> # </a></h3>
<p>除了文件，<code>StreamableFile</code> 也可以用于传输动态生成的内容，比如图像生成、报告生成等。你可以创建一个可读流，将动态生成的内容逐块传输给客户端。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Controller, Get, StreamableFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { Readable } <span class="hljs-keyword">from</span> <span class="hljs-string">'stream'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'dynamic'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> DynamicController {
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'stream'</span>)
  streamData(): StreamableFile {
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> Readable({
      read() {
        <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'Hello, this is dynamic content!\n'</span>);
        <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 结束流</span>
      }
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StreamableFile(stream);
  }
}
</code></pre>
<p>在这个例子中，<code>Readable</code> 流被用于生成动态内容，然后通过 <code>StreamableFile</code> 发送给客户端。</p>
<h3 id="t2586. 响应头设置">6. 响应头设置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2586.%20%E5%93%8D%E5%BA%94%E5%A4%B4%E8%AE%BE%E7%BD%AE"> # </a></h3>
<p>你可以通过 <code>Response</code> 对象设置各种 HTTP 头，以控制文件下载的行为，例如：</p>
<ul>
<li><strong><code>Content-Disposition</code></strong>: 控制文件名和下载行为（如附件下载）。</li>
<li><strong><code>Content-Type</code></strong>: 设置文件的 MIME 类型，告诉浏览器如何处理文件内容。</li>
<li><strong><code>Content-Length</code></strong>: 设置文件的大小（可选），有助于客户端显示进度条。</li>
</ul>
<h3 id="t2597. 与文件上传集成">7. 与文件上传集成 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2597.%20%E4%B8%8E%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%9B%86%E6%88%90"> # </a></h3>
<p><code>StreamableFile</code> 可以与文件上传功能集成。比如，在用户上传文件之后，你可以将文件流直接返回给客户端进行进一步处理。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Controller, Post, UploadedFile, UseInterceptors, StreamableFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { FileInterceptor } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { createReadStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;
<span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'upload'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> UploadController {
  <span class="hljs-meta">@Post</span>(<span class="hljs-string">'file'</span>)
  <span class="hljs-meta">@UseInterceptors</span>(FileInterceptor(<span class="hljs-string">'file'</span>))
  uploadFile(<span class="hljs-meta">@UploadedFile</span>() file: Express.Multer.File): StreamableFile {
    <span class="hljs-keyword">const</span> filePath = join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'uploads'</span>, file.filename);
    <span class="hljs-keyword">const</span> fileStream = createReadStream(filePath);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StreamableFile(fileStream);
  }
}
</code></pre>
<h3 id="t2608. 总结">8. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2608.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>StreamableFile</code> 是一个非常有用的工具，适用于需要高效传输大文件或动态内容的场景。它通过流式传输数据，减少了内存占用并提高了传输效率。在处理文件下载、实时内容生成和大文件传输时，<code>StreamableFile</code> 可以让你的 NestJS 应用更加健壮和高效。</p>
<h2 id="t261@nestjs/mongoose">@nestjs/mongoose <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t261@nestjs/mongoose"> # </a></h2>
<p><code>@nestjs/mongoose</code> 是一个用于将 MongoDB 数据库与 NestJS 框架集成的模块，它基于 Mongoose ODM（对象文档映射器）构建。Mongoose 提供了对 MongoDB 数据库的高级抽象，使得开发者可以使用面向对象的方式来操作数据库。<code>@nestjs/mongoose</code> 模块通过提供装饰器和注入机制，使得在 NestJS 应用中使用 Mongoose 更加便捷和模块化。</p>
<h3 id="t2621. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2621.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>首先，你需要在 NestJS 项目中安装 <code>@nestjs/mongoose</code> 和 <code>mongoose</code>：</p>
<pre><code class="lang-bash">npm install @nestjs/mongoose mongoose
</code></pre>
<h3 id="t2632. 基本配置">2. 基本配置 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2632.%20%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"> # </a></h3>
<p>在使用 <code>@nestjs/mongoose</code> 模块之前，需要在应用程序中进行配置。通常是在 <code>AppModule</code> 中进行全局的数据库连接配置。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Module } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { MongooseModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;

<span class="hljs-meta">@Module</span>({
  imports: [
    <span class="hljs-comment">// 使用 MongooseModule.forRoot 连接 MongoDB 数据库</span>
    MongooseModule.forRoot(<span class="hljs-string">'mongodb://localhost/nest'</span>),
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule {}
</code></pre>
<p><code>MongooseModule.forRoot()</code> 方法用于配置 MongoDB 连接字符串及其他选项。这里连接了本地运行的 MongoDB 实例。</p>
<h3 id="t2643. 定义 Schema">3. 定义 Schema <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2643.%20%E5%AE%9A%E4%B9%89%20Schema"> # </a></h3>
<p>在 Mongoose 中，Schema 是描述 MongoDB 文档结构的地方。<code>@nestjs/mongoose</code> 提供了 <code>@Schema</code>、<code>@Prop</code> 等装饰器，使得定义 Schema 更加简洁和类型安全。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Prop, Schema, SchemaFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;
<span class="hljs-keyword">import</span> { Document } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;

<span class="hljs-comment">// 定义一个 Mongoose 文档类型的类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> CatDocument = Cat &amp; Document;

<span class="hljs-meta">@Schema</span>() <span class="hljs-comment">// 使用 @Schema 装饰器将类标记为 Mongoose Schema</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> Cat {
  <span class="hljs-meta">@Prop</span>({ required: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// 使用 @Prop 装饰器定义属性并设置选项</span>
  name: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Prop</span>()
  age: <span class="hljs-built_in">number</span>;

  <span class="hljs-meta">@Prop</span>()
  breed: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 使用 SchemaFactory 生成 Mongoose Schema</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> CatSchema = SchemaFactory.createForClass(Cat);
</code></pre>
<h3 id="t2654. 创建模型">4. 创建模型 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2654.%20%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"> # </a></h3>
<p>一旦定义了 Schema，就可以创建模型。在 NestJS 中，通过使用 <code>MongooseModule.forFeature()</code> 方法将模型导入到模块中：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Module } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { MongooseModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;
<span class="hljs-keyword">import</span> { Cat, CatSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cat.schema'</span>;
<span class="hljs-keyword">import</span> { CatsService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cats.service'</span>;
<span class="hljs-keyword">import</span> { CatsController } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cats.controller'</span>;

<span class="hljs-meta">@Module</span>({
  imports: [
    <span class="hljs-comment">// 使用 MongooseModule.forFeature 注册模型</span>
    MongooseModule.forFeature([{ name: Cat.name, schema: CatSchema }]),
  ],
  controllers: [CatsController],
  providers: [CatsService],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> CatsModule {}
</code></pre>
<p>在 <code>forFeature()</code> 方法中，将模型名称和对应的 Schema 注册到模块中。这个步骤确保了模型可以在模块内的服务或控制器中被注入和使用。</p>
<h3 id="t2665. 使用模型">5. 使用模型 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2665.%20%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9E%8B"> # </a></h3>
<p>模型在服务中可以通过依赖注入的方式使用。模型对象通常用于执行数据库操作，如创建、查找、更新和删除文档。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { InjectModel } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;
<span class="hljs-keyword">import</span> { Model } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;
<span class="hljs-keyword">import</span> { Cat, CatDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cat.schema'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> CatsService {
  <span class="hljs-keyword">constructor</span>(<span class="hljs-params">
    <span class="hljs-comment">// 使用 InjectModel 装饰器注入 Cat 模型</span>
    <span class="hljs-meta">@InjectModel</span>(Cat.name) <span class="hljs-keyword">private</span> catModel: Model&lt;CatDocument&gt;,
  </span>) {}

  <span class="hljs-keyword">async</span> create(createCatDto: { name: <span class="hljs-built_in">string</span>; age: <span class="hljs-built_in">number</span>; breed: <span class="hljs-built_in">string</span> }): <span class="hljs-built_in">Promise</span>&lt;Cat&gt; {
    <span class="hljs-comment">// 创建一个新的 Cat 文档</span>
    <span class="hljs-keyword">const</span> createdCat = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.catModel(createCatDto);
    <span class="hljs-keyword">return</span> createdCat.save(); <span class="hljs-comment">// 保存文档到数据库</span>
  }

  <span class="hljs-keyword">async</span> findAll(): <span class="hljs-built_in">Promise</span>&lt;Cat[]&gt; {
    <span class="hljs-comment">// 查找所有 Cat 文档</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.catModel.find().exec();
  }
}
</code></pre>
<h3 id="t2676. 常用功能">6. 常用功能 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2676.%20%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"> # </a></h3>
<ul>
<li><strong>查询</strong>：使用 <code>find</code>、<code>findById</code>、<code>findOne</code> 等方法来查询数据库中的文档。</li>
<li><strong>更新</strong>：使用 <code>updateOne</code>、<code>updateMany</code>、<code>findByIdAndUpdate</code> 等方法更新文档。</li>
<li><strong>删除</strong>：使用 <code>deleteOne</code>、<code>deleteMany</code>、<code>findByIdAndDelete</code> 等方法删除文档。</li>
<li><strong>钩子函数</strong>：Mongoose 提供了各种钩子（如 <code>pre</code>、<code>post</code>）来在保存、更新、删除操作之前或之后执行特定逻辑。</li>
</ul>
<h3 id="t2687. 高级用法">7. 高级用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2687.%20%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"> # </a></h3>
<ul>
<li><strong>中间件</strong>：可以使用 Mongoose 中间件来处理复杂的逻辑，如在保存之前对数据进行验证或处理。</li>
<li><strong>索引</strong>：使用 Mongoose 的索引功能来提高查询效率。</li>
<li><strong>验证</strong>：通过 Schema 的验证器确保数据的完整性和一致性。</li>
</ul>
<h3 id="t2698. 事务管理">8. 事务管理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2698.%20%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"> # </a></h3>
<p>Mongoose 支持 MongoDB 4.0+ 的事务，可以确保一组操作的原子性。NestJS 中，可以通过 <code>@Transaction</code> 装饰器或手动管理 session 来实现事务。</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.catModel.startSession();
session.startTransaction();
<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 执行多步数据库操作</span>
  <span class="hljs-keyword">await</span> session.commitTransaction();
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">await</span> session.abortTransaction();
} <span class="hljs-keyword">finally</span> {
  session.endSession();
}
</code></pre>
<h3 id="t270总结">总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t270%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>@nestjs/mongoose</code> 是一个强大的工具，简化了 NestJS 应用程序中使用 MongoDB 的开发过程。它结合了 Mongoose 的灵活性和 NestJS 的模块化设计，使得开发者能够以类型安全、可维护的方式构建复杂的数据库交互逻辑。</p>
<h2 id="t271geoip-lite">geoip-lite <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t271geoip-lite"> # </a></h2>
<p><code>geoip-lite</code> 是一个轻量级的 Node.js 库，用于根据 IP 地址获取地理位置信息。它无需依赖外部服务，使用本地的 GeoLite2 数据库进行 IP 地址的地理位置解析。<code>geoip-lite</code> 特别适合需要快速查找 IP 地址相关的国家、城市信息的场景，尤其是在对性能和响应时间有要求的应用中。</p>
<h3 id="t2721. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2721.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>首先，你需要在 Node.js 项目中安装 <code>geoip-lite</code>：</p>
<pre><code class="lang-bash">npm install geoip-lite
</code></pre>
<h3 id="t2732. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2732.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p><code>geoip-lite</code> 的使用非常简单，你只需引入库并调用它提供的方法来查找 IP 地址的地理位置。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> geoip = <span class="hljs-built_in">require</span>(<span class="hljs-string">'geoip-lite'</span>);

<span class="hljs-comment">// 示例 IP 地址</span>
<span class="hljs-keyword">const</span> ip = <span class="hljs-string">'207.97.227.239'</span>;

<span class="hljs-comment">// 获取地理位置信息</span>
<span class="hljs-keyword">const</span> geo = geoip.lookup(ip);

<span class="hljs-built_in">console</span>.log(geo);
</code></pre>
<h3 id="t2743. 输出结果">3. 输出结果 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2743.%20%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C"> # </a></h3>
<p>上面的代码会输出一个包含地理位置信息的对象，通常包括以下几个字段：</p>
<ul>
<li><strong>range</strong>: 包含起始和结束的 IP 地址范围，以数字形式表示。</li>
<li><strong>country</strong>: IP 地址对应的国家代码，符合 ISO 3166-1 标准。</li>
<li><strong>region</strong>: IP 地址对应的区域代码，一般为省或州的代码。</li>
<li><strong>city</strong>: IP 地址对应的城市名称。</li>
<li><strong>ll</strong>: 包含纬度和经度的数组。</li>
<li><strong>metro</strong>: 对应于美国的地铁代码（部分地区会有）。</li>
</ul>
<pre><code class="lang-json">{
  range: [3479299040, 3479299071],
  country: 'US',
  region: 'TX',
  city: 'San Antonio',
  ll: [29.4997, -98.3992],
  metro: 641
}
</code></pre>
<h3 id="t2754. API 详解">4. API 详解 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2754.%20API%20%E8%AF%A6%E8%A7%A3"> # </a></h3>
<p><code>geoip-lite</code> 提供的核心功能是通过 IP 地址查找地理位置信息，以下是主要的方法和用法：</p>
<h4 id="t2764.1. lookup(ip)">4.1. lookup(ip) <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2764.1.%20lookup(ip)"> # </a></h4>
<p>这是 <code>geoip-lite</code> 的主要方法，用于根据传入的 IP 地址查找其地理位置信息。</p>
<ul>
<li><strong>参数</strong>: <ul>
<li><code>ip</code> (string): 需要查找的 IP 地址，可以是 IPv4 或 IPv6 地址。</li>
</ul>
</li>
<li><strong>返回值</strong>: <ul>
<li>如果查找到对应的地理信息，则返回一个包含上述字段的对象；如果未找到，则返回 <code>null</code>。</li>
</ul>
</li>
</ul>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> geo = geoip.lookup(<span class="hljs-string">'8.8.8.8'</span>);
<span class="hljs-built_in">console</span>.log(geo);
</code></pre>
<h4 id="t2774.2. 支持 IPv4 和 IPv6">4.2. 支持 IPv4 和 IPv6 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2774.2.%20%E6%94%AF%E6%8C%81%20IPv4%20%E5%92%8C%20IPv6"> # </a></h4>
<p><code>geoip-lite</code> 支持查询 IPv4 和 IPv6 地址，不过它对 IPv6 的支持较为有限，具体精度取决于数据库。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> ipv6Geo = geoip.lookup(<span class="hljs-string">'2607:f0d0:1002:51::4'</span>);
<span class="hljs-built_in">console</span>.log(ipv6Geo);
</code></pre>
<h3 id="t2785. 本地数据库">5. 本地数据库 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2785.%20%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BA%93"> # </a></h3>
<p><code>geoip-lite</code> 使用的是 MaxMind 提供的 GeoLite2 数据库。每当你安装或更新 <code>geoip-lite</code> 时，库会自动下载最新版本的 GeoLite2 数据库并将其存储在本地。这意味着查询时不需要网络请求，能够非常快速地返回结果。</p>
<h3 id="t2796. 更新数据库">6. 更新数据库 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2796.%20%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93"> # </a></h3>
<p>由于 <code>geoip-lite</code> 的数据库是本地存储的，因此需要定期更新以确保地理位置信息的准确性。你可以通过以下方式更新数据库：</p>
<ul>
<li><p><strong>手动更新</strong>: 你可以通过以下命令更新数据库：</p>
<pre><code class="lang-bash">npm run-script updatedb
</code></pre>
<p>这会自动从 MaxMind 获取最新的 GeoLite2 数据库并替换本地旧版本。</p>
</li>
<li><p><strong>自动更新</strong>: 你也可以在应用中集成自动更新逻辑，定期检查并更新数据库。</p>
</li>
</ul>
<h3 id="t2807. 注意事项">7. 注意事项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2807.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"> # </a></h3>
<ul>
<li><strong>精度限制</strong>: <code>geoip-lite</code> 使用的 GeoLite2 数据库并非实时更新，因此可能无法提供最新的地理位置映射结果。对于一些具体地址或小型区域的解析精度可能会有所欠缺。</li>
<li><strong>合规性</strong>: GeoLite2 数据库是免费的，但受 MaxMind 的使用条款约束。如果你需要更高精度和实时更新的地理位置数据，可以考虑使用 MaxMind 的付费 GeoIP 数据库。</li>
<li><strong>隐私问题</strong>: 在使用 IP 地址获取地理位置信息时，请确保遵守隐私法规和政策，特别是在处理用户敏感数据时。</li>
</ul>
<h3 id="t2818. 示例场景">8. 示例场景 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2818.%20%E7%A4%BA%E4%BE%8B%E5%9C%BA%E6%99%AF"> # </a></h3>
<p><code>geoip-lite</code> 适用于多种场景，如：</p>
<ul>
<li><strong>访问控制</strong>: 根据访问者的地理位置限制或允许访问某些内容。</li>
<li><strong>内容定制</strong>: 根据用户的地理位置定制网站内容或广告。</li>
<li><strong>数据分析</strong>: 对访问日志进行地理位置分析，以了解用户分布和访问模式。</li>
</ul>
<h3 id="t2829. 总结">9. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2829.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>geoip-lite</code> 是一个简单、快速的库，适用于在 Node.js 环境中进行 IP 地址的地理位置解析。它的轻量级特性和本地数据库的使用使得查询速度非常快，适合需要快速响应的应用场景。虽然精度有限，但对于大多数常见应用场景来说，<code>geoip-lite</code> 提供了足够的地理位置信息支持。如果你的应用需要基于 IP 的地理位置分析，<code>geoip-lite</code> 是一个很好的选择。</p>
<h2 id="t283ECharts">ECharts <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t283ECharts"> # </a></h2>
<p><strong>ECharts</strong> 是一个由百度开源的强大、灵活、易用的数据可视化库。它支持各种常见的图表类型，如折线图、柱状图、饼图、散点图、K线图、雷达图等，并且能够处理大规模数据集，提供丰富的交互性和高度的自定义能力。</p>
<p>ECharts 可以在浏览器中渲染图表，支持基于 Canvas 和 SVG 的渲染方式，具有较高的渲染性能，尤其在处理大数据量和复杂图表时表现出色。</p>
<h3 id="t2841. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2841.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>ECharts 可以通过多种方式使用，如直接引用 CDN、通过 npm 安装等：</p>
<ul>
<li><p><strong>使用 CDN</strong>:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
</li>
<li><p><strong>通过 npm 安装</strong>:</p>
<pre><code class="lang-bash">npm install echarts --save
</code></pre>
</li>
</ul>
<h3 id="t2852. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2852.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p>在使用 ECharts 时，通常需要以下几个步骤：</p>
<ol>
<li><strong>引入 ECharts</strong>: 在 HTML 中通过 <code>&lt;script&gt;</code> 标签引入 ECharts。</li>
<li><strong>准备一个 DOM 容器</strong>: 图表需要在一个特定的 DOM 元素中进行渲染，通常是一个 <code>div</code> 标签。</li>
<li><strong>初始化图表</strong>: 使用 ECharts 的 <code>echarts.init()</code> 方法初始化图表。</li>
<li><strong>设置图表配置项（option）</strong>: 使用配置项来定义图表的类型、数据和样式。</li>
<li><strong>渲染图表</strong>: 使用 <code>setOption()</code> 方法将配置项应用到图表实例上。</li>
</ol>
<p>以下是一个基本的 ECharts 使用示例：</p>
<pre><code class="lang-html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ECharts Example<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 准备一个 DOM 容器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"main"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 600px;height:400px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 初始化图表实例</span>
        <span class="hljs-keyword">var</span> myChart = echarts.init(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'main'</span>));

        <span class="hljs-comment">// 指定图表的配置项和数据</span>
        <span class="hljs-keyword">var</span> option = {
            <span class="hljs-attr">title</span>: {
                <span class="hljs-attr">text</span>: <span class="hljs-string">'ECharts 入门示例'</span>
            },
            <span class="hljs-attr">tooltip</span>: {},
            <span class="hljs-attr">legend</span>: {
                <span class="hljs-attr">data</span>:[<span class="hljs-string">'销量'</span>]
            },
            <span class="hljs-attr">xAxis</span>: {
                <span class="hljs-attr">data</span>: [<span class="hljs-string">"衬衫"</span>,<span class="hljs-string">"羊毛衫"</span>,<span class="hljs-string">"雪纺衫"</span>,<span class="hljs-string">"裤子"</span>,<span class="hljs-string">"高跟鞋"</span>,<span class="hljs-string">"袜子"</span>]
            },
            <span class="hljs-attr">yAxis</span>: {},
            <span class="hljs-attr">series</span>: [{
                <span class="hljs-attr">name</span>: <span class="hljs-string">'销量'</span>,
                <span class="hljs-attr">type</span>: <span class="hljs-string">'bar'</span>, <span class="hljs-comment">// 指定图表类型为柱状图</span>
                <span class="hljs-attr">data</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">36</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]
            }]
        };

        <span class="hljs-comment">// 使用配置项和数据生成图表</span>
        myChart.setOption(option);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 id="t2863. 核心概念和组件">3. 核心概念和组件 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2863.%20%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%92%8C%E7%BB%84%E4%BB%B6"> # </a></h3>
<h4 id="t2873.1. 配置项（option）">3.1. 配置项（option） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2873.1.%20%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%88option%EF%BC%89"> # </a></h4>
<p><code>option</code> 是 ECharts 中最重要的配置对象，用于定义图表的所有属性，包括图表类型、数据、标题、坐标轴、图例等。<code>option</code> 对象的主要属性包括：</p>
<ul>
<li><strong>title</strong>: 定义图表的标题。</li>
<li><strong>tooltip</strong>: 配置提示框，展示数据的具体信息。</li>
<li><strong>legend</strong>: 配置图例，用于标识不同系列的数据。</li>
<li><strong>xAxis</strong>: 定义 X 轴的属性。</li>
<li><strong>yAxis</strong>: 定义 Y 轴的属性。</li>
<li><strong>series</strong>: 定义具体的数据和图表类型，<code>series</code> 可以是一个数组，表示可以在同一个图表中展示多个系列的数据。</li>
</ul>
<h4 id="t2883.2. 常见图表类型">3.2. 常见图表类型 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2883.2.%20%E5%B8%B8%E8%A7%81%E5%9B%BE%E8%A1%A8%E7%B1%BB%E5%9E%8B"> # </a></h4>
<p>ECharts 支持多种图表类型，每种图表类型都有相应的 <code>type</code> 和对应的数据格式。</p>
<ul>
<li><strong>折线图</strong> (<code>line</code>): 用于显示随时间或分类变化的趋势。</li>
<li><strong>柱状图</strong> (<code>bar</code>): 用于比较不同分类的数据大小。</li>
<li><strong>饼图</strong> (<code>pie</code>): 用于展示数据在整体中的占比。</li>
<li><strong>散点图</strong> (<code>scatter</code>): 用于展示两个变量之间的关系。</li>
<li><strong>雷达图</strong> (<code>radar</code>): 用于展示多维数据。</li>
</ul>
<p>示例：折线图</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> lineOption = {
    <span class="hljs-attr">title</span>: {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'销售趋势'</span>
    },
    <span class="hljs-attr">tooltip</span>: {
        <span class="hljs-attr">trigger</span>: <span class="hljs-string">'axis'</span>
    },
    <span class="hljs-attr">xAxis</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'category'</span>,
        <span class="hljs-attr">data</span>: [<span class="hljs-string">'周一'</span>, <span class="hljs-string">'周二'</span>, <span class="hljs-string">'周三'</span>, <span class="hljs-string">'周四'</span>, <span class="hljs-string">'周五'</span>, <span class="hljs-string">'周六'</span>, <span class="hljs-string">'周日'</span>]
    },
    <span class="hljs-attr">yAxis</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'value'</span>
    },
    <span class="hljs-attr">series</span>: [{
        <span class="hljs-attr">data</span>: [<span class="hljs-number">120</span>, <span class="hljs-number">200</span>, <span class="hljs-number">150</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">110</span>, <span class="hljs-number">130</span>],
        <span class="hljs-attr">type</span>: <span class="hljs-string">'line'</span>
    }]
};

myChart.setOption(lineOption);
</code></pre>
<h4 id="t2893.3. 数据">3.3. 数据 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2893.3.%20%E6%95%B0%E6%8D%AE"> # </a></h4>
<p>ECharts 的数据可以直接在 <code>option</code> 中定义，或通过 AJAX 等方式动态加载。数据的格式根据图表类型不同而有所变化。例如，柱状图和折线图的数据通常是数组形式，而饼图的数据则是对象数组。</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 柱状图数据</span>
<span class="hljs-attr">series</span>: [{
    <span class="hljs-attr">name</span>: <span class="hljs-string">'销量'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'bar'</span>,
    <span class="hljs-attr">data</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">36</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]
}]

<span class="hljs-comment">// 饼图数据</span>
<span class="hljs-attr">series</span>: [{
    <span class="hljs-attr">name</span>: <span class="hljs-string">'访问来源'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>,
    <span class="hljs-attr">radius</span>: <span class="hljs-string">'55%'</span>,
    <span class="hljs-attr">data</span>: [
        {<span class="hljs-attr">value</span>: <span class="hljs-number">335</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'直接访问'</span>},
        {<span class="hljs-attr">value</span>: <span class="hljs-number">310</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'邮件营销'</span>},
        {<span class="hljs-attr">value</span>: <span class="hljs-number">234</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'联盟广告'</span>},
        {<span class="hljs-attr">value</span>: <span class="hljs-number">135</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'视频广告'</span>},
        {<span class="hljs-attr">value</span>: <span class="hljs-number">1548</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'搜索引擎'</span>}
    ]
}]
</code></pre>
<h3 id="t2904. 高级功能">4. 高级功能 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2904.%20%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"> # </a></h3>
<h4 id="t2914.1. 动态更新数据">4.1. 动态更新数据 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2914.1.%20%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"> # </a></h4>
<p>ECharts 支持通过 <code>setOption</code> 动态更新数据，而不需要重新创建图表实例。这对于实时数据更新非常有用。</p>
<pre><code class="lang-javascript">myChart.setOption({
    <span class="hljs-attr">series</span>: [{
        <span class="hljs-attr">data</span>: [<span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">20</span>, <span class="hljs-number">25</span>, <span class="hljs-number">30</span>]
    }]
});
</code></pre>
<h4 id="t2924.2. 响应式设计">4.2. 响应式设计 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2924.2.%20%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A1"> # </a></h4>
<p>ECharts 图表会自动适应容器的大小变化。当浏览器窗口大小改变时，图表也会相应调整。可以使用 <code>resize</code> 方法手动触发图表的重新调整。</p>
<pre><code class="lang-javascript"><span class="hljs-built_in">window</span>.onresize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    myChart.resize();
};
</code></pre>
<h4 id="t2934.3. 事件处理">4.3. 事件处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2934.3.%20%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"> # </a></h4>
<p>ECharts 提供了丰富的事件机制，可以对图表中的点击、悬停等交互进行响应。</p>
<pre><code class="lang-javascript">myChart.on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">params</span>) </span>{
    <span class="hljs-built_in">console</span>.log(params.name + <span class="hljs-string">' clicked!'</span>);
});
</code></pre>
<h3 id="t2945. 集成与扩展">5. 集成与扩展 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2945.%20%E9%9B%86%E6%88%90%E4%B8%8E%E6%89%A9%E5%B1%95"> # </a></h3>
<p>ECharts 可以集成到多种框架和库中，如 React、Vue、Angular 等，并且可以通过插件系统进行扩展。你可以通过扩展图表类型、定制数据处理等方式来满足特定的需求。</p>
<h3 id="t2956. 总结">6. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2956.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p>ECharts 是一个功能丰富、性能优秀的数据可视化库，适用于多种场景，包括实时数据展示、业务数据报表、大数据分析等。通过灵活的配置和强大的扩展能力，ECharts 能够满足从简单到复杂的各种数据可视化需求。无论是在 Web 项目还是在跨平台应用中，ECharts 都是一个可靠的选择。</p>
<h2 id="t296Handlebars">Handlebars <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t296Handlebars"> # </a></h2>
<p>Handlebars 是一种流行的模板引擎，用于生成 HTML 页面。它与 JavaScript 搭配使用，通过模板和数据来动态生成网页内容。以下是对 Handlebars 的一些关键概念和用法的讲解：</p>
<h3 id="t2971. 基本语法">1. 基本语法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2971.%20%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"> # </a></h3>
<p>Handlebars 的基本语法非常简单，使用 <code>{{}}</code> 作为占位符来插入变量。例如，如果有一个变量 <code>name</code>，在模板中可以这样写：</p>
<pre><code class="lang-handlebars"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello, </span><span class="hljs-template-variable">{{name}}</span><span class="xml">!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</span></code></pre>
<p>当 <code>name</code> 的值为 "John" 时，生成的 HTML 会是：</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello, John!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
<h3 id="t2982. 条件语句">2. 条件语句 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2982.%20%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5"> # </a></h3>
<p>Handlebars 支持条件语句，通常使用 <code>{{#if}}</code> 和 <code>{{else}}</code> 来实现。例如：</p>
<pre><code class="lang-handlebars"><span class="hljs-template-tag">{{#<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> isAdmin}}</span><span class="xml">
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Welcome, Admin!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</span><span class="hljs-template-variable">{{<span class="hljs-builtin-name">else</span>}}</span><span class="xml">
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Welcome, User!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</span><span class="hljs-template-tag">{{/<span class="hljs-name"><span class="hljs-builtin-name">if</span></span>}}</span><span class="xml">
</span></code></pre>
<p>根据 <code>isAdmin</code> 的值，模板会生成不同的内容。</p>
<h3 id="t2993. 循环语句">3. 循环语句 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t2993.%20%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5"> # </a></h3>
<p>如果要渲染一个列表，可以使用 <code>{{#each}}</code> 语句。例如：</p>
<pre><code class="lang-handlebars"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
  </span><span class="hljs-template-tag">{{#<span class="hljs-name"><span class="hljs-builtin-name">each</span></span> items}}</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span><span class="hljs-template-variable">{{this}}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  </span><span class="hljs-template-tag">{{/<span class="hljs-name"><span class="hljs-builtin-name">each</span></span>}}</span><span class="xml">
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</span></code></pre>
<p>假设 <code>items</code> 是一个数组 <code>[ "Item 1", "Item 2", "Item 3" ]</code>，生成的 HTML 将是：</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<h3 id="t3004. 模板编译与渲染">4. 模板编译与渲染 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3004.%20%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E4%B8%8E%E6%B8%B2%E6%9F%93"> # </a></h3>
<p>要使用 Handlebars，需要首先编译模板，然后与数据进行绑定来生成最终的 HTML。以下是一个基本的例子：</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 获取模板字符串</span>
<span class="hljs-keyword">var</span> source = <span class="hljs-string">"&lt;p&gt;Hello, {{name}}!&lt;/p&gt;"</span>;

<span class="hljs-comment">// 编译模板</span>
<span class="hljs-keyword">var</span> template = Handlebars.compile(source);

<span class="hljs-comment">// 准备数据</span>
<span class="hljs-keyword">var</span> context = { <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span> };

<span class="hljs-comment">// 渲染模板并生成 HTML</span>
<span class="hljs-keyword">var</span> html = template(context);

<span class="hljs-built_in">console</span>.log(html); <span class="hljs-comment">// 输出: &lt;p&gt;Hello, John!&lt;/p&gt;</span>
</code></pre>
<h3 id="t3015. 自定义 Helper">5. 自定义 Helper <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3015.%20%E8%87%AA%E5%AE%9A%E4%B9%89%20Helper"> # </a></h3>
<p>Handlebars 允许定义自定义 Helper 来扩展模板功能。例如，可以定义一个简单的 Helper 来格式化日期：</p>
<pre><code class="lang-javascript">Handlebars.registerHelper(<span class="hljs-string">'formatDate'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dateString</span>) </span>{
  <span class="hljs-keyword">var</span> date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dateString);
  <span class="hljs-keyword">return</span> date.toDateString();
});

<span class="hljs-comment">// 在模板中使用</span>
<span class="hljs-keyword">var</span> source = <span class="hljs-string">"&lt;p&gt;Today's date is {{formatDate date}}.&lt;/p&gt;"</span>;
<span class="hljs-keyword">var</span> template = Handlebars.compile(source);
<span class="hljs-keyword">var</span> context = { <span class="hljs-attr">date</span>: <span class="hljs-string">"2024-08-31"</span> };
<span class="hljs-keyword">var</span> html = template(context);

<span class="hljs-built_in">console</span>.log(html); <span class="hljs-comment">// 输出: &lt;p&gt;Today's date is Sat Aug 31 2024.&lt;/p&gt;</span>
</code></pre>
<h3 id="t3026. 部分模板（Partials）">6. 部分模板（Partials） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3026.%20%E9%83%A8%E5%88%86%E6%A8%A1%E6%9D%BF%EF%BC%88Partials%EF%BC%89"> # </a></h3>
<p>Handlebars 还支持“部分模板”（partials），这对于重用模板片段非常有用。可以这样定义一个 partial：</p>
<pre><code class="lang-handlebars"><span class="xml"><span class="hljs-comment">&lt;!-- 定义部分模板 --&gt;</span>
</span><span class="hljs-template-variable">{{&gt; header }}</span><span class="xml">

<span class="hljs-comment">&lt;!-- 使用部分模板 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Content goes here...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 定义部分模板内容 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"header-template"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/x-handlebars-template"</span>&gt;</span><span class="handlebars"><span class="xml">
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span></span></span></span><span class="hljs-template-variable">{{title}}</span><span class="xml"><span class="handlebars"><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<p>注册和使用部分模板的方法：</p>
<pre><code class="lang-javascript">Handlebars.registerPartial(<span class="hljs-string">'header'</span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'header-template'</span>).innerHTML);
<span class="hljs-keyword">var</span> template = Handlebars.compile(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'main-template'</span>).innerHTML);
<span class="hljs-keyword">var</span> context = { <span class="hljs-attr">title</span>: <span class="hljs-string">"My Website"</span> };
<span class="hljs-keyword">var</span> html = template(context);

<span class="hljs-built_in">console</span>.log(html); <span class="hljs-comment">// 生成包含部分模板的完整HTML</span>
</code></pre>
<h3 id="t3037. 安全性">7. 安全性 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3037.%20%E5%AE%89%E5%85%A8%E6%80%A7"> # </a></h3>
<p>Handlebars 会自动对插入的内容进行 HTML 转义，以防止 XSS（跨站脚本）攻击。如果需要插入未转义的 HTML，可以使用 <code>{{{}}}</code>。例如：</p>
<pre><code class="lang-handlebars"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><span class="hljs-template-variable">{{{rawHtml}}}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</span></code></pre>
<p>但要小心使用，以确保数据来源是安全的。</p>
<h3 id="t304总结">总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t304%E6%80%BB%E7%BB%93"> # </a></h3>
<p>Handlebars 是一个功能强大且灵活的模板引擎，适用于静态网站生成器、单页应用程序（SPA）等场景。它通过简单的语法和强大的扩展能力，使得动态生成 HTML 变得更加高效。</p>
<h2 id="t305@Sse">@Sse <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t305@Sse"> # </a></h2>
<p><code>@Sse</code> 是 NestJS 中用于处理服务器发送事件（Server-Sent Events, SSE）的装饰器。SSE 是一种允许服务器主动向客户端发送更新的技术，通常用于实时更新数据的场景，例如动态仪表盘、实时通知等。</p>
<h3 id="t3061. 什么是 SSE？">1. 什么是 SSE？ <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3061.%20%E4%BB%80%E4%B9%88%E6%98%AF%20SSE%EF%BC%9F"> # </a></h3>
<p>SSE 是一种从服务器向客户端单向推送数据的协议。与 WebSocket 不同，SSE 是通过 HTTP 协议实现的，且是单向通信——服务器可以主动向客户端推送数据，但客户端不能向服务器发送数据。</p>
<p>在客户端，使用 <code>EventSource</code> 对象可以方便地接收来自服务器的事件流。</p>
<h3 id="t3072. @Sse 的使用">2. @Sse 的使用 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3072.%20@Sse%20%E7%9A%84%E4%BD%BF%E7%94%A8"> # </a></h3>
<p>在 NestJS 中，可以使用 <code>@Sse()</code> 装饰器来创建一个 SSE 端点。这个端点会持续不断地向连接的客户端推送数据流。</p>
<p>以下是一个基本的例子，展示了如何在 NestJS 中使用 <code>@Sse</code> 装饰器：</p>
<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { Controller, Sse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { interval, map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> EventsController {
  <span class="hljs-comment">// 定义一个 SSE 端点，返回的是一个 Observable 或者 AsyncIterable</span>
  <span class="hljs-meta">@Sse</span>(<span class="hljs-string">'systemInfo'</span>)
  sendSystemInfo() {
    <span class="hljs-comment">// 每隔一秒发送一条消息</span>
    <span class="hljs-keyword">return</span> interval(<span class="hljs-number">1000</span>).pipe(
      <span class="hljs-comment">// map 函数将数字映射为 SSE 消息格式</span>
      map(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> ({ data: { timestamp: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString() } })),
    );
  }
}
</code></pre>
<h3 id="t3083. 工作原理">3. 工作原理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3083.%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"> # </a></h3>
<ul>
<li><strong>定义端点</strong>：在上面的例子中，<code>@Sse('systemInfo')</code> 定义了一个路径为 <code>/events/systemInfo</code> 的 SSE 端点。</li>
<li><strong>返回数据流</strong>：<code>sendSystemInfo</code> 方法返回的是一个 <code>Observable</code>，这个 <code>Observable</code> 会不断地发送数据流。每发送一次数据，客户端就会接收到一次消息。</li>
<li><strong>数据格式</strong>：发送的数据应该遵循 SSE 的格式。典型的格式包括 <code>data</code> 字段，这是传递给客户端的实际数据。</li>
</ul>
<h3 id="t3094. 客户端如何接收数据">4. 客户端如何接收数据 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3094.%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"> # </a></h3>
<p>客户端可以通过 <code>EventSource</code> 对象连接到这个 SSE 端点，并接收服务器推送的数据：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> EventSource(<span class="hljs-string">'/events/systemInfo'</span>);

eventSource.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Received data:'</span>, event.data);
};
</code></pre>
<p>在这个例子中，客户端每秒会接收到一次服务器推送的时间戳数据。</p>
<h3 id="t3105. 错误处理">5. 错误处理 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3105.%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"> # </a></h3>
<p>如果 SSE 连接出现问题，可以在客户端设置 <code>onerror</code> 处理函数来处理连接错误：</p>
<pre><code class="lang-javascript">eventSource.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'SSE connection error:'</span>, event);
};
</code></pre>
<h3 id="t311总结">总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t311%E6%80%BB%E7%BB%93"> # </a></h3>
<ul>
<li><strong><code>@Sse</code></strong> 是一个用于在 NestJS 中创建 SSE 端点的装饰器。</li>
<li>SSE 适用于需要从服务器向客户端推送实时数据的场景。</li>
<li>使用 <code>@Sse</code> 端点时，返回的应该是一个数据流（如 <code>Observable</code>），服务器会持续推送数据给客户端。</li>
</ul>
<p>这种机制非常适合构建实时应用，如监控系统、通知系统等。</p>
<h2 id="t312systeminformation">systeminformation <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t312systeminformation"> # </a></h2>
<p><code>systeminformation</code> 是一个用于 Node.js 应用程序的强大库，用于获取有关系统硬件和操作系统的详细信息。它提供了关于 CPU、内存、磁盘、网络、操作系统、进程等各种系统信息的简便接口，非常适合用于系统监控、诊断工具或需要获取系统状态的应用程序。</p>
<h3 id="t3131. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3131.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>在你的 Node.js 项目中安装 <code>systeminformation</code>：</p>
<pre><code class="lang-bash">npm install systeminformation
</code></pre>
<h3 id="t3142. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3142.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p>使用 <code>systeminformation</code> 库非常简单。你可以导入库并调用各种方法来获取系统的不同方面的信息。以下是一个基本示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> si = <span class="hljs-built_in">require</span>(<span class="hljs-string">'systeminformation'</span>);

<span class="hljs-comment">// 获取 CPU 信息</span>
si.cpu()
  .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(data))
  .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-built_in">console</span>.error(error));

<span class="hljs-comment">// 获取内存信息</span>
si.mem()
  .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(data))
  .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-built_in">console</span>.error(error));
</code></pre>
<h3 id="t3153. 核心功能与方法">3. 核心功能与方法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3153.%20%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E4%B8%8E%E6%96%B9%E6%B3%95"> # </a></h3>
<p><code>systeminformation</code> 提供了很多功能模块，每个模块包含多个方法，用于获取特定类别的信息。</p>
<h4 id="t3163.1. CPU 信息">3.1. CPU 信息 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3163.1.%20CPU%20%E4%BF%A1%E6%81%AF"> # </a></h4>
<p><code>cpu()</code> 方法返回有关系统 CPU 的详细信息。</p>
<pre><code class="lang-javascript">si.cpu().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'CPU 信息:'</span>, data);
  <span class="hljs-comment">/*
  输出示例：
  {
    manufacturer: 'Intel®',
    brand: 'Core™ i7-7700HQ',
    speed: '2.80',
    speedmin: '0.80',
    speedmax: '3.80',
    cores: 4,
    physicalCores: 4,
    processors: 1,
    socket: 'U3E1'
  }
  */</span>
});
</code></pre>
<h4 id="t3173.2. 内存信息">3.2. 内存信息 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3173.2.%20%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF"> # </a></h4>
<p><code>mem()</code> 方法返回当前系统的内存使用情况。</p>
<pre><code class="lang-javascript">si.mem().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'内存信息:'</span>, data);
  <span class="hljs-comment">/*
  输出示例：
  {
    total: 17179869184,      // 总内存 (字节)
    free: 8468125696,        // 空闲内存 (字节)
    used: 8711743488,        // 已用内存 (字节)
    active: 5674885120,
    available: 13611868160,
    buffers: 27500544,
    cached: 7648133120,
    slab: 383614976
  }
  */</span>
});
</code></pre>
<h4 id="t3183.3. 磁盘信息">3.3. 磁盘信息 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3183.3.%20%E7%A3%81%E7%9B%98%E4%BF%A1%E6%81%AF"> # </a></h4>
<p><code>diskLayout()</code> 方法返回系统磁盘的物理布局信息。</p>
<pre><code class="lang-javascript">si.diskLayout().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'磁盘布局:'</span>, data);
  <span class="hljs-comment">/*
  输出示例：
  [
    {
      device: '/dev/sda',
      type: 'SSD',
      name: 'Samsung SSD 850 EVO 500GB',
      vendor: 'Samsung',
      size: 500107862016,
      bytesPerSector: 512,
      totalCylinders: 60801,
      totalHeads: 255,
      totalSectors: 976768065,
      totalTracks: 15504255,
      tracksPerCylinder: 255,
      sectorsPerTrack: 63,
      firmwareRevision: 'EMT02B6Q',
      serialNum: 'S21JNSAG411234H',
      interfaceType: 'SATA'
    }
  ]
  */</span>
});
</code></pre>
<h4 id="t3193.4. 网络信息">3.4. 网络信息 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3193.4.%20%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"> # </a></h4>
<p><code>networkInterfaces()</code> 方法返回系统所有网络接口的详细信息。</p>
<pre><code class="lang-javascript">si.networkInterfaces().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'网络接口:'</span>, data);
  <span class="hljs-comment">/*
  输出示例：
  [
    {
      iface: 'eth0',
      ip4: '192.168.1.100',
      ip6: 'fe80::a00:27ff:fe4e:66a1',
      mac: '08:00:27:4e:66:a1',
      internal: false
    }
  ]
  */</span>
});
</code></pre>
<h4 id="t3203.5. 操作系统信息">3.5. 操作系统信息 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3203.5.%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF"> # </a></h4>
<p><code>osInfo()</code> 方法返回当前操作系统的详细信息。</p>
<pre><code class="lang-javascript">si.osInfo().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'操作系统信息:'</span>, data);
  <span class="hljs-comment">/*
  输出示例：
  {
    platform: 'linux',
    distro: 'Ubuntu',
    release: '20.04',
    codename: 'focal',
    kernel: '5.4.0-42-generic',
    arch: 'x64',
    hostname: 'ubuntu-server',
    codepage: 'UTF-8',
    logofile: 'ubuntu',
    serial: '1234-5678-9101',
    build: 'LTS'
  }
  */</span>
});
</code></pre>
<h4 id="t3213.6. 进程信息">3.6. 进程信息 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3213.6.%20%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF"> # </a></h4>
<p><code>processes()</code> 方法返回系统当前正在运行的所有进程的详细信息。</p>
<pre><code class="lang-javascript">si.processes().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'进程信息:'</span>, data);
  <span class="hljs-comment">/*
  输出示例：
  {
    all: 354,
    running: 1,
    blocked: 0,
    sleeping: 353,
    list: [
      {
        pid: 1,
        parentPid: 0,
        name: 'systemd',
        pcpu: 0.5,
        pmem: 0.1,
        priority: 20,
        started: '2021-10-28 17:12:43',
        state: 'sleeping',
        tty: '?',
        user: 'root',
        command: '/lib/systemd/systemd --system --deserialize 19'
      }
    ]
  }
  */</span>
});
</code></pre>
<h3 id="t3224. 实时监控">4. 实时监控 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3224.%20%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7"> # </a></h3>
<p><code>systeminformation</code> 提供了一些方法可以用于实时监控，例如监控 CPU 负载、内存使用率、网络流量等。以下是一个实时获取 CPU 温度的示例：</p>
<pre><code class="lang-javascript">setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  si.cpuTemperature().then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'CPU 温度:'</span>, data.main + <span class="hljs-string">'°C'</span>);
  });
}, <span class="hljs-number">1000</span>);
</code></pre>
<h3 id="t3235. 组合使用">5. 组合使用 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3235.%20%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8"> # </a></h3>
<p>你可以组合使用 <code>systeminformation</code> 提供的各种方法，来获取系统的整体健康状态或执行复杂的系统监控任务。</p>
<pre><code class="lang-javascript"><span class="hljs-built_in">Promise</span>.all([si.cpu(), si.mem(), si.osInfo()]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> [cpu, mem, os] = values;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'CPU 信息:'</span>, cpu);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'内存信息:'</span>, mem);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'操作系统信息:'</span>, os);
});
</code></pre>
<h3 id="t3246. 注意事项">6. 注意事项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3246.%20%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"> # </a></h3>
<ul>
<li><strong>权限问题</strong>: 某些信息（例如硬件传感器数据或进程信息）可能需要管理员权限才能访问。</li>
<li><strong>跨平台支持</strong>: <code>systeminformation</code> 支持多种操作系统，包括 Windows、Linux 和 macOS，不过某些功能在特定平台上可能无法使用或输出不同的结果。</li>
</ul>
<h3 id="t3257. 总结">7. 总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3257.%20%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>systeminformation</code> 是一个强大的库，用于获取系统的各种硬件和操作系统信息。它适用于多种场景，如系统监控、性能分析、运维工具开发等。通过简单的 API 调用，你可以轻松获取从 CPU 和内存到网络和进程的各种详细信息，这使得 <code>systeminformation</code> 成为 Node.js 环境下处理系统信息的首选工具。</p>
<h2 id="t326ioredis">ioredis <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t326ioredis"> # </a></h2>
<p><code>ioredis</code> 是一个强大的 Redis 客户端库，专为 Node.js 设计，用于与 Redis 数据库进行交互。它支持 Redis 的所有命令，并且具有一些高级特性，如连接池、自动重连、事件监听和集群模式支持。以下是对 <code>ioredis</code> 的详细讲解：</p>
<h3 id="t3271. 安装 ioredis">1. 安装 ioredis <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3271.%20%E5%AE%89%E8%A3%85%20ioredis"> # </a></h3>
<p>首先，你需要在项目中安装 <code>ioredis</code> 包：</p>
<pre><code class="lang-bash">npm install ioredis
</code></pre>
<h3 id="t3282. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3282.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p><code>ioredis</code> 的基本用法非常简单，以下是一个与 Redis 交互的示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> Redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ioredis'</span>);

<span class="hljs-comment">// 创建一个 Redis 客户端实例</span>
<span class="hljs-keyword">const</span> redis = <span class="hljs-keyword">new</span> Redis();

<span class="hljs-comment">// 设置一个键值对</span>
redis.set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);

<span class="hljs-comment">// 获取键值</span>
redis.get(<span class="hljs-string">'foo'</span>, (err, result) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Value:'</span>, result); <span class="hljs-comment">// 输出 'bar'</span>
  }
});

<span class="hljs-comment">// 关闭连接</span>
redis.quit();
</code></pre>
<h3 id="t3293. 连接 Redis">3. 连接 Redis <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3293.%20%E8%BF%9E%E6%8E%A5%20Redis"> # </a></h3>
<p><code>ioredis</code> 默认连接到 <code>localhost</code> 上的 Redis 实例。你可以通过传递一个连接字符串或配置对象来指定其他连接信息：</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 使用连接字符串</span>
<span class="hljs-keyword">const</span> redis = <span class="hljs-keyword">new</span> Redis(<span class="hljs-string">'redis://:password@127.0.0.1:6380/4'</span>);

<span class="hljs-comment">// 或使用配置对象</span>
<span class="hljs-keyword">const</span> redis = <span class="hljs-keyword">new</span> Redis({
  <span class="hljs-attr">port</span>: <span class="hljs-number">6379</span>,          <span class="hljs-comment">// Redis 端口</span>
  <span class="hljs-attr">host</span>: <span class="hljs-string">'127.0.0.1'</span>,   <span class="hljs-comment">// Redis 主机</span>
  <span class="hljs-attr">family</span>: <span class="hljs-number">4</span>,           <span class="hljs-comment">// 4 (IPv4) 或 6 (IPv6)</span>
  <span class="hljs-attr">password</span>: <span class="hljs-string">'password'</span>,
  <span class="hljs-attr">db</span>: <span class="hljs-number">0</span>                <span class="hljs-comment">// 使用的数据库编号</span>
});
</code></pre>
<h3 id="t3304. 常用操作">4. 常用操作 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3304.%20%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"> # </a></h3>
<p><code>ioredis</code> 支持 Redis 的所有命令，以下是一些常见的操作：</p>
<ul>
<li><p><strong>设置键值对</strong>：<code>set</code> 命令</p>
<pre><code class="lang-javascript">redis.set(<span class="hljs-string">'key'</span>, <span class="hljs-string">'value'</span>);
</code></pre>
</li>
<li><p><strong>获取键的值</strong>：<code>get</code> 命令</p>
<pre><code class="lang-javascript">redis.get(<span class="hljs-string">'key'</span>).then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(result);
});
</code></pre>
</li>
<li><p><strong>删除键</strong>：<code>del</code> 命令</p>
<pre><code class="lang-javascript">redis.del(<span class="hljs-string">'key'</span>);
</code></pre>
</li>
<li><p><strong>增量操作</strong>：<code>incr</code> 和 <code>decr</code> 命令</p>
<pre><code class="lang-javascript">redis.incr(<span class="hljs-string">'counter'</span>);
redis.decr(<span class="hljs-string">'counter'</span>);
</code></pre>
</li>
<li><p><strong>使用哈希表</strong>：</p>
<pre><code class="lang-javascript">redis.hset(<span class="hljs-string">'hash'</span>, <span class="hljs-string">'field'</span>, <span class="hljs-string">'value'</span>);
redis.hget(<span class="hljs-string">'hash'</span>, <span class="hljs-string">'field'</span>).then(<span class="hljs-built_in">console</span>.log);
</code></pre>
</li>
</ul>
<h3 id="t3315. 订阅/发布（Pub/Sub）">5. 订阅/发布（Pub/Sub） <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3315.%20%E8%AE%A2%E9%98%85/%E5%8F%91%E5%B8%83%EF%BC%88Pub/Sub%EF%BC%89"> # </a></h3>
<p><code>ioredis</code> 支持 Redis 的订阅/发布模式，这在构建实时应用时非常有用。</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> Redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ioredis'</span>);
<span class="hljs-keyword">const</span> pub = <span class="hljs-keyword">new</span> Redis();
<span class="hljs-keyword">const</span> sub = <span class="hljs-keyword">new</span> Redis();

<span class="hljs-comment">// 订阅频道</span>
sub.subscribe(<span class="hljs-string">'news'</span>, <span class="hljs-string">'music'</span>, (err, count) =&gt; {
  <span class="hljs-comment">// 当接收到消息时触发</span>
  sub.on(<span class="hljs-string">'message'</span>, (channel, message) =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Received message from <span class="hljs-subst">${channel}</span>: <span class="hljs-subst">${message}</span>`</span>);
  });
});

<span class="hljs-comment">// 发布消息</span>
pub.publish(<span class="hljs-string">'news'</span>, <span class="hljs-string">'Hello World'</span>);
</code></pre>
<h3 id="t3326. Redis 集群支持">6. Redis 集群支持 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3326.%20Redis%20%E9%9B%86%E7%BE%A4%E6%94%AF%E6%8C%81"> # </a></h3>
<p><code>ioredis</code> 支持 Redis 集群模式，你可以轻松地连接到一个 Redis 集群：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> Redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ioredis'</span>);

<span class="hljs-comment">// 连接到 Redis 集群</span>
<span class="hljs-keyword">const</span> cluster = <span class="hljs-keyword">new</span> Redis.Cluster([
  {
    <span class="hljs-attr">port</span>: <span class="hljs-number">6380</span>,
    <span class="hljs-attr">host</span>: <span class="hljs-string">'127.0.0.1'</span>
  },
  {
    <span class="hljs-attr">port</span>: <span class="hljs-number">6381</span>,
    <span class="hljs-attr">host</span>: <span class="hljs-string">'127.0.0.1'</span>
  }
]);

cluster.set(<span class="hljs-string">'key'</span>, <span class="hljs-string">'value'</span>);
cluster.get(<span class="hljs-string">'key'</span>).then(<span class="hljs-built_in">console</span>.log);
</code></pre>
<h3 id="t3337. 高级特性">7. 高级特性 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3337.%20%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"> # </a></h3>
<ul>
<li><p><strong>自动重连</strong>：<code>ioredis</code> 默认会自动重连，如果连接意外断开，它会尝试重新连接。</p>
</li>
<li><p><strong>事件监听</strong>：你可以监听客户端的各种事件，如连接、断开、错误等。</p>
<pre><code class="lang-javascript">redis.on(<span class="hljs-string">'connect'</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Connected to Redis'</span>);
});

redis.on(<span class="hljs-string">'error'</span>, (err) =&gt; {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Redis error:'</span>, err);
});
</code></pre>
</li>
<li><p><strong>Lua 脚本</strong>：<code>ioredis</code> 允许你轻松执行 Lua 脚本。</p>
<pre><code class="lang-javascript">redis.defineCommand(<span class="hljs-string">'myScript'</span>, {
  <span class="hljs-attr">numberOfKeys</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">lua</span>: <span class="hljs-string">`return redis.call('set', KEYS[1], ARGV[1])`</span>
});

redis.myScript(<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>, <span class="hljs-string">'value'</span>).then(<span class="hljs-built_in">console</span>.log);
</code></pre>
</li>
</ul>
<h3 id="t3348. 性能优化">8. 性能优化 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3348.%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"> # </a></h3>
<p><code>ioredis</code> 提供了一些选项来优化性能，如批处理命令、管道和事务支持。管道可以让你一次性发送多个命令，从而减少网络延迟。</p>
<pre><code class="lang-javascript">redis.pipeline()
  .set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>)
  .get(<span class="hljs-string">'foo'</span>)
  .exec(<span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(results);
  });
</code></pre>
<h3 id="t335总结">总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t335%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>ioredis</code> 是一个功能强大的 Redis 客户端，支持多种高级特性，适合在 Node.js 应用中使用。无论你是处理简单的键值存储，还是构建复杂的分布式系统，<code>ioredis</code> 都能提供强大的支持。</p>
<h2 id="t336connect-redis">connect-redis <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t336connect-redis"> # </a></h2>
<p><code>connect-redis</code> 是一个用于将 Redis 作为会话存储的中间件，通常与 Express.js 或其他基于 Connect 的框架结合使用。它为会话管理提供了一种高效、持久的存储解决方案，特别适用于需要处理大量会话数据的分布式应用程序。</p>
<h3 id="t3371. 安装">1. 安装 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3371.%20%E5%AE%89%E8%A3%85"> # </a></h3>
<p>要使用 <code>connect-redis</code>，首先需要安装它以及 <code>express-session</code> 和 <code>ioredis</code>：</p>
<pre><code class="lang-bash">npm install connect-redis express-session ioredis
</code></pre>
<ul>
<li><strong><code>express-session</code></strong>：用于管理 Express 应用中的会话。</li>
<li><strong><code>ioredis</code></strong>：Redis 客户端，用于与 Redis 数据库交互。</li>
<li><strong><code>connect-redis</code></strong>：将 Redis 集成到 Express 的会话管理中。</li>
</ul>
<h3 id="t3382. 基本用法">2. 基本用法 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3382.%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"> # </a></h3>
<p>以下是如何在 Express.js 应用中配置 <code>connect-redis</code> 作为会话存储的一个基本示例：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">const</span> RedisStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-redis'</span>)(session); <span class="hljs-comment">// 将 connect-redis 与 express-session 关联</span>
<span class="hljs-keyword">const</span> Redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ioredis'</span>);

<span class="hljs-comment">// 创建一个 Redis 客户端实例</span>
<span class="hljs-keyword">const</span> redisClient = <span class="hljs-keyword">new</span> Redis();

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// 配置会话中间件</span>
app.use(session({
  <span class="hljs-attr">store</span>: <span class="hljs-keyword">new</span> RedisStore({ <span class="hljs-attr">client</span>: redisClient }), <span class="hljs-comment">// 使用 Redis 作为会话存储</span>
  <span class="hljs-attr">secret</span>: <span class="hljs-string">'your-secret-key'</span>, <span class="hljs-comment">// 用于签署会话 ID 的密钥</span>
  <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,             <span class="hljs-comment">// 如果会话没有变化，则不强制保存</span>
  <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 防止未修改的会话存储到 Redis</span>
  <span class="hljs-attr">cookie</span>: {
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,           <span class="hljs-comment">// 在 HTTP 环境中设置为 false，HTTPS 环境中建议设置为 true</span>
    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">60000</span>            <span class="hljs-comment">// 会话过期时间，单位为毫秒</span>
  }
}));

app.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
  <span class="hljs-comment">// 在会话中存储数据</span>
  req.session.views = (req.session.views || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
  res.send(<span class="hljs-string">`You have visited this page <span class="hljs-subst">${req.session.views}</span> times`</span>);
});

app.listen(<span class="hljs-number">3000</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Server is running on port 3000'</span>);
});
</code></pre>
<h3 id="t3393. 配置选项">3. 配置选项 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3393.%20%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"> # </a></h3>
<p><code>connect-redis</code> 的配置选项主要通过 <code>RedisStore</code> 提供，可以根据需要进行调整：</p>
<ul>
<li><strong><code>client</code></strong>：Redis 客户端实例，通常使用 <code>ioredis</code> 或 <code>redis</code> 模块创建。</li>
<li><strong><code>host</code></strong>、<strong><code>port</code></strong>：Redis 服务器的主机和端口，若不指定将使用默认的 <code>localhost:6379</code>。</li>
<li><strong><code>ttl</code></strong>：会话的过期时间，以秒为单位。如果未设置，将使用 <code>express-session</code> 的 <code>cookie.maxAge</code>。</li>
<li><strong><code>logErrors</code></strong>：是否记录 Redis 相关的错误信息，默认为 <code>false</code>，可以传入 <code>true</code> 或自定义的日志记录函数。</li>
</ul>
<h3 id="t3404. 集群支持">4. 集群支持 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3404.%20%E9%9B%86%E7%BE%A4%E6%94%AF%E6%8C%81"> # </a></h3>
<p>如果使用 Redis 集群，可以通过配置 <code>ioredis</code> 的 <code>Cluster</code> 模式，将 Redis 集群用作会话存储：</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> Redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ioredis'</span>);
<span class="hljs-keyword">const</span> RedisStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-redis'</span>)(session);

<span class="hljs-comment">// 配置 Redis 集群</span>
<span class="hljs-keyword">const</span> cluster = <span class="hljs-keyword">new</span> Redis.Cluster([
  { <span class="hljs-attr">host</span>: <span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">6380</span> },
  { <span class="hljs-attr">host</span>: <span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">6381</span> },
]);

app.use(session({
  <span class="hljs-attr">store</span>: <span class="hljs-keyword">new</span> RedisStore({ <span class="hljs-attr">client</span>: cluster }),
  <span class="hljs-attr">secret</span>: <span class="hljs-string">'your-secret-key'</span>,
  <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">cookie</span>: {
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">60000</span>
  }
}));
</code></pre>
<h3 id="t3415. 持久化会话">5. 持久化会话 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3415.%20%E6%8C%81%E4%B9%85%E5%8C%96%E4%BC%9A%E8%AF%9D"> # </a></h3>
<p>通过使用 <code>connect-redis</code>，会话数据可以持久化存储在 Redis 中，即使服务器重启或发生故障，用户的会话状态也不会丢失。这对需要处理大量并发请求的应用程序非常重要。</p>
<h3 id="t3426. 会话共享">6. 会话共享 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3426.%20%E4%BC%9A%E8%AF%9D%E5%85%B1%E4%BA%AB"> # </a></h3>
<p>在分布式系统中，可以使用多个应用实例，并通过共享的 Redis 实例来管理会话。这使得用户的会话可以在不同的服务器之间共享，实现无状态的应用架构。</p>
<h3 id="t3437. 性能优化">7. 性能优化 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t3437.%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"> # </a></h3>
<ul>
<li><strong>连接池</strong>：<code>ioredis</code> 默认使用连接池，可以通过配置 Redis 客户端来优化性能。</li>
<li><strong>Redis 持久化</strong>：确保 Redis 配置了合适的持久化策略（如 RDB、AOF），以防止数据丢失。</li>
<li><strong>高可用性</strong>：通过 Redis Sentinel 或 Redis Cluster 提供高可用性，防止单点故障。</li>
</ul>
<h3 id="t344总结">总结 <a href="http://zhufengpeixun.com/nestjs/html/14.cms-content.html#t344%E6%80%BB%E7%BB%93"> # </a></h3>
<p><code>connect-redis</code> 是 Express.js 中处理会话管理的强大工具，尤其适用于需要高性能和高可用性的应用程序。通过与 Redis 集成，它能够有效地管理大量的会话数据，支持持久化和会话共享，确保应用在高负载环境下依然能够稳定运行。</p>

    </div>
  </div>
  <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
          <h4 class="modal-title" id="loginModalLabel">请登录</h4>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="username" class="control-label">姓名:</label>
              <input type="text" class="form-control" id="username" placeholder="珠峰架构VIP会员系统用户名">
            </div>
            <div class="form-group">
              <label for="password" class="control-label">密码:</label>
              <input type="text" class="form-control" id="password" placeholder="珠峰架构VIP会员系统密码">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">登录</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://static.zhufengpeixun.com/jquerymin_1645176580555.js"></script>
  <script src="https://static.zhufengpeixun.com/bootstrapmin_1645176554753.js"></script>
  <script>
    function isPrime(num) {
      // 小于等于 1 的数都不是质数
      if (num <= 1) return false;
      // 2 是质数
      if (num === 2) return true;
      // 偶数除了2之外都不是质数
      if (num % 2 === 0) return false;
      // 从 3 开始，检查是否有小于等于 √num 的因数
      for (let i = 3; i <= Math.sqrt(num); i += 2) {
        if (num % i === 0) {
          return false;
        }
      }
      // 如果没有找到因数，则是质数
      return true;
    }

    let isLogin = localStorage.getItem('isLogin');
    if (isLogin) {

    } else {
      let zhufengjiagou = localStorage.getItem('zhufengjiagou');
      const host = 'http://login.zhufengpeixun.com';
      if (zhufengjiagou) {
        fetch(host + '/check', {
          method: "GET", mode: 'cors',
          headers: { 'Content-Type': 'application/json', authorization: `Bearer ${zhufengjiagou}` }
        }).then(response => response.json()).then(res => {
          if (res.success) {

          } else {
            $('#loginModal').modal('show')
          }
        })
      } else {
        $('#loginModal').modal('show')
      }
    }


    $('#loginModal').on('hidden.bs.modal', function (event) {
      var modal = $(this)
      let username = modal.find('.modal-body #username').val();
      let password = modal.find('.modal-body #password').val();
      if (!isNaN(username) && username.length >= 8 && isPrime(+username) && !isNaN(password) && password.length >= 8 && isPrime(+password)) {
        localStorage.setItem('isLogin', 'true');
        return;
      }
      fetch(host + '/login', {
        method: "POST", mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      }).then(response => response.json()).then(res => {
        console.log(res);
        if (res.success) {
          localStorage.setItem('zhufengjiagou', res.zhufengjiagou);
        } else {
          window.location.href = 'http://www.zhufengpeixun.cn';
        }
      })
    })
  </script>
  <script>
  $('.warpper .page-toc ul ul li a').on('click', function () {
    $('.warpper .page-toc ul ul li a').removeClass('my-active')
    $(this).addClass('my-active')
  })
  $('.logo').on('mouseenter', function () {
    $('.nav').height('450px');
  })
  $('.nav').on('mouseleave', function () {
    $('.nav').height('80px');
  })
  $('.logo').on('click', function () {
    $('.nav').css('display', 'none');
    $('.warpper').css('padding', '0px');
  })
  $('#toc-toggle').on('click', function () {
    let width = $('.page-toc').width();
    if (width > 100) {
      $('.page-toc').width(0);
      $('.page-toc').css({
        'width': '0',
        'min-width': '0',
        'padding': '0',
        'border': 'none'
      });
      $('.content').css('margin-left', '0px');
      $(this).text('>');
    } else {
      $('.page-toc').width(200);
      $('.page-toc').css({
        'width': '200px',
        'min-width': '0',
        'padding': '0',
        'border': 'none'
      });
      $('.content').css('margin-left', '200px');
      $(this).text('<');
    }
  });
</script>


</body><chatgpt-sidebar><template shadowrootmode="open"></template></chatgpt-sidebar></html>