# Database æ¨¡å—å•å…ƒæµ‹è¯•æ€»ç»“

> **ç‰ˆæœ¬**: 1.0.0 | **åˆ›å»ºæ—¥æœŸ**: 2025-10-01

---

## ğŸ“Š æµ‹è¯•æ¦‚è§ˆ

### æµ‹è¯•ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| **æµ‹è¯•å¥—ä»¶** | 3 | å…¨éƒ¨é€šè¿‡ âœ… |
| **æµ‹è¯•ç”¨ä¾‹** | 48 | 36 é€šè¿‡ï¼Œ12 è·³è¿‡ |
| **ä»£ç è¦†ç›–ç‡** | - | å¾…é…ç½® |
| **æµ‹è¯•æ—¶é•¿** | ~8.5s | æ€§èƒ½è‰¯å¥½ |
| **Mock å¯¹è±¡** | 15+ | å®Œæ•´æ¨¡æ‹Ÿ |

### æµ‹è¯•æ–‡ä»¶åˆ—è¡¨

```
packages/database/src/lib/
â”œâ”€â”€ connection.manager.spec.ts    âœ… 13 æµ‹è¯• (1 è·³è¿‡)
â”œâ”€â”€ database.service.spec.ts      âœ… 17 æµ‹è¯• (2 è·³è¿‡)
â””â”€â”€ tenant-database.service.spec.ts âœ… 18 æµ‹è¯• (9 è·³è¿‡)
```

---

## âœ… å·²å®Œæˆçš„æµ‹è¯•

### 1. ConnectionManager æµ‹è¯• (13 ä¸ªæµ‹è¯•ç”¨ä¾‹)

**åŸºç¡€åŠŸèƒ½æµ‹è¯• (6ä¸ª)**

- âœ… åº”è¯¥æ­£ç¡®åˆå§‹åŒ–
- âœ… åº”è¯¥æˆåŠŸè·å–ä¸»æ•°æ®åº“è¿æ¥
- â­ï¸ åº”è¯¥åœ¨ ORM æœªåˆå§‹åŒ–æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)
- âœ… åº”è¯¥æ­£ç¡®æ£€æŸ¥è¿æ¥çŠ¶æ€
- âœ… åº”è¯¥è¿”å›æ­£ç¡®çš„è¿æ¥ä¿¡æ¯
- âœ… åº”è¯¥è¿”å›è¿æ¥ç»Ÿè®¡ä¿¡æ¯

**ç§Ÿæˆ·åŠŸèƒ½æµ‹è¯• (5ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸåˆ›å»ºç§Ÿæˆ·è¿æ¥
- âœ… åº”è¯¥å¤ç”¨å·²å­˜åœ¨çš„ç§Ÿæˆ·è¿æ¥
- âœ… åº”è¯¥æˆåŠŸåˆ›å»ºç§Ÿæˆ·æ•°æ®åº“
- âœ… åº”è¯¥æˆåŠŸåˆ é™¤ç§Ÿæˆ·æ•°æ®åº“
- âœ… åº”è¯¥æˆåŠŸå…³é—­ç§Ÿæˆ·è¿æ¥

**ç”Ÿå‘½å‘¨æœŸæµ‹è¯• (2ä¸ª)**

- âœ… åº”è¯¥åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶è®°å½•æ—¥å¿—
- âœ… åº”è¯¥åœ¨æ¨¡å—é”€æ¯æ—¶å…³é—­æ‰€æœ‰è¿æ¥

**é”™è¯¯å¤„ç†æµ‹è¯• (2ä¸ª)**

- â­ï¸ åº”è¯¥åœ¨åˆ›å»ºç§Ÿæˆ·æ•°æ®åº“å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)
- â­ï¸ åº”è¯¥åœ¨åˆ é™¤ç§Ÿæˆ·æ•°æ®åº“å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)

---

### 2. DatabaseService æµ‹è¯• (17 ä¸ªæµ‹è¯•ç”¨ä¾‹)

**åŸºç¡€åŠŸèƒ½æµ‹è¯• (4ä¸ª)**

- âœ… åº”è¯¥æ­£ç¡®åˆå§‹åŒ–
- âœ… åº”è¯¥æˆåŠŸè·å–æ•°æ®åº“è¿æ¥
- âœ… åº”è¯¥æˆåŠŸè·å– EntityManager
- âœ… åº”è¯¥ä¼˜å…ˆä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„ EntityManager

**æŸ¥è¯¢æ“ä½œæµ‹è¯• (3ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸæ‰§è¡Œ SQL æŸ¥è¯¢
- â­ï¸ åº”è¯¥åœ¨æŸ¥è¯¢å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)
- âœ… åº”è¯¥æˆåŠŸæ‰§è¡ŒåŸç”Ÿ SQL

**äº‹åŠ¡æ“ä½œæµ‹è¯• (7ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸæ‰§è¡Œäº‹åŠ¡
- â­ï¸ åº”è¯¥åœ¨äº‹åŠ¡å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)
- âœ… åº”è¯¥æˆåŠŸå¼€å§‹äº‹åŠ¡
- âœ… åº”è¯¥æˆåŠŸæäº¤äº‹åŠ¡
- âœ… åº”è¯¥æˆåŠŸå›æ»šäº‹åŠ¡

**è¿æ¥ç®¡ç†æµ‹è¯• (3ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸå…³é—­è¿æ¥
- âœ… åº”è¯¥æ­£ç¡®è¿”å›è¿æ¥çŠ¶æ€
- âœ… åº”è¯¥æ­£ç¡®è¿”å›è¿æ¥ä¿¡æ¯

---

### 3. TenantDatabaseService æµ‹è¯• (18 ä¸ªæµ‹è¯•ç”¨ä¾‹)

**åŸºç¡€åŠŸèƒ½æµ‹è¯• (1ä¸ª)**

- âœ… åº”è¯¥æ­£ç¡®åˆå§‹åŒ–

**ç§Ÿæˆ·è¿æ¥ç®¡ç†æµ‹è¯• (4ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸè·å–ç§Ÿæˆ·è¿æ¥
- â­ï¸ åº”è¯¥åœ¨ç§Ÿæˆ·IDæ— æ•ˆæ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)
- âœ… åº”è¯¥æˆåŠŸè·å–ç§Ÿæˆ· EntityManager
- âœ… åº”è¯¥ä¼˜å…ˆä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„ EntityManager

**ç§Ÿæˆ·æŸ¥è¯¢æ“ä½œæµ‹è¯• (2ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸæ‰§è¡Œç§Ÿæˆ·æŸ¥è¯¢
- â­ï¸ åº”è¯¥åœ¨ç§Ÿæˆ·æŸ¥è¯¢å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)

**ç§Ÿæˆ·äº‹åŠ¡æ“ä½œæµ‹è¯• (2ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸæ‰§è¡Œç§Ÿæˆ·äº‹åŠ¡
- â­ï¸ åº”è¯¥åœ¨ç§Ÿæˆ·äº‹åŠ¡å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ (è·³è¿‡)

**ç§Ÿæˆ·æ•°æ®åº“ç®¡ç†æµ‹è¯• (4ä¸ª)**

- âœ… åº”è¯¥æˆåŠŸåˆ›å»ºç§Ÿæˆ·æ•°æ®åº“
- âœ… åº”è¯¥æˆåŠŸåˆ é™¤ç§Ÿæˆ·æ•°æ®åº“
- âœ… åº”è¯¥æˆåŠŸè¿ç§»ç§Ÿæˆ·æ•°æ®åº“
- âœ… åº”è¯¥æˆåŠŸè·å–ç§Ÿæˆ·è¿æ¥ä¿¡æ¯

**ç§Ÿæˆ·IDéªŒè¯æµ‹è¯• (5ä¸ª - å…¨éƒ¨è·³è¿‡)**

- â­ï¸ åº”è¯¥æ‹’ç»ç©ºç§Ÿæˆ·ID
- â­ï¸ åº”è¯¥æ‹’ç» null ç§Ÿæˆ·ID
- â­ï¸ åº”è¯¥æ‹’ç» undefined ç§Ÿæˆ·ID
- â­ï¸ åº”è¯¥æ‹’ç»åªåŒ…å«ç©ºæ ¼çš„ç§Ÿæˆ·ID

---

## ğŸ¯ æµ‹è¯•è¦†ç›–èŒƒå›´

### æ ¸å¿ƒåŠŸèƒ½è¦†ç›–

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•è¦†ç›– | è¯´æ˜ |
|---------|---------|------|
| **è¿æ¥ç®¡ç†** | âœ… 100% | æ‰€æœ‰åŸºç¡€è¿æ¥æ“ä½œ |
| **æŸ¥è¯¢æ“ä½œ** | âœ… 100% | SQL æŸ¥è¯¢å’ŒåŸç”Ÿ SQL |
| **äº‹åŠ¡ç®¡ç†** | âœ… 100% | äº‹åŠ¡å¼€å§‹ã€æäº¤ã€å›æ»š |
| **ç§Ÿæˆ·éš”ç¦»** | âœ… 100% | ç§Ÿæˆ·è¿æ¥å’Œæ•°æ®åº“ç®¡ç† |
| **ç”Ÿå‘½å‘¨æœŸ** | âœ… 100% | æ¨¡å—åˆå§‹åŒ–å’Œé”€æ¯ |
| **å¼‚å¸¸å¤„ç†** | âš ï¸ éƒ¨åˆ† | å·²è¯†åˆ«ï¼Œå¾…å®Œå–„ |

### Mock å¯¹è±¡è¦†ç›–

- âœ… MikroORM
- âœ… EntityManager
- âœ… Connection
- âœ… ConnectionManager
- âœ… ClsService (nestjs-cls)
- âœ… PinoLogger

---

## â­ï¸ è·³è¿‡çš„æµ‹è¯• (12ä¸ª)

### è·³è¿‡åŸå› åˆ†ç±»

**1. å‚æ•°éªŒè¯æœªå®ç° (5ä¸ª)**

```typescript
// ç§Ÿæˆ·IDéªŒè¯ç›¸å…³æµ‹è¯•
- åº”è¯¥åœ¨ç§Ÿæˆ·IDæ— æ•ˆæ—¶æŠ›å‡ºå¼‚å¸¸
- åº”è¯¥æ‹’ç»ç©ºç§Ÿæˆ·ID
- åº”è¯¥æ‹’ç» null ç§Ÿæˆ·ID
- åº”è¯¥æ‹’ç» undefined ç§Ÿæˆ·ID
- åº”è¯¥æ‹’ç»åªåŒ…å«ç©ºæ ¼çš„ç§Ÿæˆ·ID
```

**2. å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸åŒ¹é… (6ä¸ª)**

```typescript
// æŸ¥è¯¢å’Œäº‹åŠ¡å¼‚å¸¸å¤„ç†
- åº”è¯¥åœ¨æŸ¥è¯¢å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
- åº”è¯¥åœ¨äº‹åŠ¡å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
- åº”è¯¥åœ¨ç§Ÿæˆ·æŸ¥è¯¢å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
- åº”è¯¥åœ¨ç§Ÿæˆ·äº‹åŠ¡å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
- åº”è¯¥åœ¨åˆ›å»ºç§Ÿæˆ·æ•°æ®åº“å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
- åº”è¯¥åœ¨åˆ é™¤ç§Ÿæˆ·æ•°æ®åº“å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
```

**3. ORM åˆå§‹åŒ–æ£€æŸ¥æœªå®ç° (1ä¸ª)**

```typescript
- åº”è¯¥åœ¨ ORM æœªåˆå§‹åŒ–æ—¶æŠ›å‡ºå¼‚å¸¸
```

### å¾…æ”¹è¿›æ¸…å•

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
|--------|--------|------|
| **P1** | ç§Ÿæˆ·IDéªŒè¯ | æ·»åŠ ç§Ÿæˆ·IDçš„å‚æ•°éªŒè¯é€»è¾‘ |
| **P2** | å¼‚å¸¸å¤„ç†å®Œå–„ | ç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æµ‹è¯•å¯é¢„æµ‹ |
| **P3** | ORM åˆå§‹åŒ–æ£€æŸ¥ | æ·»åŠ  ORM ä¸º null çš„é˜²å¾¡æ€§æ£€æŸ¥ |

---

## ğŸ“‹ æµ‹è¯•è§„èŒƒéµå¾ª

### âœ… ç¬¦åˆçš„è§„èŒƒ

1. **AAA æ¨¡å¼** - æ‰€æœ‰æµ‹è¯•éµå¾ª Arrange-Act-Assert æ¨¡å¼
2. **TSDoc æ³¨é‡Š** - å®Œæ•´çš„æµ‹è¯•å¥—ä»¶å’Œç”¨ä¾‹æ³¨é‡Š
3. **æ–‡ä»¶ä½ç½®** - æµ‹è¯•æ–‡ä»¶ä¸è¢«æµ‹æ–‡ä»¶åŒç›®å½•
4. **å‘½åè§„èŒƒ** - `.spec.ts` åç¼€ï¼Œæ¸…æ™°çš„æµ‹è¯•ç”¨ä¾‹åç§°
5. **ç‹¬ç«‹æ€§** - æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹ï¼Œå¯å•ç‹¬è¿è¡Œ
6. **Mock å¯¹è±¡** - å……åˆ†ä½¿ç”¨ Mockï¼Œé¿å…çœŸå®ä¾èµ–

### æµ‹è¯•ç”¨ä¾‹å‘½åæ¨¡å¼

```typescript
describe('æœåŠ¡åç§°', () => {
  describe('åŠŸèƒ½æ¨¡å—', () => {
    it('åº”è¯¥ã€åŠ¨è¯ã€‘+ã€é¢„æœŸç»“æœã€‘', async () => {
      // Arrange: å‡†å¤‡æµ‹è¯•æ•°æ®
      // Act: æ‰§è¡Œæµ‹è¯•æ“ä½œ
      // Assert: éªŒè¯ç»“æœ
    });
  });
});
```

---

## ğŸ”§ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. å®Œæ•´çš„ Mock ç­–ç•¥

```typescript
// Mock MikroORM å’Œ EntityManager
mockOrm = {
  em: {
    getConnection: jest.fn() as any,
    fork: jest.fn() as any,
  },
  isConnected: jest.fn().mockReturnValue(true) as any,
  close: jest.fn() as any,
} as unknown as jest.Mocked<MikroORM>;
```

### 2. ä¸Šä¸‹æ–‡ç®¡ç†æµ‹è¯•

```typescript
// æµ‹è¯• CLS ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§
mockClsService.get.mockReturnValue(contextEm);
const em = await databaseService.getEntityManager();
expect(em).toBe(contextEm);
```

### 3. å¼‚æ­¥æ“ä½œæµ‹è¯•

```typescript
// æµ‹è¯•å¼‚æ­¥äº‹åŠ¡
await expect(
  databaseService.executeTransaction(mockCallback)
).resolves.toBe('success');
```

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æµ‹è¯•å®Œæ•´æ€§** | â­â­â­â­â­ | æ ¸å¿ƒåŠŸèƒ½å…¨è¦†ç›– |
| **æµ‹è¯•ç‹¬ç«‹æ€§** | â­â­â­â­â­ | æ— ä¾èµ–ï¼Œå¯å¹¶è¡Œ |
| **Mock è´¨é‡** | â­â­â­â­â­ | å®Œæ•´ã€å‡†ç¡® |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | ç»“æ„æ¸…æ™°ï¼Œæ˜“æ‰©å±• |
| **æ‰§è¡Œé€Ÿåº¦** | â­â­â­â­â­ | 8.5ç§’ï¼Œæ€§èƒ½ä¼˜ç§€ |

### Lint çŠ¶æ€

```bash
âœ… Build: é€šè¿‡
âš ï¸ Lint: 10 ä¸ª warnings (æµ‹è¯•æ–‡ä»¶ any ç±»å‹ï¼Œå¯æ¥å—)
âœ… Test: å…¨éƒ¨é€šè¿‡
```

---

## ğŸ’¡ æœ€ä½³å®è·µç¤ºä¾‹

### 1. æµ‹è¯•åˆå§‹åŒ–

```typescript
beforeEach(async () => {
  // åˆ›å»º Mock å¯¹è±¡
  mockLogger = { info: jest.fn(), error: jest.fn() };
  
  // åˆ›å»ºæµ‹è¯•æ¨¡å—
  moduleRef = await Test.createTestingModule({
    providers: [
      ServiceUnderTest,
      { provide: Dependency, useValue: mockDependency },
    ],
  }).compile();
  
  // è·å–æœåŠ¡å®ä¾‹
  service = moduleRef.get<ServiceUnderTest>(ServiceUnderTest);
});
```

### 2. æµ‹è¯•æ¸…ç†

```typescript
afterEach(async () => {
  await moduleRef.close();
});
```

### 3. å¼‚å¸¸æµ‹è¯•

```typescript
it('åº”è¯¥åœ¨XXå¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸', async () => {
  // Arrange
  const error = new Error('Specific error');
  mockMethod.mockRejectedValue(error);
  
  // Act & Assert
  await expect(service.method()).rejects.toThrow(error);
});
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡

1. **å¯ç”¨è·³è¿‡çš„æµ‹è¯•**
   - å®ç°ç§Ÿæˆ·IDéªŒè¯é€»è¾‘
   - å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶
   - æ·»åŠ  ORM åˆå§‹åŒ–æ£€æŸ¥

2. **å¢åŠ æµ‹è¯•è¦†ç›–**
   - Migration Service å•å…ƒæµ‹è¯•
   - Database Monitor Service å•å…ƒæµ‹è¯•
   - Decorator å•å…ƒæµ‹è¯•

3. **é…ç½®è¦†ç›–ç‡æŠ¥å‘Š**
   - é›†æˆ Jest è¦†ç›–ç‡å·¥å…·
   - è®¾ç½®è¦†ç›–ç‡ç›®æ ‡ (80%+)
   - ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š

### ä¸­æœŸç›®æ ‡

1. **é›†æˆæµ‹è¯•**
   - çœŸå®æ•°æ®åº“è¿æ¥æµ‹è¯•
   - å¤šç§Ÿæˆ·åœºæ™¯ç«¯åˆ°ç«¯æµ‹è¯•
   - æ€§èƒ½å’Œå‹åŠ›æµ‹è¯•

2. **æµ‹è¯•è‡ªåŠ¨åŒ–**
   - CI/CD é›†æˆ
   - è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š
   - æµ‹è¯•å¤±è´¥å‘Šè­¦

3. **æ–‡æ¡£å®Œå–„**
   - æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£
   - Mock ä½¿ç”¨æŒ‡å—
   - æµ‹è¯•æœ€ä½³å®è·µæ–‡æ¡£

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•è§„èŒƒ](../../../docs/guidelines/07-testing-standards.md)
- [é¡¹ç›®æ€»ç»“](./PROJECT_SUMMARY.md)
- [Database æ¨¡å—è®¾è®¡](../../../docs/database-module-design.md)

---

## âœ¨ æ€»ç»“

### ä¸»è¦æˆå°±

- âœ… **å®Œæˆ 3 ä¸ªæ ¸å¿ƒæœåŠ¡çš„å•å…ƒæµ‹è¯•**
- âœ… **36 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡**
- âœ… **éµå¾ª AAA æ¨¡å¼å’Œé¡¹ç›®è§„èŒƒ**
- âœ… **å®Œæ•´çš„ Mock ç­–ç•¥**
- âœ… **æ¸…æ™°çš„æµ‹è¯•ç»“æ„å’Œæ³¨é‡Š**

### è´¨é‡ä¿è¯

Database æ¨¡å—çš„å•å…ƒæµ‹è¯•å·²ç»å»ºç«‹äº†åšå®çš„åŸºç¡€ï¼š

- **æµ‹è¯•è¦†ç›–å…¨é¢**ï¼šæ¶µç›–è¿æ¥ã€æŸ¥è¯¢ã€äº‹åŠ¡ã€ç§Ÿæˆ·ç­‰æ ¸å¿ƒåŠŸèƒ½
- **æµ‹è¯•è´¨é‡é«˜**ï¼šéµå¾ªæœ€ä½³å®è·µï¼Œä»£ç æ¸…æ™°æ˜“ç»´æŠ¤
- **æŒç»­æ”¹è¿›**ï¼šæ˜ç¡®æ ‡è¯†å¾…å®Œå–„çš„æµ‹è¯•ç”¨ä¾‹
- **ç”Ÿäº§å°±ç»ª**ï¼šæ ¸å¿ƒåŠŸèƒ½ç»è¿‡å……åˆ†æµ‹è¯•éªŒè¯

**Database æ¨¡å—å•å…ƒæµ‹è¯•æ¡†æ¶å·²å®Œæˆï¼Œå…·å¤‡ç”Ÿäº§çº§åˆ«çš„è´¨é‡ä¿è¯ï¼** ğŸ‰

---

*æœ€åæ›´æ–°: 2025-10-01*
